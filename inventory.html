<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSåœ¨åº«ãƒŠãƒ“</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%232383e2'/><stop offset='100%25' stop-color='%231a5fb4'/></linearGradient></defs><circle cx='16' cy='16' r='15' fill='url(%23g)'/><path d='M8 11 L16 7 L24 11 L24 21 L16 25 L8 21 Z' fill='none' stroke='%23fff' stroke-width='1.5'/><path d='M16 7 L16 25' stroke='%23fff' stroke-width='1.5'/><path d='M8 11 L16 15 L24 11' fill='none' stroke='%23fff' stroke-width='1.5'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%232383e2'/><path d='M45 65 L90 40 L135 65 L135 115 L90 140 L45 115 Z' fill='none' stroke='%23fff' stroke-width='8'/><path d='M90 40 L90 140' stroke='%23fff' stroke-width='8'/><path d='M45 65 L90 90 L135 65' fill='none' stroke='%23fff' stroke-width='8'/></svg>">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap');
        * { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-slate-100 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-slate-600 text-lg">åˆæœŸåŒ–ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ'; // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ï¼ˆèª¿é”ç®¡ç†ã¨åŒã˜ï¼‰
        const PRODUCT_MASTER_ID = '1YnEJ5LEYBwZJ2zDYnjUpkpjnB2naHFVAtPdzcv81nvI'; // è£½å“ãƒã‚¹ã‚¿
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';
        const PARENT_FOLDER_ID = '1EvObQiCJgxJCzd_kQJ1PNbOUMD5P-Zxp';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let inventory = [];
        let archivedInventory = [];
        let archiveLoaded = false; // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–èª­ã¿è¾¼ã¿å®Œäº†ãƒ•ãƒ©ã‚°
        let folderCache = {};
        let lastUpdated = null; // æœ€çµ‚æ›´æ–°æ—¥æ™‚
        let isDarkMode = localStorage.getItem('darkMode') === 'true'; // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹
        let bulkSelectMode = false; // ä¸€æ‹¬é¸æŠãƒ¢ãƒ¼ãƒ‰
        let selectedItems = new Set(); // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ID
        let productMaster = []; // è£½å“ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
        let suppliers = []; // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒã‚¹ã‚¿
        let projects = []; // æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
        let viewMode = 'group'; // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: 'group'ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºï¼‰ or 'flat'ï¼ˆãƒ•ãƒ©ãƒƒãƒˆè¡¨ç¤ºï¼‰
        let groupMode = 'order'; // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–åŸºæº–: 'order'ï¼ˆç™ºæ³¨æ¡ˆä»¶ï¼‰ or 'ship'ï¼ˆå‡ºåº«å…ˆï¼‰
        
        // è¤‡æ•°äººåˆ©ç”¨å¯¾å¿œ
        let autoReloadInterval = null;
        let autoReloadEnabled = true;
        const AUTO_RELOAD_SECONDS = 60; // 60ç§’é–“éš”
        let lastDataHash = ''; // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ¤œçŸ¥ç”¨
        let lastSaveTime = 0; // æœ€å¾Œã«ä¿å­˜ã—ãŸæ™‚åˆ»
        
        // ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        let tokenRefreshTimer = null;
        let tokenExpiresAt = null;
        const TOKEN_REFRESH_MINUTES = 50; // 50åˆ†ã”ã¨ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆæœ‰åŠ¹æœŸé™60åˆ†ã®å‰ï¼‰

        // æ¡ˆä»¶ç•ªå·ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        // è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¾‹: AD-1681ï¼‰
        function formatProjectNumber(prefix, number) {
            if (!prefix && !number) return '';
            return `${prefix || 'AD'}-${number || 0}`;
        }

        // æ¡ˆä»¶ç•ªå·æ–‡å­—åˆ—ã‹ã‚‰prefix/numberã‚’åˆ†è§£
        function parseProjectNumberString(str) {
            if (!str) return { prefix: '', number: '' };
            const match = str.match(/^([A-Z]+)-?(\d+)$/i);
            if (match) {
                return { prefix: match[1].toUpperCase(), number: match[2] };
            }
            // æ•°å­—ã®ã¿ã®å ´åˆ
            const numMatch = str.match(/^(\d+)$/);
            if (numMatch) {
                return { prefix: 'AD', number: numMatch[1] };
            }
            return { prefix: '', number: '' };
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ­£è¦åŒ–ï¼ˆå¾Œæ–¹äº’æ›ï¼šç™ºé€æ¸ˆãƒ»å¼•æ¸¡æ¸ˆ â†’ å‡ºåº«æ¸ˆã€ä¸å…·åˆ â†’ ä¸è‰¯å“ï¼‰
        function normalizeStatus(status) {
            if (status === 'ç™ºé€æ¸ˆ' || status === 'å¼•æ¸¡æ¸ˆ') {
                return 'å‡ºåº«æ¸ˆ';
            }
            if (status === 'ä¸å…·åˆ') {
                return 'ä¸è‰¯å“';
            }
            return status;
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            document.documentElement.classList.toggle('dark', isDarkMode);
            renderMain();
        }

        // ç¨®åˆ¥ãƒªã‚¹ãƒˆ
        const CATEGORIES = [
            'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤',
            'å±‹å¤–',
            'å±‹å¤–LED',
            'å±‹å†…',
            'å±‹å†…LED',
            'LEDã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼',
            'STUDIA',
            'ãƒãƒˆãƒªã‚¯ã‚¹',
            'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼',
            'OPS',
            'ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·',
            'å‘¨è¾ºæ©Ÿå™¨'
        ];

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚¹ãƒˆ
        const STATUSES = ['å…¥åº«å¾…ã¡', 'æ¤œå“å¾…ã¡', 'åœ¨åº«ä¸­', 'å‡ºåº«æ¸ˆ', 'ç¤¾å†…ä½¿ç”¨', 'ä¸è‰¯å“', 'å»ƒæ£„'];

        // ä¿ç®¡å ´æ‰€ãƒªã‚¹ãƒˆ
        const LOCATIONS = ['è“®ç”°', 'æ±äº¬', 'å¤§é˜ª'];

        // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿
        let currentFilters = {
            category: '',
            status: '',
            search: '',
            sort: 'orderDate-desc',
            shelfNo: '',
            receiveDateFrom: '',
            receiveDateTo: '',
            shipProject: '',
            costRange: '',
            noShelf: false,
            location: ''
        };

        // è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿é–‹é–‰çŠ¶æ…‹
        let showDetailFilters = false;

        // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ï¼ˆæ¡ˆä»¶ç•ªå·ã”ã¨ï¼‰- localStorageã§ä¿æŒ
        let expandedProjects = JSON.parse(localStorage.getItem('inventoryExpandedProjects') || '{}');

        // æ£šç•ªãƒªã‚¹ãƒˆï¼ˆ1ã€œ30ï¼‰
        const SHELF_NUMBERS = Array.from({length: 30}, (_, i) => String(i + 1));

        // åŸä¾¡å¸¯ãƒªã‚¹ãƒˆ
        const COST_RANGES = [
            { value: '', label: 'ã™ã¹ã¦' },
            { value: '0-50000', label: '5ä¸‡å††æœªæº€' },
            { value: '50000-100000', label: '5ã€œ10ä¸‡å††' },
            { value: '100000-300000', label: '10ã€œ30ä¸‡å††' },
            { value: '300000-', label: '30ä¸‡å††ä»¥ä¸Š' }
        ];

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    'https://sheets.googleapis.com/$discovery/rest?version=v4',
                    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                ],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    accessToken = resp.access_token;
                    sessionStorage.setItem('googleAccessToken', accessToken);
                    
                    // ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã‚’è¨˜éŒ²ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60åˆ†ï¼‰
                    const expiresIn = resp.expires_in || 3600;
                    tokenExpiresAt = Date.now() + (expiresIn * 1000);
                    sessionStorage.setItem('tokenExpiresAt', tokenExpiresAt.toString());
                    
                    // è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
                    startTokenRefreshTimer();
                    
                    loadData();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        // ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒãƒ¼
        function startTokenRefreshTimer() {
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            // 50åˆ†å¾Œã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            tokenRefreshTimer = setTimeout(() => {
                console.log('ğŸ”„ ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ä¸­...');
                silentTokenRefresh();
            }, TOKEN_REFRESH_MINUTES * 60 * 1000);
            
            console.log(`â° ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥äºˆå®š: ${TOKEN_REFRESH_MINUTES}åˆ†å¾Œ`);
        }
        
        // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ãˆãªã„å½¢ã§æ›´æ–°ï¼‰
        function silentTokenRefresh() {
            if (!tokenClient) return;
            
            tokenClient.callback = (resp) => {
                if (resp.error !== undefined) {
                    console.error('ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—:', resp.error);
                    showConnectionStatus('warning');
                    return;
                }
                accessToken = resp.access_token;
                sessionStorage.setItem('googleAccessToken', accessToken);
                
                const expiresIn = resp.expires_in || 3600;
                tokenExpiresAt = Date.now() + (expiresIn * 1000);
                sessionStorage.setItem('tokenExpiresAt', tokenExpiresAt.toString());
                
                console.log('âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æˆåŠŸ');
                showConnectionStatus('connected');
                startTokenRefreshTimer();
            };
            
            tokenClient.requestAccessToken({ prompt: '' });
        }
        
        // æ¥ç¶šçŠ¶æ…‹è¡¨ç¤º
        function showConnectionStatus(status) {
            const indicator = document.getElementById('connectionIndicator');
            if (!indicator) return;
            
            if (status === 'connected') {
                indicator.className = 'w-2 h-2 rounded-full bg-green-400';
                indicator.title = 'æ¥ç¶šä¸­';
            } else if (status === 'warning') {
                indicator.className = 'w-2 h-2 rounded-full bg-yellow-400 animate-pulse';
                indicator.title = 'å†æ¥ç¶šãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
            } else {
                indicator.className = 'w-2 h-2 rounded-full bg-red-400';
                indicator.title = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
            }
        }
        
        // APIå‘¼ã³å‡ºã—ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã«è‡ªå‹•å†èªè¨¼ï¼‰
        async function apiCallWithRetry(apiCall) {
            try {
                return await apiCall();
            } catch (err) {
                if (err.status === 401 || err.status === 403) {
                    console.log('ğŸ”‘ èªè¨¼ã‚¨ãƒ©ãƒ¼ã€å†èªè¨¼ã‚’è©¦è¡Œ...');
                    
                    // å†èªè¨¼ã‚’è©¦ã¿ã‚‹
                    return new Promise((resolve, reject) => {
                        tokenClient.callback = async (resp) => {
                            if (resp.error) {
                                showConnectionStatus('error');
                                reject(new Error('å†èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚'));
                                return;
                            }
                            accessToken = resp.access_token;
                            sessionStorage.setItem('googleAccessToken', accessToken);
                            gapi.client.setToken({ access_token: accessToken });
                            
                            tokenExpiresAt = Date.now() + 3600000;
                            sessionStorage.setItem('tokenExpiresAt', tokenExpiresAt.toString());
                            startTokenRefreshTimer();
                            showConnectionStatus('connected');
                            
                            try {
                                const result = await apiCall();
                                resolve(result);
                            } catch (retryErr) {
                                reject(retryErr);
                            }
                        };
                        tokenClient.requestAccessToken({ prompt: '' });
                    });
                }
                throw err;
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const savedToken = sessionStorage.getItem('googleAccessToken');
                const savedExpiry = sessionStorage.getItem('tokenExpiresAt');
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã€æœ‰åŠ¹æœŸé™å†…ã‹ãƒã‚§ãƒƒã‚¯
                if (savedToken && savedExpiry) {
                    const expiresAt = parseInt(savedExpiry);
                    const now = Date.now();
                    
                    // æœ‰åŠ¹æœŸé™ã¾ã§5åˆ†ä»¥ä¸Šã‚ã‚‹å ´åˆã®ã¿ä½¿ç”¨
                    if (expiresAt > now + 300000) {
                        accessToken = savedToken;
                        tokenExpiresAt = expiresAt;
                        gapi.client.setToken({ access_token: accessToken });
                        startTokenRefreshTimer();
                        loadData();
                        return;
                    } else {
                        // æœŸé™åˆ‡ã‚Œé–“è¿‘ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ â†’ ã‚¯ãƒªã‚¢
                        console.log('âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã€å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');
                        sessionStorage.removeItem('googleAccessToken');
                        sessionStorage.removeItem('tokenExpiresAt');
                    }
                }
                renderSignIn();
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = resp.access_token;
                sessionStorage.setItem('googleAccessToken', accessToken);
                
                // ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã‚’è¨˜éŒ²
                const expiresIn = resp.expires_in || 3600;
                tokenExpiresAt = Date.now() + (expiresIn * 1000);
                sessionStorage.setItem('tokenExpiresAt', tokenExpiresAt.toString());
                
                // è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
                startTokenRefreshTimer();
                
                await loadData();
            };

            if (accessToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            accessToken = null;
            sessionStorage.removeItem('googleAccessToken');
            sessionStorage.removeItem('tokenExpiresAt');
            gapi.client.setToken(null);
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            
            renderSignIn();
        }

        async function findFolderUrl(projectNumber) {
            if (folderCache[projectNumber]) {
                return folderCache[projectNumber];
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name = '${projectNumber}' and '${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
                    fields: 'files(id, name, webViewLink)',
                    pageSize: 1,
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true,
                    corpora: 'allDrives'
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    const url = files[0].webViewLink;
                    folderCache[projectNumber] = url;
                    return url;
                }
                return null;
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        async function loadFolderUrls() {
            const projectNumbers = [...new Set(inventory.map(i => formatProjectNumber(i.orderPrefix, i.orderNumber)).filter(p => p && p !== 'æœªè¨­å®š' && p !== '-0'))];
            for (const projectNumber of projectNumbers) {
                if (!folderCache[projectNumber]) {
                    await findFolderUrl(projectNumber);
                }
            }
            renderMain();
        }

        function renderSignIn() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-900">
                    <div class="bg-white dark:bg-slate-800 p-10 rounded-2xl shadow-xl max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/50 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">YSåœ¨åº«ãƒŠãƒ“</h1>
                            <p class="text-slate-500 dark:text-slate-400 mb-8">å…¥å‡ºåº«ãƒ»æ£šå¸ã—ç®¡ç†</p>
                            <button onclick="handleAuthClick()" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 text-slate-700 dark:text-white px-6 py-4 rounded-xl font-semibold hover:bg-slate-50 dark:hover:bg-slate-600 hover:border-slate-300 transition-all">
                                <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        // åœ¨åº«IDã®é‡è¤‡ã‚’ä¿®å¾©
        async function repairDuplicateIds() {
            if (!confirm('åœ¨åº«ã‚·ãƒ¼ãƒˆã®IDã®é‡è¤‡ã‚’ä¿®å¾©ã—ã¾ã™ã€‚\n\né‡è¤‡ã—ã¦ã„ã‚‹IDã‚’æ–°ã—ã„ä¸€æ„ã®IDã«ç½®ãæ›ãˆã¾ã™ã€‚\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                showStatus('IDé‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
                
                // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A2:A',
                });
                const rows = response.result.values || [];
                
                // é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
                const idCounts = {};
                rows.forEach((row, idx) => {
                    const id = row[0] || '';
                    if (!idCounts[id]) {
                        idCounts[id] = [];
                    }
                    idCounts[id].push(idx);
                });
                
                // é‡è¤‡ã—ã¦ã„ã‚‹IDã‚’ä¿®å¾©
                const updates = [];
                let repairCount = 0;
                
                Object.keys(idCounts).forEach(id => {
                    const indices = idCounts[id];
                    if (indices.length > 1) {
                        // æœ€åˆã®1ã¤ã¯æ®‹ã—ã€æ®‹ã‚Šã¯æ–°ã—ã„IDã‚’ä»˜ä¸
                        for (let i = 1; i < indices.length; i++) {
                            const rowNum = indices[i] + 2; // å®Ÿéš›ã®è¡Œç•ªå·
                            const newId = Date.now().toString() + '-' + rowNum + '-' + i;
                            updates.push({
                                range: `åœ¨åº«!A${rowNum}`,
                                values: [[newId]]
                            });
                            repairCount++;
                        }
                    }
                });
                
                console.log('ä¿®å¾©å¯¾è±¡:', repairCount, 'ä»¶');
                
                if (updates.length > 0) {
                    showStatus(`${repairCount}ä»¶ã®IDã‚’ä¿®å¾©ä¸­...`);
                    
                    // ãƒãƒƒãƒã§æ›´æ–°
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            valueInputOption: 'RAW',
                            data: updates
                        }
                    });
                    
                    showStatus(`âœ… ${repairCount}ä»¶ã®IDã‚’ä¿®å¾©ã—ã¾ã—ãŸ`);
                    alert(`${repairCount}ä»¶ã®é‡è¤‡IDã‚’ä¿®å¾©ã—ã¾ã—ãŸã€‚\n\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`);
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    await loadData();
                } else {
                    showStatus('é‡è¤‡IDã¯ã‚ã‚Šã¾ã›ã‚“');
                    alert('é‡è¤‡ã—ã¦ã„ã‚‹IDã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('IDä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('IDä¿®å¾©ã‚¨ãƒ©ãƒ¼: ' + error.message);
                alert('IDä¿®å¾©ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function loadData() {
            try {
                showStatus('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                
                // åœ¨åº«ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
                try {
                    const inventoryResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A2:Q',
                    });
                    const inventoryRows = inventoryResponse.result.values || [];
                    inventory = inventoryRows.map((row, idx) => {
                        // IDãŒãªã„å ´åˆã¯è‡ªå‹•ç”Ÿæˆ
                        const itemId = row[0] || `auto-${Date.now()}-${idx}`;
                        
                        // å¾Œæ–¹äº’æ›: å¤ã„å½¢å¼(orderProject=AD-1234)ã¨æ–°ã—ã„å½¢å¼(prefix + number)ã®ä¸¡æ–¹ã«å¯¾å¿œ
                        let orderPrefix = row[4] || '';
                        let orderNumber = row[5] || '';
                        let shipPrefix = row[10] || '';
                        let shipNumber = row[11] || '';
                        
                        // å¤ã„å½¢å¼ã®å ´åˆï¼ˆrow[4]ãŒ"AD-1234"ã®ã‚ˆã†ãªå½¢å¼ï¼‰
                        if (row[4] && row[4].match(/^[A-Z]+-\d+$/i)) {
                            const parsed = parseProjectNumberString(row[4]);
                            orderPrefix = parsed.prefix;
                            orderNumber = parsed.number;
                            // å¤ã„å½¢å¼ã®å ´åˆã€ã‚«ãƒ©ãƒ ä½ç½®ã‚’ã‚·ãƒ•ãƒˆ
                            return {
                                id: itemId,
                                serial: row[1] || '',
                                category: row[2] || '',
                                productName: row[3] || '',
                                orderPrefix: orderPrefix,
                                orderNumber: orderNumber,
                                orderDate: row[5] || '',
                                receiveDate: row[6] || '',
                                status: normalizeStatus(row[7] || 'å…¥åº«å¾…ã¡'),
                                shipDate: row[8] || '',
                                shipPrefix: '',
                                shipNumber: '',
                                shipProject: row[9] || '', // å¤ã„å½¢å¼ã®å‡ºåº«å…ˆ
                                costJPY: row[10] || '',
                                note: row[11] || '',
                                shelfNo: row[12] || '',
                                location: row[13] || '',
                                supplierId: row[14] || ''
                            };
                        }
                        
                        return {
                            id: itemId,
                            serial: row[1] || '',
                            category: row[2] || '',
                            productName: row[3] || '',
                            orderPrefix: row[4] || '',
                            orderNumber: row[5] || '',
                            orderDate: row[6] || '',
                            receiveDate: row[7] || '',
                            status: normalizeStatus(row[8] || 'å…¥åº«å¾…ã¡'),
                            shipDate: row[9] || '',
                            shipPrefix: row[10] || '',
                            shipNumber: row[11] || '',
                            costJPY: row[12] || '',
                            note: row[13] || '',
                            shelfNo: row[14] || '',
                            location: row[15] || '',
                            supplierId: row[16] || ''
                        };
                    });
                } catch (e) {
                    console.log('åœ¨åº«ã‚·ãƒ¼ãƒˆãŒãªã„ãŸã‚æ–°è¦ä½œæˆã—ã¾ã™');
                    inventory = [];
                    await createInventorySheet();
                }

                // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆèª¿é”é€£æºç”¨ï¼‰
                try {
                    const supplierResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A2:C',
                    });
                    const supplierRows = supplierResponse.result.values || [];
                    suppliers = supplierRows.map(row => ({
                        id: parseInt(row[0] || Date.now()),
                        name: row[1] || '',
                        paymentPatterns: JSON.parse(row[2] || '[{"name":"æ¨™æº–","rates":[50,50]}]')
                    }));
                } catch (e) {
                    console.log('ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
                    suppliers = [];
                }

                // æ¡ˆä»¶ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
                try {
                    const projectResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'æ¡ˆä»¶!A2:E',
                    });
                    const projectRows = projectResponse.result.values || [];
                    projects = projectRows.map(row => ({
                        id: row[0] || '',
                        prefix: row[1] || 'AD',
                        number: row[2] || '',
                        supplierId: row[3] || '',
                        productName: row[4] || ''
                    }));
                } catch (e) {
                    console.log('æ¡ˆä»¶ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
                    projects = [];
                }

                // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
                try {
                    const archiveResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A2:Q',
                    });
                    const archiveRows = archiveResponse.result.values || [];
                    archivedInventory = archiveRows.map((row, idx) => {
                        const itemId = row[0] || `archive-${Date.now()}-${idx}`;
                        
                        // å¾Œæ–¹äº’æ›
                        if (row[4] && row[4].match(/^[A-Z]+-\d+$/i)) {
                            const parsed = parseProjectNumberString(row[4]);
                            return {
                                id: itemId,
                                serial: row[1] || '',
                                category: row[2] || '',
                                productName: row[3] || '',
                                orderPrefix: parsed.prefix,
                                orderNumber: parsed.number,
                                orderDate: row[5] || '',
                                receiveDate: row[6] || '',
                                status: normalizeStatus(row[7] || ''),
                                shipDate: row[8] || '',
                                shipPrefix: '',
                                shipNumber: '',
                                shipProject: row[9] || '',
                                costJPY: row[10] || '',
                                note: row[11] || '',
                                shelfNo: row[12] || '',
                                location: row[13] || ''
                            };
                        }
                        
                        return {
                            id: itemId,
                            serial: row[1] || '',
                            category: row[2] || '',
                            productName: row[3] || '',
                            orderPrefix: row[4] || '',
                            orderNumber: row[5] || '',
                            orderDate: row[6] || '',
                            receiveDate: row[7] || '',
                            status: normalizeStatus(row[8] || ''),
                            shipDate: row[9] || '',
                            shipPrefix: row[10] || '',
                            shipNumber: row[11] || '',
                            costJPY: row[12] || '',
                            note: row[13] || '',
                            shelfNo: row[14] || '',
                            location: row[15] || '',
                            supplierId: row[16] || ''
                        };
                    });
                    archiveLoaded = true; // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–èª­ã¿è¾¼ã¿å®Œäº†
                } catch (e) {
                    console.log('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚·ãƒ¼ãƒˆãŒãªã„ãŸã‚æ–°è¦ä½œæˆã—ã¾ã™');
                    archivedInventory = [];
                    await createArchiveSheet();
                    archiveLoaded = true; // æ–°è¦ä½œæˆã‚‚å®Œäº†æ‰±ã„
                }

                // è£½å“ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿
                try {
                    await loadProductMaster();
                } catch (e) {
                    console.log('è£½å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                    productMaster = [];
                }

                lastUpdated = new Date();
                showStatus('');
                renderMain();
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¡ˆä»¶æŒ‡å®šãŒã‚ã‚Œã°ãƒ•ã‚£ãƒ«ã‚¿
                checkUrlParams();
                
                // ãƒ•ã‚©ãƒ«ãƒ€URLã‚’éåŒæœŸã§èª­ã¿è¾¼ã¿
                loadFolderUrls();
                
                // è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹
                startAutoReload();
            } catch (err) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        // è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function startAutoReload() {
            if (autoReloadInterval) {
                clearInterval(autoReloadInterval);
            }
            if (autoReloadEnabled) {
                autoReloadInterval = setInterval(async () => {
                    await silentReload();
                }, AUTO_RELOAD_SECONDS * 1000);
            }
        }

        function stopAutoReload() {
            if (autoReloadInterval) {
                clearInterval(autoReloadInterval);
                autoReloadInterval = null;
            }
        }

        function toggleAutoReload() {
            autoReloadEnabled = !autoReloadEnabled;
            if (autoReloadEnabled) {
                startAutoReload();
            } else {
                stopAutoReload();
            }
            renderMain();
        }

        // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆUIã‚’æ›´æ–°ã›ãšã«ãƒ‡ãƒ¼ã‚¿å–å¾—ã€å¤‰æ›´ãŒã‚ã‚Œã°é€šçŸ¥ï¼‰
        async function silentReload() {
            // ä¿å­˜ç›´å¾Œ5ç§’é–“ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (Date.now() - lastSaveTime < 5000) {
                console.log('ä¿å­˜ç›´å¾Œã®ãŸã‚è‡ªå‹•åŒæœŸã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A2:Q',
                });
                const rows = response.result.values || [];
                const newHash = JSON.stringify(rows);
                
                if (lastDataHash && newHash !== lastDataHash) {
                    // ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚ŒãŸ
                    showSyncNotification();
                    inventory = rows.map(row => {
                        // å¾Œæ–¹äº’æ›
                        if (row[4] && row[4].match(/^[A-Z]+-\d+$/i)) {
                            const parsed = parseProjectNumberString(row[4]);
                            return {
                                id: row[0] || '',
                                serial: row[1] || '',
                                category: row[2] || '',
                                productName: row[3] || '',
                                orderPrefix: parsed.prefix,
                                orderNumber: parsed.number,
                                orderDate: row[5] || '',
                                receiveDate: row[6] || '',
                                status: normalizeStatus(row[7] || 'å…¥åº«å¾…ã¡'),
                                shipDate: row[8] || '',
                                shipPrefix: '',
                                shipNumber: '',
                                costJPY: row[10] || '',
                                note: row[11] || '',
                                shelfNo: row[12] || '',
                                location: row[13] || '',
                                supplierId: row[14] || ''
                            };
                        }
                        return {
                            id: row[0] || '',
                            serial: row[1] || '',
                            category: row[2] || '',
                            productName: row[3] || '',
                            orderPrefix: row[4] || '',
                            orderNumber: row[5] || '',
                            orderDate: row[6] || '',
                            receiveDate: row[7] || '',
                            status: normalizeStatus(row[8] || 'å…¥åº«å¾…ã¡'),
                            shipDate: row[9] || '',
                            shipPrefix: row[10] || '',
                            shipNumber: row[11] || '',
                            costJPY: row[12] || '',
                            note: row[13] || '',
                            shelfNo: row[14] || '',
                            location: row[15] || '',
                            supplierId: row[16] || ''
                        };
                    });
                    lastUpdated = new Date();
                    renderMain();
                }
                lastDataHash = newHash;
            } catch (err) {
                console.log('è‡ªå‹•åŒæœŸã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        // åŒæœŸé€šçŸ¥ã‚’è¡¨ç¤º
        function showSyncNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-pulse';
            notification.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                <span>ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ</span>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // è£½å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿
        async function loadProductMaster() {
            const sheetNames = ['LCD', 'LED', 'LED_others', 'matrix-switcher', 'TVwall_controller', 'STUDIA', 'e-board_stand', 'OPS', 'dongle', 'player'];
            productMaster = [];
            
            for (const sheetName of sheetNames) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: PRODUCT_MASTER_ID,
                        range: `${sheetName}!A1:BZ`,
                    });
                    const rows = response.result.values || [];
                    if (rows.length < 2) continue;
                    
                    const headers = rows[0];
                    const dataRows = rows.slice(1);
                    
                    // ã‚«ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
                    const colIndex = {};
                    headers.forEach((h, i) => colIndex[h] = i);
                    
                    dataRows.forEach(row => {
                        // is_active ãƒã‚§ãƒƒã‚¯ï¼ˆæ—§å½¢å¼ãƒ»æ–°å½¢å¼ä¸¡å¯¾å¿œï¼‰
                        const isActive = row[colIndex['is_active']] || '';
                        if (isActive !== 'TRUE') return;
                        
                        // type ã‹ã‚‰ category ã‚’æ±ºå®šï¼ˆæ—§å½¢å¼å¯¾å¿œï¼‰
                        const type = row[colIndex['type']] || '';
                        // æ–°å½¢å¼ã® category ã‚«ãƒ©ãƒ ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã° type ã‹ã‚‰å¤‰æ›
                        let category = row[colIndex['category']] || '';
                        if (!category) {
                            if (type === 'ID') category = 'å±‹å†…';
                            else if (type === 'OD') category = 'å±‹å¤–';
                            else if (type === 'MD') category = 'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤';
                            else category = sheetName;
                        }
                        
                        // æ–°æ—§ä¸¡æ–¹ã®ã‚«ãƒ©ãƒ åã«å¯¾å¿œ
                        productMaster.push({
                            id: row[colIndex['id']] || row[colIndex['ID']] || '',
                            pn: row[colIndex['pn']] || row[colIndex['PN']] || '',
                            pn_full: row[colIndex['pn_full']] || row[colIndex['PN2']] || '',
                            type: type,
                            category: category,
                            supplier: row[colIndex['supplier']] || row[colIndex['suplier']] || '',
                            inch: row[colIndex['inch']] || '',
                            color: row[colIndex['color_body']] || '',
                            resolution: row[colIndex['resolution']] || row[colIndex['resoltion']] || '',
                            brightness: row[colIndex['brightness']] || '',
                            touch: (row[colIndex['touch']] === 'TRUE' || row[colIndex['touch']] === true),
                            sheetName: sheetName,
                            // LCD/STUDIA/OPS/playerå…±é€š
                            os: row[colIndex['os']] || row[colIndex['OS']] || '',
                            cpu: row[colIndex['cpu']] || row[colIndex['CPU']] || '',
                            gpu: row[colIndex['gpu']] || row[colIndex['GPU']] || '',
                            ram: row[colIndex['ram']] || row[colIndex['RAM']] || '',
                            rom: row[colIndex['rom']] || row[colIndex['ROM']] || '',
                            // STUDIAå›ºæœ‰
                            edla_certified: row[colIndex['edla_certified']] || row[colIndex['EDLAcartification_TF']] || '',
                            touch_type: row[colIndex['touch_type']] || '',
                            weight_net: row[colIndex['weight_net']] || '',
                            weight_gross: row[colIndex['weight_gross']] || '',
                            warranty_term: row[colIndex['warranty_term']] || '',
                            // LEDå›ºæœ‰
                            pixel_pitch: row[colIndex['pixel_pitch']] || row[colIndex['pixel']] || '',
                            smd_type: row[colIndex['smd_type']] || row[colIndex['SMD']] || '',
                            ip_rating: row[colIndex['ip_rating']] || row[colIndex['IP']] || '',
                            // ãƒãƒˆãƒªã‚¯ã‚¹å›ºæœ‰
                            input_count: row[colIndex['input_count']] || row[colIndex['in']] || '',
                            output_count: row[colIndex['output_count']] || row[colIndex['out']] || '',
                            // TVwallå›ºæœ‰
                            hdmi_out: row[colIndex['hdmi_out']] || row[colIndex['HDMI_output_amount']] || '',
                            hdmi_in: row[colIndex['hdmi_in']] || row[colIndex['HDMI_input_amount']] || '',
                            // LED_otherså›ºæœ‰
                            product_type: row[colIndex['product_type']] || '',
                            detail: row[colIndex['detail']] || '',
                            // OPSå›ºæœ‰
                            soc: row[colIndex['soc']] || row[colIndex['SoC']] || '',
                            graphics_card: row[colIndex['graphics_card']] || '',
                            usb3_amount: row[colIndex['usb3_amount']] || row[colIndex['USB3.0_amount']] || '',
                            usb_typec_amount: row[colIndex['usb_typec_amount']] || row[colIndex['USBTypeC_amount']] || '',
                            dp_out: row[colIndex['dp_out']] || row[colIndex['DP_out_amount']] || '',
                            // playerå›ºæœ‰
                            wifi: row[colIndex['wifi']] || row[colIndex['Wi-Fi']] || '',
                            bluetooth_version: row[colIndex['bluetooth_version']] || '',
                            usb2_amount: row[colIndex['usb2_amount']] || row[colIndex['USB2.0_amount']] || '',
                            // dongleå›ºæœ‰
                            connector_type: row[colIndex['connector_type']] || '',
                            resolution_max: row[colIndex['resolution_max']] || '',
                            distance_max: row[colIndex['distance_max']] || '',
                            touchback: row[colIndex['touchback']] || row[colIndex['touchback_TF']] || '',
                            // ã‚¹ã‚¿ãƒ³ãƒ‰å›ºæœ‰
                            inch_65: row[colIndex['inch_65']] || row[colIndex['65inch_attachable_TF']] || '',
                            inch_75: row[colIndex['inch_75']] || row[colIndex['75inch_attachable_TF']] || '',
                            inch_86: row[colIndex['inch_86']] || row[colIndex['86inch_attachable_TF']] || '',
                            inch_98: row[colIndex['inch_98']] || row[colIndex['98inch_attachable_TF']] || '',
                            inch_110: row[colIndex['inch_110']] || row[colIndex['110inch_attachable_TF']] || '',
                            tilt_angle: row[colIndex['tilt_angle']] || '',
                            height: row[colIndex['height']] || '',
                            electric: row[colIndex['electric']] || row[colIndex['electric_TF']] || '',
                            // é›»æº
                            power_max_w: row[colIndex['power_max_w']] || (row[colIndex['power_max_consumption']] || '').replace('W', '') || '',
                            power_consumption: row[colIndex['power_consumption']] || '',
                            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
                            doc_path: row[colIndex['doc_path']] || ''
                        });
                    });
                } catch (e) {
                    console.log(`${sheetName} ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—:`, e.message);
                }
            }
            console.log(`è£½å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${productMaster.length}ä»¶`);
        }

        // è£½å“ãƒã‚¹ã‚¿ã‹ã‚‰ä¸€æ„ã®PNä¸€è¦§ã‚’å–å¾—ï¼ˆè‰²é•ã„ã‚’é™¤ãï¼‰
        function getUniquePNList() {
            const pnMap = new Map();
            productMaster.forEach(p => {
                if (!pnMap.has(p.pn)) {
                    pnMap.set(p.pn, p);
                }
            });
            return Array.from(pnMap.values());
        }

        // PNã‹ã‚‰è£½å“æƒ…å ±ã‚’å–å¾—
        function getProductByPN(pn) {
            return productMaster.find(p => p.pn === pn);
        }

        // PNã®è‰²ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        function getColorVariants(pn) {
            return productMaster.filter(p => p.pn === pn).map(p => p.color).filter(c => c);
        }

        // NSï¼ˆNo Serialï¼‰è‡ªå‹•æ¡ç•ª
        function generateNSSerial() {
            // æ—¢å­˜ã®NS-xxxã®æœ€å¤§ç•ªå·ã‚’å–å¾—
            const nsSerials = inventory
                .filter(i => i.serial && i.serial.startsWith('NS-'))
                .map(i => {
                    const match = i.serial.match(/^NS-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                });
            const maxNS = nsSerials.length > 0 ? Math.max(...nsSerials) : 0;
            const nextNum = String(maxNS + 1).padStart(3, '0');
            return `NS-${nextNum}`;
        }

        async function createInventorySheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: 'åœ¨åº«' }
                            }
                        }]
                    }
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A1:Q1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¥é ­è¾', 'ç™ºæ³¨ç•ªå·', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«æ¥é ­è¾', 'å‡ºåº«ç•ªå·', 'å–å¾—é‡‘(ç¨åˆ¥)', 'å‚™è€ƒ', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID']]
                    }
                });
            } catch (e) {
                console.log('ã‚·ãƒ¼ãƒˆä½œæˆã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢å­˜ã®å¯èƒ½æ€§ï¼‰:', e);
            }
        }

        async function createArchiveSheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–' }
                            }
                        }]
                    }
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A1:Q1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¥é ­è¾', 'ç™ºæ³¨ç•ªå·', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«æ¥é ­è¾', 'å‡ºåº«ç•ªå·', 'å–å¾—é‡‘(ç¨åˆ¥)', 'å‚™è€ƒ', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID']]
                    }
                });
            } catch (e) {
                console.log('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚·ãƒ¼ãƒˆä½œæˆã‚¹ã‚­ãƒƒãƒ—:', e);
            }
        }

        async function saveData() {
            try {
                showStatus('ä¿å­˜ä¸­...');
                
                // ä¿å­˜å‰ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç«¶åˆæ¤œçŸ¥ï¼‰
                try {
                    const checkResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A2:Q',
                    });
                    const currentRows = checkResponse.result.values || [];
                    const currentHash = JSON.stringify(currentRows);
                    
                    if (lastDataHash && currentHash !== lastDataHash) {
                        const confirmOverwrite = confirm('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ï¼‰');
                        if (!confirmOverwrite) {
                            await loadData();
                            return;
                        }
                    }
                } catch (e) {
                    console.log('ç«¶åˆãƒã‚§ãƒƒã‚¯ã‚¹ã‚­ãƒƒãƒ—:', e);
                }
                
                const inventoryData = [
                    ['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¥é ­è¾', 'ç™ºæ³¨ç•ªå·', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«æ¥é ­è¾', 'å‡ºåº«ç•ªå·', 'å–å¾—é‡‘(ç¨åˆ¥)', 'å‚™è€ƒ', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID'],
                    ...inventory.map(item => [
                        item.id,
                        item.serial,
                        item.category,
                        item.productName,
                        item.orderPrefix || '',
                        item.orderNumber || '',
                        item.orderDate,
                        item.receiveDate,
                        item.status,
                        item.shipDate,
                        item.shipPrefix || '',
                        item.shipNumber || '',
                        item.costJPY,
                        item.note,
                        item.shelfNo,
                        item.location,
                        item.supplierId || ''
                    ])
                ];
                
                // ã¾ãšã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ›¸ãè¾¼ã¿ï¼ˆå‰Šé™¤ã•ã‚ŒãŸè¡Œã‚‚åæ˜ ï¼‰
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A:Z'
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A1',
                    valueInputOption: 'RAW',
                    resource: { values: inventoryData }
                });

                // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä¿å­˜ï¼ˆèª­ã¿è¾¼ã¿å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
                if (archiveLoaded) {
                    const archiveData = [
                        ['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¥é ­è¾', 'ç™ºæ³¨ç•ªå·', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«æ¥é ­è¾', 'å‡ºåº«ç•ªå·', 'å–å¾—é‡‘(ç¨åˆ¥)', 'å‚™è€ƒ', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID'],
                        ...archivedInventory.map(item => [
                            item.id,
                            item.serial,
                            item.category,
                            item.productName,
                            item.orderPrefix || '',
                            item.orderNumber || '',
                            item.orderDate,
                            item.receiveDate,
                            item.status,
                            item.shipDate,
                            item.shipPrefix || '',
                            item.shipNumber || '',
                            item.costJPY,
                            item.note,
                            item.shelfNo,
                            item.location,
                            item.supplierId || ''
                        ])
                    ];
                    
                    // ã¾ãšã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ›¸ãè¾¼ã¿ï¼ˆå‰Šé™¤ã•ã‚ŒãŸè¡Œã‚‚åæ˜ ï¼‰
                    await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A:Z'
                    });
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A1',
                        valueInputOption: 'RAW',
                        resource: { values: archiveData }
                    });
                } else {
                    console.log('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æœªèª­ã¿è¾¼ã¿ã®ãŸã‚ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                }

                // ä¿å­˜å¾Œã«ãƒãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                lastSaveTime = Date.now();
                lastDataHash = JSON.stringify(inventory.map(item => [
                    item.id, item.serial, item.category, item.productName, 
                    item.orderPrefix, item.orderNumber, item.orderDate, item.receiveDate, 
                    item.status, item.shipDate, item.shipPrefix, item.shipNumber,
                    item.costJPY, item.note, item.shelfNo, item.location, item.supplierId
                ]));
                lastUpdated = new Date();

                showStatus('ä¿å­˜å®Œäº†');
                setTimeout(() => showStatus(''), 2000);
            } catch (err) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        function showStatus(message) {
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.textContent = message;
        }

        function getFilteredInventory() {
            const today = new Date().toISOString().split('T')[0];
            
            let result = inventory.filter(item => {
                if (currentFilters.category && item.category !== currentFilters.category) return false;
                if (currentFilters.status && item.status !== currentFilters.status) return false;
                if (currentFilters.shelfNo && item.shelfNo !== currentFilters.shelfNo) return false;
                
                // å…¥åº«æ—¥ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿
                if (currentFilters.receiveDateFrom && item.receiveDate < currentFilters.receiveDateFrom) return false;
                if (currentFilters.receiveDateTo && item.receiveDate > currentFilters.receiveDateTo) return false;
                
                // å‡ºåº«å…ˆæ¡ˆä»¶ãƒ•ã‚£ãƒ«ã‚¿
                const shipProjectFull = formatProjectNumber(item.shipPrefix, item.shipNumber);
                if (currentFilters.shipProject && !shipProjectFull.toLowerCase().includes(currentFilters.shipProject.toLowerCase())) return false;
                
                // åŸä¾¡å¸¯ãƒ•ã‚£ãƒ«ã‚¿
                if (currentFilters.costRange) {
                    const cost = Number(item.costJPY) || 0;
                    const [min, max] = currentFilters.costRange.split('-').map(v => v ? Number(v) : null);
                    if (min !== null && cost < min) return false;
                    if (max !== null && cost >= max) return false;
                }
                
                // ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿: æ£šæœªè¨­å®š
                if (currentFilters.noShelf && item.shelfNo) return false;
                
                // ä¿ç®¡å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿
                if (currentFilters.location && item.location !== currentFilters.location) return false;
                
                if (currentFilters.search) {
                    const search = currentFilters.search.toLowerCase();
                    const matchSerial = item.serial.toLowerCase().includes(search);
                    const matchProduct = item.productName.toLowerCase().includes(search);
                    const orderProjectFull = formatProjectNumber(item.orderPrefix, item.orderNumber);
                    const matchProject = orderProjectFull.toLowerCase().includes(search) || shipProjectFull.toLowerCase().includes(search);
                    // ç•ªå·ã®ã¿ã§æ¤œç´¢ã‚‚ãƒãƒƒãƒ
                    const matchNumber = (item.orderNumber && item.orderNumber.toString().includes(search)) || 
                                       (item.shipNumber && item.shipNumber.toString().includes(search));
                    if (!matchSerial && !matchProduct && !matchProject && !matchNumber) return false;
                }
                return true;
            });

            // ã‚½ãƒ¼ãƒˆ
            const sortValue = currentFilters.sort || 'project-asc';
            const parts = sortValue.split('-');
            const sortKey = parts[0];
            const sortOrder = parts[1] || 'desc';
            
            result.sort((a, b) => {
                let valA, valB;
                switch(sortKey) {
                    case 'orderDate':
                        valA = a.orderDate || '9999';
                        valB = b.orderDate || '9999';
                        return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    case 'serial':
                        valA = a.serial || '';
                        valB = b.serial || '';
                        return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    case 'project':
                        // ADå„ªå…ˆã€æ¬¡ã«SPã€ç•ªå·ã¯æ•°å€¤é †
                        const prefixA = (a.orderPrefix || 'AD').toUpperCase();
                        const prefixB = (b.orderPrefix || 'AD').toUpperCase();
                        const numA = parseInt(a.orderNumber) || 0;
                        const numB = parseInt(b.orderNumber) || 0;
                        
                        // ã¾ãšæ¥é ­è¾ã§æ¯”è¼ƒï¼ˆAD < SPï¼‰
                        if (prefixA !== prefixB) {
                            const prefixCompare = prefixA.localeCompare(prefixB);
                            return sortOrder === 'asc' ? prefixCompare : -prefixCompare;
                        }
                        // åŒã˜æ¥é ­è¾ãªã‚‰ç•ªå·ã§æ¯”è¼ƒ
                        const numCompare = numA - numB;
                        return sortOrder === 'asc' ? numCompare : -numCompare;
                    default:
                        valA = a.orderDate || '9999';
                        valB = b.orderDate || '9999';
                        return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
            });

            return result;
        }

        // æ¡ˆä»¶ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        function groupByProject(items) {
            const groups = {};
            items.forEach(item => {
                let project;
                if (groupMode === 'ship') {
                    // å‡ºåº«å…ˆã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆå‡ºåº«å…ˆãŒç©ºãªã‚‰ã€Œæœªå‡ºåº«ã€ï¼‰
                    project = formatProjectNumber(item.shipPrefix, item.shipNumber) || 'æœªå‡ºåº«';
                } else {
                    // ç™ºæ³¨æ¡ˆä»¶ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                    project = formatProjectNumber(item.orderPrefix, item.orderNumber) || 'æœªè¨­å®š';
                }
                if (!groups[project]) {
                    groups[project] = [];
                }
                groups[project].push(item);
            });
            return groups;
        }
        
        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function setGroupMode(mode) {
            groupMode = mode;
            expandedProjects = {}; // å±•é–‹çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            localStorage.setItem('inventoryExpandedProjects', JSON.stringify(expandedProjects));
            renderMain();
        }

        // æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«
        function toggleProject(project) {
            expandedProjects[project] = !expandedProjects[project];
            // localStorageã«ä¿å­˜
            localStorage.setItem('inventoryExpandedProjects', JSON.stringify(expandedProjects));
            renderMain();
        }

        function getSummary() {
            const inStockItems = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            const inStockValue = inStockItems.reduce((sum, i) => sum + (Number(i.costJPY) || 0), 0);
            const noShelfCount = inStockItems.filter(i => !i.shelfNo).length;
            const tokyoCount = inventory.filter(i => i.location === 'æ±äº¬' && i.status === 'åœ¨åº«ä¸­').length;
            const osakaCount = inventory.filter(i => i.location === 'å¤§é˜ª' && i.status === 'åœ¨åº«ä¸­').length;
            return {
                total: inventory.length,
                waiting: inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').length,
                pendingInspection: inventory.filter(i => i.status === 'æ¤œå“å¾…ã¡').length,
                inStock: inStockItems.length,
                inStockValue: inStockValue,
                shipped: inventory.filter(i => i.status === 'å‡ºåº«æ¸ˆ').length,
                defect: inventory.filter(i => i.status === 'ä¸è‰¯å“').length,
                noShelf: noShelfCount,
                tokyo: tokyoCount,
                osaka: osakaCount
            };
        }

        function getStatusClass(status) {
            switch(status) {
                case 'å…¥åº«å¾…ã¡': return 'bg-amber-100 text-amber-700';
                case 'æ¤œå“å¾…ã¡': return 'bg-orange-100 text-orange-700';
                case 'åœ¨åº«ä¸­': return 'bg-emerald-100 text-emerald-700';
                case 'å‡ºåº«æ¸ˆ': return 'bg-blue-100 text-blue-700';
                case 'ç¤¾å†…ä½¿ç”¨': return 'bg-purple-100 text-purple-700';
                case 'ä¸è‰¯å“': return 'bg-red-100 text-red-700';
                case 'å»ƒæ£„': return 'bg-slate-200 text-slate-600';
                default: return 'bg-slate-100 text-slate-700';
            }
        }
        
        // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼IDâ†’ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åå¤‰æ›
        function getSupplierName(supplierId) {
            if (!supplierId) return '-';
            const supplier = suppliers.find(s => s.id === parseInt(supplierId));
            return supplier ? supplier.name : '-';
        }
        
        // èª¿é”ç®¡ç†ç”»é¢ã¸ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆæ¡ˆä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
        function openProcurementForProject(projectNumber) {
            window.open(`index.html?project=${encodeURIComponent(projectNumber)}`, '_blank');
        }
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æ¡ˆä»¶ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectParam = urlParams.get('project');
            
            if (projectParam) {
                // ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«
                viewMode = 'group';
                groupMode = 'order';  // ç™ºæ³¨å…ƒã§ã‚°ãƒ«ãƒ¼ãƒ—
                
                // è©²å½“ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å±•é–‹
                expandedProjects[projectParam] = true;
                
                renderMain();
                
                // è©²å½“ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                setTimeout(() => {
                    const groupEl = document.getElementById('group-' + projectParam.replace(/[^a-zA-Z0-9]/g, '-'));
                    if (groupEl) {
                        groupEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        groupEl.classList.add('ring-2', 'ring-blue-500');
                        setTimeout(() => groupEl.classList.remove('ring-2', 'ring-blue-500'), 2000);
                    }
                }, 200);
                
                showStatus(`ã€Œ${projectParam}ã€ã‚’è¡¨ç¤ºä¸­`);
                setTimeout(() => showStatus(''), 2000);
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆå±¥æ­´ã‚’æ±šã•ãªã„ï¼‰
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // è¿½è·¡ãƒªãƒ³ã‚¯ç”Ÿæˆ
        function getTrackingLink(carrier, trackingNo) {
            if (!trackingNo) return '-';
            let url = '';
            switch(carrier) {
                case 'ãƒ¤ãƒãƒˆé‹è¼¸':
                    url = `https://jizen.kuronekoyamato.co.jp/jizen/servlet/crjz.b.NQ0010?id=${trackingNo}`;
                    break;
                case 'ä½å·æ€¥ä¾¿':
                    url = `https://k2k.sagawa-exp.co.jp/p/web/okurijosearch.do?okurijoNo=${trackingNo}`;
                    break;
                case 'è¥¿æ¿ƒé‹è¼¸':
                    url = `https://track.seino.co.jp/kamotsu/GempyoNoShoworiBin.do?gnpNo1=${trackingNo}`;
                    break;
                default:
                    return trackingNo;
            }
            return `<a href="${url}" target="_blank" class="text-blue-600 hover:underline">${trackingNo} ğŸ”—</a>`;
        }

        function renderMain() {
            const summary = getSummary();
            const filtered = getFilteredInventory();
            const lastUpdatedText = lastUpdated ? lastUpdated.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) : '-';
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-slate-100 dark:bg-slate-900 ${bulkSelectMode ? 'pb-20' : ''}">
                    <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm sticky top-0 z-40">
                        <div class="max-w-7xl mx-auto px-3 sm:px-6 py-3 sm:py-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">YSåœ¨åº«ãƒŠãƒ“</h1>
                                    <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">å…¥å‡ºåº«ãƒ»æ£šå¸ã—ç®¡ç†</p>
                                </div>
                                <div class="flex items-center gap-1 sm:gap-3">
                                    <span id="status" class="text-xs sm:text-sm text-blue-600 dark:text-blue-400 hidden sm:inline"></span>
                                    <button onclick="toggleDarkMode()" class="p-1.5 sm:p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
                                        ${isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                                    </button>
                                    <div class="relative">
                                        <button onclick="toggleReportMenu()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-purple-600 text-white text-xs sm:text-sm rounded-lg hover:bg-purple-700">
                                            <span class="hidden sm:inline">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆ</span>
                                            <span class="sm:hidden">ğŸ“Š</span>
                                        </button>
                                        <div id="reportMenu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg border dark:border-slate-700 z-50">
                                            <button onclick="exportCSV()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white rounded-t-lg">ğŸ“¥ CSVå‡ºåŠ›</button>
                                            <button onclick="printInventoryList()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white">ğŸ–¨ï¸ æ£šå¸ã—ãƒªã‚¹ãƒˆå°åˆ·</button>
                                            <button onclick="showMonthlyReport()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white">ğŸ“ˆ æœˆæ¬¡åœ¨åº«ãƒ¬ãƒãƒ¼ãƒˆ</button>
                                            <div class="border-t dark:border-slate-600"></div>
                                            <button onclick="showLabelPrintModal()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white">ğŸ·ï¸ QRãƒ©ãƒ™ãƒ«å°åˆ·</button>
                                            <div class="border-t dark:border-slate-600"></div>
                                            <button onclick="showImportToProcurementModal()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white">ğŸ“¤ èª¿é”ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                                            <div class="border-t dark:border-slate-600"></div>
                                            <button onclick="repairDuplicateIds()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 text-red-600 dark:text-red-400 rounded-b-lg">ğŸ”§ IDé‡è¤‡ã‚’ä¿®å¾©</button>
                                        </div>
                                    </div>
                                    <a href="index.html" class="p-1.5 sm:px-3 sm:py-2 border border-blue-600 text-blue-600 dark:text-blue-400 dark:border-blue-400 text-xs sm:text-sm rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/30" title="æ”¯æ‰•ãƒŠãƒ“">
                                        <span class="sm:hidden">ğŸ’´</span>
                                        <span class="hidden sm:inline">æ”¯æ‰•</span>
                                    </a>
                                    <a href="inspection.html" class="p-1.5 sm:px-3 sm:py-2 border border-green-600 text-green-600 dark:text-green-400 dark:border-green-400 text-xs sm:text-sm rounded-lg hover:bg-green-50 dark:hover:bg-green-900/30" title="æ¤œå“ãƒŠãƒ“">
                                        <span class="sm:hidden">âœ“</span>
                                        <span class="hidden sm:inline">æ¤œå“</span>
                                    </a>
                                    <button onclick="toggleBulkSelectMode()" class="px-2 sm:px-3 py-1.5 sm:py-2 ${bulkSelectMode ? 'bg-amber-500' : 'bg-slate-500'} text-white text-xs sm:text-sm rounded-lg hover:opacity-90">
                                        <span class="hidden sm:inline">${bulkSelectMode ? 'é¸æŠä¸­' : 'ä¸€æ‹¬'}</span>
                                        <span class="sm:hidden">â˜‘</span>
                                    </button>
                                    <button onclick="showAddInventoryModal()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700">+ è¿½åŠ </button>
                                    <button onclick="handleSignoutClick()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-600 text-white text-xs sm:text-sm rounded-lg hover:bg-slate-700">
                                        <span class="hidden sm:inline">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</span>
                                        <span class="sm:hidden">â†ª</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mt-2 text-xs text-slate-500 dark:text-slate-400">
                                <div class="flex items-center gap-3">
                                    <span class="flex items-center gap-1">
                                        <span id="connectionIndicator" class="w-2 h-2 rounded-full bg-green-400" title="æ¥ç¶šä¸­"></span>
                                        æœ€çµ‚æ›´æ–°: ${lastUpdatedText}
                                    </span>
                                    <button onclick="toggleAutoReload()" class="flex items-center gap-1 px-2 py-0.5 rounded ${autoReloadEnabled ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-400' : 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-400'}" title="${autoReloadEnabled ? 'è‡ªå‹•åŒæœŸON (60ç§’)' : 'è‡ªå‹•åŒæœŸOFF'}">
                                        <span class="${autoReloadEnabled ? 'animate-pulse' : ''}">ğŸ”„</span>
                                        <span class="hidden sm:inline">${autoReloadEnabled ? 'è‡ªå‹•åŒæœŸON' : 'è‡ªå‹•åŒæœŸOFF'}</span>
                                    </button>
                                </div>
                                <button onclick="loadData()" class="flex items-center gap-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-400 rounded hover:bg-blue-200 dark:hover:bg-blue-900/70">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    ä»Šã™ãæ›´æ–°
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <main class="max-w-7xl mx-auto px-3 sm:px-6 py-4 sm:py-8">
                        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
                        ${(summary.noShelf > 0 || summary.waiting > 0 || summary.pendingInspection > 0 || summary.defect > 0) ? `
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${summary.noShelf > 0 ? `
                                    <button onclick="quickFilter('noShelf')" class="flex items-center gap-1 px-3 py-1.5 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 text-xs sm:text-sm rounded-lg hover:bg-amber-200 dark:hover:bg-amber-900/70 border border-amber-300 dark:border-amber-700">
                                        âš ï¸ æ£šæœªè¨­å®š ${summary.noShelf}ä»¶
                                    </button>
                                ` : ''}
                                ${summary.waiting > 0 ? `
                                    <span class="flex items-center gap-1 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs sm:text-sm rounded-lg border border-blue-300 dark:border-blue-700">
                                        ğŸ“¦ å…¥åº«å¾…ã¡ ${summary.waiting}ä»¶
                                    </span>
                                ` : ''}
                                ${summary.pendingInspection > 0 ? `
                                    <a href="inspection.html" class="flex items-center gap-1 px-3 py-1.5 bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300 text-xs sm:text-sm rounded-lg border border-orange-300 dark:border-orange-700 hover:bg-orange-200 dark:hover:bg-orange-900/70">
                                        ğŸ” æ¤œå“å¾…ã¡ ${summary.pendingInspection}ä»¶
                                    </a>
                                ` : ''}
                                ${summary.defect > 0 ? `
                                    <span class="flex items-center gap-1 px-3 py-1.5 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 text-xs sm:text-sm rounded-lg border border-red-300 dark:border-red-700">
                                        ğŸ”´ ä¸è‰¯å“ ${summary.defect}ä»¶
                                    </span>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- ã‚µãƒãƒªãƒ¼ -->
                        <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-4 mb-4 sm:mb-6">
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border-l-4 border-emerald-500">
                                <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">åœ¨åº«ä¸­</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">${summary.inStock}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border-l-4 border-amber-500">
                                <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">å…¥åº«å¾…</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">${summary.waiting}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border-l-4 border-orange-500">
                                <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">æ¤œå“å¾…</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">${summary.pendingInspection}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border-l-4 border-blue-500 hidden sm:block">
                                <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">å‡ºåº«æ¸ˆ</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">${summary.shipped}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border-l-4 border-red-500 hidden sm:block">
                                <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">ä¸è‰¯å“</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">${summary.defect}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border-l-4 border-slate-400 hidden sm:block">
                                <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">ç·åœ¨åº«</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">${summary.total}</p>
                            </div>
                        </div>

                        <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿ -->
                        <div class="flex flex-wrap items-center gap-2 mb-3 sm:mb-4">
                            <span class="text-slate-400" title="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ">âš¡</span>
                            <button onclick="quickFilter('multi')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.category === 'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤' ? 'bg-slate-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'}">
                                ãƒãƒ«ãƒ
                            </button>
                            <button onclick="quickFilter('blackboard')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.category === 'STUDIA' ? 'bg-slate-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'}">
                                STUDIA
                            </button>
                            <button onclick="quickFilter('outdoor')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.category === 'å±‹å¤–' ? 'bg-slate-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'}">
                                å±‹å¤–
                            </button>
                            <button onclick="quickFilter('tokyo')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.location === 'æ±äº¬' ? 'bg-slate-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'}">
                                æ±äº¬
                            </button>
                            <button onclick="quickFilter('osaka')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.location === 'å¤§é˜ª' ? 'bg-slate-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'}">
                                å¤§é˜ª
                            </button>
                        </div>

                        <!-- åŸºæœ¬ãƒ•ã‚£ãƒ«ã‚¿ -->
                        <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-sm border dark:border-slate-700 mb-4 sm:mb-6">
                            <div class="flex flex-wrap gap-2 sm:gap-4 items-end">
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 block mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                    <select id="filterStatus" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                        <option value="">ã™ã¹ã¦</option>
                                        ${STATUSES.map(s => `<option value="${s}" ${currentFilters.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/3 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 block mb-1">ç¨®åˆ¥</label>
                                    <select id="filterCategory" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                        <option value="">ã™ã¹ã¦</option>
                                        ${CATEGORIES.map(c => `<option value="${c}" ${currentFilters.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/3 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 block mb-1">ä¸¦ã³æ›¿ãˆ</label>
                                    <select id="filterSort" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                        <option value="project-asc" ${!currentFilters.sort || currentFilters.sort === 'project-asc' ? 'selected' : ''}>æ¡ˆä»¶é †</option>
                                        <option value="orderDate-desc" ${currentFilters.sort === 'orderDate-desc' ? 'selected' : ''}>æ–°ã—ã„é †</option>
                                        <option value="orderDate-asc" ${currentFilters.sort === 'orderDate-asc' ? 'selected' : ''}>å¤ã„é †</option>
                                        <option value="serial-asc" ${currentFilters.sort === 'serial-asc' ? 'selected' : ''}>Serialé †</option>
                                    </select>
                                </div>
                                <button onclick="clearFilters()" class="px-3 py-1.5 sm:py-2 bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-white text-sm rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500">ã‚¯ãƒªã‚¢</button>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <input type="text" id="filterSearch" value="${currentFilters.search}" onkeydown="if(event.key==='Enter'){applyFilters();event.target.blur();}" placeholder="Serial/è£½å“å/æ¡ˆä»¶ç•ªå·ã§æ¤œç´¢" class="flex-1 px-3 py-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 rounded-lg">
                                <button onclick="applyFilters()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">æ¤œç´¢</button>
                            </div>
                            
                            <!-- è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå€‰åº«æ‹…å½“è€…å‘ã‘ï¼‰ -->
                            <div class="mt-3 border-t dark:border-slate-600 pt-3">
                                <button onclick="toggleDetailFilters()" class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 flex items-center gap-1">
                                    <span>${showDetailFilters ? 'â–¼' : 'â–¶'}</span>
                                    <span>è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå€‰åº«æ‹…å½“è€…å‘ã‘ï¼‰</span>
                                </button>
                                ${showDetailFilters ? `
                                    <div class="mt-3 grid grid-cols-2 sm:grid-cols-5 gap-3">
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">æ£šç•ª</label>
                                            <select id="filterShelfNo" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                                <option value="">ã™ã¹ã¦</option>
                                                ${SHELF_NUMBERS.map(n => `<option value="${n}" ${currentFilters.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">å…¥åº«æ—¥ï¼ˆé–‹å§‹ï¼‰</label>
                                            <input type="date" id="filterReceiveDateFrom" value="${currentFilters.receiveDateFrom}" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">å…¥åº«æ—¥ï¼ˆçµ‚äº†ï¼‰</label>
                                            <input type="date" id="filterReceiveDateTo" value="${currentFilters.receiveDateTo}" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">å‡ºåº«å…ˆæ¡ˆä»¶</label>
                                            <input type="text" id="filterShipProject" value="${currentFilters.shipProject}" onchange="applyFilters()" placeholder="AD-1700" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">åŸä¾¡å¸¯</label>
                                            <select id="filterCostRange" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                                ${COST_RANGES.map(r => `<option value="${r.value}" ${currentFilters.costRange === r.value ? 'selected' : ''}>${r.label}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        <button onclick="quickFilter('noShelf')" class="px-3 py-1.5 text-xs sm:text-sm rounded-lg border ${currentFilters.noShelf ? 'bg-amber-600 text-white border-amber-600' : 'bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-300 border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600'}">
                                            âš ï¸ æ£šæœªè¨­å®šã®ã¿
                                        </button>
                                    </div>
                                    <!-- åœ¨åº«ç·é¡ï¼ˆæ£šå¸ã—ç”¨ï¼‰ -->
                                    <div class="mt-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg p-3 border border-blue-200 dark:border-blue-700 flex justify-between items-center">
                                        <div>
                                            <p class="text-blue-700 dark:text-blue-300 text-xs sm:text-sm">åœ¨åº«ç·é¡ï¼ˆæ£šå¸ã—ç”¨ï¼‰</p>
                                            <p class="text-lg sm:text-xl font-bold text-blue-700 dark:text-blue-300">Â¥${summary.inStockValue.toLocaleString()}</p>
                                        </div>
                                        <p class="text-xs sm:text-sm text-blue-600 dark:text-blue-400">${summary.inStock}ä»¶</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- åœ¨åº«ãƒªã‚¹ãƒˆ -->
                        <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl shadow-sm border dark:border-slate-700 overflow-hidden">
                            <div class="p-3 sm:p-4 border-b dark:border-slate-700 bg-slate-50 dark:bg-slate-700/50 flex flex-wrap justify-between items-center gap-2">
                                <div class="flex items-center gap-2 sm:gap-3 flex-wrap">
                                    <h2 class="font-bold text-sm sm:text-base text-slate-900 dark:text-white">åœ¨åº«ä¸€è¦§ï¼ˆ${filtered.length}ä»¶ï¼‰</h2>
                                    <div class="flex rounded-lg overflow-hidden border dark:border-slate-600">
                                        <button onclick="setViewMode('group')" class="px-2 py-1 text-xs ${(hasActiveFilters() ? 'flat' : viewMode) === 'group' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600'}">
                                            ã‚°ãƒ«ãƒ¼ãƒ—
                                        </button>
                                        <button onclick="setViewMode('flat')" class="px-2 py-1 text-xs ${(hasActiveFilters() ? 'flat' : viewMode) === 'flat' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600'}">
                                            ä¸€è¦§
                                        </button>
                                    </div>
                                    ${(!hasActiveFilters() && viewMode === 'group') ? `
                                        <div class="flex rounded-lg overflow-hidden border dark:border-slate-600">
                                            <button onclick="setGroupMode('order')" class="px-2 py-1 text-xs ${groupMode === 'order' ? 'bg-slate-600 text-white' : 'bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600'}">
                                                ç™ºæ³¨å…ƒ
                                            </button>
                                            <button onclick="setGroupMode('ship')" class="px-2 py-1 text-xs ${groupMode === 'ship' ? 'bg-slate-600 text-white' : 'bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600'}">
                                                å‡ºåº«å…ˆ
                                            </button>
                                        </div>
                                    ` : ''}
                                    ${hasActiveFilters() ? '<span class="text-xs text-slate-400">ãƒ•ã‚£ãƒ«ã‚¿ä¸­</span>' : ''}
                                </div>
                                <button onclick="showArchiveModal()" class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
                            </div>
                            
                            <!-- åœ¨åº«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                            <div>
                                ${filtered.length === 0 ? `
                                    <div class="px-4 py-8 text-center text-slate-500 dark:text-slate-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                                ` : (hasActiveFilters() || viewMode === 'flat') ? `
                                    <!-- ãƒ•ãƒ©ãƒƒãƒˆè¡¨ç¤ºï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ -->
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-slate-100 dark:bg-slate-700">
                                                <tr>
                                                    ${bulkSelectMode ? '<th class="px-2 py-2 text-center w-8"><input type="checkbox" onclick="toggleSelectAllFlat()" class="w-4 h-4 rounded"></th>' : ''}
                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">Serial</th>
                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</th>
                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">æ¡ˆä»¶</th>
                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">ç¨®åˆ¥</th>
                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">è£½å“å</th>
                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 hidden md:table-cell">å‚™è€ƒ</th>
                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700 dark:text-slate-300">æ£šç•ª</th>
                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700 dark:text-slate-300">å ´æ‰€</th>
                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">å…¥åº«æ—¥</th>
                                                    <th class="px-3 py-2 text-right text-xs font-semibold text-slate-700 dark:text-slate-300">åŸä¾¡</th>
                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700 dark:text-slate-300">æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y dark:divide-slate-700">
                                                ${filtered.map(item => `
                                                    <tr onclick="showDetailModal('${item.id}')" class="hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer ${selectedItems.has(item.id) ? 'bg-amber-50 dark:bg-amber-900/30' : ''}">
                                                        ${bulkSelectMode ? `<td class="px-2 py-2 text-center" onclick="event.stopPropagation()"><input type="checkbox" ${selectedItems.has(item.id) ? 'checked' : ''} onclick="toggleSelectItem('${item.id}')" class="w-4 h-4 rounded"></td>` : ''}
                                                        <td class="px-3 py-2 font-mono font-semibold text-sm text-slate-900 dark:text-white">${item.serial || "-"}</td>
                                                        <td class="px-3 py-2 text-xs text-slate-600 dark:text-slate-400">${getSupplierName(item.supplierId)}</td>
                                                        <td class="px-3 py-2 text-xs text-blue-600 dark:text-blue-400 font-semibold">${formatProjectNumber(item.orderPrefix, item.orderNumber) ? `<a href="#" onclick="event.stopPropagation();openProcurementForProject('${formatProjectNumber(item.orderPrefix, item.orderNumber)}');return false;" class="hover:underline" title="èª¿é”ç®¡ç†ã§é–‹ã">${formatProjectNumber(item.orderPrefix, item.orderNumber)}</a>` : '-'}</td>
                                                        <td class="px-3 py-2 text-xs text-slate-600 dark:text-slate-400">${item.category}</td>
                                                        <td class="px-3 py-2 text-xs dark:text-slate-300">${item.productName}</td>
                                                        <td class="px-3 py-2 text-xs text-slate-500 dark:text-slate-400 hidden md:table-cell max-w-32 truncate" title="${item.note || ''}">${item.note || '-'}</td>
                                                        <td class="px-3 py-2 text-center text-xs font-semibold text-purple-600 dark:text-purple-400">${item.shelfNo || '-'}</td>
                                                        <td class="px-3 py-2 text-center">
                                                            ${item.location === 'æ±äº¬' ? '<span class="text-xs text-slate-500 dark:text-slate-400">æ±äº¬</span>' : ''}
                                                            ${item.location === 'å¤§é˜ª' ? '<span class="text-xs text-slate-500 dark:text-slate-400">å¤§é˜ª</span>' : ''}
                                                            ${!item.location ? '-' : ''}
                                                        </td>
                                                        <td class="px-3 py-2 text-xs text-slate-600 dark:text-slate-400">${item.receiveDate || '-'}</td>
                                                        <td class="px-3 py-2 text-xs text-right font-semibold dark:text-white">${item.costJPY ? 'Â¥' + Number(item.costJPY).toLocaleString() : '-'}</td>
                                                        <td class="px-3 py-2">
                                                            <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                        </td>
                                                        <td class="px-3 py-2 text-center" onclick="event.stopPropagation()">
                                                            <div class="flex gap-1 justify-center">
                                                                ${item.status === 'å…¥åº«å¾…ã¡' ? `<button onclick="showReceiveModal('${item.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å…¥åº«</button>` : ''}
                                                                ${item.status === 'åœ¨åº«ä¸­' ? `<button onclick="showShipModal('${item.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å‡ºåº«</button><button onclick="showInternalUseModal('${item.id}')" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">ç¤¾å†…</button>` : ''}
                                                                ${item.status === 'ä¸è‰¯å“' ? `<button onclick="showDisposeModal('${item.id}')" class="px-2 py-1 bg-slate-400 text-white text-xs rounded hover:bg-slate-500">å»ƒæ£„</button>` : ''}
                                                                <button onclick="editItem('${item.id}')" class="px-2 py-1 bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-white text-xs rounded hover:bg-slate-300 dark:hover:bg-slate-500">ç·¨é›†</button>
                                                                ${item.status === 'å‡ºåº«æ¸ˆ' || item.status === 'ç¤¾å†…ä½¿ç”¨' || item.status === 'å»ƒæ£„' ? `<button onclick="archiveItem('${item.id}')" class="px-2 py-1 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">ä¿ç®¡</button>` : ''}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : (() => {
                                    // ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤º
                                    const groups = groupByProject(filtered);
                                    return Object.keys(groups).map(project => {
                                        const items = groups[project];
                                        const isExpanded = expandedProjects[project];
                                        const statusCounts = {
                                            waiting: items.filter(i => i.status === 'å…¥åº«å¾…ã¡').length,
                                            inStock: items.filter(i => i.status === 'åœ¨åº«ä¸­').length,
                                            shipped: items.filter(i => i.status === 'å‡ºåº«æ¸ˆ').length,
                                            internal: items.filter(i => i.status === 'ç¤¾å†…ä½¿ç”¨').length,
                                            issue: items.filter(i => i.status === 'ä¸è‰¯å“').length,
                                            disposed: items.filter(i => i.status === 'å»ƒæ£„').length
                                        };
                                        const folderUrl = folderCache[project] || null;
                                        // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å‚™è€ƒã‚’å–å¾—ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚‚ã®ï¼‰
                                        const groupNotes = [...new Set(items.map(i => i.note).filter(n => n && n.trim()))];
                                        const groupNoteDisplay = groupNotes.length > 0 ? groupNotes[0] : '';
                                        const hasMoreNotes = groupNotes.length > 1;
                                        return `
                                            <div id="group-${project.replace(/[^a-zA-Z0-9]/g, '-')}" class="border-b dark:border-slate-700 last:border-b-0">
                                                <div onclick="toggleProject('${project}')" class="p-3 sm:p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 active:bg-slate-100 dark:active:bg-slate-600">
                                                    <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                                        <span class="text-slate-400 flex-shrink-0">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                                                        <span class="font-semibold text-blue-600 dark:text-blue-400 text-sm sm:text-base flex-shrink-0">${project}</span>
                                                        <span class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 flex-shrink-0">(${items.length}ä»¶)</span>
                                                        ${folderUrl ? `
                                                            <a href="${folderUrl}" target="_blank" onclick="event.stopPropagation()" class="text-blue-500 hover:text-blue-700 flex-shrink-0" title="Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‚’é–‹ã">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                                                            </a>
                                                        ` : (project !== 'æœªè¨­å®š' ? `
                                                            <span class="text-slate-300 dark:text-slate-600 flex-shrink-0" title="ãƒ•ã‚©ãƒ«ãƒ€æœªæ¤œå‡º">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                                                            </span>
                                                        ` : '')}
                                                        ${groupNoteDisplay ? `
                                                            <span class="text-xs text-slate-500 dark:text-slate-400 truncate max-w-[200px] sm:max-w-[300px] hidden sm:inline" title="${groupNotes.join(' / ')}">
                                                                ğŸ“ ${groupNoteDisplay}${hasMoreNotes ? '...' : ''}
                                                            </span>
                                                        ` : ''}
                                                    </div>
                                                    <div class="flex gap-1 sm:gap-2 flex-shrink-0">
                                                        ${statusCounts.waiting > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300">å¾…${statusCounts.waiting}</span>` : ''}
                                                        ${statusCounts.inStock > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300">åº«${statusCounts.inStock}</span>` : ''}
                                                        ${statusCounts.shipped > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300">å‡º${statusCounts.shipped}</span>` : ''}
                                                        ${statusCounts.internal > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300">ç¤¾${statusCounts.internal}</span>` : ''}
                                                        ${statusCounts.issue > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300">ä¸${statusCounts.issue}</span>` : ''}
                                                        ${statusCounts.disposed > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300">å»ƒ${statusCounts.disposed}</span>` : ''}
                                                    </div>
                                                </div>
                                                ${isExpanded ? `
                                                    <!-- PC: ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º -->
                                                    <div class="hidden md:block bg-slate-50 dark:bg-slate-700/30 border-t dark:border-slate-700">
                                                        <table class="w-full">
                                                            <thead class="bg-slate-100 dark:bg-slate-700">
                                                                <tr>
                                                                    ${bulkSelectMode ? `<th class="px-2 py-2 text-center w-8"><input type="checkbox" onclick="toggleSelectAll('${project}')" class="w-4 h-4 rounded"></th>` : ''}
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">Serial</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">ç¨®åˆ¥</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">è£½å“å</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">å‚™è€ƒ</th>
                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700 dark:text-slate-300">æ£šç•ª</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">å…¥åº«æ—¥</th>
                                                                    <th class="px-3 py-2 text-right text-xs font-semibold text-slate-700 dark:text-slate-300">åŸä¾¡(ç¨åˆ¥)</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">${groupMode === 'ship' ? 'ç™ºæ³¨å…ƒ' : 'å‡ºåº«å…ˆ'}</th>
                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700 dark:text-slate-300">æ“ä½œ</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="divide-y dark:divide-slate-700 bg-white dark:bg-slate-800">
                                                                ${items.map(item => `
                                                                    <tr onclick="showDetailModal('${item.id}')" class="hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer ${selectedItems.has(item.id) ? 'bg-amber-50 dark:bg-amber-900/30' : ''}">
                                                                        ${bulkSelectMode ? `<td class="px-2 py-2 text-center" onclick="event.stopPropagation()"><input type="checkbox" ${selectedItems.has(item.id) ? 'checked' : ''} onclick="toggleSelectItem('${item.id}')" class="w-4 h-4 rounded"></td>` : ''}
                                                                        <td class="px-3 py-2 font-mono font-semibold text-sm text-slate-900 dark:text-white">${item.serial || "-"}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600 dark:text-slate-400">${getSupplierName(item.supplierId)}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600 dark:text-slate-400">${item.category}</td>
                                                                        <td class="px-3 py-2 text-xs dark:text-slate-300">${item.productName}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-500 dark:text-slate-400 max-w-32 truncate" title="${item.note || ''}">${item.note || '-'}</td>
                                                                        <td class="px-3 py-2 text-center text-xs font-semibold text-purple-600 dark:text-purple-400">${item.shelfNo || '-'}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600 dark:text-slate-400">${item.receiveDate || '-'}</td>
                                                                        <td class="px-3 py-2 text-xs text-right font-semibold dark:text-white">${item.costJPY ? 'Â¥' + Number(item.costJPY).toLocaleString() : '-'}</td>
                                                                        <td class="px-3 py-2">
                                                                            <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                                            ${item.location === 'æ±äº¬' ? '<span class="ml-1 text-xs text-slate-500">æ±äº¬</span>' : ''}
                                                                            ${item.location === 'å¤§é˜ª' ? '<span class="ml-1 text-xs text-slate-500">å¤§é˜ª</span>' : ''}
                                                                        </td>
                                                                        <td class="px-3 py-2 text-xs font-semibold text-blue-600 dark:text-blue-400">${groupMode === 'ship' ? (formatProjectNumber(item.orderPrefix, item.orderNumber) ? `<a href="#" onclick="event.stopPropagation();openProcurementForProject('${formatProjectNumber(item.orderPrefix, item.orderNumber)}');return false;" class="hover:underline" title="èª¿é”ç®¡ç†ã§é–‹ã">${formatProjectNumber(item.orderPrefix, item.orderNumber)}</a>` : '-') : (formatProjectNumber(item.shipPrefix, item.shipNumber) || '-')}</td>
                                                                        <td class="px-3 py-2 text-center" onclick="event.stopPropagation()">
                                                                            <div class="flex gap-1 justify-center">
                                                                                ${item.status === 'å…¥åº«å¾…ã¡' ? `
                                                                                    <button onclick="showReceiveModal('${item.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å…¥åº«</button>
                                                                                ` : ''}
                                                                                ${item.status === 'åœ¨åº«ä¸­' ? `
                                                                                    <button onclick="showShipModal('${item.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å‡ºåº«</button>
                                                                                    <button onclick="showInternalUseModal('${item.id}')" class="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">ç¤¾å†…</button>
                                                                                ` : ''}
                                                                                ${item.status === 'ä¸è‰¯å“' ? `
                                                                                    <button onclick="showDisposeModal('${item.id}')" class="px-2 py-1 bg-slate-400 text-white text-xs rounded hover:bg-slate-500">å»ƒæ£„</button>
                                                                                ` : ''}
                                                                                <button onclick="editItem('${item.id}')" class="px-2 py-1 bg-slate-200 text-slate-700 text-xs rounded hover:bg-slate-300">ç·¨é›†</button>
                                                                                ${item.status === 'å‡ºåº«æ¸ˆ' || item.status === 'ç¤¾å†…ä½¿ç”¨' || item.status === 'å»ƒæ£„' ? `
                                                                                    <button onclick="archiveItem('${item.id}')" class="px-2 py-1 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">ä¿ç®¡</button>
                                                                                ` : ''}
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <!-- ã‚¹ãƒãƒ›: ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
                                                    <div class="md:hidden bg-slate-50 dark:bg-slate-700/30">
                                                        ${items.map(item => `
                                                            <div onclick="showDetailModal('${item.id}')" class="p-3 border-t border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 ${selectedItems.has(item.id) ? 'bg-amber-50 dark:bg-amber-900/30' : ''}">
                                                                <div class="flex justify-between items-start mb-2">
                                                                    <div class="flex items-center gap-2">
                                                                        ${bulkSelectMode ? `<input type="checkbox" ${selectedItems.has(item.id) ? 'checked' : ''} onclick="event.stopPropagation();toggleSelectItem('${item.id}')" class="w-4 h-4 rounded">` : ''}
                                                                        <div>
                                                                            <p class="font-mono font-bold text-sm text-slate-900 dark:text-white">${item.serial || "-"}</p>
                                                                            <p class="text-xs text-slate-500 dark:text-slate-400">${item.category}</p>
                                                                        </div>
                                                                    </div>
                                                                    <div class="flex items-center gap-1">
                                                                        ${item.shelfNo ? `<span class="px-1.5 py-0.5 rounded text-xs font-semibold bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300">æ£š${item.shelfNo}</span>` : ''}
                                                                        ${item.location === 'æ±äº¬' ? '<span class="text-xs text-slate-500 dark:text-slate-400">æ±äº¬</span>' : ''}
                                                                        ${item.location === 'å¤§é˜ª' ? '<span class="text-xs text-slate-500 dark:text-slate-400">å¤§é˜ª</span>' : ''}
                                                                        <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-xs text-slate-800 dark:text-slate-300 mb-1">${item.productName}</p>
                                                                <div class="flex justify-between items-center text-xs text-slate-500 dark:text-slate-400 mb-2">
                                                                    <span>å…¥åº«: ${item.receiveDate || '-'}</span>
                                                                    <span>åŸä¾¡: ${item.costJPY ? 'Â¥' + Number(item.costJPY).toLocaleString() : '-'}</span>
                                                                </div>
                                                                <div class="flex gap-2" onclick="event.stopPropagation()">
                                                                    ${item.status === 'å…¥åº«å¾…ã¡' ? `
                                                                        <button onclick="showReceiveModal('${item.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å…¥åº«</button>
                                                                    ` : ''}
                                                                    ${item.status === 'åœ¨åº«ä¸­' ? `
                                                                        <button onclick="showShipModal('${item.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å‡ºåº«</button>
                                                                        <button onclick="showInternalUseModal('${item.id}')" class="px-3 py-1.5 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">ç¤¾å†…</button>
                                                                    ` : ''}
                                                                    ${item.status === 'ä¸è‰¯å“' ? `
                                                                        <button onclick="showDisposeModal('${item.id}')" class="px-3 py-1.5 bg-slate-400 text-white text-xs rounded hover:bg-slate-500">å»ƒæ£„</button>
                                                                    ` : ''}
                                                                    <button onclick="editItem('${item.id}')" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-white text-xs rounded hover:bg-slate-300 dark:hover:bg-slate-500">ç·¨é›†</button>
                                                                    ${item.status === 'å‡ºåº«æ¸ˆ' || item.status === 'ç¤¾å†…ä½¿ç”¨' || item.status === 'å»ƒæ£„' ? `
                                                                        <button onclick="archiveItem('${item.id}')" class="px-3 py-1.5 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">ä¿ç®¡</button>
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                            </div>
                        </div>
                    </main>
                </div>
                
                <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ -->
                ${!bulkSelectMode ? `
                    <button onclick="openQRScanner()" class="fixed bottom-6 right-6 z-40 w-16 h-16 rounded-full shadow-xl active:scale-95 transition-transform flex items-center justify-center" style="background: linear-gradient(135deg, #2383e2 0%, #1a5fb4 100%);">
                        <svg class="w-8 h-8" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9V6a3 3 0 013-3h3M3 15v3a3 3 0 003 3h3m6-18h3a3 3 0 013 3v3m0 6v3a3 3 0 01-3 3h-3M9 12h6m-3-3v6"/>
                        </svg>
                    </button>
                ` : ''}
                
                ${bulkSelectMode && selectedItems.size > 0 ? `
                    <div class="fixed bottom-0 left-0 right-0 bg-amber-500 text-white p-3 shadow-lg z-50">
                        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-2">
                            <span class="font-semibold text-sm">${selectedItems.size}ä»¶é¸æŠä¸­</span>
                            <div class="flex flex-wrap gap-2">
                                <!-- PC: å…¨ãƒœã‚¿ãƒ³è¡¨ç¤º -->
                                <button onclick="showBulkProjectModal()" class="hidden sm:block px-3 py-1.5 bg-indigo-600 text-white text-xs sm:text-sm rounded hover:bg-indigo-700">æ¡ˆä»¶å¤‰æ›´</button>
                                <button onclick="showBulkSupplierModal()" class="hidden sm:block px-3 py-1.5 bg-orange-600 text-white text-xs sm:text-sm rounded hover:bg-orange-700">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</button>
                                <button onclick="showBulkShelfModal()" class="hidden sm:block px-3 py-1.5 bg-purple-600 text-white text-xs sm:text-sm rounded hover:bg-purple-700">æ£šç•ªå¤‰æ›´</button>
                                <button onclick="showBulkLocationModal()" class="hidden sm:block px-3 py-1.5 bg-teal-600 text-white text-xs sm:text-sm rounded hover:bg-teal-700">å ´æ‰€å¤‰æ›´</button>
                                <button onclick="showBulkEditModal()" class="px-3 py-1.5 bg-cyan-600 text-white text-xs sm:text-sm rounded hover:bg-cyan-700">ç·¨é›†</button>
                                <button onclick="bulkReceive()" class="px-3 py-1.5 bg-blue-600 text-white text-xs sm:text-sm rounded hover:bg-blue-700">å…¥åº«</button>
                                <button onclick="showBulkShipModal()" class="px-3 py-1.5 bg-blue-600 text-white text-xs sm:text-sm rounded hover:bg-blue-700">å‡ºåº«</button>
                                <button onclick="bulkDelete()" class="hidden sm:block px-3 py-1.5 bg-red-600 text-white text-xs sm:text-sm rounded hover:bg-red-700">ä¸€æ‹¬å‰Šé™¤</button>
                                <button onclick="bulkArchive()" class="hidden sm:block px-3 py-1.5 bg-slate-700 text-white text-xs sm:text-sm rounded hover:bg-slate-800">ä¸€æ‹¬ä¿ç®¡</button>
                                
                                <!-- ã‚¹ãƒãƒ›: ãã®ä»–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                                <div class="relative sm:hidden">
                                    <button onclick="toggleBulkMoreMenu()" class="px-3 py-1.5 bg-slate-700 text-white text-xs rounded hover:bg-slate-800">ãã®ä»– â–¼</button>
                                    <div id="bulkMoreMenu" class="hidden absolute bottom-full right-0 mb-2 w-36 bg-white dark:bg-slate-800 rounded-lg shadow-lg border dark:border-slate-700 overflow-hidden">
                                        <button onclick="showBulkProjectModal();closeBulkMoreMenu()" class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-700">æ¡ˆä»¶å¤‰æ›´</button>
                                        <button onclick="showBulkSupplierModal();closeBulkMoreMenu()" class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-700">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</button>
                                        <button onclick="showBulkShelfModal();closeBulkMoreMenu()" class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-700">æ£šç•ªå¤‰æ›´</button>
                                        <button onclick="showBulkLocationModal();closeBulkMoreMenu()" class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-700">å ´æ‰€å¤‰æ›´</button>
                                        <div class="border-t dark:border-slate-600"></div>
                                        <button onclick="bulkDelete();closeBulkMoreMenu()" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-slate-100 dark:hover:bg-slate-700">å‰Šé™¤</button>
                                        <button onclick="bulkArchive();closeBulkMoreMenu()" class="w-full px-4 py-2 text-left text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700">ä¿ç®¡</button>
                                    </div>
                                </div>
                                
                                <button onclick="cancelBulkSelect()" class="px-3 py-1.5 bg-slate-600 text-white text-xs sm:text-sm rounded hover:bg-slate-700">Ã—</button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // ä¸€æ‹¬é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function toggleBulkSelectMode() {
            bulkSelectMode = !bulkSelectMode;
            if (!bulkSelectMode) {
                selectedItems.clear();
            }
            renderMain();
        }

        // ã‚¢ã‚¤ãƒ†ãƒ é¸æŠåˆ‡æ›¿
        function toggleSelectItem(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            renderMain();
        }

        // æ¡ˆä»¶å†…å…¨é¸æŠ
        function toggleSelectAll(project) {
            const filtered = getFilteredInventory();
            const projectItems = filtered.filter(i => (formatProjectNumber(i.orderPrefix, i.orderNumber) || 'æœªè¨­å®š') === project);
            const allSelected = projectItems.every(i => selectedItems.has(i.id));
            
            if (allSelected) {
                projectItems.forEach(i => selectedItems.delete(i.id));
            } else {
                projectItems.forEach(i => selectedItems.add(i.id));
            }
            renderMain();
        }
        
        // ãƒ•ãƒ©ãƒƒãƒˆè¡¨ç¤ºã§ã®å…¨é¸æŠ
        function toggleSelectAllFlat() {
            const filtered = getFilteredInventory();
            const allSelected = filtered.every(i => selectedItems.has(i.id));
            
            if (allSelected) {
                filtered.forEach(i => selectedItems.delete(i.id));
            } else {
                filtered.forEach(i => selectedItems.add(i.id));
            }
            renderMain();
        }

        // é¸æŠã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelBulkSelect() {
            bulkSelectMode = false;
            selectedItems.clear();
            renderMain();
        }

        // ã‚¹ãƒãƒ›ç”¨ãã®ä»–ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        function toggleBulkMoreMenu() {
            const menu = document.getElementById('bulkMoreMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }
        
        function closeBulkMoreMenu() {
            const menu = document.getElementById('bulkMoreMenu');
            if (menu) {
                menu.classList.add('hidden');
            }
        }

        // ä¸€æ‹¬æ¡ˆä»¶ç•ªå·å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkProjectModal() {
            const modal = document.createElement('div');
            modal.id = 'bulkProjectModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬æ¡ˆä»¶å¤‰æ›´ï¼ˆ${selectedItems.size}ä»¶ï¼‰</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç™ºæ³¨æ¡ˆä»¶ç•ªå·</label>
                            <input type="text" id="bulkOrderProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="AD-1700">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitBulkProject()" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">å¤‰æ›´</button>
                            <button onclick="closeModal('bulkProjectModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitBulkProject() {
            const orderProjectInput = document.getElementById('bulkOrderProject').value.trim();
            if (!orderProjectInput) {
                alert('æ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const parsed = parseProjectNumberString(orderProjectInput);
            
            selectedItems.forEach(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                if (item) {
                    item.orderPrefix = parsed.prefix;
                    item.orderNumber = parsed.number;
                }
            });
            saveData();
            closeModal('bulkProjectModal');
            cancelBulkSelect();
        }

        // ä¸€æ‹¬æ£šç•ªå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkShelfModal() {
            const modal = document.createElement('div');
            modal.id = 'bulkShelfModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬æ£šç•ªå¤‰æ›´ï¼ˆ${selectedItems.size}ä»¶ï¼‰</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ£šç•ª</label>
                            <select id="bulkShelfNo" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="">æœªè¨­å®š</option>
                                ${SHELF_NUMBERS.map(n => `<option value="${n}">${n}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitBulkShelf()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">å¤‰æ›´</button>
                            <button onclick="closeModal('bulkShelfModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitBulkShelf() {
            const shelfNo = document.getElementById('bulkShelfNo').value;
            selectedItems.forEach(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                if (item) item.shelfNo = shelfNo;
            });
            saveData();
            closeModal('bulkShelfModal');
            cancelBulkSelect();
        }

        // ä¸€æ‹¬ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkSupplierModal() {
            const modal = document.createElement('div');
            modal.id = 'bulkSupplierModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å¤‰æ›´ï¼ˆ${selectedItems.size}ä»¶ï¼‰</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</label>
                            <select id="bulkSupplierId" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="">æœªè¨­å®š</option>
                                ${suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitBulkSupplier()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">å¤‰æ›´</button>
                            <button onclick="closeModal('bulkSupplierModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitBulkSupplier() {
            const supplierId = document.getElementById('bulkSupplierId').value;
            selectedItems.forEach(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                if (item) item.supplierId = supplierId;
            });
            await saveData();
            closeModal('bulkSupplierModal');
            cancelBulkSelect();
        }

        // ä¸€æ‹¬ä¿ç®¡å ´æ‰€å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkLocationModal() {
            const modal = document.createElement('div');
            modal.id = 'bulkLocationModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬å ´æ‰€å¤‰æ›´ï¼ˆ${selectedItems.size}ä»¶ï¼‰</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ä¿ç®¡å ´æ‰€</label>
                            <select id="bulkLocation" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="">è“®ç”°ï¼ˆé€šå¸¸ï¼‰</option>
                                <option value="æ±äº¬">æ±äº¬</option>
                                <option value="å¤§é˜ª">å¤§é˜ª</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitBulkLocation()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">å¤‰æ›´</button>
                            <button onclick="closeModal('bulkLocationModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitBulkLocation() {
            const location = document.getElementById('bulkLocation').value;
            selectedItems.forEach(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                if (item) item.location = location;
            });
            saveData();
            closeModal('bulkLocationModal');
            cancelBulkSelect();
        }

        // ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkEditModal() {
            // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®å…±é€šå€¤ã‚’å–å¾—
            const selectedList = Array.from(selectedItems).map(id => 
                inventory.find(i => String(i.id) === String(id))
            ).filter(item => item);
            
            if (selectedList.length === 0) return;
            
            // å…±é€šå€¤ãŒã‚ã‚Œã°åˆæœŸå€¤ã¨ã—ã¦è¡¨ç¤º
            const commonNote = selectedList.every(i => i.note === selectedList[0].note) ? (selectedList[0].note || '') : '';
            const commonCategory = selectedList.every(i => i.category === selectedList[0].category) ? (selectedList[0].category || '') : '';
            const commonProductName = selectedList.every(i => i.productName === selectedList[0].productName) ? (selectedList[0].productName || '') : '';
            
            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            const escapeHtml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            
            const modal = document.createElement('div');
            modal.id = 'bulkEditModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">âœï¸ ä¸€æ‹¬ç·¨é›†ï¼ˆ${selectedItems.size}ä»¶ï¼‰</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">â€»ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸé …ç›®ã®ã¿å¤‰æ›´ã•ã‚Œã¾ã™</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="flex items-center gap-2 mb-1">
                                    <input type="checkbox" id="bulkEditNoteApply" ${commonNote ? 'checked' : ''} class="w-4 h-4">
                                    <span class="text-sm font-semibold dark:text-slate-300">å‚™è€ƒ</span>
                                </label>
                                <input type="text" id="bulkEditNote" value="${escapeHtml(commonNote)}" 
                                       oninput="document.getElementById('bulkEditNoteApply').checked = true"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" 
                                       placeholder="${commonNote ? '' : '(è¤‡æ•°ã®å€¤ã‚ã‚Š - å…¥åŠ›ã™ã‚‹ã¨é©ç”¨)'}">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç¨®åˆ¥</label>
                                <select id="bulkEditCategory" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="">-- å¤‰æ›´ã—ãªã„ --</option>
                                    ${CATEGORIES.map(c => `<option value="${c}" ${commonCategory === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="flex items-center gap-2 mb-1">
                                    <input type="checkbox" id="bulkEditProductNameApply" ${commonProductName ? 'checked' : ''} class="w-4 h-4">
                                    <span class="text-sm font-semibold dark:text-slate-300">è£½å“å</span>
                                </label>
                                <input type="text" id="bulkEditProductName" value="${escapeHtml(commonProductName)}" 
                                       oninput="document.getElementById('bulkEditProductNameApply').checked = true"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" 
                                       placeholder="${commonProductName ? '' : '(è¤‡æ•°ã®å€¤ã‚ã‚Š - å…¥åŠ›ã™ã‚‹ã¨é©ç”¨)'}">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="bulkEditStatus" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="">-- å¤‰æ›´ã—ãªã„ --</option>
                                    ${STATUSES.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-6">
                            <button onclick="submitBulkEdit()" class="flex-1 px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700">é©ç”¨</button>
                            <button onclick="closeModal('bulkEditModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitBulkEdit() {
            const noteApply = document.getElementById('bulkEditNoteApply').checked;
            const note = document.getElementById('bulkEditNote').value;
            const category = document.getElementById('bulkEditCategory').value;
            const productNameApply = document.getElementById('bulkEditProductNameApply').checked;
            const productName = document.getElementById('bulkEditProductName').value;
            const status = document.getElementById('bulkEditStatus').value;
            
            let updatedCount = 0;
            
            selectedItems.forEach(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                if (item) {
                    if (noteApply) {
                        item.note = note;
                    }
                    if (category) {
                        item.category = category;
                    }
                    if (productNameApply) {
                        item.productName = productName;
                    }
                    if (status) {
                        item.status = status;
                    }
                    updatedCount++;
                }
            });
            
            closeModal('bulkEditModal');
            
            // éåŒæœŸã§ä¿å­˜
            (async () => {
                await saveData();
                showStatus(`âœ… ${updatedCount}ä»¶ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
                setTimeout(() => showStatus(''), 3000);
            })();
            
            cancelBulkSelect();
        }

        // ä¸€æ‹¬å…¥åº«
        // ä¸€æ‹¬å…¥åº«ãƒ¢ãƒ¼ãƒ€ãƒ«
        function bulkReceive() {
            const waitingItems = Array.from(selectedItems).filter(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                return item && item.status === 'å…¥åº«å¾…ã¡';
            });
            
            if (waitingItems.length === 0) {
                alert('å…¥åº«å¾…ã¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'bulkReceiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬å…¥åº«ï¼ˆ${waitingItems.length}ä»¶ï¼‰</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å…¥åº«æ—¥</label>
                            <input type="date" id="bulkReceiveDate" value="${today}" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2 dark:text-slate-300">å…¥åº«å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg cursor-pointer border-2 border-transparent has-[:checked]:border-orange-500">
                                    <input type="radio" name="bulkReceiveStatus" value="æ¤œå“å¾…ã¡" class="w-4 h-4 text-orange-600">
                                    <div>
                                        <span class="font-semibold text-orange-700 dark:text-orange-400">ğŸ” æ¤œå“å¾…ã¡</span>
                                        <p class="text-xs text-orange-600 dark:text-orange-500">æ¤œå“å¾Œã«åœ¨åº«ã¸</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg cursor-pointer border-2 border-transparent has-[:checked]:border-emerald-500">
                                    <input type="radio" name="bulkReceiveStatus" value="åœ¨åº«ä¸­" checked class="w-4 h-4 text-emerald-600">
                                    <div>
                                        <span class="font-semibold text-emerald-700 dark:text-emerald-400">âœ… åœ¨åº«ä¸­</span>
                                        <p class="text-xs text-emerald-600 dark:text-emerald-500">æ¤œå“ã‚¹ã‚­ãƒƒãƒ—</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitBulkReceive()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å…¥åº«</button>
                            <button onclick="closeModal('bulkReceiveModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitBulkReceive() {
            const receiveDate = document.getElementById('bulkReceiveDate').value;
            const newStatus = document.querySelector('input[name="bulkReceiveStatus"]:checked')?.value || 'åœ¨åº«ä¸­';
            
            const waitingItems = Array.from(selectedItems).filter(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                return item && item.status === 'å…¥åº«å¾…ã¡';
            });
            
            // å½±éŸ¿ã‚’å—ã‘ã‚‹æ¡ˆä»¶ã‚’åé›†
            const affectedProjects = new Set();
            
            waitingItems.forEach(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                if (item) {
                    item.status = newStatus;
                    item.receiveDate = receiveDate;
                    const projectNumber = formatProjectNumber(item.orderPrefix, item.orderNumber);
                    if (projectNumber) {
                        affectedProjects.add(projectNumber);
                    }
                }
            });
            
            saveData();
            closeModal('bulkReceiveModal');
            cancelBulkSelect();
            
            const statusText = newStatus === 'æ¤œå“å¾…ã¡' ? 'ğŸ” æ¤œå“å¾…ã¡ã«è¨­å®š' : 'âœ… åœ¨åº«ã«è¿½åŠ ';
            showStatus(`${statusText}: ${waitingItems.length}ä»¶`, 'success');
            
            // åœ¨åº«ä¸­ã®å ´åˆã®ã¿ã€å„æ¡ˆä»¶ã«ã¤ã„ã¦å…¨å°å…¥åº«ãƒã‚§ãƒƒã‚¯
            if (newStatus === 'åœ¨åº«ä¸­') {
                for (const projectNumber of affectedProjects) {
                    await checkAndUpdateProcurement(projectNumber);
                }
            }
        }

        // ä¸€æ‹¬å‡ºåº«ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkShipModal() {
            const inStockItems = Array.from(selectedItems).filter(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                return item && item.status === 'åœ¨åº«ä¸­';
            });
            
            if (inStockItems.length === 0) {
                alert('åœ¨åº«ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'bulkShipModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬å‡ºåº«ï¼ˆ${inStockItems.length}ä»¶ï¼‰</h3>
                        
                        <div class="space-y-4">
                            <!-- å‡ºåº«æ–¹æ³• -->
                            <div>
                                <label class="block text-sm font-semibold mb-2 dark:text-slate-300">å‡ºåº«æ–¹æ³•</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="bulkShipMethod" value="delivery" checked onchange="toggleBulkShipMethod()">
                                        <span class="dark:text-white">ğŸ“¦ é…é€</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="bulkShipMethod" value="pickup" onchange="toggleBulkShipMethod()">
                                        <span class="dark:text-white">ğŸ¤ å¼•æ¸¡ã—</span>
                                    </label>
                                </div>
                            </div>

                            <!-- é…é€ã®å ´åˆ -->
                            <div id="bulkDeliveryFields">
                                <div class="mb-3">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">é…é€æ¥­è€…</label>
                                    <select id="bulkShipCarrier" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        ${CARRIERS.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">é€ã‚ŠçŠ¶ç•ªå·</label>
                                    <input type="text" id="bulkShipTrackingNo" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="è¿½è·¡ç•ªå·ã‚’å…¥åŠ›">
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å±Šã‘å…ˆ</label>
                                    <input type="text" id="bulkShipDestination" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="ä¼šç¤¾åãƒ»æ‹…å½“è€…ãƒ»ä½æ‰€ãªã©">
                                </div>
                            </div>

                            <!-- å¼•æ¸¡ã—ã®å ´åˆ -->
                            <div id="bulkPickupFields" class="hidden">
                                <div class="mb-3">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å¼•æ¸¡ã—å…ˆ</label>
                                    <input type="text" id="bulkShipPickupTo" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="æ–½å·¥æ¥­è€…åãªã©">
                                </div>
                            </div>

                            <!-- å…±é€š -->
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå· <span class="text-red-500">*</span></label>
                                <input type="text" id="bulkShipProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="AD-1700">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«æ—¥</label>
                                <input type="date" id="bulkShipDate" value="${today}" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-6">
                            <button onclick="submitBulkShip()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å‡ºåº«</button>
                            <button onclick="closeModal('bulkShipModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function toggleBulkShipMethod() {
            const method = document.querySelector('input[name="bulkShipMethod"]:checked').value;
            document.getElementById('bulkDeliveryFields').classList.toggle('hidden', method !== 'delivery');
            document.getElementById('bulkPickupFields').classList.toggle('hidden', method !== 'pickup');
        }

        function submitBulkShip() {
            const shipProjectInput = document.getElementById('bulkShipProject').value.trim();
            const shipDate = document.getElementById('bulkShipDate').value;
            const method = document.querySelector('input[name="bulkShipMethod"]:checked').value;
            
            if (!shipProjectInput) {
                alert('å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const parsedShip = parseProjectNumberString(shipProjectInput);
            
            const inStockItems = Array.from(selectedItems).filter(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                return item && item.status === 'åœ¨åº«ä¸­';
            });
            
            inStockItems.forEach(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                if (item) {
                    item.shipPrefix = parsedShip.prefix;
                    item.shipNumber = parsedShip.number;
                    item.shipDate = shipDate;
                    item.shipMethod = method;

                    if (method === 'delivery') {
                        item.shipCarrier = document.getElementById('bulkShipCarrier').value;
                        item.shipTrackingNo = document.getElementById('bulkShipTrackingNo').value.trim();
                        item.shipDestination = document.getElementById('bulkShipDestination').value.trim();
                        item.status = 'å‡ºåº«æ¸ˆ';
                    } else {
                        item.shipPickupTo = document.getElementById('bulkShipPickupTo').value.trim();
                        item.status = 'å‡ºåº«æ¸ˆ';
                    }
                }
            });
            
            saveData();
            closeModal('bulkShipModal');
            cancelBulkSelect();
        }

        function applyFilters() {
            const categoryEl = document.getElementById('filterCategory');
            const statusEl = document.getElementById('filterStatus');
            const searchEl = document.getElementById('filterSearch');
            const sortEl = document.getElementById('filterSort');
            const shelfNoEl = document.getElementById('filterShelfNo');
            const receiveDateFromEl = document.getElementById('filterReceiveDateFrom');
            const receiveDateToEl = document.getElementById('filterReceiveDateTo');
            const shipProjectEl = document.getElementById('filterShipProject');
            const costRangeEl = document.getElementById('filterCostRange');
            
            if (categoryEl) currentFilters.category = categoryEl.value;
            if (statusEl) currentFilters.status = statusEl.value;
            if (searchEl) currentFilters.search = searchEl.value;
            if (sortEl) currentFilters.sort = sortEl.value;
            if (shelfNoEl) currentFilters.shelfNo = shelfNoEl.value;
            if (receiveDateFromEl) currentFilters.receiveDateFrom = receiveDateFromEl.value;
            if (receiveDateToEl) currentFilters.receiveDateTo = receiveDateToEl.value;
            if (shipProjectEl) currentFilters.shipProject = shipProjectEl.value;
            if (costRangeEl) currentFilters.costRange = costRangeEl.value;
            renderMain();
        }

        function clearFilters() {
            currentFilters = { 
                category: '', 
                status: '', 
                search: '', 
                sort: 'orderDate-desc', 
                shelfNo: '',
                receiveDateFrom: '',
                receiveDateTo: '',
                shipProject: '',
                costRange: '',
                noShelf: false,
                location: ''
            };
            // expandedProjectsã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆå±•é–‹çŠ¶æ…‹ã‚’ç¶­æŒï¼‰
            showDetailFilters = false;
            viewMode = 'group'; // ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢æ™‚ã¯ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºã«æˆ»ã™
            renderMain();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ã©ã†ã‹åˆ¤å®š
        function hasActiveFilters() {
            return currentFilters.category || 
                   currentFilters.status || 
                   currentFilters.search ||
                   currentFilters.shelfNo ||
                   currentFilters.receiveDateFrom ||
                   currentFilters.receiveDateTo ||
                   currentFilters.shipProject ||
                   currentFilters.costRange ||
                   currentFilters.noShelf ||
                   currentFilters.location;
        }
        
        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleViewMode() {
            viewMode = viewMode === 'group' ? 'flat' : 'group';
            renderMain();
        }
        
        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®š
        function setViewMode(mode) {
            viewMode = mode;
            renderMain();
        }

        function quickFilter(type) {
            // ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿ã¯ãƒˆã‚°ãƒ«å¼
            if (type === 'noShelf') {
                currentFilters.noShelf = !currentFilters.noShelf;
                currentFilters.category = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'multi') {
                if (currentFilters.category === 'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤';
                }
                currentFilters.noShelf = false;
                currentFilters.location = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'blackboard') {
                if (currentFilters.category === 'STUDIA') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'STUDIA';
                }
                currentFilters.noShelf = false;
                currentFilters.location = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'outdoor') {
                if (currentFilters.category === 'å±‹å¤–') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'å±‹å¤–';
                }
                currentFilters.noShelf = false;
                currentFilters.location = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'indoor') {
                if (currentFilters.category === 'å±‹å†…') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'å±‹å†…';
                }
                currentFilters.noShelf = false;
                currentFilters.location = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'tokyo') {
                if (currentFilters.location === 'æ±äº¬') {
                    currentFilters.location = '';
                } else {
                    currentFilters.location = 'æ±äº¬';
                }
                currentFilters.category = '';
                currentFilters.noShelf = false;
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'osaka') {
                if (currentFilters.location === 'å¤§é˜ª') {
                    currentFilters.location = '';
                } else {
                    currentFilters.location = 'å¤§é˜ª';
                }
                currentFilters.category = '';
                currentFilters.noShelf = false;
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            }
            renderMain();
        }

        function toggleDetailFilters() {
            showDetailFilters = !showDetailFilters;
            renderMain();
        }

        // åœ¨åº«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showAddInventoryModal() {
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'addModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">åœ¨åº«è¿½åŠ </h3>
                        
                        <!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="setAddMode('master')" id="addModeMaster" class="flex-1 px-3 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white">è£½å“ãƒã‚¹ã‚¿ã‹ã‚‰</button>
                            <button onclick="setAddMode('manual')" id="addModeManual" class="flex-1 px-3 py-2 rounded-lg text-sm font-semibold bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-300">æ‰‹å‹•å…¥åŠ›</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">Serial <span class="text-slate-400 text-xs">ï¼ˆç©ºæ¬„ã§NSè‡ªå‹•æ¡ç•ªï¼‰</span></label>
                                <input type="text" id="addSerial" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="ç©ºæ¬„å¯ï¼ˆä¾‹: YS0554-1ï¼‰">
                            </div>
                            
                            <!-- è£½å“ãƒã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ‰ -->
                            <div id="masterModeFields">
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç¨®åˆ¥ <span class="text-red-500">*</span></label>
                                    <select id="addMasterCategory" onchange="onMasterCategorySelect()" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">ç¨®åˆ¥ã‚’é¸æŠ...</option>
                                        ${getMasterCategories().map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">è£½å“ãƒã‚¹ã‚¿: ${productMaster.length}ä»¶ç™»éŒ²æ¸ˆã¿</p>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‹ç•ªï¼ˆPNï¼‰<span class="text-red-500">*</span></label>
                                    <select id="addPN" onchange="onPNSelect()" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">ã¾ãšç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è‰²</label>
                                    <select id="addColor" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">è‰²ã‚’é¸æŠ...</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚¤ãƒ³ãƒ</label>
                                        <input type="text" id="addInchDisplay" class="w-full px-3 py-2 border rounded-lg bg-slate-100 dark:bg-slate-600 dark:border-slate-500 dark:text-slate-300" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è§£åƒåº¦</label>
                                        <input type="text" id="addResolutionDisplay" class="w-full px-3 py-2 border rounded-lg bg-slate-100 dark:bg-slate-600 dark:border-slate-500 dark:text-slate-300" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
                            <div id="manualModeFields" class="hidden">
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç¨®åˆ¥ <span class="text-red-500">*</span></label>
                                    <select id="addCategory" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        ${CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è£½å“å <span class="text-red-500">*</span></label>
                                    <input type="text" id="addProductName" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="è£½å“åã‚’å…¥åŠ›">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç™ºæ³¨æ¡ˆä»¶ç•ªå·</label>
                                <input type="text" id="addOrderProject" oninput="onOrderProjectInput()" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="AD-1682">
                                <p id="projectStatusMsg" class="text-xs mt-1 hidden"></p>
                            </div>
                            <div id="supplierSelectRow" class="hidden">
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ <span class="text-red-500">*</span></label>
                                <select id="addSupplier" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    ${suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç™ºæ³¨æ—¥</label>
                                <input type="date" id="addOrderDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${today}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ•°é‡ï¼ˆè¤‡æ•°å°ã®å ´åˆï¼‰</label>
                                <input type="number" id="addQuantity" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="1" min="1">
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">è¤‡æ•°ã®å ´åˆã€Serial-1, Serial-2... ã¨é€£ç•ªã§è¿½åŠ ã•ã‚Œã¾ã™</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‚™è€ƒ</label>
                                <textarea id="addNote" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('addModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitAddInventory()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">è¿½åŠ </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        let addMode = 'master'; // 'master' or 'manual'
        
        function setAddMode(mode) {
            addMode = mode;
            const masterBtn = document.getElementById('addModeMaster');
            const manualBtn = document.getElementById('addModeManual');
            const masterFields = document.getElementById('masterModeFields');
            const manualFields = document.getElementById('manualModeFields');
            
            if (mode === 'master') {
                masterBtn.className = 'flex-1 px-3 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white';
                manualBtn.className = 'flex-1 px-3 py-2 rounded-lg text-sm font-semibold bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-300';
                masterFields.classList.remove('hidden');
                manualFields.classList.add('hidden');
            } else {
                masterBtn.className = 'flex-1 px-3 py-2 rounded-lg text-sm font-semibold bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-300';
                manualBtn.className = 'flex-1 px-3 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white';
                masterFields.classList.add('hidden');
                manualFields.classList.remove('hidden');
            }
        }

        // æ—¢å­˜æ¡ˆä»¶ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        function findExistingProject(prefix, number, productName = null) {
            if (!number) return null;
            return projects.find(p => {
                const prefixMatch = p.prefix.toUpperCase() === prefix.toUpperCase();
                const numberMatch = String(p.number) === String(number);
                if (!prefixMatch || !numberMatch) return false;
                
                // è£½å“åãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°è£½å“åã‚‚ä¸€è‡´ãƒã‚§ãƒƒã‚¯
                if (productName) {
                    return p.productName === productName;
                }
                return true;
            });
        }
        
        // æ¡ˆä»¶ç•ªå· + è£½å“åã§æ—¢å­˜æ¡ˆä»¶ã‚’æ¤œç´¢ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
        function findExactProject(prefix, number, productName) {
            if (!number || !productName) return null;
            return projects.find(p => 
                p.prefix.toUpperCase() === prefix.toUpperCase() && 
                String(p.number) === String(number) &&
                p.productName === productName
            );
        }

        // æ¡ˆä»¶ç•ªå·å…¥åŠ›æ™‚ã®å‡¦ç†
        function onOrderProjectInput() {
            const orderProject = document.getElementById('addOrderProject').value.trim();
            const supplierRow = document.getElementById('supplierSelectRow');
            const projectStatusMsg = document.getElementById('projectStatusMsg');
            
            const parsed = parseProjectNumberString(orderProject);
            
            if (parsed.number) {
                const existing = findExistingProject(parsed.prefix, parsed.number);
                
                if (existing) {
                    // æ—¢å­˜æ¡ˆä»¶ â†’ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼é¸æŠä¸è¦
                    supplierRow.classList.add('hidden');
                    projectStatusMsg.innerHTML = '<span class="text-blue-600 dark:text-blue-400">âœ“ æ—¢å­˜æ¡ˆä»¶ã«è¿½åŠ ã—ã¾ã™</span>';
                    projectStatusMsg.classList.remove('hidden');
                } else {
                    // æ–°è¦æ¡ˆä»¶ â†’ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼é¸æŠå¿…é ˆ
                    supplierRow.classList.remove('hidden');
                    projectStatusMsg.innerHTML = '<span class="text-amber-600 dark:text-amber-400">æ–°è¦æ¡ˆä»¶ã¨ã—ã¦èª¿é”ç®¡ç†ã«ç™»éŒ²ã•ã‚Œã¾ã™</span>';
                    projectStatusMsg.classList.remove('hidden');
                }
            } else {
                supplierRow.classList.add('hidden');
                projectStatusMsg.classList.add('hidden');
            }
        }

        function onPNSelect() {
            const pnSelect = document.getElementById('addPN');
            const selectedPN = pnSelect.value;
            const colorSelect = document.getElementById('addColor');
            const inchDisplay = document.getElementById('addInchDisplay');
            const resolutionDisplay = document.getElementById('addResolutionDisplay');
            
            if (!selectedPN) {
                colorSelect.innerHTML = '<option value="">è‰²ã‚’é¸æŠ...</option>';
                inchDisplay.value = '';
                resolutionDisplay.value = '';
                return;
            }
            
            const product = getProductByPN(selectedPN);
            const colors = getColorVariants(selectedPN);
            
            // è‰²é¸æŠè‚¢ã‚’æ›´æ–°
            colorSelect.innerHTML = '<option value="">è‰²ã‚’é¸æŠ...</option>' + 
                colors.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // ã‚¤ãƒ³ãƒãƒ»è§£åƒåº¦ã‚’è‡ªå‹•å…¥åŠ›
            if (product) {
                inchDisplay.value = product.inch ? product.inch + 'ã‚¤ãƒ³ãƒ' : '';
                resolutionDisplay.value = product.resolution || '';
            }
        }

        // è£½å“ãƒã‚¹ã‚¿ã®ç¨®åˆ¥ä¸€è¦§ã‚’å–å¾—
        function getMasterCategories() {
            const categories = new Set();
            productMaster.forEach(p => {
                if (p.category) categories.add(p.category);
            });
            return Array.from(categories).sort();
        }

        // ç¨®åˆ¥é¸æŠæ™‚ã®å‡¦ç†
        function onMasterCategorySelect() {
            const categorySelect = document.getElementById('addMasterCategory');
            const selectedCategory = categorySelect.value;
            const pnSelect = document.getElementById('addPN');
            const colorSelect = document.getElementById('addColor');
            const inchDisplay = document.getElementById('addInchDisplay');
            const resolutionDisplay = document.getElementById('addResolutionDisplay');
            
            // ãƒªã‚»ãƒƒãƒˆ
            colorSelect.innerHTML = '<option value="">è‰²ã‚’é¸æŠ...</option>';
            inchDisplay.value = '';
            resolutionDisplay.value = '';
            
            if (!selectedCategory) {
                pnSelect.innerHTML = '<option value="">ã¾ãšç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                return;
            }
            
            // é¸æŠã•ã‚ŒãŸç¨®åˆ¥ã®å‹ç•ªä¸€è¦§ã‚’å–å¾—ï¼ˆé‡è¤‡é™¤å»ï¼‰
            const pnMap = new Map();
            productMaster.filter(p => p.category === selectedCategory).forEach(p => {
                if (!pnMap.has(p.pn)) {
                    pnMap.set(p.pn, p);
                }
            });
            const pns = Array.from(pnMap.values());
            
            // å‹ç•ªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            pnSelect.innerHTML = '<option value="">å‹ç•ªã‚’é¸æŠ...</option>' + 
                pns.map(p => `<option value="${p.pn}">${p.pn}${p.inch ? ` (${p.inch}")` : ''}</option>`).join('');
        }

        async function submitAddInventory() {
            let serial = document.getElementById('addSerial').value.trim();
            const orderProjectInput = document.getElementById('addOrderProject').value.trim();
            const orderDate = document.getElementById('addOrderDate').value;
            const quantity = parseInt(document.getElementById('addQuantity').value) || 1;
            const note = document.getElementById('addNote').value.trim();
            
            const parsedOrder = parseProjectNumberString(orderProjectInput);
            
            // æ—¢å­˜æ¡ˆä»¶ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
            const existingProject = parsedOrder.number ? findExistingProject(parsedOrder.prefix, parsedOrder.number) : null;
            
            // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼IDã®å–å¾—
            let supplierId = null;
            if (existingProject) {
                // æ—¢å­˜æ¡ˆä»¶ãŒã‚ã‚‹å ´åˆã¯ã€ãã®æ¡ˆä»¶ã®ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼IDã‚’ä½¿ã†
                supplierId = existingProject.supplierId || '';
            } else if (parsedOrder.number) {
                // æ–°è¦æ¡ˆä»¶ã®å ´åˆã¯ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼é¸æŠå¿…é ˆ
                const supplierSelect = document.getElementById('addSupplier');
                supplierId = supplierSelect ? supplierSelect.value : '';
                if (!supplierId) {
                    alert('æ–°è¦æ¡ˆä»¶ã®å ´åˆã¯ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã®é¸æŠãŒå¿…é ˆã§ã™');
                    return;
                }
            }
            
            let category, productName;
            
            if (addMode === 'master') {
                const pn = document.getElementById('addPN').value;
                const color = document.getElementById('addColor').value;
                
                if (!pn) {
                    alert('å‹ç•ªã¯å¿…é ˆã§ã™');
                    return;
                }
                
                const product = getProductByPN(pn);
                category = product ? product.category : '';
                // è£½å“å: PN + è‰²ï¼ˆã‚ã‚Œã°ï¼‰+ ã‚¤ãƒ³ãƒ
                productName = pn + (color ? ` ${color}` : '') + (product && product.inch ? ` ${product.inch}"` : '');
            } else {
                category = document.getElementById('addCategory').value;
                productName = document.getElementById('addProductName').value.trim();
                
                if (!category || !productName) {
                    alert('ç¨®åˆ¥ã€è£½å“åã¯å¿…é ˆã§ã™');
                    return;
                }
            }

            for (let i = 1; i <= quantity; i++) {
                const itemSerial = serial ? (quantity > 1 ? `${serial}-${i}` : serial) : '';
                inventory.push({
                    id: Date.now().toString() + '-' + i,
                    serial: itemSerial,
                    category,
                    productName,
                    orderPrefix: parsedOrder.prefix,
                    orderNumber: parsedOrder.number,
                    orderDate,
                    receiveDate: '',
                    status: 'å…¥åº«å¾…ã¡',
                    shipDate: '',
                    shipPrefix: '',
                    shipNumber: '',
                    costJPY: '',
                    note,
                    shelfNo: '',
                    location: '',
                    supplierId: supplierId || ''
                });
            }

            saveData();
            
            // æ–°è¦æ¡ˆä»¶ã®å ´åˆã®ã¿èª¿é”ã‚·ãƒ¼ãƒˆã«ã‚‚è¿½åŠ 
            if (parsedOrder.number && supplierId && !existingProject) {
                await addToProcurement(parsedOrder, supplierId, productName, serial, quantity, orderDate, category);
            }
            
            closeModal('addModal');
            renderMain();
        }
        
        // èª¿é”ã‚·ãƒ¼ãƒˆã«æ¡ˆä»¶ã‚’è¿½åŠ ï¼ˆæœªæ‰•ã„çŠ¶æ…‹ã§ç™»éŒ²ï¼‰
        async function addToProcurement(parsedOrder, supplierId, productName, serial, quantity, orderDate, category) {
            try {
                const supplier = suppliers.find(s => s.id === parseInt(supplierId));
                const defaultPattern = supplier && supplier.paymentPatterns ? supplier.paymentPatterns[0] : { rates: [50, 50] };
                const depositSchedule = defaultPattern.rates.map((rate, idx) => ({
                    depositNumber: idx + 1,
                    percentage: rate,
                    amountUSD: 0, // é‡‘é¡æœªå®š
                    paid: false,
                    paidDate: null,
                    exchangeRate: null,
                    amountJPY: null
                }));
                
                const serialDisplay = quantity > 1 ? `${serial}(1-${quantity})` : serial;
                
                // æ¡ˆä»¶ã‚·ãƒ¼ãƒˆã«è¿½åŠ 
                const newRow = [
                    Date.now().toString(),                    // ID
                    parsedOrder.prefix || 'AD',               // æ¥é ­è¾
                    parsedOrder.number,                       // ç•ªå·
                    supplierId,                               // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID
                    productName,                              // è£½å“å
                    0,                                        // ç·é¡USDï¼ˆæœªå®šï¼‰
                    JSON.stringify(depositSchedule),          // ãƒ‡ãƒã‚¸ãƒƒãƒˆäºˆå®š
                    serialDisplay,                            // Serial
                    quantity,                                 // æ•°é‡
                    30,                                       // WorkingDaysï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                    '',                                       // é›†è·äºˆå®šæ—¥ï¼ˆæœªå®šï¼‰
                    orderDate,                                // ç™ºæ³¨æ—¥
                    '[]'                                      // è«¸è²»ç”¨
                ];
                
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A:M',
                    valueInputOption: 'RAW',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: [newRow]
                    }
                });
                
                console.log('èª¿é”ã‚·ãƒ¼ãƒˆã«æ¡ˆä»¶ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', parsedOrder.prefix + '-' + parsedOrder.number);
            } catch (e) {
                console.error('èª¿é”ã‚·ãƒ¼ãƒˆã¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚åœ¨åº«è¿½åŠ ã¯æˆåŠŸã—ã¦ã„ã‚‹ã®ã§ç¶šè¡Œ
            }
        }

        // åœ¨åº«ã«ã‚ã£ã¦èª¿é”ã«ãªã„æ¡ˆä»¶ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
        function getMissingProjects() {
            // æ¡ˆä»¶ç•ªå· Ã— è£½å“å ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const inventoryProjects = {};
            inventory.forEach(item => {
                if (!item.orderPrefix || !item.orderNumber) return;
                const key = `${item.orderPrefix}-${item.orderNumber}|${item.productName}`;
                if (!inventoryProjects[key]) {
                    inventoryProjects[key] = {
                        prefix: item.orderPrefix,
                        number: item.orderNumber,
                        productName: item.productName,
                        serials: [],
                        totalCost: 0,
                        orderDate: item.orderDate || ''
                    };
                }
                inventoryProjects[key].serials.push(item.serial);
                if (item.costJPY) {
                    inventoryProjects[key].totalCost += parseFloat(item.costJPY) || 0;
                }
                if (!inventoryProjects[key].orderDate && item.orderDate) {
                    inventoryProjects[key].orderDate = item.orderDate;
                }
            });
            
            // èª¿é”ã«ãªã„æ¡ˆä»¶ã ã‘æŠ½å‡ºï¼ˆæ¡ˆä»¶ç•ªå· + è£½å“åã§åˆ¤å®šï¼‰
            const missing = [];
            Object.keys(inventoryProjects).forEach(key => {
                const proj = inventoryProjects[key];
                const exists = findExactProject(proj.prefix, proj.number, proj.productName);
                if (!exists) {
                    // Serialã‚’ã¾ã¨ã‚ã‚‹ï¼ˆä¾‹: YS0554-1, YS0554-2 â†’ YS0554(1-2)ï¼‰
                    const serialDisplay = formatSerialRange(proj.serials);
                    missing.push({
                        key,
                        prefix: proj.prefix,
                        number: proj.number,
                        productName: proj.productName,
                        serialDisplay,
                        quantity: proj.serials.length,
                        totalCost: proj.totalCost,
                        orderDate: proj.orderDate
                    });
                }
            });
            
            // ç•ªå·é † â†’ è£½å“åé †ã«ã‚½ãƒ¼ãƒˆ
            missing.sort((a, b) => {
                if (a.prefix !== b.prefix) return a.prefix.localeCompare(b.prefix);
                if (a.number !== b.number) return parseInt(a.number) - parseInt(b.number);
                return a.productName.localeCompare(b.productName);
            });
            
            return missing;
        }
        
        // Serialé…åˆ—ã‚’ã¾ã¨ã‚ã¦è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatSerialRange(serials) {
            if (serials.length === 0) return '';
            if (serials.length === 1) return serials[0];
            
            // ãƒ™ãƒ¼ã‚¹éƒ¨åˆ†ã¨æç•ªã‚’åˆ†é›¢ï¼ˆä¾‹: YS0554-1 â†’ base: YS0554, num: 1ï¼‰
            const parsed = serials.map(s => {
                const match = s.match(/^(.+)-(\d+)$/);
                if (match) {
                    return { base: match[1], num: parseInt(match[2]), original: s };
                }
                return { base: s, num: null, original: s };
            });
            
            // ãƒ™ãƒ¼ã‚¹ãŒå…¨éƒ¨åŒã˜ã‹ãƒã‚§ãƒƒã‚¯
            const bases = [...new Set(parsed.map(p => p.base))];
            if (bases.length === 1 && parsed.every(p => p.num !== null)) {
                // å…¨éƒ¨åŒã˜ãƒ™ãƒ¼ã‚¹ã§æç•ªã‚ã‚Š â†’ ã¾ã¨ã‚ã‚‹
                const nums = parsed.map(p => p.num).sort((a, b) => a - b);
                const base = bases[0];
                
                // é€£ç•ªã‹ãƒã‚§ãƒƒã‚¯
                const isConsecutive = nums.every((n, i) => i === 0 || n === nums[i-1] + 1);
                if (isConsecutive && nums.length > 1) {
                    return `${base}(${nums[0]}-${nums[nums.length-1]})`;
                } else {
                    return `${base}(${nums.join(',')})`;
                }
            }
            
            // ãƒãƒ©ãƒãƒ©ãªã‚‰æœ€åˆã®ã‚‚ã®ã ã‘è¡¨ç¤º
            return serials.length > 2 ? `${serials[0]} ä»–${serials.length - 1}ä»¶` : serials.join(', ');
        }

        // èª¿é”ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showImportToProcurementModal() {
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            document.getElementById('reportMenu').classList.add('hidden');
            
            const missing = getMissingProjects();
            
            if (missing.length === 0) {
                alert('èª¿é”ã«æœªç™»éŒ²ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'importModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-2 dark:text-white">èª¿é”ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">åœ¨åº«ã«ç™»éŒ²æ¸ˆã¿ã§èª¿é”ã«æœªç™»éŒ²ã®æ¡ˆä»¶: ${missing.length}ä»¶</p>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-100 dark:bg-slate-700">
                                    <tr>
                                        <th class="px-3 py-2 text-left">
                                            <input type="checkbox" id="importSelectAll" onchange="toggleImportSelectAll()" checked class="rounded">
                                        </th>
                                        <th class="px-3 py-2 text-left dark:text-white">æ¡ˆä»¶ç•ªå·</th>
                                        <th class="px-3 py-2 text-left dark:text-white">è£½å“å / Serial</th>
                                        <th class="px-3 py-2 text-center dark:text-white">æ•°é‡</th>
                                        <th class="px-3 py-2 text-right dark:text-white">å–å¾—é‡‘è¨ˆ</th>
                                        <th class="px-3 py-2 text-left dark:text-white">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y dark:divide-slate-600">
                                    ${missing.map((p, idx) => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                            <td class="px-3 py-2">
                                                <input type="checkbox" id="importCheck_${idx}" data-index="${idx}" checked class="import-checkbox rounded">
                                            </td>
                                            <td class="px-3 py-2 font-mono font-semibold dark:text-white">${p.prefix}-${p.number}</td>
                                            <td class="px-3 py-2 dark:text-slate-300">
                                                <div>${p.productName}</div>
                                                <div class="text-xs text-slate-400 font-mono">${p.serialDisplay}</div>
                                            </td>
                                            <td class="px-3 py-2 text-center dark:text-slate-300">${p.quantity}</td>
                                            <td class="px-3 py-2 text-right dark:text-slate-300">${p.totalCost ? 'Â¥' + p.totalCost.toLocaleString() : '-'}</td>
                                            <td class="px-3 py-2">
                                                <select id="importSupplier_${idx}" class="w-full px-2 py-1 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm">
                                                    <option value="">é¸æŠ...</option>
                                                    ${suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                                </select>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 p-3 bg-amber-50 dark:bg-amber-900/30 rounded-lg">
                            <p class="text-sm text-amber-700 dark:text-amber-400">
                                âš ï¸ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼æœªé¸æŠã®æ¡ˆä»¶ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™<br>
                                ğŸ’° å–å¾—é‡‘ãŒã‚ã‚‹æ¡ˆä»¶ã¯ã€Œæ”¯æ‰•æ¸ˆã¿ã€ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™
                            </p>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('importModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitImportToProcurement()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // å…¨é¸æŠ/å…¨è§£é™¤
        function toggleImportSelectAll() {
            const selectAll = document.getElementById('importSelectAll').checked;
            document.querySelectorAll('.import-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
        async function submitImportToProcurement() {
            const missing = getMissingProjects();
            const toImport = [];
            
            // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ¡ˆä»¶ã‚’åé›†
            missing.forEach((p, idx) => {
                const checkbox = document.getElementById(`importCheck_${idx}`);
                const supplierSelect = document.getElementById(`importSupplier_${idx}`);
                
                if (checkbox && checkbox.checked && supplierSelect && supplierSelect.value) {
                    toImport.push({
                        ...p,
                        supplierId: supplierSelect.value
                    });
                }
            });
            
            if (toImport.length === 0) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ¡ˆä»¶ã‚’é¸æŠã—ã€ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`${toImport.length}ä»¶ã®æ¡ˆä»¶ã‚’èª¿é”ã«ç™»éŒ²ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                showStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
                
                const rows = toImport.map((p, idx) => {
                    const supplier = suppliers.find(s => s.id === parseInt(p.supplierId));
                    
                    // å–å¾—é‡‘ãŒã‚ã‚‹å ´åˆã¯æ”¯æ‰•æ¸ˆã¿ã¨ã—ã¦ç™»éŒ²
                    let depositSchedule;
                    if (p.totalCost > 0) {
                        depositSchedule = [{
                            depositNumber: 1,
                            percentage: 100,
                            amountUSD: 0,
                            paid: true,
                            paidDate: p.orderDate || null,
                            exchangeRate: null,
                            amountJPY: p.totalCost
                        }];
                    } else {
                        // å–å¾—é‡‘ãŒãªã„å ´åˆã¯ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã®ãƒ‡ãƒã‚¸ãƒƒãƒˆè¨­å®šã‚’ä½¿ç”¨
                        const defaultPattern = supplier && supplier.paymentPatterns ? supplier.paymentPatterns[0] : { rates: [50, 50] };
                        depositSchedule = defaultPattern.rates.map((rate, idx) => ({
                            depositNumber: idx + 1,
                            percentage: rate,
                            amountUSD: 0,
                            paid: false,
                            paidDate: null,
                            exchangeRate: null,
                            amountJPY: null
                        }));
                    }
                    
                    return [
                        Date.now().toString() + '-' + p.number + '-' + idx,  // IDï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹ãŸã‚idxã‚‚ä»˜åŠ ï¼‰
                        p.prefix,                                  // æ¥é ­è¾
                        p.number,                                  // ç•ªå·
                        p.supplierId,                             // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID
                        p.productName,                            // è£½å“å
                        0,                                        // ç·é¡USD
                        JSON.stringify(depositSchedule),          // ãƒ‡ãƒã‚¸ãƒƒãƒˆäºˆå®š
                        p.serialDisplay,                          // Serial
                        p.quantity,                               // æ•°é‡
                        30,                                       // WorkingDays
                        '',                                       // é›†è·äºˆå®šæ—¥
                        p.orderDate || '',                        // ç™ºæ³¨æ—¥
                        '[]'                                      // è«¸è²»ç”¨
                    ];
                });
                
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A:M',
                    valueInputOption: 'RAW',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: rows
                    }
                });
                
                // projectsé…åˆ—ã‚’æ›´æ–°
                toImport.forEach(p => {
                    projects.push({
                        id: Date.now().toString() + '-' + p.number,
                        prefix: p.prefix,
                        number: p.number
                    });
                });
                
                closeModal('importModal');
                showStatus(`${toImport.length}ä»¶ã®æ¡ˆä»¶ã‚’èª¿é”ã«ç™»éŒ²ã—ã¾ã—ãŸ`, 'success');
                
            } catch (e) {
                console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            }
        }

        // å…¥åº«ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showReceiveModal(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;
            
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'receiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">å…¥åº«å‡¦ç†</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">Serial: <span class="font-mono font-semibold">${item.serial || "-"}</span></p>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">${item.productName}</p>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å…¥åº«æ—¥ <span class="text-red-500">*</span></label>
                            <input type="date" id="receiveDate" class="w-full px-3 py-2 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white" value="${today}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2 dark:text-slate-300">å…¥åº«å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg cursor-pointer border-2 border-transparent hover:border-orange-300 dark:hover:border-orange-700">
                                    <input type="radio" name="receiveStatus" value="æ¤œå“å¾…ã¡" class="w-4 h-4 text-orange-600">
                                    <div class="flex-1">
                                        <span class="font-semibold text-orange-700 dark:text-orange-400">ğŸ” æ¤œå“å¾…ã¡</span>
                                        <p class="text-xs text-orange-600 dark:text-orange-500">æ¤œå“ãƒŠãƒ“ã§æ¤œå“å¾Œã«åœ¨åº«ã¸</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg cursor-pointer border-2 border-transparent hover:border-emerald-300 dark:hover:border-emerald-700">
                                    <input type="radio" name="receiveStatus" value="åœ¨åº«ä¸­" checked class="w-4 h-4 text-emerald-600">
                                    <div class="flex-1">
                                        <span class="font-semibold text-emerald-700 dark:text-emerald-400">âœ… åœ¨åº«ä¸­ï¼ˆæ¤œå“ã‚¹ã‚­ãƒƒãƒ—ï¼‰</span>
                                        <p class="text-xs text-emerald-600 dark:text-emerald-500">æ¤œå“ä¸è¦ã€ã™ãã«åœ¨åº«ã¸</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('receiveModal')" class="flex-1 px-4 py-2 border dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-white">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitReceive('${id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å…¥åº«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitReceive(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            const receiveDate = document.getElementById('receiveDate').value;
            const newStatus = document.querySelector('input[name="receiveStatus"]:checked')?.value || 'åœ¨åº«ä¸­';

            if (!receiveDate) {
                alert('å…¥åº«æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            item.receiveDate = receiveDate;
            item.status = newStatus;
            
            saveData();
            closeModal('receiveModal');
            renderMain();
            
            const statusText = newStatus === 'æ¤œå“å¾…ã¡' ? 'ğŸ” æ¤œå“å¾…ã¡ã«è¨­å®š' : 'âœ… åœ¨åº«ã«è¿½åŠ ';
            showStatus(`${statusText}: ${item.serial || item.productName}`, 'success');
            
            // åœ¨åº«ä¸­ã®å ´åˆã®ã¿ã€åŒã˜æ¡ˆä»¶ã®å…¨ã‚¢ã‚¤ãƒ†ãƒ ãŒå…¥åº«æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (newStatus === 'åœ¨åº«ä¸­') {
                const projectNumber = formatProjectNumber(item.orderPrefix, item.orderNumber);
                if (projectNumber) {
                    await checkAndUpdateProcurement(projectNumber);
                }
            }
        }
        
        // å…¨å°å…¥åº«ãƒã‚§ãƒƒã‚¯ â†’ èª¿é”ã‚·ãƒ¼ãƒˆæ›´æ–°
        async function checkAndUpdateProcurement(projectNumber) {
            try {
                // åŒã˜æ¡ˆä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
                const projectItems = inventory.filter(i => 
                    formatProjectNumber(i.orderPrefix, i.orderNumber) === projectNumber
                );
                
                // å…¨ã¦ã€Œåœ¨åº«ä¸­ã€ã¾ãŸã¯ã€Œå‡ºåº«æ¸ˆã€ã‹ç¢ºèª
                const allReceived = projectItems.every(i => 
                    i.status === 'åœ¨åº«ä¸­' || i.status === 'å‡ºåº«æ¸ˆ'
                );
                
                if (!allReceived || projectItems.length === 0) return;
                
                // èª¿é”ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A2:N',
                });
                const rows = response.result.values || [];
                
                // è©²å½“æ¡ˆä»¶ã‚’æ¤œç´¢
                const parsed = parseProjectNumberString(projectNumber);
                let rowIndex = -1;
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row[1] === parsed.prefix && parseInt(row[2]) === parseInt(parsed.number)) {
                        rowIndex = i + 2; // 1-indexed + ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                        break;
                    }
                }
                
                if (rowIndex === -1) return;
                
                // Nåˆ—ï¼ˆå…¥åº«å®Œäº†ï¼‰ã‚’æ›´æ–°
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `æ¡ˆä»¶!N${rowIndex}`,
                    valueInputOption: 'RAW',
                    resource: { values: [['true']] }
                });
                
                showStatus(`âœ… ${projectNumber} å…¨å°å…¥åº«å®Œäº† â†’ èª¿é”ã«åæ˜ `);
                setTimeout(() => showStatus(''), 3000);
                
            } catch (err) {
                console.error('èª¿é”ã‚·ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        // å‡ºåº«ãƒ¢ãƒ¼ãƒ€ãƒ«
        // é…é€æ¥­è€…ãƒªã‚¹ãƒˆ
        const CARRIERS = ['è¥¿æ¿ƒé‹è¼¸', 'ãƒ¤ãƒãƒˆé‹è¼¸', 'ä½å·æ€¥ä¾¿', 'ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿', 'ãã®ä»–'];

        function showShipModal(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'shipModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">å‡ºåº«å‡¦ç†</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">Serial: <span class="font-mono font-semibold">${item.serial || "-"}</span></p>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">${item.productName}</p>
                        
                        <div class="space-y-4">
                            <!-- å‡ºåº«æ–¹æ³• -->
                            <div>
                                <label class="block text-sm font-semibold mb-2 dark:text-slate-300">å‡ºåº«æ–¹æ³•</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="shipMethod" value="delivery" checked onchange="toggleShipMethod()">
                                        <span class="dark:text-white">ğŸ“¦ é…é€</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="shipMethod" value="pickup" onchange="toggleShipMethod()">
                                        <span class="dark:text-white">ğŸ¤ å¼•æ¸¡ã—</span>
                                    </label>
                                </div>
                            </div>

                            <!-- é…é€ã®å ´åˆ -->
                            <div id="deliveryFields">
                                <div class="mb-3">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">é…é€æ¥­è€…</label>
                                    <select id="shipCarrier" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        ${CARRIERS.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">é€ã‚ŠçŠ¶ç•ªå·</label>
                                    <input type="text" id="shipTrackingNo" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="è¿½è·¡ç•ªå·ã‚’å…¥åŠ›">
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å±Šã‘å…ˆ</label>
                                    <input type="text" id="shipDestination" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="ä¼šç¤¾åãƒ»æ‹…å½“è€…ãƒ»ä½æ‰€ãªã©">
                                </div>
                            </div>

                            <!-- å¼•æ¸¡ã—ã®å ´åˆ -->
                            <div id="pickupFields" class="hidden">
                                <div class="mb-3">
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å¼•æ¸¡ã—å…ˆ</label>
                                    <input type="text" id="shipPickupTo" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="æ–½å·¥æ¥­è€…åãªã©">
                                </div>
                            </div>

                            <!-- å…±é€š -->
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå· <span class="text-red-500">*</span></label>
                                <input type="text" id="shipProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${formatProjectNumber(item.orderPrefix, item.orderNumber) || ''}" placeholder="AD-1700">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«æ—¥</label>
                                <input type="date" id="shipDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${today}">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('shipModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitShip('${id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å‡ºåº«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ç¤¾å†…ä½¿ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showInternalUseModal(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'internalUseModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ¢ ç¤¾å†…ä½¿ç”¨</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">Serial: <span class="font-mono font-semibold">${item.serial || "-"}</span></p>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">${item.productName}</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ä½¿ç”¨æ—¥</label>
                                <input type="date" id="internalUseDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${today}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç”¨é€”ãƒ»å‚™è€ƒ</label>
                                <input type="text" id="internalUseNote" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.note || ''}" placeholder="ä¾‹ï¼šå€‰åº«å‚™å“ã€ãƒ‡ãƒ¢æ©Ÿã€æ¤œè¨¼ç”¨ãªã©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ä¿ç®¡å ´æ‰€</label>
                                <select id="internalUseLocation" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    ${LOCATIONS.map(loc => `<option value="${loc}" ${item.location === loc ? 'selected' : ''}>${loc}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('internalUseModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitInternalUse('${id}')" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">ç¤¾å†…ä½¿ç”¨ã«å¤‰æ›´</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ç¤¾å†…ä½¿ç”¨å‡¦ç†
        function submitInternalUse(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            const useDate = document.getElementById('internalUseDate').value;
            const note = document.getElementById('internalUseNote').value.trim();
            const location = document.getElementById('internalUseLocation').value;

            item.status = 'ç¤¾å†…ä½¿ç”¨';
            item.shipDate = useDate;
            item.note = note;
            item.location = location;

            closeModal('internalUseModal');
            saveData();
            renderMain();
            showStatus('âœ… ç¤¾å†…ä½¿ç”¨ã«å¤‰æ›´ã—ã¾ã—ãŸ');
            setTimeout(() => showStatus(''), 3000);
        }

        // å»ƒæ£„ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showDisposeModal(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'disposeModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ—‘ï¸ å»ƒæ£„å‡¦ç†</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">Serial: <span class="font-mono font-semibold">${item.serial || "-"}</span></p>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">${item.productName}</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å»ƒæ£„æ—¥</label>
                                <input type="date" id="disposeDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${today}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å»ƒæ£„ç†ç”±</label>
                                <select id="disposeReason" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="æ•…éšœãƒ»ä¿®ç†ä¸å¯">æ•…éšœãƒ»ä¿®ç†ä¸å¯</option>
                                    <option value="çµŒå¹´åŠ£åŒ–">çµŒå¹´åŠ£åŒ–</option>
                                    <option value="ç ´æ">ç ´æ</option>
                                    <option value="è¿”å“ä¸å¯">è¿”å“ä¸å¯</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‚™è€ƒ</label>
                                <input type="text" id="disposeNote" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.note || ''}" placeholder="è©³ç´°ãªç†ç”±ãªã©">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('disposeModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitDispose('${id}')" class="flex-1 px-4 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">å»ƒæ£„ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // å»ƒæ£„å‡¦ç†
        function submitDispose(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            const disposeDate = document.getElementById('disposeDate').value;
            const disposeReason = document.getElementById('disposeReason').value;
            const disposeNote = document.getElementById('disposeNote').value.trim();

            item.status = 'å»ƒæ£„';
            item.shipDate = disposeDate;
            item.note = disposeReason + (disposeNote ? `: ${disposeNote}` : '');

            closeModal('disposeModal');
            saveData();
            renderMain();
            showStatus('âœ… å»ƒæ£„å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
            setTimeout(() => showStatus(''), 3000);
        }

        function toggleShipMethod() {
            const method = document.querySelector('input[name="shipMethod"]:checked').value;
            document.getElementById('deliveryFields').classList.toggle('hidden', method !== 'delivery');
            document.getElementById('pickupFields').classList.toggle('hidden', method !== 'pickup');
        }

        function submitShip(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            const shipProject = document.getElementById('shipProject').value.trim();
            const shipDate = document.getElementById('shipDate').value;
            const method = document.querySelector('input[name="shipMethod"]:checked').value;

            if (!shipProject) {
                alert('å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const parsedShip = parseProjectNumberString(shipProject);
            item.shipPrefix = parsedShip.prefix;
            item.shipNumber = parsedShip.number;
            item.shipDate = shipDate;
            item.shipMethod = method;

            if (method === 'delivery') {
                item.shipCarrier = document.getElementById('shipCarrier').value;
                item.shipTrackingNo = document.getElementById('shipTrackingNo').value.trim();
                item.shipDestination = document.getElementById('shipDestination').value.trim();
                item.status = 'å‡ºåº«æ¸ˆ';
            } else {
                item.shipPickupTo = document.getElementById('shipPickupTo').value.trim();
                item.status = 'å‡ºåº«æ¸ˆ';
            }
            
            saveData();
            closeModal('shipModal');
            renderMain();
        }

        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ3ã‚¿ãƒ–ï¼šè©³ç´°ãƒ»ã‚¹ãƒšãƒƒã‚¯ãƒ»ç·¨é›†ï¼‰
        function showDetailModal(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            // è£½å“ãƒã‚¹ã‚¿ã‹ã‚‰ã‚¹ãƒšãƒƒã‚¯æƒ…å ±ã‚’å–å¾—
            const spec = findProductSpec(item.productName);
            const specHtml = spec ? generateSpecHtml(spec) : '<p class="text-slate-500 dark:text-slate-400 text-sm">è£½å“ãƒã‚¹ã‚¿ã«è©²å½“ã™ã‚‹ã‚¹ãƒšãƒƒã‚¯æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';

            const modal = document.createElement('div');
            modal.id = 'detailModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-1 dark:text-white">${item.productName}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Serial: <span class="font-mono font-semibold">${item.serial || "-"}</span></p>
                        
                        <!-- ã‚¿ãƒ–åˆ‡æ›¿ -->
                        <div class="flex border-b dark:border-slate-600 mb-4">
                            <button onclick="switchDetailTab('detail')" id="detailTabDetail" class="px-4 py-2 text-sm font-semibold border-b-2 border-blue-600 text-blue-600">è©³ç´°</button>
                            <button onclick="switchDetailTab('spec')" id="detailTabSpec" class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700 dark:text-slate-400">ã‚¹ãƒšãƒƒã‚¯</button>
                            <button onclick="switchDetailTab('edit')" id="detailTabEdit" class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700 dark:text-slate-400">ç·¨é›†</button>
                        </div>
                        
                        <!-- è©³ç´°ã‚¿ãƒ– -->
                        <div id="detailContentDetail">
                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-4">
                                <table class="w-full text-sm">
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400 w-1/3">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</td>
                                        <td class="py-2 dark:text-white"><span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span></td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">ç¨®åˆ¥</td>
                                        <td class="py-2 dark:text-white font-medium">${item.category}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">æ£šç•ª</td>
                                        <td class="py-2 dark:text-white font-medium">${item.shelfNo || 'æœªè¨­å®š'}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">ä¿ç®¡å ´æ‰€</td>
                                        <td class="py-2 dark:text-white font-medium">${item.location || 'è“®ç”°'}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">ç™ºæ³¨æ¡ˆä»¶</td>
                                        <td class="py-2 dark:text-white font-medium">${formatProjectNumber(item.orderPrefix, item.orderNumber) || '-'}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</td>
                                        <td class="py-2 dark:text-white font-medium">${getSupplierName(item.supplierId)}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">ç™ºæ³¨æ—¥</td>
                                        <td class="py-2 dark:text-white">${item.orderDate || '-'}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">å…¥åº«æ—¥</td>
                                        <td class="py-2 dark:text-white">${item.receiveDate || '-'}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">å–å¾—é‡‘ï¼ˆç¨åˆ¥ï¼‰</td>
                                        <td class="py-2 dark:text-white font-semibold">${item.costJPY ? 'Â¥' + Number(item.costJPY).toLocaleString() : '-'}</td>
                                    </tr>
                                    ${item.status === 'å‡ºåº«æ¸ˆ' ? `
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">å‡ºåº«æ—¥</td>
                                        <td class="py-2 dark:text-white">${item.shipDate || '-'}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">å‡ºåº«å…ˆæ¡ˆä»¶</td>
                                        <td class="py-2 dark:text-white font-medium">${formatProjectNumber(item.shipPrefix, item.shipNumber) || '-'}</td>
                                    </tr>
                                    ${item.shipMethod === 'delivery' ? `
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">é…é€æ¥­è€…</td>
                                        <td class="py-2 dark:text-white">${item.shipCarrier || '-'}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">é€ã‚ŠçŠ¶ç•ªå·</td>
                                        <td class="py-2 dark:text-white font-mono">${item.shipTrackingNo ? getTrackingLink(item.shipCarrier, item.shipTrackingNo) : '-'}</td>
                                    </tr>
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">å±Šã‘å…ˆ</td>
                                        <td class="py-2 dark:text-white">${item.shipDestination || '-'}</td>
                                    </tr>
                                    ` : ''}
                                    ${item.shipMethod === 'pickup' ? `
                                    <tr class="border-b border-slate-200 dark:border-slate-600">
                                        <td class="py-2 text-slate-500 dark:text-slate-400">å¼•æ¸¡ã—å…ˆ</td>
                                        <td class="py-2 dark:text-white">${item.shipPickupTo || '-'}</td>
                                    </tr>
                                    ` : ''}
                                    ` : ''}
                                    ${item.note ? `
                                    <tr>
                                        <td class="py-2 text-slate-500 dark:text-slate-400">å‚™è€ƒ</td>
                                        <td class="py-2 dark:text-white">${item.note}</td>
                                    </tr>
                                    ` : ''}
                                </table>
                            </div>
                        </div>
                        
                        <!-- ã‚¹ãƒšãƒƒã‚¯ã‚¿ãƒ– -->
                        <div id="detailContentSpec" class="hidden">
                            ${specHtml}
                        </div>
                        
                        <!-- ç·¨é›†ã‚¿ãƒ– -->
                        <div id="detailContentEdit" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">Serial</label>
                                <input type="text" id="detailEditSerial" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.serial}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç¨®åˆ¥</label>
                                    <select id="detailEditCategory" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        ${CATEGORIES.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                    <select id="detailEditStatus" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        ${STATUSES.map(s => `<option value="${s}" ${item.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è£½å“å</label>
                                <input type="text" id="detailEditProductName" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.productName}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ£šç•ª</label>
                                    <select id="detailEditShelfNo" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">æœªè¨­å®š</option>
                                        ${SHELF_NUMBERS.map(n => `<option value="${n}" ${item.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ä¿ç®¡å ´æ‰€</label>
                                    <select id="detailEditLocation" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="" ${!item.location || item.location === 'è“®ç”°' ? 'selected' : ''}>è“®ç”°</option>
                                        <option value="æ±äº¬" ${item.location === 'æ±äº¬' ? 'selected' : ''}>æ±äº¬</option>
                                        <option value="å¤§é˜ª" ${item.location === 'å¤§é˜ª' ? 'selected' : ''}>å¤§é˜ª</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç™ºæ³¨æ¡ˆä»¶</label>
                                    <input type="text" id="detailEditOrderProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${formatProjectNumber(item.orderPrefix, item.orderNumber)}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</label>
                                    <select id="detailEditSupplierId" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">æœªè¨­å®š</option>
                                        ${suppliers.map(s => `<option value="${s.id}" ${String(item.supplierId) === String(s.id) ? 'selected' : ''}>${s.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç™ºæ³¨æ—¥</label>
                                <input type="date" id="detailEditOrderDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.orderDate}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å…¥åº«æ—¥</label>
                                    <input type="date" id="detailEditReceiveDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.receiveDate}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å–å¾—é‡‘ï¼ˆç¨åˆ¥å††ï¼‰</label>
                                    <input type="number" id="detailEditCostJPY" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.costJPY || ''}">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«æ—¥</label>
                                    <input type="date" id="detailEditShipDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.shipDate}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«å…ˆæ¡ˆä»¶</label>
                                    <input type="text" id="detailEditShipProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${formatProjectNumber(item.shipPrefix, item.shipNumber)}">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‚™è€ƒ</label>
                                <textarea id="detailEditNote" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" rows="2">${item.note}</textarea>
                            </div>
                            <div class="flex gap-3 pt-2">
                                <button onclick="deleteItem('${id}');closeModal('detailModal')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">å‰Šé™¤</button>
                                <button onclick="submitDetailEdit('${id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6" id="detailCloseBtn">
                            <button onclick="closeModal('detailModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ãƒ–åˆ‡æ›¿
        function switchDetailTab(tab) {
            const tabs = ['detail', 'spec', 'edit'];
            tabs.forEach(t => {
                const tabBtn = document.getElementById(`detailTab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                const content = document.getElementById(`detailContent${t.charAt(0).toUpperCase() + t.slice(1)}`);
                if (t === tab) {
                    tabBtn.className = 'px-4 py-2 text-sm font-semibold border-b-2 border-blue-600 text-blue-600';
                    content.classList.remove('hidden');
                } else {
                    tabBtn.className = 'px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700 dark:text-slate-400';
                    content.classList.add('hidden');
                }
            });
            // ç·¨é›†ã‚¿ãƒ–ã®æ™‚ã¯é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('detailCloseBtn').style.display = tab === 'edit' ? 'none' : 'flex';
        }

        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã®ç·¨é›†ä¿å­˜
        async function submitDetailEdit(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            item.serial = document.getElementById('detailEditSerial').value.trim();
            item.category = document.getElementById('detailEditCategory').value;
            item.status = document.getElementById('detailEditStatus').value;
            item.productName = document.getElementById('detailEditProductName').value.trim();
            item.shelfNo = document.getElementById('detailEditShelfNo').value;
            item.location = document.getElementById('detailEditLocation').value;
            
            const orderProjectInput = document.getElementById('detailEditOrderProject').value.trim();
            const parsedOrder = parseProjectNumberString(orderProjectInput);
            item.orderPrefix = parsedOrder.prefix;
            item.orderNumber = parsedOrder.number;
            
            item.orderDate = document.getElementById('detailEditOrderDate').value;
            item.supplierId = document.getElementById('detailEditSupplierId').value;
            item.receiveDate = document.getElementById('detailEditReceiveDate').value;
            item.costJPY = document.getElementById('detailEditCostJPY').value;
            item.shipDate = document.getElementById('detailEditShipDate').value;
            
            const shipProjectInput = document.getElementById('detailEditShipProject').value.trim();
            const parsedShip = parseProjectNumberString(shipProjectInput);
            item.shipPrefix = parsedShip.prefix;
            item.shipNumber = parsedShip.number;
            
            item.note = document.getElementById('detailEditNote').value.trim();

            await saveData();
            closeModal('detailModal');
            renderMain();
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function editItem(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            // è£½å“ãƒã‚¹ã‚¿ã‹ã‚‰ã‚¹ãƒšãƒƒã‚¯æƒ…å ±ã‚’å–å¾—
            const spec = findProductSpec(item.productName);
            const specHtml = spec ? generateSpecHtml(spec) : '<p class="text-slate-500 text-sm">è£½å“ãƒã‚¹ã‚¿ã«è©²å½“ã™ã‚‹ã‚¹ãƒšãƒƒã‚¯æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';

            const modal = document.createElement('div');
            modal.id = 'editModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-2 dark:text-white">${item.productName}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Serial: ${item.serial || "-"}</p>
                        
                        <!-- ã‚¿ãƒ–åˆ‡æ›¿ -->
                        <div class="flex border-b mb-4">
                            <button onclick="switchEditTab('info')" id="tabInfo" class="px-4 py-2 text-sm font-semibold border-b-2 border-blue-600 text-blue-600">åŸºæœ¬æƒ…å ±</button>
                            <button onclick="switchEditTab('spec')" id="tabSpec" class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700 dark:text-slate-400">ã‚¹ãƒšãƒƒã‚¯</button>
                        </div>
                        
                        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
                        <div id="editTabInfo" class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">Serial</label>
                                <input type="text" id="editSerial" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.serial}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç¨®åˆ¥</label>
                                <select id="editCategory" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    ${CATEGORIES.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è£½å“å</label>
                                <input type="text" id="editProductName" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.productName}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ£šç•ª</label>
                                    <select id="editShelfNo" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">æœªè¨­å®š</option>
                                        ${SHELF_NUMBERS.map(n => `<option value="${n}" ${item.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ä¿ç®¡å ´æ‰€</label>
                                    <select id="editLocation" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="" ${!item.location || item.location === 'è“®ç”°' ? 'selected' : ''}>è“®ç”°</option>
                                        <option value="æ±äº¬" ${item.location === 'æ±äº¬' ? 'selected' : ''}>æ±äº¬</option>
                                        <option value="å¤§é˜ª" ${item.location === 'å¤§é˜ª' ? 'selected' : ''}>å¤§é˜ª</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç™ºæ³¨æ¡ˆä»¶</label>
                                    <input type="text" id="editOrderProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${formatProjectNumber(item.orderPrefix, item.orderNumber)}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</label>
                                    <select id="editSupplierId" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">æœªè¨­å®š</option>
                                        ${suppliers.map(s => `<option value="${s.id}" ${String(item.supplierId) === String(s.id) ? 'selected' : ''}>${s.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç™ºæ³¨æ—¥</label>
                                <input type="date" id="editOrderDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.orderDate}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å…¥åº«æ—¥</label>
                                    <input type="date" id="editReceiveDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.receiveDate}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å–å¾—é‡‘ï¼ˆç¨åˆ¥å††ï¼‰</label>
                                    <input type="number" id="editCostJPY" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.costJPY || ''}">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="editStatus" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    ${STATUSES.map(s => `<option value="${s}" ${item.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«æ—¥</label>
                                    <input type="date" id="editShipDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${item.shipDate}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«å…ˆæ¡ˆä»¶</label>
                                    <input type="text" id="editShipProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${formatProjectNumber(item.shipPrefix, item.shipNumber)}">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‚™è€ƒ</label>
                                <textarea id="editNote" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" rows="2">${item.note}</textarea>
                            </div>
                        </div>
                        
                        <!-- ã‚¹ãƒšãƒƒã‚¯ã‚¿ãƒ– -->
                        <div id="editTabSpec" class="hidden">
                            ${specHtml}
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('editModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="deleteItem('${id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">å‰Šé™¤</button>
                            <button onclick="submitEdit('${id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ã‚¿ãƒ–åˆ‡æ›¿
        function switchEditTab(tab) {
            const tabInfo = document.getElementById('tabInfo');
            const tabSpec = document.getElementById('tabSpec');
            const contentInfo = document.getElementById('editTabInfo');
            const contentSpec = document.getElementById('editTabSpec');
            
            if (tab === 'info') {
                tabInfo.className = 'px-4 py-2 text-sm font-semibold border-b-2 border-blue-600 text-blue-600';
                tabSpec.className = 'px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700 dark:text-slate-400';
                contentInfo.classList.remove('hidden');
                contentSpec.classList.add('hidden');
            } else {
                tabInfo.className = 'px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700 dark:text-slate-400';
                tabSpec.className = 'px-4 py-2 text-sm font-semibold border-b-2 border-blue-600 text-blue-600';
                contentInfo.classList.add('hidden');
                contentSpec.classList.remove('hidden');
            }
        }

        // è£½å“åã‹ã‚‰ã‚¹ãƒšãƒƒã‚¯æƒ…å ±ã‚’æ¤œç´¢
        function findProductSpec(productName) {
            if (!productName) return null;
            // è£½å“åã‹ã‚‰PNã‚’æŠ½å‡ºï¼ˆä¾‹: "YSD-ID3200Z black 32"" â†’ "YSD-ID3200Z"ï¼‰
            const pnMatch = productName.match(/^([A-Za-z0-9\-]+)/);
            if (!pnMatch) return null;
            const pn = pnMatch[1];
            return productMaster.find(p => p.pn === pn || productName.includes(p.pn));
        }

        // ã‚¹ãƒšãƒƒã‚¯æƒ…å ±ã®HTMLç”Ÿæˆ
        function generateSpecHtml(spec) {
            const rows = [];
            
            // å…±é€šé …ç›®
            if (spec.pn) rows.push(['å‹ç•ª', spec.pn]);
            if (spec.category) rows.push(['ç¨®åˆ¥', spec.category]);
            if (spec.supplier) rows.push(['ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼', spec.supplier]);
            if (spec.inch) rows.push(['ã‚¤ãƒ³ãƒ', spec.inch + '"']);
            if (spec.resolution) rows.push(['è§£åƒåº¦', spec.resolution]);
            if (spec.brightness) rows.push(['è¼åº¦', spec.brightness + 'cd/mÂ²']);
            if (spec.touch !== undefined) rows.push(['ã‚¿ãƒƒãƒ', spec.touch ? 'ã‚ã‚Š' : 'ãªã—']);
            
            // LCD/OPS/playerå›ºæœ‰
            if (spec.os) rows.push(['OS', spec.os]);
            if (spec.cpu) rows.push(['CPU', spec.cpu]);
            if (spec.gpu) rows.push(['GPU', spec.gpu]);
            if (spec.ram) rows.push(['RAM', spec.ram]);
            if (spec.rom) rows.push(['ROM', spec.rom]);
            if (spec.soc) rows.push(['SoC', spec.soc]);
            if (spec.graphics_card) rows.push(['ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯', spec.graphics_card]);
            
            // STUDIAå›ºæœ‰
            if (spec.edla_certified) rows.push(['EDLAèªè¨¼', spec.edla_certified === 'TRUE' ? 'ã‚ã‚Š' : 'ãªã—']);
            if (spec.touch_type) rows.push(['ã‚¿ãƒƒãƒæ–¹å¼', spec.touch_type]);
            if (spec.weight_net) rows.push(['é‡é‡ï¼ˆæœ¬ä½“ï¼‰', spec.weight_net]);
            if (spec.weight_gross) rows.push(['é‡é‡ï¼ˆæ¢±åŒ…ï¼‰', spec.weight_gross]);
            
            // LEDå›ºæœ‰
            if (spec.pixel_pitch) rows.push(['ãƒ”ã‚¯ã‚»ãƒ«ãƒ”ãƒƒãƒ', 'P' + spec.pixel_pitch]);
            if (spec.smd_type) rows.push(['SMD', spec.smd_type]);
            if (spec.ip_rating) rows.push(['IPç­‰ç´š', spec.ip_rating]);
            
            // ãƒãƒˆãƒªã‚¯ã‚¹å›ºæœ‰
            if (spec.input_count) rows.push(['å…¥åŠ›æ•°', spec.input_count]);
            if (spec.output_count) rows.push(['å‡ºåŠ›æ•°', spec.output_count]);
            
            // TVwallå›ºæœ‰
            if (spec.hdmi_out) rows.push(['HDMIå‡ºåŠ›', spec.hdmi_out]);
            if (spec.hdmi_in) rows.push(['HDMIå…¥åŠ›', spec.hdmi_in]);
            
            // LED_otherså›ºæœ‰
            if (spec.product_type) rows.push(['è£½å“ã‚¿ã‚¤ãƒ—', spec.product_type]);
            if (spec.detail) rows.push(['è©³ç´°', spec.detail]);
            
            // OPSå›ºæœ‰
            if (spec.usb3_amount) rows.push(['USB3.0', spec.usb3_amount + 'å€‹']);
            if (spec.usb_typec_amount) rows.push(['USB Type-C', spec.usb_typec_amount + 'å€‹']);
            if (spec.dp_out) rows.push(['DPå‡ºåŠ›', spec.dp_out]);
            
            // playerå›ºæœ‰
            if (spec.wifi) rows.push(['Wi-Fi', spec.wifi]);
            if (spec.bluetooth_version) rows.push(['Bluetooth', spec.bluetooth_version]);
            if (spec.usb2_amount) rows.push(['USB2.0', spec.usb2_amount + 'å€‹']);
            
            // dongleå›ºæœ‰
            if (spec.connector_type) rows.push(['æ¥ç¶šã‚¿ã‚¤ãƒ—', spec.connector_type]);
            if (spec.resolution_max) rows.push(['æœ€å¤§è§£åƒåº¦', spec.resolution_max]);
            if (spec.distance_max) rows.push(['æœ€å¤§è·é›¢', spec.distance_max]);
            if (spec.touchback) rows.push(['ã‚¿ãƒƒãƒãƒãƒƒã‚¯', spec.touchback === 'TRUE' ? 'å¯¾å¿œ' : 'éå¯¾å¿œ']);
            
            // ã‚¹ã‚¿ãƒ³ãƒ‰å›ºæœ‰
            if (spec.inch_65 || spec.inch_75 || spec.inch_86 || spec.inch_98 || spec.inch_110) {
                const sizes = [];
                if (spec.inch_65 === 'TRUE') sizes.push('65"');
                if (spec.inch_75 === 'TRUE') sizes.push('75"');
                if (spec.inch_86 === 'TRUE') sizes.push('86"');
                if (spec.inch_98 === 'TRUE') sizes.push('98"');
                if (spec.inch_110 === 'TRUE') sizes.push('110"');
                if (sizes.length > 0) rows.push(['å¯¾å¿œã‚µã‚¤ã‚º', sizes.join(', ')]);
            }
            if (spec.tilt_angle) rows.push(['ãƒãƒ«ãƒˆè§’åº¦', spec.tilt_angle]);
            if (spec.height) rows.push(['é«˜ã•èª¿æ•´', spec.height]);
            if (spec.electric) rows.push(['é›»å‹•', spec.electric === 'TRUE' ? 'ã‚ã‚Š' : 'ãªã—']);
            
            // é›»æºé–¢é€£
            if (spec.power_max_w) rows.push(['æœ€å¤§æ¶ˆè²»é›»åŠ›', spec.power_max_w + 'W']);
            if (spec.power_consumption) rows.push(['æ¶ˆè²»é›»åŠ›', spec.power_consumption]);
            if (spec.warranty_term) rows.push(['ä¿è¨¼æœŸé–“', spec.warranty_term]);
            
            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªãƒ³ã‚¯ç”Ÿæˆ
            let docLinks = '';
            if (spec.doc_path) {
                const baseUrl = 'https://yamato-signage.com/wp-content/uploads/';
                const datasheetUrl = `${baseUrl}${spec.doc_path}_datasheet.pdf`;
                const drawingUrl = `${baseUrl}${spec.doc_path}_drawing.pdf`;
                docLinks = `
                    <div class="flex gap-2 mt-4">
                        <a href="${datasheetUrl}" target="_blank" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm text-center rounded-lg hover:bg-blue-700">
                            ğŸ“„ ã‚«ã‚¿ãƒ­ã‚°
                        </a>
                        <a href="${drawingUrl}" target="_blank" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm text-center rounded-lg hover:bg-blue-700">
                            ğŸ“ å›³é¢
                        </a>
                    </div>
                `;
            }
            
            if (rows.length === 0 && !spec.doc_path) {
                return '<p class="text-slate-500 text-sm">ã‚¹ãƒšãƒƒã‚¯æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            return `
                <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-4">
                    ${rows.length > 0 ? `
                    <table class="w-full text-sm">
                        ${rows.map(([label, value]) => `
                            <tr class="border-b border-slate-200 dark:border-slate-600 last:border-0">
                                <td class="py-2 text-slate-500 dark:text-slate-400 w-1/3">${label}</td>
                                <td class="py-2 dark:text-white font-medium">${value}</td>
                            </tr>
                        `).join('')}
                    </table>
                    ` : ''}
                    ${docLinks}
                </div>
            `;
        }

        async function submitEdit(id) {
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            item.serial = document.getElementById('editSerial').value.trim();
            item.category = document.getElementById('editCategory').value;
            item.productName = document.getElementById('editProductName').value.trim();
            item.shelfNo = document.getElementById('editShelfNo').value;
            item.location = document.getElementById('editLocation').value;
            
            const orderProjectInput = document.getElementById('editOrderProject').value.trim();
            const parsedOrder = parseProjectNumberString(orderProjectInput);
            item.orderPrefix = parsedOrder.prefix;
            item.orderNumber = parsedOrder.number;
            
            item.orderDate = document.getElementById('editOrderDate').value;
            item.supplierId = document.getElementById('editSupplierId').value;
            item.receiveDate = document.getElementById('editReceiveDate').value;
            item.costJPY = document.getElementById('editCostJPY').value;
            item.status = document.getElementById('editStatus').value;
            item.shipDate = document.getElementById('editShipDate').value;
            
            const shipProjectInput = document.getElementById('editShipProject').value.trim();
            const parsedShip = parseProjectNumberString(shipProjectInput);
            item.shipPrefix = parsedShip.prefix;
            item.shipNumber = parsedShip.number;
            
            item.note = document.getElementById('editNote').value.trim();

            await saveData();
            closeModal('editModal');
            renderMain();
        }

        function deleteItem(id) {
            if (!confirm('ã“ã®åœ¨åº«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            inventory = inventory.filter(i => i.id !== id);
            saveData();
            closeModal('editModal');
            renderMain();
        }

        // ä¸€æ‹¬å‰Šé™¤
        async function bulkDelete() {
            const count = selectedItems.size;
            if (count === 0) return;
            
            // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®æƒ…å ±ã‚’è¡¨ç¤º
            const selectedList = Array.from(selectedItems).map(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                return item ? `${item.serial || '(ã‚·ãƒªã‚¢ãƒ«ãªã—)'} - ${item.productName || '(è£½å“åãªã—)'}` : id;
            });
            
            const confirmMsg = `ä»¥ä¸‹ã®${count}ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n${selectedList.slice(0, 10).join('\n')}${count > 10 ? `\n... ä»–${count - 10}ä»¶` : ''}\n\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`;
            
            if (!confirm(confirmMsg)) return;
            
            showStatus(`å‰Šé™¤ä¸­... (${count}ä»¶)`);
            
            // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
            const idsToDelete = new Set(selectedItems);
            inventory = inventory.filter(i => !idsToDelete.has(String(i.id)));
            
            // é¸æŠã‚’ã‚¯ãƒªã‚¢
            selectedItems.clear();
            bulkSelectMode = false;
            
            await saveData();
            renderMain();
            
            showStatus(`âœ… ${count}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            setTimeout(() => showStatus(''), 3000);
        }

        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†
        function archiveItem(id) {
            if (!confirm('ã“ã®åœ¨åº«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const item = inventory.find(i => String(i.id) === String(id));
            if (!item) return;

            archivedInventory.push(item);
            inventory = inventory.filter(i => i.id !== id);
            
            saveData();
            renderMain();
        }

        // ä¸€æ‹¬ä¿ç®¡ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰
        async function bulkArchive() {
            const count = selectedItems.size;
            if (count === 0) return;
            
            // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®æƒ…å ±ã‚’å–å¾—
            const selectedList = Array.from(selectedItems).map(id => {
                const item = inventory.find(i => String(i.id) === String(id));
                return item;
            }).filter(item => item);
            
            // å‡ºåº«æ¸ˆä»¥å¤–ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹ã‹ç¢ºèª
            const nonShippedItems = selectedList.filter(item => item.status !== 'å‡ºåº«æ¸ˆ');
            
            let confirmMsg = `${count}ä»¶ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ\n\n`;
            
            if (nonShippedItems.length > 0) {
                confirmMsg += `âš ï¸ å‡ºåº«æ¸ˆä»¥å¤–ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒ${nonShippedItems.length}ä»¶å«ã¾ã‚Œã¦ã„ã¾ã™ï¼š\n`;
                confirmMsg += nonShippedItems.slice(0, 5).map(i => `  - ${i.serial || '(ã‚·ãƒªã‚¢ãƒ«ãªã—)'}: ${i.status}`).join('\n');
                if (nonShippedItems.length > 5) {
                    confirmMsg += `\n  ... ä»–${nonShippedItems.length - 5}ä»¶`;
                }
                confirmMsg += '\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ';
            }
            
            if (!confirm(confirmMsg)) return;
            
            showStatus(`ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸­... (${count}ä»¶)`);
            
            // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•
            const idsToArchive = new Set(selectedItems);
            
            selectedList.forEach(item => {
                archivedInventory.push(item);
            });
            
            inventory = inventory.filter(i => !idsToArchive.has(String(i.id)));
            
            // é¸æŠã‚’ã‚¯ãƒªã‚¢
            selectedItems.clear();
            bulkSelectMode = false;
            
            await saveData();
            renderMain();
            
            showStatus(`âœ… ${count}ä»¶ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ`);
            setTimeout(() => showStatus(''), 3000);
        }

        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showArchiveModal() {
            const modal = document.createElement('div');
            modal.id = 'archiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸€è¦§ï¼ˆ${archivedInventory.length}ä»¶ï¼‰</h3>
                            <button onclick="closeModal('archiveModal')" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm">Serial</th>
                                        <th class="px-3 py-2 text-left text-sm">ç¨®åˆ¥</th>
                                        <th class="px-3 py-2 text-left text-sm">è£½å“å</th>
                                        <th class="px-3 py-2 text-left text-sm">ç™ºæ³¨æ¡ˆä»¶</th>
                                        <th class="px-3 py-2 text-left text-sm">å‡ºåº«å…ˆ</th>
                                        <th class="px-3 py-2 text-left text-sm">å‡ºåº«æ—¥</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${archivedInventory.length === 0 ? `
                                        <tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>
                                    ` : archivedInventory.map(item => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-3 py-2 font-mono text-sm">${item.serial || "-"}</td>
                                            <td class="px-3 py-2 text-sm">${item.category}</td>
                                            <td class="px-3 py-2 text-sm">${item.productName}</td>
                                            <td class="px-3 py-2 text-sm">${formatProjectNumber(item.orderPrefix, item.orderNumber)}</td>
                                            <td class="px-3 py-2 text-sm">${formatProjectNumber(item.shipPrefix, item.shipNumber)}</td>
                                            <td class="px-3 py-2 text-sm">${item.shipDate}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        // ==================== ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ====================

        // ãƒ¬ãƒãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
        function toggleReportMenu() {
            const menu = document.getElementById('reportMenu');
            menu.classList.toggle('hidden');
            // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            if (!menu.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeReportMenuOnClickOutside);
                }, 0);
            }
        }

        function closeReportMenuOnClickOutside(e) {
            const menu = document.getElementById('reportMenu');
            if (menu && !menu.contains(e.target) && !e.target.closest('button[onclick="toggleReportMenu()"]')) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeReportMenuOnClickOutside);
            }
        }

        // CSVå‡ºåŠ›
        function exportCSV() {
            const filtered = getFilteredInventory();
            if (filtered.length === 0) {
                alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const headers = ['Serial', 'ç¨®åˆ¥', 'è£½å“å', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€', 'ç™ºæ³¨æ¡ˆä»¶', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'å–å¾—é‡‘ï¼ˆç¨åˆ¥ï¼‰', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«å…ˆæ¡ˆä»¶', 'å‚™è€ƒ'];
            const rows = filtered.map(item => [
                item.serial,
                item.category,
                item.productName,
                item.shelfNo || '',
                item.location || 'è“®ç”°',
                formatProjectNumber(item.orderPrefix, item.orderNumber) || '',
                item.orderDate || '',
                item.receiveDate || '',
                item.costJPY || '',
                item.status,
                item.shipDate || '',
                formatProjectNumber(item.shipPrefix, item.shipNumber) || '',
                item.note || ''
            ]);

            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                .join('\n');

            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `åœ¨åº«ä¸€è¦§_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            toggleReportMenu();
        }

        // æ£šå¸ã—ãƒªã‚¹ãƒˆå°åˆ·
        function printInventoryList() {
            const inStockItems = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' || i.status === 'å…¥åº«å¾…ã¡');
            if (inStockItems.length === 0) {
                alert('åœ¨åº«ä¸­ãƒ»å…¥åº«å¾…ã¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // æ£šç•ªé †ã«ã‚½ãƒ¼ãƒˆ
            const sorted = [...inStockItems].sort((a, b) => {
                const shelfA = a.shelfNo ? parseInt(a.shelfNo) : 999;
                const shelfB = b.shelfNo ? parseInt(b.shelfNo) : 999;
                if (shelfA !== shelfB) return shelfA - shelfB;
                return a.serial.localeCompare(b.serial);
            });

            // ä¿ç®¡å ´æ‰€ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const byLocation = {};
            sorted.forEach(item => {
                const loc = item.location || 'è“®ç”°';
                if (!byLocation[loc]) byLocation[loc] = [];
                byLocation[loc].push(item);
            });

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>æ£šå¸ã—ãƒªã‚¹ãƒˆ - ${new Date().toLocaleDateString('ja-JP')}</title>
                    <style>
                        body { font-family: 'Hiragino Sans', 'Meiryo', sans-serif; padding: 20px; }
                        h1 { font-size: 18px; margin-bottom: 5px; }
                        h2 { font-size: 14px; margin: 20px 0 10px; padding: 5px; background: #f0f0f0; }
                        .date { font-size: 12px; color: #666; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px; }
                        th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
                        th { background: #f5f5f5; font-weight: bold; }
                        .check { width: 30px; text-align: center; }
                        .shelf { width: 50px; text-align: center; font-weight: bold; }
                        .serial { width: 100px; font-family: monospace; }
                        .status { width: 60px; text-align: center; }
                        .cost { text-align: right; }
                        @media print {
                            body { padding: 10px; }
                            h2 { page-break-before: auto; }
                            tr { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1>æ£šå¸ã—ãƒªã‚¹ãƒˆ</h1>
                    <div class="date">ä½œæˆæ—¥: ${new Date().toLocaleString('ja-JP')} ï¼ ç·æ•°: ${sorted.length}ä»¶</div>
                    ${Object.entries(byLocation).map(([location, items]) => `
                        <h2>${location}ï¼ˆ${items.length}ä»¶ï¼‰</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th class="check">âœ“</th>
                                    <th class="shelf">æ£šç•ª</th>
                                    <th class="serial">Serial</th>
                                    <th>ç¨®åˆ¥</th>
                                    <th>è£½å“å</th>
                                    <th class="status">çŠ¶æ…‹</th>
                                    <th class="cost">å–å¾—é‡‘</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td class="check">â˜</td>
                                        <td class="shelf">${item.shelfNo || '-'}</td>
                                        <td class="serial">${item.serial || "-"}</td>
                                        <td>${item.category}</td>
                                        <td>${item.productName}</td>
                                        <td class="status">${item.status}</td>
                                        <td class="cost">${item.costJPY ? 'Â¥' + Number(item.costJPY).toLocaleString() : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();

            toggleReportMenu();
        }

        // æœˆæ¬¡åœ¨åº«ãƒ¬ãƒãƒ¼ãƒˆ
        function showMonthlyReport() {
            toggleReportMenu();

            // éå»12ãƒ¶æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
            const months = [];
            const now = new Date();
            for (let i = 11; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
                    label: `${d.getFullYear()}/${d.getMonth() + 1}`,
                    received: 0,
                    shipped: 0,
                    receivedCost: 0
                });
            }

            // å…¥åº«ãƒ»å‡ºåº«ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            inventory.forEach(item => {
                if (item.receiveDate) {
                    const key = item.receiveDate.substring(0, 7);
                    const month = months.find(m => m.key === key);
                    if (month) {
                        month.received++;
                        month.receivedCost += Number(item.costJPY) || 0;
                    }
                }
                if (item.shipDate) {
                    const key = item.shipDate.substring(0, 7);
                    const month = months.find(m => m.key === key);
                    if (month) month.shipped++;
                }
            });

            // ç¾åœ¨ã®åœ¨åº«çŠ¶æ³
            const summary = getSummary();
            const categoryBreakdown = {};
            inventory.filter(i => i.status === 'åœ¨åº«ä¸­').forEach(item => {
                categoryBreakdown[item.category] = (categoryBreakdown[item.category] || 0) + 1;
            });

            const modal = document.createElement('div');
            modal.id = 'monthlyReportModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ“ˆ æœˆæ¬¡åœ¨åº«ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                        
                        <!-- ç¾åœ¨ã®åœ¨åº«çŠ¶æ³ -->
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-slate-600 dark:text-slate-400 mb-2">ç¾åœ¨ã®åœ¨åº«çŠ¶æ³</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-emerald-600">${summary.inStock}</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">åœ¨åº«ä¸­</p>
                                </div>
                                <div class="bg-amber-50 dark:bg-amber-900/30 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-amber-600">${summary.waiting}</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">å…¥åº«å¾…ã¡</p>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-blue-600">${summary.shipped}</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">å‡ºåº«æ¸ˆ</p>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-purple-600">Â¥${summary.inStockValue.toLocaleString()}</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">åœ¨åº«ç·é¡</p>
                                </div>
                            </div>
                        </div>

                        <!-- ç¨®åˆ¥å†…è¨³ -->
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-slate-600 dark:text-slate-400 mb-2">åœ¨åº«ä¸­ã®ç¨®åˆ¥å†…è¨³</h4>
                            <div class="flex flex-wrap gap-2">
                                ${Object.entries(categoryBreakdown).sort((a, b) => b[1] - a[1]).map(([cat, count]) => `
                                    <span class="px-3 py-1 bg-slate-100 dark:bg-slate-700 rounded-full text-sm dark:text-white">
                                        ${cat}: <strong>${count}</strong>
                                    </span>
                                `).join('')}
                            </div>
                        </div>

                        <!-- æœˆåˆ¥æ¨ç§» -->
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-slate-600 dark:text-slate-400 mb-2">æœˆåˆ¥å…¥å‡ºåº«æ¨ç§»ï¼ˆéå»12ãƒ¶æœˆï¼‰</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b dark:border-slate-600">
                                            <th class="py-2 text-left dark:text-slate-300">æœˆ</th>
                                            <th class="py-2 text-right dark:text-slate-300">å…¥åº«</th>
                                            <th class="py-2 text-right dark:text-slate-300">å‡ºåº«</th>
                                            <th class="py-2 text-right dark:text-slate-300">å·®å¼•</th>
                                            <th class="py-2 text-right dark:text-slate-300">å…¥åº«é‡‘é¡</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${months.map(m => `
                                            <tr class="border-b dark:border-slate-700">
                                                <td class="py-2 dark:text-white">${m.label}</td>
                                                <td class="py-2 text-right text-emerald-600 font-semibold">${m.received > 0 ? '+' + m.received : '-'}</td>
                                                <td class="py-2 text-right text-blue-600 font-semibold">${m.shipped > 0 ? '-' + m.shipped : '-'}</td>
                                                <td class="py-2 text-right font-semibold ${m.received - m.shipped >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                                                    ${m.received - m.shipped > 0 ? '+' : ''}${m.received - m.shipped}
                                                </td>
                                                <td class="py-2 text-right dark:text-slate-300">${m.receivedCost > 0 ? 'Â¥' + m.receivedCost.toLocaleString() : '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr class="border-t-2 dark:border-slate-500 font-bold">
                                            <td class="py-2 dark:text-white">åˆè¨ˆ</td>
                                            <td class="py-2 text-right text-emerald-600">${months.reduce((s, m) => s + m.received, 0)}</td>
                                            <td class="py-2 text-right text-blue-600">${months.reduce((s, m) => s + m.shipped, 0)}</td>
                                            <td class="py-2 text-right">${months.reduce((s, m) => s + m.received - m.shipped, 0)}</td>
                                            <td class="py-2 text-right dark:text-white">Â¥${months.reduce((s, m) => s + m.receivedCost, 0).toLocaleString()}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- ç°¡æ˜“ã‚°ãƒ©ãƒ• -->
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-slate-600 dark:text-slate-400 mb-2">å…¥å‡ºåº«ã‚°ãƒ©ãƒ•</h4>
                            <div class="space-y-2">
                                ${months.slice(-6).map(m => {
                                    const maxVal = Math.max(...months.slice(-6).map(x => Math.max(x.received, x.shipped)), 1);
                                    const receivedWidth = (m.received / maxVal * 100);
                                    const shippedWidth = (m.shipped / maxVal * 100);
                                    return `
                                        <div class="flex items-center gap-2 text-xs">
                                            <span class="w-16 dark:text-slate-300">${m.label}</span>
                                            <div class="flex-1 flex gap-1">
                                                <div class="h-4 bg-emerald-500 rounded" style="width: ${receivedWidth}%" title="å…¥åº«: ${m.received}"></div>
                                                <div class="h-4 bg-blue-500 rounded" style="width: ${shippedWidth}%" title="å‡ºåº«: ${m.shipped}"></div>
                                            </div>
                                            <span class="w-20 text-right dark:text-slate-300">+${m.received}/-${m.shipped}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="flex gap-4 mt-2 text-xs text-slate-500">
                                <span><span class="inline-block w-3 h-3 bg-emerald-500 rounded mr-1"></span>å…¥åº«</span>
                                <span><span class="inline-block w-3 h-3 bg-blue-500 rounded mr-1"></span>å‡ºåº«</span>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button onclick="closeModal('monthlyReportModal')" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ==================== QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ ====================
        let html5QrCode = null;
        let scannerModal = null;
        
        function openQRScanner() {
            // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            scannerModal = document.createElement('div');
            scannerModal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
            scannerModal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-md shadow-2xl">
                    <div class="flex justify-between items-center p-4 border-b dark:border-slate-700">
                        <h3 class="text-lg font-bold dark:text-white">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³</h3>
                        <button onclick="closeQRScanner()" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
                    </div>
                    <div class="p-4">
                        <div id="qr-reader" class="w-full rounded-lg overflow-hidden"></div>
                        <p id="scan-status" class="text-center text-sm text-slate-500 dark:text-slate-400 mt-3">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</p>
                    </div>
                    <div class="p-4 border-t dark:border-slate-700">
                        <p class="text-xs text-slate-500 dark:text-slate-400 text-center">QRã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</p>
                    </div>
                </div>
            `;
            document.body.appendChild(scannerModal);
            
            // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åˆæœŸåŒ–
            setTimeout(() => {
                html5QrCode = new Html5Qrcode("qr-reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    onScanSuccess,
                    onScanFailure
                ).catch(err => {
                    document.getElementById('scan-status').textContent = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—: ' + err;
                });
            }, 100);
        }
        
        function onScanSuccess(decodedText, decodedResult) {
            // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã®å‡¦ç†
            console.log('Scanned:', decodedText);
            
            // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åœæ­¢
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    if (scannerModal) {
                        scannerModal.remove();
                        scannerModal = null;
                    }
                    
                    // ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’å‡¦ç†
                    processScannedCode(decodedText);
                });
            }
        }
        
        function onScanFailure(error) {
            // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ï¼ˆé€šå¸¸ã¯ç„¡è¦–ï¼‰
        }
        
        function closeQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().catch(err => console.log(err));
                html5QrCode = null;
            }
            if (scannerModal) {
                scannerModal.remove();
                scannerModal = null;
            }
        }
        
        function processScannedCode(code) {
            // ã‚³ãƒ¼ãƒ‰ã‚’æ­£è¦åŒ–ï¼ˆãƒˆãƒªãƒ ã€å¤§æ–‡å­—ï¼‰
            const normalizedCode = code.trim().toUpperCase();
            console.log('æ¤œç´¢ä¸­:', normalizedCode, 'åœ¨åº«æ•°:', inventory.length);
            
            // ã¾ãšIDã§å®Œå…¨ä¸€è‡´æ¤œç´¢ï¼ˆQRã«IDãŒå…¥ã£ã¦ã„ã‚‹å ´åˆï¼‰
            const itemById = inventory.find(i => String(i.id) === code.trim());
            if (itemById) {
                showScanActionModal(itemById);
                return;
            }
            
            // ã‚·ãƒªã‚¢ãƒ«ã§å®Œå…¨ä¸€è‡´æ¤œç´¢
            const itemBySerial = inventory.find(i => {
                const serial = (i.serial || '').trim().toUpperCase();
                return serial && serial === normalizedCode;
            });
            if (itemBySerial) {
                showScanActionModal(itemBySerial);
                return;
            }
            
            // æ¡ˆä»¶ç•ªå·ã§æ¤œç´¢ï¼ˆè¤‡æ•°ãƒãƒƒãƒã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
            const itemsByProject = inventory.filter(i => {
                const projectNum = formatProjectNumber(i.orderPrefix, i.orderNumber).toUpperCase();
                return projectNum === normalizedCode;
            });
            
            if (itemsByProject.length === 1) {
                showScanActionModal(itemsByProject[0]);
                return;
            } else if (itemsByProject.length > 1) {
                // è¤‡æ•°ãƒãƒƒãƒ â†’ é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showMultiMatchModal(itemsByProject, normalizedCode);
                return;
            }
            
            // éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ï¼ˆã‚·ãƒªã‚¢ãƒ«ï¼‰
            const itemByPartial = inventory.find(i => {
                const serial = (i.serial || '').trim().toUpperCase();
                if (serial && serial.includes(normalizedCode)) return true;
                if (serial && normalizedCode.includes(serial)) return true;
                return false;
            });
            
            if (itemByPartial) {
                showScanActionModal(itemByPartial);
                return;
            }
            
            // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
            console.log('æ¤œç´¢å¤±æ•—ã€‚åœ¨åº«å†…ã‚·ãƒªã‚¢ãƒ«ä¸€è¦§:', inventory.map(i => i.serial).filter(s => s).slice(0, 20));
            alert(`ã€Œ${code}ã€ã«è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n\næ–°è¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`);
            // TODO: æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã¸
        }
        
        // è¤‡æ•°ãƒãƒƒãƒæ™‚ã®é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
        function showMultiMatchModal(items, searchCode) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.id = 'multiMatchModal';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-md shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b dark:border-slate-700 text-center">
                        <p class="text-lg font-bold text-blue-600 dark:text-blue-400">${searchCode}</p>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${items.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ - é¸æŠã—ã¦ãã ã•ã„</p>
                    </div>
                    <div class="p-4 overflow-y-auto flex-1 space-y-2">
                        ${items.map(item => `
                            <button onclick="document.getElementById('multiMatchModal').remove();showScanActionModal(inventory.find(i=>String(i.id)==='${item.id}'))" 
                                    class="w-full p-3 text-left bg-slate-50 dark:bg-slate-700 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 border dark:border-slate-600">
                                <p class="font-semibold text-slate-900 dark:text-white">${item.productName}</p>
                                <p class="text-sm text-slate-600 dark:text-slate-400">
                                    ${item.serial || 'Serialæœªè¨­å®š'} 
                                    <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${
                                        item.status === 'åœ¨åº«ä¸­' ? 'bg-emerald-100 text-emerald-700' :
                                        item.status === 'å…¥åº«å¾…ã¡' ? 'bg-amber-100 text-amber-700' :
                                        'bg-slate-200 text-slate-700'
                                    }">${item.status}</span>
                                </p>
                            </button>
                        `).join('')}
                    </div>
                    <div class="p-4 border-t dark:border-slate-700">
                        <button onclick="document.getElementById('multiMatchModal').remove()" class="w-full py-2 border dark:border-slate-600 rounded-lg text-slate-600 dark:text-slate-400">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function showScanActionModal(item) {
            const projectNumber = formatProjectNumber(item.orderPrefix, item.orderNumber) || 'æœªè¨­å®š';
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.id = 'scanActionModal';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-sm shadow-2xl">
                    <div class="p-4 border-b dark:border-slate-700 text-center">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">ã‚¹ã‚­ãƒ£ãƒ³çµæœ</p>
                        <p class="text-lg font-bold text-blue-600 dark:text-blue-400">${projectNumber}</p>
                        <p class="text-sm font-mono text-slate-700 dark:text-slate-300">${item.serial || 'Serialæœªè¨­å®š'}</p>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${item.productName}</p>
                        <span class="inline-block mt-2 px-2 py-1 text-xs rounded-full ${
                            item.status === 'åœ¨åº«ä¸­' ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300' :
                            item.status === 'å…¥åº«å¾…ã¡' ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300' :
                            'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300'
                        }">${item.status}</span>
                    </div>
                    <div class="p-4 grid grid-cols-2 gap-3">
                        ${item.status === 'å…¥åº«å¾…ã¡' ? `
                            <button onclick="closeScanActionModal();quickReceive('${item.id}')" class="flex flex-col items-center justify-center p-4 bg-emerald-100 dark:bg-emerald-900/50 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-900/70">
                                <span class="text-2xl mb-1">ğŸ“¥</span>
                                <span class="text-sm font-semibold text-emerald-700 dark:text-emerald-300">å…¥åº«</span>
                            </button>
                        ` : ''}
                        ${item.status === 'åœ¨åº«ä¸­' ? `
                            <button onclick="closeScanActionModal();quickShip('${item.id}')" class="flex flex-col items-center justify-center p-4 bg-blue-100 dark:bg-blue-900/50 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/70">
                                <span class="text-2xl mb-1">ğŸ“¤</span>
                                <span class="text-sm font-semibold text-blue-700 dark:text-blue-300">å‡ºåº«</span>
                            </button>
                        ` : ''}
                        <button onclick="closeScanActionModal();editItem('${item.id}')" class="flex flex-col items-center justify-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600">
                            <span class="text-2xl mb-1">ğŸ“‹</span>
                            <span class="text-sm font-semibold text-slate-700 dark:text-slate-300">è©³ç´°</span>
                        </button>
                        <button onclick="closeScanActionModal();markAsChecked('${item.id}')" class="flex flex-col items-center justify-center p-4 bg-purple-100 dark:bg-purple-900/50 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/70">
                            <span class="text-2xl mb-1">âœ…</span>
                            <span class="text-sm font-semibold text-purple-700 dark:text-purple-300">æ£šå¸ã—</span>
                        </button>
                        <button onclick="closeScanActionModal();printSingleLabel('${item.id}')" class="flex flex-col items-center justify-center p-4 bg-amber-100 dark:bg-amber-900/50 rounded-lg hover:bg-amber-200 dark:hover:bg-amber-900/70">
                            <span class="text-2xl mb-1">ğŸ·ï¸</span>
                            <span class="text-sm font-semibold text-amber-700 dark:text-amber-300">ãƒ©ãƒ™ãƒ«</span>
                        </button>
                        <button onclick="closeScanActionModal();openQRScanner()" class="flex flex-col items-center justify-center p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                            <span class="text-2xl mb-1">ğŸ“·</span>
                            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">ç¶šã‘ã¦</span>
                        </button>
                    </div>
                    <div class="p-4 border-t dark:border-slate-700">
                        <button onclick="closeScanActionModal()" class="w-full py-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeScanActionModal() {
            const modal = document.getElementById('scanActionModal');
            if (modal) modal.remove();
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯å…¥åº«
        function quickReceive(itemId) {
            const item = inventory.find(i => String(i.id) === String(itemId));
            if (!item) return;
            
            // å…¥åº«å…ˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
            const modal = document.createElement('div');
            modal.id = 'receiveModal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-sm shadow-2xl">
                    <div class="p-4 border-b dark:border-slate-700">
                        <h3 class="font-bold text-lg text-slate-900 dark:text-white">å…¥åº«å‡¦ç†</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${item.productName}</p>
                    </div>
                    <div class="p-4">
                        <p class="text-sm text-slate-700 dark:text-slate-300 mb-4">å…¥åº«å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠï¼š</p>
                        <div class="space-y-3">
                            <button onclick="executeReceive('${item.id}', 'æ¤œå“å¾…ã¡')" class="w-full p-4 bg-orange-100 dark:bg-orange-900/30 border-2 border-orange-300 dark:border-orange-700 rounded-xl hover:bg-orange-200 dark:hover:bg-orange-900/50 text-left">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ğŸ”</span>
                                    <div>
                                        <p class="font-bold text-orange-700 dark:text-orange-400">æ¤œå“å¾…ã¡</p>
                                        <p class="text-xs text-orange-600 dark:text-orange-500">æ¤œå“ãƒŠãƒ“ã§æ¤œå“å¾Œã«åœ¨åº«ã¸</p>
                                    </div>
                                </div>
                            </button>
                            <button onclick="executeReceive('${item.id}', 'åœ¨åº«ä¸­')" class="w-full p-4 bg-emerald-100 dark:bg-emerald-900/30 border-2 border-emerald-300 dark:border-emerald-700 rounded-xl hover:bg-emerald-200 dark:hover:bg-emerald-900/50 text-left">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">âœ…</span>
                                    <div>
                                        <p class="font-bold text-emerald-700 dark:text-emerald-400">åœ¨åº«ä¸­ï¼ˆæ¤œå“ã‚¹ã‚­ãƒƒãƒ—ï¼‰</p>
                                        <p class="text-xs text-emerald-600 dark:text-emerald-500">æ¤œå“ä¸è¦ã€ã™ãã«åœ¨åº«ã¸</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 border-t dark:border-slate-700">
                        <button onclick="document.getElementById('receiveModal').remove()" class="w-full py-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function executeReceive(itemId, newStatus) {
            const item = inventory.find(i => String(i.id) === String(itemId));
            if (!item) return;
            
            const today = new Date().toISOString().split('T')[0];
            item.status = newStatus;
            item.receiveDate = today;
            
            document.getElementById('receiveModal')?.remove();
            
            saveInventory();
            renderMain();
            
            const statusText = newStatus === 'æ¤œå“å¾…ã¡' ? 'ğŸ” æ¤œå“å¾…ã¡ã«è¨­å®š' : 'âœ… åœ¨åº«ã«è¿½åŠ ';
            showStatus(`${statusText}: ${item.serial || item.productName}`, 'success');
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯å‡ºåº«ï¼ˆå‡ºåº«å…ˆå…¥åŠ›ï¼‰
        function quickShip(itemId) {
            const item = inventory.find(i => String(i.id) === String(itemId));
            if (!item) return;
            
            const shipTo = prompt('å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ï¼ˆä¾‹: SP-0001ï¼‰:', '');
            if (shipTo === null) return;
            
            const today = new Date().toISOString().split('T')[0];
            item.status = 'å‡ºåº«æ¸ˆ';
            item.shipDate = today;
            
            // å‡ºåº«å…ˆã®è§£æ
            const match = shipTo.match(/^([A-Z]+)-?(\d+)$/i);
            if (match) {
                item.shipPrefix = match[1].toUpperCase();
                item.shipNumber = parseInt(match[2]);
            }
            
            saveInventory();
            renderMain();
            showStatus(`ğŸ“¤ ${item.serial || item.productName} ã‚’å‡ºåº«ã—ã¾ã—ãŸ`, 'success');
        }
        
        // æ£šå¸ã—ãƒã‚§ãƒƒã‚¯
        function markAsChecked(itemId) {
            showStatus(`âœ… æ£šå¸ã—ãƒã‚§ãƒƒã‚¯å®Œäº†`, 'success');
            // TODO: æ£šå¸ã—è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹å ´åˆã¯ã“ã“ã«å®Ÿè£…
        }
        
        // ==================== QRãƒ©ãƒ™ãƒ«å°åˆ·æ©Ÿèƒ½ ====================
        function showLabelPrintModal() {
            toggleReportMenu(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.id = 'labelPrintModal';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-auto">
                    <div class="flex justify-between items-center p-4 border-b dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-800">
                        <h3 class="text-lg font-bold dark:text-white">ğŸ·ï¸ QRãƒ©ãƒ™ãƒ«å°åˆ·</h3>
                        <button onclick="closeLabelPrintModal()" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
                    </div>
                    <div class="p-4">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">å°åˆ·å¯¾è±¡</label>
                            <select id="labelPrintTarget" class="w-full p-2 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white" onchange="updateLabelPreview()">
                                <option value="selected">é¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ  (${selectedItems.size}ä»¶)</option>
                                <option value="instock">åœ¨åº«ä¸­ã™ã¹ã¦</option>
                                <option value="waiting">å…¥åº«å¾…ã¡ã™ã¹ã¦</option>
                                <option value="project">æ¡ˆä»¶å˜ä½ã§é¸æŠ</option>
                            </select>
                        </div>
                        <div id="projectSelector" class="mb-4 hidden">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">æ¡ˆä»¶ã‚’é¸æŠ</label>
                            <select id="labelProjectSelect" class="w-full p-2 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white" onchange="updateLabelPreview()">
                                ${getProjectOptions()}
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">ãƒ©ãƒ™ãƒ«ã‚µã‚¤ã‚º</label>
                            <select id="labelSize" class="w-full p-2 border dark:border-slate-600 rounded-lg dark:bg-slate-700 dark:text-white">
                                <option value="84x42" selected>83.8mm Ã— 42.3mmï¼ˆA4ã‚·ãƒ¼ãƒˆ12é¢ï¼‰</option>
                                <option value="29x90">29mm Ã— 90mmï¼ˆãƒ–ãƒ©ã‚¶ãƒ¼æ¨™æº–ï¼‰</option>
                                <option value="38x90">38mm Ã— 90mmï¼ˆå¤§ãã‚ï¼‰</option>
                                <option value="50x30">50mm Ã— 30mmï¼ˆæ­£æ–¹å½¢ï¼‰</option>
                                <option value="62x29">62mm Ã— 29mmï¼ˆå¹…åºƒï¼‰</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
                            <div id="labelPreview" class="border dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-900 flex flex-wrap gap-2 justify-center">
                                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                            </div>
                            <p id="labelCount" class="text-xs text-slate-500 dark:text-slate-400 mt-2 text-center"></p>
                        </div>
                    </div>
                    <div class="p-4 border-t dark:border-slate-700 flex gap-3">
                        <button onclick="closeLabelPrintModal()" class="flex-1 py-2 border dark:border-slate-600 rounded-lg text-slate-600 dark:text-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button onclick="printLabels()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ğŸ–¨ï¸ å°åˆ·</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            document.getElementById('labelPrintTarget').addEventListener('change', function() {
                document.getElementById('projectSelector').classList.toggle('hidden', this.value !== 'project');
            });
            updateLabelPreview();
        }
        
        function getProjectOptions() {
            const projects = {};
            inventory.forEach(item => {
                const pn = formatProjectNumber(item.orderPrefix, item.orderNumber);
                if (pn && !projects[pn]) {
                    projects[pn] = { count: 0 };
                }
                if (pn) projects[pn].count++;
            });
            
            return Object.entries(projects)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .map(([pn, data]) => `<option value="${pn}">${pn} (${data.count}ä»¶)</option>`)
                .join('');
        }
        
        function updateLabelPreview() {
            const target = document.getElementById('labelPrintTarget').value;
            const items = getLabelTargetItems(target);
            const preview = document.getElementById('labelPreview');
            const countEl = document.getElementById('labelCount');
            
            if (items.length === 0) {
                preview.innerHTML = '<p class="text-slate-400 text-sm">å¯¾è±¡ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                countEl.textContent = '';
                return;
            }
            
            // æœ€åˆã®3ä»¶ã ã‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            const previewItems = items.slice(0, 3);
            preview.innerHTML = previewItems.map(item => {
                const pn = formatProjectNumber(item.orderPrefix, item.orderNumber) || '---';
                const qrContent = item.serial || pn || String(item.id);
                const qrDataUrl = generateQRDataURL(qrContent);
                return `
                    <div class="bg-white border rounded p-2 text-center" style="min-width: 100px;">
                        <img class="mx-auto mb-1" style="width:60px;height:60px;" src="${qrDataUrl}" alt="QR">
                        <p class="text-xs font-bold text-blue-600">${pn}</p>
                        <p class="text-xs font-mono truncate" style="max-width:90px;">${item.serial || '---'}</p>
                    </div>
                `;
            }).join('');
            
            countEl.textContent = `${items.length}ä»¶ã®ãƒ©ãƒ™ãƒ«ã‚’å°åˆ·ã—ã¾ã™` + (items.length > 3 ? 'ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯3ä»¶ã¾ã§ï¼‰' : '');
        }
        
        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆDataURLï¼‰
        function generateQRDataURL(content) {
            try {
                const qr = qrcode(0, 'M');
                qr.addData(content);
                qr.make();
                return qr.createDataURL(4, 0);
            } catch (e) {
                console.error('QRç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
                return 'data:image/gif;base64,R0lGODlhAQABAIAAAMLCwgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==';
            }
        }
        
        function getLabelTargetItems(target) {
            switch (target) {
                case 'selected':
                    return inventory.filter(i => selectedItems.has(String(i.id)));
                case 'instock':
                    return inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
                case 'waiting':
                    return inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡');
                case 'project':
                    const selectedProject = document.getElementById('labelProjectSelect')?.value;
                    return inventory.filter(i => formatProjectNumber(i.orderPrefix, i.orderNumber) === selectedProject);
                default:
                    return [];
            }
        }
        
        function closeLabelPrintModal() {
            const modal = document.getElementById('labelPrintModal');
            if (modal) modal.remove();
        }
        
        function printLabels() {
            const target = document.getElementById('labelPrintTarget').value;
            const items = getLabelTargetItems(target);
            const size = document.getElementById('labelSize').value;
            
            if (items.length === 0) {
                alert('å°åˆ·å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ã‚µã‚¤ã‚ºè¨­å®šï¼ˆmmï¼‰
            const sizes = {
                '84x42': { w: 83.8, h: 42.3, sheet: true, cols: 2, rows: 6 },
                '29x90': { w: 90, h: 29 },
                '38x90': { w: 90, h: 38 },
                '50x30': { w: 50, h: 30 },
                '62x29': { w: 62, h: 29 }
            };
            const labelSize = sizes[size];
            
            // å°åˆ·ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ï¼ˆQRã‚³ãƒ¼ãƒ‰ã‚’äº‹å‰ç”Ÿæˆï¼‰
            const printData = items.map(item => {
                const pn = formatProjectNumber(item.orderPrefix, item.orderNumber) || '---';
                const serial = item.serial || '---';
                const qrContent = item.serial || pn || String(item.id);
                return {
                    id: item.id,
                    serial: serial,
                    pn: pn,
                    qrDataUrl: generateQRDataURL(qrContent)
                };
            });
            
            // å°åˆ·ç”¨HTMLã‚’ç”Ÿæˆ
            const printWindow = window.open('', '_blank');
            
            // A4ã‚·ãƒ¼ãƒˆå°åˆ·ï¼ˆ12é¢ï¼‰ã®å ´åˆ
            if (labelSize.sheet) {
                const labelsPerPage = labelSize.cols * labelSize.rows; // 12
                const pages = [];
                for (let i = 0; i < printData.length; i += labelsPerPage) {
                    pages.push(printData.slice(i, i + labelsPerPage));
                }
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>QRãƒ©ãƒ™ãƒ«å°åˆ·</title>
                        <style>
                            @page { margin: 0; size: A4; }
                            * { box-sizing: border-box; }
                            body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
                            .page {
                                width: 210mm;
                                height: 297mm;
                                padding: 8.5mm 13.5mm;
                                page-break-after: always;
                            }
                            .page:last-child { page-break-after: auto; }
                            .grid {
                                display: grid;
                                grid-template-columns: repeat(${labelSize.cols}, ${labelSize.w}mm);
                                grid-template-rows: repeat(${labelSize.rows}, ${labelSize.h}mm);
                                gap: 0;
                            }
                            .label {
                                width: ${labelSize.w}mm;
                                height: ${labelSize.h}mm;
                                display: flex;
                                align-items: center;
                                padding: 3mm;
                                border: 0.5px dashed #ccc;
                            }
                            .qr-container {
                                flex-shrink: 0;
                                width: 32mm;
                                height: 32mm;
                            }
                            .qr-container img {
                                width: 100%;
                                height: 100%;
                            }
                            .text-container {
                                margin-left: 3mm;
                                overflow: hidden;
                                flex: 1;
                            }
                            .project-number {
                                font-size: 14pt;
                                font-weight: bold;
                                color: #1d4ed8;
                                margin: 0 0 2mm 0;
                            }
                            .serial {
                                font-size: 9pt;
                                font-family: monospace;
                                margin: 0;
                                color: #333;
                                word-break: break-all;
                            }
                            .empty { border: 0.5px dashed #eee; }
                            @media print {
                                .label { border: none; }
                                .empty { border: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${pages.map(pageItems => `
                            <div class="page">
                                <div class="grid">
                                    ${Array.from({length: labelsPerPage}, (_, idx) => {
                                        const item = pageItems[idx];
                                        if (item) {
                                            return `
                                                <div class="label">
                                                    <div class="qr-container">
                                                        <img src="${item.qrDataUrl}" alt="QR">
                                                    </div>
                                                    <div class="text-container">
                                                        <p class="project-number">${item.pn}</p>
                                                        <p class="serial">${item.serial}</p>
                                                    </div>
                                                </div>
                                            `;
                                        } else {
                                            return '<div class="label empty"></div>';
                                        }
                                    }).join('')}
                                </div>
                            </div>
                        `).join('')}
                        <script>
                            window.onload = function() {
                                setTimeout(() => window.print(), 200);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
            } else {
                // å˜ç¥¨å°åˆ·ï¼ˆå¾“æ¥é€šã‚Šï¼‰
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>QRãƒ©ãƒ™ãƒ«å°åˆ·</title>
                        <style>
                            @page { margin: 0; size: ${labelSize.w}mm ${labelSize.h}mm; }
                            body { margin: 0; padding: 0; }
                            .label {
                                width: ${labelSize.w}mm;
                                height: ${labelSize.h}mm;
                                page-break-after: always;
                                display: flex;
                                align-items: center;
                                padding: 2mm;
                                box-sizing: border-box;
                                font-family: 'Arial', sans-serif;
                            }
                            .qr-container {
                                flex-shrink: 0;
                                width: ${Math.min(labelSize.h - 4, 25)}mm;
                                height: ${Math.min(labelSize.h - 4, 25)}mm;
                            }
                            .qr-container img {
                                width: 100%;
                                height: 100%;
                            }
                            .text-container {
                                margin-left: 2mm;
                                overflow: hidden;
                            }
                            .project-number {
                                font-size: ${labelSize.h > 30 ? '12pt' : '10pt'};
                                font-weight: bold;
                                color: #1d4ed8;
                                margin: 0;
                            }
                            .serial {
                                font-size: ${labelSize.h > 30 ? '9pt' : '7pt'};
                                font-family: monospace;
                                margin: 1mm 0 0 0;
                                color: #333;
                            }
                        </style>
                    </head>
                    <body>
                        ${printData.map(item => `
                            <div class="label">
                                <div class="qr-container">
                                    <img src="${item.qrDataUrl}" alt="QR">
                                </div>
                                <div class="text-container">
                                    <p class="project-number">${item.pn}</p>
                                    <p class="serial">${item.serial}</p>
                                </div>
                            </div>
                        `).join('')}
                        <script>
                            window.onload = function() {
                                setTimeout(() => window.print(), 200);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
            }
            printWindow.document.close();
            
            closeLabelPrintModal();
        }
        
        // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ©ãƒ™ãƒ«å°åˆ·
        function printSingleLabel(itemId) {
            const item = inventory.find(i => String(i.id) === String(itemId));
            if (!item) return;
            
            // ä¸€æ™‚çš„ã«é¸æŠçŠ¶æ…‹ã«ã—ã¦ãƒ©ãƒ™ãƒ«å°åˆ·ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            selectedItems.clear();
            selectedItems.add(String(itemId));
            showLabelPrintModal();
        }

        // APIèª­ã¿è¾¼ã¿ç¢ºèªã¨åˆæœŸåŒ–
        function checkAndInit() {
            if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                gapiLoaded();
                gisLoaded();
            } else {
                setTimeout(checkAndInit, 100);
            }
        }
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', checkAndInit);
    </script>
</body>
</html>
