<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap');
        * { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-emerald-600 mx-auto mb-4"></div>
                <p class="text-slate-600 text-lg">ÂàùÊúüÂåñ‰∏≠...</p>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';
        const PARENT_FOLDER_ID = '1EvObQiCJgxJCzd_kQJ1PNbOUMD5P-Zxp';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let inventory = [];
        let archivedInventory = [];
        let folderCache = {};

        // Á®ÆÂà•„É™„Çπ„Éà
        const CATEGORIES = [
            '„Éû„É´„ÉÅ„Éá„Ç£„Çπ„Éó„É¨„Ç§',
            'Â±ãÂ§ñ',
            'Â±ãÂÜÖ',
            'ÈõªÂ≠êÈªíÊùø',
            '„Éû„Éà„É™„ÇØ„Çπ',
            '„É°„Éá„Ç£„Ç¢„Éó„É¨„Éº„É§„Éº',
            '„Çπ„Çø„É≥„Éâ/ÈáëÂÖ∑',
            'Âë®Ëæ∫Ê©üÂô®'
        ];

        // „Çπ„ÉÜ„Éº„Çø„Çπ„É™„Çπ„Éà
        const STATUSES = ['ÂÖ•Â∫´ÂæÖ„Å°', 'Âú®Â∫´‰∏≠', 'Âá∫Â∫´Ê∏à', '‰∏çÂÖ∑Âêà'];

        // ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø
        let currentFilters = {
            category: '',
            status: '',
            search: '',
            sort: 'orderDate-desc',
            shelfNo: '',
            receiveDateFrom: '',
            receiveDateTo: '',
            shipProject: '',
            costRange: '',
            noShelf: false,
            todayReceive: false
        };

        // Ë©≥Á¥∞„Éï„Ç£„É´„ÇøÈñãÈñâÁä∂ÊÖã
        let showDetailFilters = false;

        // Êäò„Çä„Åü„Åü„ÅøÁä∂ÊÖãÔºàÊ°à‰ª∂Áï™Âè∑„Åî„Å®Ôºâ
        let expandedProjects = {};

        // Ê£öÁï™„É™„Çπ„ÉàÔºà1„Äú30Ôºâ
        const SHELF_NUMBERS = Array.from({length: 30}, (_, i) => String(i + 1));

        // Âéü‰æ°Â∏Ø„É™„Çπ„Éà
        const COST_RANGES = [
            { value: '', label: '„Åô„Åπ„Å¶' },
            { value: '0-50000', label: '5‰∏áÂÜÜÊú™Ê∫Ä' },
            { value: '50000-100000', label: '5„Äú10‰∏áÂÜÜ' },
            { value: '100000-300000', label: '10„Äú30‰∏áÂÜÜ' },
            { value: '300000-', label: '30‰∏áÂÜÜ‰ª•‰∏ä' }
        ];

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    'https://sheets.googleapis.com/$discovery/rest?version=v4',
                    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                ],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    accessToken = resp.access_token;
                    sessionStorage.setItem('googleAccessToken', accessToken);
                    loadData();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) {
                    accessToken = savedToken;
                    gapi.client.setToken({ access_token: accessToken });
                    loadData();
                } else {
                    renderSignIn();
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = resp.access_token;
                sessionStorage.setItem('googleAccessToken', accessToken);
                await loadData();
            };

            if (accessToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            accessToken = null;
            sessionStorage.removeItem('googleAccessToken');
            gapi.client.setToken(null);
            renderSignIn();
        }

        async function findFolderUrl(projectNumber) {
            if (folderCache[projectNumber]) {
                return folderCache[projectNumber];
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name = '${projectNumber}' and '${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
                    fields: 'files(id, name, webViewLink)',
                    pageSize: 1,
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true,
                    corpora: 'allDrives'
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    const url = files[0].webViewLink;
                    folderCache[projectNumber] = url;
                    return url;
                }
                return null;
            } catch (error) {
                console.error('„Éï„Ç©„É´„ÉÄÊ§úÁ¥¢„Ç®„É©„Éº:', error);
                return null;
            }
        }

        async function loadFolderUrls() {
            const projectNumbers = [...new Set(inventory.map(i => i.orderProject).filter(p => p && p !== 'Êú™Ë®≠ÂÆö'))];
            for (const projectNumber of projectNumbers) {
                if (!folderCache[projectNumber]) {
                    await findFolderUrl(projectNumber);
                }
            }
            renderMain();
        }

        function renderSignIn() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100">
                    <div class="bg-white p-10 rounded-2xl shadow-xl max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-emerald-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-slate-800 mb-2">Âú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
                            <p class="text-slate-500 mb-8">ÂÖ•Âá∫Â∫´„ÉªÊ£öÂç∏„ÅóÁÆ°ÁêÜ</p>
                            <button onclick="handleAuthClick()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-slate-200 text-slate-700 px-6 py-4 rounded-xl font-semibold hover:bg-slate-50 hover:border-slate-300 transition-all">
                                <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                Google„Åß„É≠„Ç∞„Ç§„É≥
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        async function loadData() {
            try {
                showStatus('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
                
                // Âú®Â∫´„Ç∑„Éº„Éà„ÇíË™≠„ÅøËæº„Åø
                try {
                    const inventoryResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'Âú®Â∫´!A2:M',
                    });
                    const inventoryRows = inventoryResponse.result.values || [];
                    inventory = inventoryRows.map(row => ({
                        id: row[0] || '',
                        serial: row[1] || '',
                        category: row[2] || '',
                        productName: row[3] || '',
                        orderProject: row[4] || '',
                        orderDate: row[5] || '',
                        receiveDate: row[6] || '',
                        status: row[7] || 'ÂÖ•Â∫´ÂæÖ„Å°',
                        shipDate: row[8] || '',
                        shipProject: row[9] || '',
                        costJPY: row[10] || '',
                        note: row[11] || '',
                        shelfNo: row[12] || ''
                    }));
                } catch (e) {
                    console.log('Âú®Â∫´„Ç∑„Éº„Éà„Åå„Å™„ÅÑ„Åü„ÇÅÊñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô');
                    inventory = [];
                    await createInventorySheet();
                }

                // „Ç¢„Éº„Ç´„Ç§„Éñ„Ç∑„Éº„Éà„ÇíË™≠„ÅøËæº„Åø
                try {
                    const archiveResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'Âú®Â∫´„Ç¢„Éº„Ç´„Ç§„Éñ!A2:M',
                    });
                    const archiveRows = archiveResponse.result.values || [];
                    archivedInventory = archiveRows.map(row => ({
                        id: row[0] || '',
                        serial: row[1] || '',
                        category: row[2] || '',
                        productName: row[3] || '',
                        orderProject: row[4] || '',
                        orderDate: row[5] || '',
                        receiveDate: row[6] || '',
                        status: row[7] || '',
                        shipDate: row[8] || '',
                        shipProject: row[9] || '',
                        costJPY: row[10] || '',
                        note: row[11] || '',
                        shelfNo: row[12] || ''
                    }));
                } catch (e) {
                    console.log('„Ç¢„Éº„Ç´„Ç§„Éñ„Ç∑„Éº„Éà„Åå„Å™„ÅÑ„Åü„ÇÅÊñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô');
                    archivedInventory = [];
                    await createArchiveSheet();
                }

                showStatus('');
                renderMain();
                
                // „Éï„Ç©„É´„ÉÄURL„ÇíÈùûÂêåÊúü„ÅßË™≠„ÅøËæº„Åø
                loadFolderUrls();
            } catch (err) {
                console.error('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', err);
                showStatus('„Ç®„É©„Éº: ' + err.message);
            }
        }

        async function createInventorySheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: 'Âú®Â∫´' }
                            }
                        }]
                    }
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Âú®Â∫´!A1:M1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['ID', 'Serial', 'Á®ÆÂà•', 'Ë£ΩÂìÅÂêç', 'Áô∫Ê≥®Ê°à‰ª∂', 'Áô∫Ê≥®Êó•', 'ÂÖ•Â∫´Êó•', '„Çπ„ÉÜ„Éº„Çø„Çπ', 'Âá∫Â∫´Êó•', 'Âá∫Â∫´ÂÖàÊ°à‰ª∂', 'ÂèñÂæóÈáë(Á®éËæº)', 'ÂÇôËÄÉ', 'Ê£öÁï™']]
                    }
                });
            } catch (e) {
                console.log('„Ç∑„Éº„Éà‰ΩúÊàê„Çπ„Ç≠„ÉÉ„ÉóÔºàÊó¢Â≠ò„ÅÆÂèØËÉΩÊÄßÔºâ:', e);
            }
        }

        async function createArchiveSheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: 'Âú®Â∫´„Ç¢„Éº„Ç´„Ç§„Éñ' }
                            }
                        }]
                    }
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Âú®Â∫´„Ç¢„Éº„Ç´„Ç§„Éñ!A1:M1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['ID', 'Serial', 'Á®ÆÂà•', 'Ë£ΩÂìÅÂêç', 'Áô∫Ê≥®Ê°à‰ª∂', 'Áô∫Ê≥®Êó•', 'ÂÖ•Â∫´Êó•', '„Çπ„ÉÜ„Éº„Çø„Çπ', 'Âá∫Â∫´Êó•', 'Âá∫Â∫´ÂÖàÊ°à‰ª∂', 'ÂèñÂæóÈáë(Á®éËæº)', 'ÂÇôËÄÉ', 'Ê£öÁï™']]
                    }
                });
            } catch (e) {
                console.log('„Ç¢„Éº„Ç´„Ç§„Éñ„Ç∑„Éº„Éà‰ΩúÊàê„Çπ„Ç≠„ÉÉ„Éó:', e);
            }
        }

        async function saveData() {
            try {
                showStatus('‰øùÂ≠ò‰∏≠...');
                
                const inventoryData = [
                    ['ID', 'Serial', 'Á®ÆÂà•', 'Ë£ΩÂìÅÂêç', 'Áô∫Ê≥®Ê°à‰ª∂', 'Áô∫Ê≥®Êó•', 'ÂÖ•Â∫´Êó•', '„Çπ„ÉÜ„Éº„Çø„Çπ', 'Âá∫Â∫´Êó•', 'Âá∫Â∫´ÂÖàÊ°à‰ª∂', 'ÂèñÂæóÈáë(Á®éËæº)', 'ÂÇôËÄÉ', 'Ê£öÁï™'],
                    ...inventory.map(item => [
                        item.id,
                        item.serial,
                        item.category,
                        item.productName,
                        item.orderProject,
                        item.orderDate,
                        item.receiveDate,
                        item.status,
                        item.shipDate,
                        item.shipProject,
                        item.costJPY,
                        item.note,
                        item.shelfNo
                    ])
                ];
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Âú®Â∫´!A1',
                    valueInputOption: 'RAW',
                    resource: { values: inventoryData }
                });

                const archiveData = [
                    ['ID', 'Serial', 'Á®ÆÂà•', 'Ë£ΩÂìÅÂêç', 'Áô∫Ê≥®Ê°à‰ª∂', 'Áô∫Ê≥®Êó•', 'ÂÖ•Â∫´Êó•', '„Çπ„ÉÜ„Éº„Çø„Çπ', 'Âá∫Â∫´Êó•', 'Âá∫Â∫´ÂÖàÊ°à‰ª∂', 'ÂèñÂæóÈáë(Á®éËæº)', 'ÂÇôËÄÉ', 'Ê£öÁï™'],
                    ...archivedInventory.map(item => [
                        item.id,
                        item.serial,
                        item.category,
                        item.productName,
                        item.orderProject,
                        item.orderDate,
                        item.receiveDate,
                        item.status,
                        item.shipDate,
                        item.shipProject,
                        item.costJPY,
                        item.note,
                        item.shelfNo
                    ])
                ];
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Âú®Â∫´„Ç¢„Éº„Ç´„Ç§„Éñ!A1',
                    valueInputOption: 'RAW',
                    resource: { values: archiveData }
                });

                showStatus('‰øùÂ≠òÂÆå‰∫Ü');
                setTimeout(() => showStatus(''), 2000);
            } catch (err) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', err);
                showStatus('‰øùÂ≠ò„Ç®„É©„Éº: ' + err.message);
            }
        }

        function showStatus(message) {
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.textContent = message;
        }

        function getFilteredInventory() {
            const today = new Date().toISOString().split('T')[0];
            
            let result = inventory.filter(item => {
                if (currentFilters.category && item.category !== currentFilters.category) return false;
                if (currentFilters.status && item.status !== currentFilters.status) return false;
                if (currentFilters.shelfNo && item.shelfNo !== currentFilters.shelfNo) return false;
                
                // ÂÖ•Â∫´Êó•ÁØÑÂõ≤„Éï„Ç£„É´„Çø
                if (currentFilters.receiveDateFrom && item.receiveDate < currentFilters.receiveDateFrom) return false;
                if (currentFilters.receiveDateTo && item.receiveDate > currentFilters.receiveDateTo) return false;
                
                // Âá∫Â∫´ÂÖàÊ°à‰ª∂„Éï„Ç£„É´„Çø
                if (currentFilters.shipProject && !item.shipProject.toLowerCase().includes(currentFilters.shipProject.toLowerCase())) return false;
                
                // Âéü‰æ°Â∏Ø„Éï„Ç£„É´„Çø
                if (currentFilters.costRange) {
                    const cost = Number(item.costJPY) || 0;
                    const [min, max] = currentFilters.costRange.split('-').map(v => v ? Number(v) : null);
                    if (min !== null && cost < min) return false;
                    if (max !== null && cost >= max) return false;
                }
                
                // „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø: Ê£öÊú™Ë®≠ÂÆö
                if (currentFilters.noShelf && item.shelfNo) return false;
                
                // „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø: ‰ªäÊó•ÂÖ•Â∫´
                if (currentFilters.todayReceive && item.receiveDate !== today) return false;
                
                if (currentFilters.search) {
                    const search = currentFilters.search.toLowerCase();
                    const matchSerial = item.serial.toLowerCase().includes(search);
                    const matchProduct = item.productName.toLowerCase().includes(search);
                    const matchProject = item.orderProject.toLowerCase().includes(search) || item.shipProject.toLowerCase().includes(search);
                    if (!matchSerial && !matchProduct && !matchProject) return false;
                }
                return true;
            });

            // „ÇΩ„Éº„Éà
            const sortValue = currentFilters.sort || 'orderDate-desc';
            const parts = sortValue.split('-');
            const sortKey = parts[0];
            const sortOrder = parts[1] || 'desc';
            
            result.sort((a, b) => {
                let valA, valB;
                switch(sortKey) {
                    case 'orderDate':
                        valA = a.orderDate || '9999';
                        valB = b.orderDate || '9999';
                        break;
                    case 'serial':
                        valA = a.serial || '';
                        valB = b.serial || '';
                        break;
                    case 'project':
                        valA = a.orderProject || '';
                        valB = b.orderProject || '';
                        break;
                    default:
                        valA = a.orderDate || '9999';
                        valB = b.orderDate || '9999';
                }
                
                let comparison = valA.localeCompare(valB);
                return sortOrder === 'asc' ? comparison : -comparison;
            });

            return result;
        }

        // Ê°à‰ª∂„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
        function groupByProject(items) {
            const groups = {};
            items.forEach(item => {
                const project = item.orderProject || 'Êú™Ë®≠ÂÆö';
                if (!groups[project]) {
                    groups[project] = [];
                }
                groups[project].push(item);
            });
            return groups;
        }

        // Êäò„Çä„Åü„Åü„Åø„Éà„Ç∞„É´
        function toggleProject(project) {
            expandedProjects[project] = !expandedProjects[project];
            renderMain();
        }

        function getSummary() {
            const inStockItems = inventory.filter(i => i.status === 'Âú®Â∫´‰∏≠');
            const inStockValue = inStockItems.reduce((sum, i) => sum + (Number(i.costJPY) || 0), 0);
            return {
                total: inventory.length,
                waiting: inventory.filter(i => i.status === 'ÂÖ•Â∫´ÂæÖ„Å°').length,
                inStock: inStockItems.length,
                inStockValue: inStockValue,
                shipped: inventory.filter(i => i.status === 'Âá∫Â∫´Ê∏à').length,
                issue: inventory.filter(i => i.status === '‰∏çÂÖ∑Âêà').length
            };
        }

        function getStatusClass(status) {
            switch(status) {
                case 'ÂÖ•Â∫´ÂæÖ„Å°': return 'bg-amber-100 text-amber-700';
                case 'Âú®Â∫´‰∏≠': return 'bg-emerald-100 text-emerald-700';
                case 'Âá∫Â∫´Ê∏à': return 'bg-blue-100 text-blue-700';
                case '‰∏çÂÖ∑Âêà': return 'bg-red-100 text-red-700';
                default: return 'bg-slate-100 text-slate-700';
            }
        }

        function renderMain() {
            const summary = getSummary();
            const filtered = getFilteredInventory();
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100">
                    <header class="bg-white border-b border-slate-200 shadow-sm">
                        <div class="max-w-7xl mx-auto px-3 sm:px-6 py-3 sm:py-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-lg sm:text-2xl font-bold text-slate-900">Âú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
                                    <p class="text-xs sm:text-sm text-slate-500">ÂÖ•Âá∫Â∫´„ÉªÊ£öÂç∏„ÅóÁÆ°ÁêÜ</p>
                                </div>
                                <div class="flex items-center gap-1 sm:gap-3">
                                    <span id="status" class="text-xs sm:text-sm text-emerald-600 hidden sm:inline"></span>
                                    <a href="index.html" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700">Ë™øÈÅî</a>
                                    <button onclick="showAddInventoryModal()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-emerald-600 text-white text-xs sm:text-sm rounded-lg hover:bg-emerald-700">+ ËøΩÂä†</button>
                                    <button onclick="handleSignoutClick()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-600 text-white text-xs sm:text-sm rounded-lg hover:bg-slate-700 hidden sm:inline">„Çµ„Ç§„É≥„Ç¢„Ç¶„Éà</button>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    <main class="max-w-7xl mx-auto px-3 sm:px-6 py-4 sm:py-8">
                        <!-- „Çµ„Éû„É™„Éº -->
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 sm:gap-4 mb-4 sm:mb-6">
                            <div class="bg-emerald-50 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-emerald-200">
                                <p class="text-emerald-700 text-xs sm:text-sm">Âú®Â∫´‰∏≠</p>
                                <p class="text-lg sm:text-2xl font-bold text-emerald-600">${summary.inStock}</p>
                            </div>
                            <div class="bg-amber-50 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-amber-200">
                                <p class="text-amber-700 text-xs sm:text-sm">ÂÖ•Â∫´ÂæÖ</p>
                                <p class="text-lg sm:text-2xl font-bold text-amber-600">${summary.waiting}</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-blue-200">
                                <p class="text-blue-700 text-xs sm:text-sm">Âá∫Â∫´Ê∏à</p>
                                <p class="text-lg sm:text-2xl font-bold text-blue-600">${summary.shipped}</p>
                            </div>
                            <div class="bg-red-50 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-red-200 hidden sm:block">
                                <p class="text-red-700 text-xs sm:text-sm">‰∏çÂÖ∑Âêà</p>
                                <p class="text-lg sm:text-2xl font-bold text-red-600">${summary.issue}</p>
                            </div>
                            <div class="bg-white rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border hidden sm:block">
                                <p class="text-slate-600 text-xs sm:text-sm">Á∑èÂú®Â∫´</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900">${summary.total}</p>
                            </div>
                        </div>

                        <!-- „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø -->
                        <div class="flex flex-wrap gap-2 mb-3 sm:mb-4">
                            <button onclick="quickFilter('todayReceive')" class="px-3 py-1.5 text-xs sm:text-sm rounded-lg border ${currentFilters.todayReceive ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'}">
                                üì¶ ‰ªäÊó•ÂÖ•Â∫´
                            </button>
                            <button onclick="quickFilter('issue')" class="px-3 py-1.5 text-xs sm:text-sm rounded-lg border ${currentFilters.status === '‰∏çÂÖ∑Âêà' ? 'bg-red-600 text-white border-red-600' : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'}">
                                üî¥ ‰∏çÂÖ∑Âêà
                            </button>
                            <button onclick="quickFilter('multi')" class="px-3 py-1.5 text-xs sm:text-sm rounded-lg border ${currentFilters.category === '„Éû„É´„ÉÅ„Éá„Ç£„Çπ„Éó„É¨„Ç§' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'}">
                                üñ•Ô∏è „Éû„É´„ÉÅ
                            </button>
                            <button onclick="quickFilter('blackboard')" class="px-3 py-1.5 text-xs sm:text-sm rounded-lg border ${currentFilters.category === 'ÈõªÂ≠êÈªíÊùø' ? 'bg-slate-700 text-white border-slate-700' : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'}">
                                üìã ÈõªÂ≠êÈªíÊùø
                            </button>
                        </div>

                        <!-- Âü∫Êú¨„Éï„Ç£„É´„Çø -->
                        <div class="bg-white rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-sm border mb-4 sm:mb-6">
                            <div class="flex flex-wrap gap-2 sm:gap-4 items-end">
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 block mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                    <select id="filterStatus" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border rounded-lg">
                                        <option value="">„Åô„Åπ„Å¶</option>
                                        ${STATUSES.map(s => `<option value="${s}" ${currentFilters.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 block mb-1">Á®ÆÂà•</label>
                                    <select id="filterCategory" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border rounded-lg">
                                        <option value="">„Åô„Åπ„Å¶</option>
                                        ${CATEGORIES.map(c => `<option value="${c}" ${currentFilters.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 block mb-1">Ê£öÁï™</label>
                                    <select id="filterShelfNo" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border rounded-lg">
                                        <option value="">„Åô„Åπ„Å¶</option>
                                        ${SHELF_NUMBERS.map(n => `<option value="${n}" ${currentFilters.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 block mb-1">‰∏¶„Å≥Êõø„Åà</label>
                                    <select id="filterSort" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border rounded-lg">
                                        <option value="orderDate-desc" ${currentFilters.sort === 'orderDate-desc' ? 'selected' : ''}>Êñ∞„Åó„ÅÑÈ†Ü</option>
                                        <option value="orderDate-asc" ${currentFilters.sort === 'orderDate-asc' ? 'selected' : ''}>Âè§„ÅÑÈ†Ü</option>
                                        <option value="serial-asc" ${currentFilters.sort === 'serial-asc' ? 'selected' : ''}>SerialÈ†Ü</option>
                                        <option value="project-asc" ${currentFilters.sort === 'project-asc' ? 'selected' : ''}>Ê°à‰ª∂È†Ü</option>
                                    </select>
                                </div>
                                <button onclick="clearFilters()" class="px-3 py-1.5 sm:py-2 bg-slate-200 text-slate-700 text-sm rounded-lg hover:bg-slate-300">„ÇØ„É™„Ç¢</button>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <input type="text" id="filterSearch" value="${currentFilters.search}" onkeydown="if(event.key==='Enter'){applyFilters();event.target.blur();}" placeholder="Serial/Ë£ΩÂìÅÂêç/Ê°à‰ª∂Áï™Âè∑„ÅßÊ§úÁ¥¢" class="flex-1 px-3 py-2 text-sm border rounded-lg">
                                <button onclick="applyFilters()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">Ê§úÁ¥¢</button>
                            </div>
                            
                            <!-- Ë©≥Á¥∞„Éï„Ç£„É´„ÇøÔºàÂÄâÂ∫´ÊãÖÂΩìËÄÖÂêë„ÅëÔºâ -->
                            <div class="mt-3 border-t pt-3">
                                <button onclick="toggleDetailFilters()" class="text-xs sm:text-sm text-slate-600 hover:text-slate-800 flex items-center gap-1">
                                    <span>${showDetailFilters ? '‚ñº' : '‚ñ∂'}</span>
                                    <span>Ë©≥Á¥∞„Éï„Ç£„É´„ÇøÔºàÂÄâÂ∫´ÊãÖÂΩìËÄÖÂêë„ÅëÔºâ</span>
                                </button>
                                ${showDetailFilters ? `
                                    <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-3">
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">ÂÖ•Â∫´Êó•ÔºàÈñãÂßãÔºâ</label>
                                            <input type="date" id="filterReceiveDateFrom" value="${currentFilters.receiveDateFrom}" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">ÂÖ•Â∫´Êó•ÔºàÁµÇ‰∫ÜÔºâ</label>
                                            <input type="date" id="filterReceiveDateTo" value="${currentFilters.receiveDateTo}" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">Âá∫Â∫´ÂÖàÊ°à‰ª∂</label>
                                            <input type="text" id="filterShipProject" value="${currentFilters.shipProject}" onchange="applyFilters()" placeholder="AD-1700" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">Âéü‰æ°Â∏Ø</label>
                                            <select id="filterCostRange" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                                ${COST_RANGES.map(r => `<option value="${r.value}" ${currentFilters.costRange === r.value ? 'selected' : ''}>${r.label}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        <button onclick="quickFilter('noShelf')" class="px-3 py-1.5 text-xs sm:text-sm rounded-lg border ${currentFilters.noShelf ? 'bg-amber-600 text-white border-amber-600' : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'}">
                                            ‚ö†Ô∏è Ê£öÊú™Ë®≠ÂÆö„ÅÆ„Åø
                                        </button>
                                    </div>
                                    <!-- Âú®Â∫´Á∑èÈ°çÔºàÊ£öÂç∏„ÅóÁî®Ôºâ -->
                                    <div class="mt-3 bg-emerald-50 rounded-lg p-3 border border-emerald-200 flex justify-between items-center">
                                        <div>
                                            <p class="text-emerald-700 text-xs sm:text-sm">Âú®Â∫´Á∑èÈ°çÔºàÊ£öÂç∏„ÅóÁî®Ôºâ</p>
                                            <p class="text-lg sm:text-xl font-bold text-emerald-700">¬•${summary.inStockValue.toLocaleString()}</p>
                                        </div>
                                        <p class="text-xs sm:text-sm text-emerald-600">${summary.inStock}‰ª∂</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Âú®Â∫´„É™„Çπ„Éà -->
                        <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border overflow-hidden">
                            <div class="p-3 sm:p-4 border-b bg-slate-50 flex justify-between items-center">
                                <h2 class="font-bold text-sm sm:text-base text-slate-900">Âú®Â∫´‰∏ÄË¶ßÔºà${filtered.length}‰ª∂Ôºâ</h2>
                                <button onclick="showArchiveModal()" class="text-xs sm:text-sm text-slate-600 hover:text-slate-800">„Ç¢„Éº„Ç´„Ç§„Éñ</button>
                            </div>
                            
                            <!-- Ê°à‰ª∂„Åî„Å®Êäò„Çä„Åü„Åü„ÅøË°®Á§∫ -->
                            <div>
                                ${filtered.length === 0 ? `
                                    <div class="px-4 py-8 text-center text-slate-500 text-sm">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                                ` : (() => {
                                    const groups = groupByProject(filtered);
                                    return Object.keys(groups).map(project => {
                                        const items = groups[project];
                                        const isExpanded = expandedProjects[project];
                                        const statusCounts = {
                                            waiting: items.filter(i => i.status === 'ÂÖ•Â∫´ÂæÖ„Å°').length,
                                            inStock: items.filter(i => i.status === 'Âú®Â∫´‰∏≠').length,
                                            shipped: items.filter(i => i.status === 'Âá∫Â∫´Ê∏à').length,
                                            issue: items.filter(i => i.status === '‰∏çÂÖ∑Âêà').length
                                        };
                                        const folderUrl = folderCache[project] || null;
                                        return `
                                            <div class="border-b last:border-b-0">
                                                <div onclick="toggleProject('${project}')" class="p-3 sm:p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 active:bg-slate-100">
                                                    <div class="flex items-center gap-2 sm:gap-3">
                                                        <span class="text-slate-400">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                                        <span class="font-semibold text-blue-600 text-sm sm:text-base">${project}</span>
                                                        <span class="text-xs sm:text-sm text-slate-500">(${items.length}‰ª∂)</span>
                                                        ${folderUrl ? `
                                                            <a href="${folderUrl}" target="_blank" onclick="event.stopPropagation()" class="text-blue-500 hover:text-blue-700" title="Google„Éâ„É©„Ç§„Éñ„ÇíÈñã„Åè">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                                                            </a>
                                                        ` : (project !== 'Êú™Ë®≠ÂÆö' ? `
                                                            <span class="text-slate-300" title="„Éï„Ç©„É´„ÉÄÊú™Ê§úÂá∫">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                                                            </span>
                                                        ` : '')}
                                                    </div>
                                                    <div class="flex gap-1 sm:gap-2">
                                                        ${statusCounts.waiting > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-amber-100 text-amber-700">ÂæÖ${statusCounts.waiting}</span>` : ''}
                                                        ${statusCounts.inStock > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-emerald-100 text-emerald-700">Â∫´${statusCounts.inStock}</span>` : ''}
                                                        ${statusCounts.shipped > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">Âá∫${statusCounts.shipped}</span>` : ''}
                                                        ${statusCounts.issue > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-red-100 text-red-700">‰∏ç${statusCounts.issue}</span>` : ''}
                                                    </div>
                                                </div>
                                                ${isExpanded ? `
                                                    <!-- PC: „ÉÜ„Éº„Éñ„É´Ë°®Á§∫ -->
                                                    <div class="hidden md:block bg-slate-50 border-t">
                                                        <table class="w-full">
                                                            <thead class="bg-slate-100">
                                                                <tr>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">Serial</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">Á®ÆÂà•</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">Ë£ΩÂìÅÂêç</th>
                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700">Ê£öÁï™</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">ÂÖ•Â∫´Êó•</th>
                                                                    <th class="px-3 py-2 text-right text-xs font-semibold text-slate-700">Âéü‰æ°(Á®éËæº)</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">Âá∫Â∫´ÂÖà</th>
                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700">Êìç‰Ωú</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="divide-y bg-white">
                                                                ${items.map(item => `
                                                                    <tr class="hover:bg-slate-50">
                                                                        <td class="px-3 py-2 font-mono font-semibold text-sm text-slate-900">${item.serial}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600">${item.category}</td>
                                                                        <td class="px-3 py-2 text-xs">${item.productName}</td>
                                                                        <td class="px-3 py-2 text-center text-xs font-semibold text-purple-600">${item.shelfNo || '-'}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600">${item.receiveDate || '-'}</td>
                                                                        <td class="px-3 py-2 text-xs text-right font-semibold">${item.costJPY ? '¬•' + Number(item.costJPY).toLocaleString() : '-'}</td>
                                                                        <td class="px-3 py-2">
                                                                            <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                                        </td>
                                                                        <td class="px-3 py-2 text-xs">${item.shipProject || '-'}</td>
                                                                        <td class="px-3 py-2 text-center">
                                                                            <div class="flex gap-1 justify-center">
                                                                                ${item.status === 'ÂÖ•Â∫´ÂæÖ„Å°' ? `
                                                                                    <button onclick="event.stopPropagation();showReceiveModal('${item.id}')" class="px-2 py-1 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">ÂÖ•Â∫´</button>
                                                                                ` : ''}
                                                                                ${item.status === 'Âú®Â∫´‰∏≠' ? `
                                                                                    <button onclick="event.stopPropagation();showShipModal('${item.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Âá∫Â∫´</button>
                                                                                ` : ''}
                                                                                <button onclick="event.stopPropagation();editItem('${item.id}')" class="px-2 py-1 bg-slate-200 text-slate-700 text-xs rounded hover:bg-slate-300">Á∑®ÈõÜ</button>
                                                                                ${item.status === 'Âá∫Â∫´Ê∏à' ? `
                                                                                    <button onclick="event.stopPropagation();archiveItem('${item.id}')" class="px-2 py-1 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">‰øùÁÆ°</button>
                                                                                ` : ''}
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <!-- „Çπ„Éû„Éõ: „Ç´„Éº„ÉâË°®Á§∫ -->
                                                    <div class="md:hidden bg-slate-50">
                                                        ${items.map(item => `
                                                            <div class="p-3 border-t border-slate-200">
                                                                <div class="flex justify-between items-start mb-2">
                                                                    <div>
                                                                        <p class="font-mono font-bold text-sm text-slate-900">${item.serial}</p>
                                                                        <p class="text-xs text-slate-500">${item.category}</p>
                                                                    </div>
                                                                    <div class="flex items-center gap-2">
                                                                        ${item.shelfNo ? `<span class="px-1.5 py-0.5 rounded text-xs font-semibold bg-purple-100 text-purple-700">Ê£ö${item.shelfNo}</span>` : ''}
                                                                        <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-xs text-slate-800 mb-1">${item.productName}</p>
                                                                <div class="flex justify-between items-center text-xs text-slate-500 mb-2">
                                                                    <span>ÂÖ•Â∫´: ${item.receiveDate || '-'}</span>
                                                                    <span>Âéü‰æ°: ${item.costJPY ? '¬•' + Number(item.costJPY).toLocaleString() : '-'}</span>
                                                                </div>
                                                                <div class="flex gap-2">
                                                                    ${item.status === 'ÂÖ•Â∫´ÂæÖ„Å°' ? `
                                                                        <button onclick="event.stopPropagation();showReceiveModal('${item.id}')" class="flex-1 px-3 py-1.5 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">ÂÖ•Â∫´</button>
                                                                    ` : ''}
                                                                    ${item.status === 'Âú®Â∫´‰∏≠' ? `
                                                                        <button onclick="event.stopPropagation();showShipModal('${item.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Âá∫Â∫´</button>
                                                                    ` : ''}
                                                                    <button onclick="event.stopPropagation();editItem('${item.id}')" class="px-3 py-1.5 bg-slate-200 text-slate-700 text-xs rounded hover:bg-slate-300">Á∑®ÈõÜ</button>
                                                                    ${item.status === 'Âá∫Â∫´Ê∏à' ? `
                                                                        <button onclick="event.stopPropagation();archiveItem('${item.id}')" class="px-3 py-1.5 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">‰øùÁÆ°</button>
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function applyFilters() {
            const categoryEl = document.getElementById('filterCategory');
            const statusEl = document.getElementById('filterStatus');
            const searchEl = document.getElementById('filterSearch');
            const sortEl = document.getElementById('filterSort');
            const shelfNoEl = document.getElementById('filterShelfNo');
            const receiveDateFromEl = document.getElementById('filterReceiveDateFrom');
            const receiveDateToEl = document.getElementById('filterReceiveDateTo');
            const shipProjectEl = document.getElementById('filterShipProject');
            const costRangeEl = document.getElementById('filterCostRange');
            
            if (categoryEl) currentFilters.category = categoryEl.value;
            if (statusEl) currentFilters.status = statusEl.value;
            if (searchEl) currentFilters.search = searchEl.value;
            if (sortEl) currentFilters.sort = sortEl.value;
            if (shelfNoEl) currentFilters.shelfNo = shelfNoEl.value;
            if (receiveDateFromEl) currentFilters.receiveDateFrom = receiveDateFromEl.value;
            if (receiveDateToEl) currentFilters.receiveDateTo = receiveDateToEl.value;
            if (shipProjectEl) currentFilters.shipProject = shipProjectEl.value;
            if (costRangeEl) currentFilters.costRange = costRangeEl.value;
            renderMain();
        }

        function clearFilters() {
            currentFilters = { 
                category: '', 
                status: '', 
                search: '', 
                sort: 'orderDate-desc', 
                shelfNo: '',
                receiveDateFrom: '',
                receiveDateTo: '',
                shipProject: '',
                costRange: '',
                noShelf: false,
                todayReceive: false
            };
            expandedProjects = {};
            showDetailFilters = false;
            renderMain();
        }

        function quickFilter(type) {
            // „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø„ÅØ„Éà„Ç∞„É´Âºè
            if (type === 'todayReceive') {
                currentFilters.todayReceive = !currentFilters.todayReceive;
                currentFilters.noShelf = false;
                currentFilters.category = '';
                if (currentFilters.status === '‰∏çÂÖ∑Âêà') currentFilters.status = '';
            } else if (type === 'noShelf') {
                currentFilters.noShelf = !currentFilters.noShelf;
                currentFilters.todayReceive = false;
                currentFilters.category = '';
                if (currentFilters.status === '‰∏çÂÖ∑Âêà') currentFilters.status = '';
            } else if (type === 'issue') {
                if (currentFilters.status === '‰∏çÂÖ∑Âêà') {
                    currentFilters.status = '';
                } else {
                    currentFilters.status = '‰∏çÂÖ∑Âêà';
                }
                currentFilters.todayReceive = false;
                currentFilters.noShelf = false;
                currentFilters.category = '';
            } else if (type === 'multi') {
                if (currentFilters.category === '„Éû„É´„ÉÅ„Éá„Ç£„Çπ„Éó„É¨„Ç§') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = '„Éû„É´„ÉÅ„Éá„Ç£„Çπ„Éó„É¨„Ç§';
                }
                currentFilters.todayReceive = false;
                currentFilters.noShelf = false;
                if (currentFilters.status === '‰∏çÂÖ∑Âêà') currentFilters.status = '';
            } else if (type === 'blackboard') {
                if (currentFilters.category === 'ÈõªÂ≠êÈªíÊùø') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'ÈõªÂ≠êÈªíÊùø';
                }
                currentFilters.todayReceive = false;
                currentFilters.noShelf = false;
                if (currentFilters.status === '‰∏çÂÖ∑Âêà') currentFilters.status = '';
            }
            renderMain();
        }

        function toggleDetailFilters() {
            showDetailFilters = !showDetailFilters;
            renderMain();
        }

        // Âú®Â∫´ËøΩÂä†„É¢„Éº„ÉÄ„É´
        function showAddInventoryModal() {
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'addModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">Âú®Â∫´ËøΩÂä†</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Serial <span class="text-red-500">*</span></label>
                                <input type="text" id="addSerial" class="w-full px-3 py-2 border rounded-lg" placeholder="YS0554-1">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Á®ÆÂà• <span class="text-red-500">*</span></label>
                                <select id="addCategory" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    ${CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Ë£ΩÂìÅÂêç <span class="text-red-500">*</span></label>
                                <input type="text" id="addProductName" class="w-full px-3 py-2 border rounded-lg" placeholder="Ë£ΩÂìÅÂêç„ÇíÂÖ•Âäõ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Áô∫Ê≥®Ê°à‰ª∂Áï™Âè∑</label>
                                <input type="text" id="addOrderProject" class="w-full px-3 py-2 border rounded-lg" placeholder="AD-1682">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Áô∫Ê≥®Êó•</label>
                                <input type="date" id="addOrderDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Êï∞ÈáèÔºàË§áÊï∞Âè∞„ÅÆÂ†¥ÂêàÔºâ</label>
                                <input type="number" id="addQuantity" class="w-full px-3 py-2 border rounded-lg" value="1" min="1">
                                <p class="text-xs text-slate-500 mt-1">Ë§áÊï∞„ÅÆÂ†¥Âêà„ÄÅSerial-1, Serial-2... „Å®ÈÄ£Áï™„ÅßËøΩÂä†„Åï„Çå„Åæ„Åô</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ÂÇôËÄÉ</label>
                                <textarea id="addNote" class="w-full px-3 py-2 border rounded-lg" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('addModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="submitAddInventory()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">ËøΩÂä†</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitAddInventory() {
            const serial = document.getElementById('addSerial').value.trim();
            const category = document.getElementById('addCategory').value;
            const productName = document.getElementById('addProductName').value.trim();
            const orderProject = document.getElementById('addOrderProject').value.trim();
            const orderDate = document.getElementById('addOrderDate').value;
            const quantity = parseInt(document.getElementById('addQuantity').value) || 1;
            const note = document.getElementById('addNote').value.trim();

            if (!serial || !category || !productName) {
                alert('Serial„ÄÅÁ®ÆÂà•„ÄÅË£ΩÂìÅÂêç„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }

            for (let i = 1; i <= quantity; i++) {
                const itemSerial = quantity > 1 ? `${serial}-${i}` : serial;
                inventory.push({
                    id: Date.now().toString() + '-' + i,
                    serial: itemSerial,
                    category,
                    productName,
                    orderProject,
                    orderDate,
                    receiveDate: '',
                    status: 'ÂÖ•Â∫´ÂæÖ„Å°',
                    shipDate: '',
                    shipProject: '',
                    costJPY: '',
                    note
                });
            }

            saveData();
            closeModal('addModal');
            renderMain();
        }

        // ÂÖ•Â∫´„É¢„Éº„ÉÄ„É´
        function showReceiveModal(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'receiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4">ÂÖ•Â∫´Âá¶ÁêÜ</h3>
                        <p class="text-sm text-slate-600 mb-2">Serial: <span class="font-mono font-semibold">${item.serial}</span></p>
                        <p class="text-sm text-slate-600 mb-4">${item.productName}</p>
                        <div>
                            <label class="block text-sm font-semibold mb-1">ÂÖ•Â∫´Êó• <span class="text-red-500">*</span></label>
                            <input type="date" id="receiveDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('receiveModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="submitReceive('${id}')" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">ÂÖ•Â∫´</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitReceive(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const receiveDate = document.getElementById('receiveDate').value;

            if (!receiveDate) {
                alert('ÂÖ•Â∫´Êó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            item.receiveDate = receiveDate;
            item.status = 'Âú®Â∫´‰∏≠';
            
            saveData();
            closeModal('receiveModal');
            renderMain();
        }

        // Âá∫Â∫´„É¢„Éº„ÉÄ„É´
        function showShipModal(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'shipModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4">Âá∫Â∫´Âá¶ÁêÜ</h3>
                        <p class="text-sm text-slate-600 mb-2">Serial: <span class="font-mono font-semibold">${item.serial}</span></p>
                        <p class="text-sm text-slate-600 mb-4">${item.productName}</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Âá∫Â∫´ÂÖàÊ°à‰ª∂Áï™Âè∑ <span class="text-red-500">*</span></label>
                                <input type="text" id="shipProject" class="w-full px-3 py-2 border rounded-lg" value="${item.orderProject || ''}" placeholder="AD-1700">
                                <p class="text-xs text-slate-500 mt-1">Áô∫Ê≥®Ê°à‰ª∂„Å®Áï∞„Å™„ÇãÂ†¥Âêà„ÅØÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Âá∫Â∫´Êó•</label>
                                <input type="date" id="shipDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('shipModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="submitShip('${id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Âá∫Â∫´</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitShip(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const shipProject = document.getElementById('shipProject').value.trim();
            const shipDate = document.getElementById('shipDate').value;

            if (!shipProject) {
                alert('Âá∫Â∫´ÂÖàÊ°à‰ª∂Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            item.shipProject = shipProject;
            item.shipDate = shipDate;
            item.status = 'Âá∫Â∫´Ê∏à';
            
            saveData();
            closeModal('shipModal');
            renderMain();
        }

        // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´
        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const modal = document.createElement('div');
            modal.id = 'editModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">Âú®Â∫´Á∑®ÈõÜ</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Serial</label>
                                <input type="text" id="editSerial" class="w-full px-3 py-2 border rounded-lg" value="${item.serial}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Á®ÆÂà•</label>
                                <select id="editCategory" class="w-full px-3 py-2 border rounded-lg">
                                    ${CATEGORIES.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Ë£ΩÂìÅÂêç</label>
                                <input type="text" id="editProductName" class="w-full px-3 py-2 border rounded-lg" value="${item.productName}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Ê£öÁï™</label>
                                <select id="editShelfNo" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Êú™Ë®≠ÂÆö</option>
                                    ${SHELF_NUMBERS.map(n => `<option value="${n}" ${item.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Áô∫Ê≥®Ê°à‰ª∂Áï™Âè∑</label>
                                <input type="text" id="editOrderProject" class="w-full px-3 py-2 border rounded-lg" value="${item.orderProject}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Áô∫Ê≥®Êó•</label>
                                <input type="date" id="editOrderDate" class="w-full px-3 py-2 border rounded-lg" value="${item.orderDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ÂÖ•Â∫´Êó•</label>
                                <input type="date" id="editReceiveDate" class="w-full px-3 py-2 border rounded-lg" value="${item.receiveDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ÂèñÂæóÈáëÔºàÁ®éËæºÂÜÜÔºâ</label>
                                <input type="number" id="editCostJPY" class="w-full px-3 py-2 border rounded-lg" value="${item.costJPY || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                <select id="editStatus" class="w-full px-3 py-2 border rounded-lg">
                                    ${STATUSES.map(s => `<option value="${s}" ${item.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Âá∫Â∫´Êó•</label>
                                <input type="date" id="editShipDate" class="w-full px-3 py-2 border rounded-lg" value="${item.shipDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Âá∫Â∫´ÂÖàÊ°à‰ª∂</label>
                                <input type="text" id="editShipProject" class="w-full px-3 py-2 border rounded-lg" value="${item.shipProject}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ÂÇôËÄÉ</label>
                                <textarea id="editNote" class="w-full px-3 py-2 border rounded-lg" rows="2">${item.note}</textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('editModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="deleteItem('${id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ÂâäÈô§</button>
                            <button onclick="submitEdit('${id}')" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitEdit(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            item.serial = document.getElementById('editSerial').value.trim();
            item.category = document.getElementById('editCategory').value;
            item.productName = document.getElementById('editProductName').value.trim();
            item.shelfNo = document.getElementById('editShelfNo').value;
            item.orderProject = document.getElementById('editOrderProject').value.trim();
            item.orderDate = document.getElementById('editOrderDate').value;
            item.receiveDate = document.getElementById('editReceiveDate').value;
            item.costJPY = document.getElementById('editCostJPY').value;
            item.status = document.getElementById('editStatus').value;
            item.shipDate = document.getElementById('editShipDate').value;
            item.shipProject = document.getElementById('editShipProject').value.trim();
            item.note = document.getElementById('editNote').value.trim();

            saveData();
            closeModal('editModal');
            renderMain();
        }

        function deleteItem(id) {
            if (!confirm('„Åì„ÅÆÂú®Â∫´„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            inventory = inventory.filter(i => i.id !== id);
            saveData();
            closeModal('editModal');
            renderMain();
        }

        // „Ç¢„Éº„Ç´„Ç§„ÉñÂá¶ÁêÜ
        function archiveItem(id) {
            if (!confirm('„Åì„ÅÆÂú®Â∫´„Çí„Ç¢„Éº„Ç´„Ç§„Éñ„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            archivedInventory.push(item);
            inventory = inventory.filter(i => i.id !== id);
            
            saveData();
            renderMain();
        }

        // „Ç¢„Éº„Ç´„Ç§„Éñ‰∏ÄË¶ß„É¢„Éº„ÉÄ„É´
        function showArchiveModal() {
            const modal = document.createElement('div');
            modal.id = 'archiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">„Ç¢„Éº„Ç´„Ç§„Éñ‰∏ÄË¶ßÔºà${archivedInventory.length}‰ª∂Ôºâ</h3>
                            <button onclick="closeModal('archiveModal')" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm">Serial</th>
                                        <th class="px-3 py-2 text-left text-sm">Á®ÆÂà•</th>
                                        <th class="px-3 py-2 text-left text-sm">Ë£ΩÂìÅÂêç</th>
                                        <th class="px-3 py-2 text-left text-sm">Áô∫Ê≥®Ê°à‰ª∂</th>
                                        <th class="px-3 py-2 text-left text-sm">Âá∫Â∫´ÂÖà</th>
                                        <th class="px-3 py-2 text-left text-sm">Âá∫Â∫´Êó•</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${archivedInventory.length === 0 ? `
                                        <tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">„Ç¢„Éº„Ç´„Ç§„Éñ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>
                                    ` : archivedInventory.map(item => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-3 py-2 font-mono text-sm">${item.serial}</td>
                                            <td class="px-3 py-2 text-sm">${item.category}</td>
                                            <td class="px-3 py-2 text-sm">${item.productName}</td>
                                            <td class="px-3 py-2 text-sm">${item.orderProject}</td>
                                            <td class="px-3 py-2 text-sm">${item.shipProject}</td>
                                            <td class="px-3 py-2 text-sm">${item.shipDate}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        // APIË™≠„ÅøËæº„ÅøÁ¢∫Ë™ç„Å®ÂàùÊúüÂåñ
        function checkAndInit() {
            if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                gapiLoaded();
                gisLoaded();
            } else {
                setTimeout(checkAndInit, 100);
            }
        }
        
        // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', checkAndInit);
    </script>
</body>
</html>
