<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在庫管理システム</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap');
        * { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-emerald-600 mx-auto mb-4"></div>
                <p class="text-slate-600 text-lg">初期化中...</p>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let inventory = [];
        let archivedInventory = [];

        // 種別リスト
        const CATEGORIES = [
            'マルチディスプレイ',
            '屋外',
            '屋内',
            '電子黒板',
            'マトリクス',
            'メディアプレーヤー',
            'スタンド/金具',
            '周辺機器'
        ];

        // ステータスリスト
        const STATUSES = ['入庫待ち', '在庫中', '出庫済', '不具合'];

        // 現在のフィルタ
        let currentFilters = {
            category: '',
            status: '',
            search: '',
            sort: 'orderDate-desc',
            shelfNo: ''
        };

        // 折りたたみ状態（案件番号ごと）
        let expandedProjects = {};

        // 棚番リスト（1〜30）
        const SHELF_NUMBERS = Array.from({length: 30}, (_, i) => String(i + 1));

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    'https://sheets.googleapis.com/$discovery/rest?version=v4',
                    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                ],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    accessToken = resp.access_token;
                    sessionStorage.setItem('googleAccessToken', accessToken);
                    loadData();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) {
                    accessToken = savedToken;
                    gapi.client.setToken({ access_token: accessToken });
                    loadData();
                } else {
                    renderSignIn();
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = resp.access_token;
                sessionStorage.setItem('googleAccessToken', accessToken);
                await loadData();
            };

            if (accessToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            accessToken = null;
            sessionStorage.removeItem('googleAccessToken');
            gapi.client.setToken(null);
            renderSignIn();
        }

        function renderSignIn() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100">
                    <div class="bg-white p-10 rounded-2xl shadow-xl max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-emerald-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-slate-800 mb-2">在庫管理システム</h1>
                            <p class="text-slate-500 mb-8">デジタルサイネージ 在庫管理</p>
                            <button onclick="handleAuthClick()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-slate-200 text-slate-700 px-6 py-4 rounded-xl font-semibold hover:bg-slate-50 hover:border-slate-300 transition-all">
                                <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                Googleでログイン
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        async function loadData() {
            try {
                showStatus('データ読み込み中...');
                
                // 在庫シートを読み込み
                try {
                    const inventoryResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: '在庫!A2:M',
                    });
                    const inventoryRows = inventoryResponse.result.values || [];
                    inventory = inventoryRows.map(row => ({
                        id: row[0] || '',
                        serial: row[1] || '',
                        category: row[2] || '',
                        productName: row[3] || '',
                        orderProject: row[4] || '',
                        orderDate: row[5] || '',
                        receiveDate: row[6] || '',
                        status: row[7] || '入庫待ち',
                        shipDate: row[8] || '',
                        shipProject: row[9] || '',
                        costJPY: row[10] || '',
                        note: row[11] || '',
                        shelfNo: row[12] || ''
                    }));
                } catch (e) {
                    console.log('在庫シートがないため新規作成します');
                    inventory = [];
                    await createInventorySheet();
                }

                // アーカイブシートを読み込み
                try {
                    const archiveResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: '在庫アーカイブ!A2:M',
                    });
                    const archiveRows = archiveResponse.result.values || [];
                    archivedInventory = archiveRows.map(row => ({
                        id: row[0] || '',
                        serial: row[1] || '',
                        category: row[2] || '',
                        productName: row[3] || '',
                        orderProject: row[4] || '',
                        orderDate: row[5] || '',
                        receiveDate: row[6] || '',
                        status: row[7] || '',
                        shipDate: row[8] || '',
                        shipProject: row[9] || '',
                        costJPY: row[10] || '',
                        note: row[11] || '',
                        shelfNo: row[12] || ''
                    }));
                } catch (e) {
                    console.log('アーカイブシートがないため新規作成します');
                    archivedInventory = [];
                    await createArchiveSheet();
                }

                showStatus('');
                renderMain();
            } catch (err) {
                console.error('読み込みエラー:', err);
                showStatus('エラー: ' + err.message);
            }
        }

        async function createInventorySheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: '在庫' }
                            }
                        }]
                    }
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: '在庫!A1:M1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['ID', 'Serial', '種別', '製品名', '発注案件', '発注日', '入庫日', 'ステータス', '出庫日', '出庫先案件', '取得金(税込)', '備考', '棚番']]
                    }
                });
            } catch (e) {
                console.log('シート作成スキップ（既存の可能性）:', e);
            }
        }

        async function createArchiveSheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: '在庫アーカイブ' }
                            }
                        }]
                    }
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: '在庫アーカイブ!A1:M1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['ID', 'Serial', '種別', '製品名', '発注案件', '発注日', '入庫日', 'ステータス', '出庫日', '出庫先案件', '取得金(税込)', '備考', '棚番']]
                    }
                });
            } catch (e) {
                console.log('アーカイブシート作成スキップ:', e);
            }
        }

        async function saveData() {
            try {
                showStatus('保存中...');
                
                const inventoryData = [
                    ['ID', 'Serial', '種別', '製品名', '発注案件', '発注日', '入庫日', 'ステータス', '出庫日', '出庫先案件', '取得金(税込)', '備考', '棚番'],
                    ...inventory.map(item => [
                        item.id,
                        item.serial,
                        item.category,
                        item.productName,
                        item.orderProject,
                        item.orderDate,
                        item.receiveDate,
                        item.status,
                        item.shipDate,
                        item.shipProject,
                        item.costJPY,
                        item.note,
                        item.shelfNo
                    ])
                ];
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: '在庫!A1',
                    valueInputOption: 'RAW',
                    resource: { values: inventoryData }
                });

                const archiveData = [
                    ['ID', 'Serial', '種別', '製品名', '発注案件', '発注日', '入庫日', 'ステータス', '出庫日', '出庫先案件', '取得金(税込)', '備考', '棚番'],
                    ...archivedInventory.map(item => [
                        item.id,
                        item.serial,
                        item.category,
                        item.productName,
                        item.orderProject,
                        item.orderDate,
                        item.receiveDate,
                        item.status,
                        item.shipDate,
                        item.shipProject,
                        item.costJPY,
                        item.note,
                        item.shelfNo
                    ])
                ];
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: '在庫アーカイブ!A1',
                    valueInputOption: 'RAW',
                    resource: { values: archiveData }
                });

                showStatus('保存完了');
                setTimeout(() => showStatus(''), 2000);
            } catch (err) {
                console.error('保存エラー:', err);
                showStatus('保存エラー: ' + err.message);
            }
        }

        function showStatus(message) {
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.textContent = message;
        }

        function getFilteredInventory() {
            let result = inventory.filter(item => {
                if (currentFilters.category && item.category !== currentFilters.category) return false;
                if (currentFilters.status && item.status !== currentFilters.status) return false;
                if (currentFilters.shelfNo && item.shelfNo !== currentFilters.shelfNo) return false;
                if (currentFilters.search) {
                    const search = currentFilters.search.toLowerCase();
                    const matchSerial = item.serial.toLowerCase().includes(search);
                    const matchProduct = item.productName.toLowerCase().includes(search);
                    const matchProject = item.orderProject.toLowerCase().includes(search) || item.shipProject.toLowerCase().includes(search);
                    if (!matchSerial && !matchProduct && !matchProject) return false;
                }
                return true;
            });

            // ソート
            const sortValue = currentFilters.sort || 'orderDate-desc';
            const parts = sortValue.split('-');
            const sortKey = parts[0];
            const sortOrder = parts[1] || 'desc';
            
            result.sort((a, b) => {
                let valA, valB;
                switch(sortKey) {
                    case 'orderDate':
                        valA = a.orderDate || '9999';
                        valB = b.orderDate || '9999';
                        break;
                    case 'serial':
                        valA = a.serial || '';
                        valB = b.serial || '';
                        break;
                    case 'project':
                        valA = a.orderProject || '';
                        valB = b.orderProject || '';
                        break;
                    default:
                        valA = a.orderDate || '9999';
                        valB = b.orderDate || '9999';
                }
                
                let comparison = valA.localeCompare(valB);
                return sortOrder === 'asc' ? comparison : -comparison;
            });

            return result;
        }

        // 案件ごとにグループ化
        function groupByProject(items) {
            const groups = {};
            items.forEach(item => {
                const project = item.orderProject || '未設定';
                if (!groups[project]) {
                    groups[project] = [];
                }
                groups[project].push(item);
            });
            return groups;
        }

        // 折りたたみトグル
        function toggleProject(project) {
            expandedProjects[project] = !expandedProjects[project];
            renderMain();
        }

        function getSummary() {
            const inStockItems = inventory.filter(i => i.status === '在庫中');
            const inStockValue = inStockItems.reduce((sum, i) => sum + (Number(i.costJPY) || 0), 0);
            return {
                total: inventory.length,
                waiting: inventory.filter(i => i.status === '入庫待ち').length,
                inStock: inStockItems.length,
                inStockValue: inStockValue,
                shipped: inventory.filter(i => i.status === '出庫済').length,
                issue: inventory.filter(i => i.status === '不具合').length
            };
        }

        function getStatusClass(status) {
            switch(status) {
                case '入庫待ち': return 'bg-amber-100 text-amber-700';
                case '在庫中': return 'bg-emerald-100 text-emerald-700';
                case '出庫済': return 'bg-blue-100 text-blue-700';
                case '不具合': return 'bg-red-100 text-red-700';
                default: return 'bg-slate-100 text-slate-700';
            }
        }

        function renderMain() {
            const summary = getSummary();
            const filtered = getFilteredInventory();
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100">
                    <header class="bg-white border-b border-slate-200 shadow-sm">
                        <div class="max-w-7xl mx-auto px-3 sm:px-6 py-3 sm:py-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-lg sm:text-2xl font-bold text-slate-900">在庫管理システム</h1>
                                    <p class="text-xs sm:text-sm text-slate-500">デジタルサイネージ 在庫管理</p>
                                </div>
                                <div class="flex items-center gap-1 sm:gap-3">
                                    <span id="status" class="text-xs sm:text-sm text-emerald-600 hidden sm:inline"></span>
                                    <a href="index.html" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700">調達</a>
                                    <button onclick="showAddInventoryModal()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-emerald-600 text-white text-xs sm:text-sm rounded-lg hover:bg-emerald-700">+ 追加</button>
                                    <button onclick="handleSignoutClick()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-600 text-white text-xs sm:text-sm rounded-lg hover:bg-slate-700 hidden sm:inline">サインアウト</button>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    <main class="max-w-7xl mx-auto px-3 sm:px-6 py-4 sm:py-8">
                        <!-- サマリー -->
                        <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-4 mb-4 sm:mb-8">
                            <div class="bg-white rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border">
                                <p class="text-slate-600 text-xs sm:text-sm">総在庫</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900">${summary.total}</p>
                            </div>
                            <div class="bg-amber-50 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-amber-200">
                                <p class="text-amber-700 text-xs sm:text-sm">入庫待</p>
                                <p class="text-lg sm:text-2xl font-bold text-amber-600">${summary.waiting}</p>
                            </div>
                            <div class="bg-emerald-50 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-emerald-200">
                                <p class="text-emerald-700 text-xs sm:text-sm">在庫中</p>
                                <p class="text-lg sm:text-2xl font-bold text-emerald-600">${summary.inStock}</p>
                            </div>
                            <div class="col-span-3 sm:col-span-1 bg-emerald-100 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-emerald-300">
                                <p class="text-emerald-800 text-xs sm:text-sm">在庫総額</p>
                                <p class="text-base sm:text-xl font-bold text-emerald-700">¥${summary.inStockValue.toLocaleString()}</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-blue-200 hidden sm:block">
                                <p class="text-blue-700 text-xs sm:text-sm">出庫済</p>
                                <p class="text-lg sm:text-2xl font-bold text-blue-600">${summary.shipped}</p>
                            </div>
                            <div class="bg-red-50 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-red-200 hidden sm:block">
                                <p class="text-red-700 text-xs sm:text-sm">不具合</p>
                                <p class="text-lg sm:text-2xl font-bold text-red-600">${summary.issue}</p>
                            </div>
                        </div>

                        <!-- フィルタ -->
                        <div class="bg-white rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-sm border mb-4 sm:mb-6">
                            <div class="flex flex-wrap gap-2 sm:gap-4 items-end">
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 block mb-1">ステータス</label>
                                    <select id="filterStatus" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border rounded-lg">
                                        <option value="">すべて</option>
                                        ${STATUSES.map(s => `<option value="${s}" ${currentFilters.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 block mb-1">種別</label>
                                    <select id="filterCategory" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border rounded-lg">
                                        <option value="">すべて</option>
                                        ${CATEGORIES.map(c => `<option value="${c}" ${currentFilters.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 block mb-1">棚番</label>
                                    <select id="filterShelfNo" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border rounded-lg">
                                        <option value="">すべて</option>
                                        ${SHELF_NUMBERS.map(n => `<option value="${n}" ${currentFilters.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 block mb-1">並び替え</label>
                                    <select id="filterSort" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border rounded-lg">
                                        <option value="orderDate-desc" ${currentFilters.sort === 'orderDate-desc' ? 'selected' : ''}>新しい順</option>
                                        <option value="orderDate-asc" ${currentFilters.sort === 'orderDate-asc' ? 'selected' : ''}>古い順</option>
                                        <option value="serial-asc" ${currentFilters.sort === 'serial-asc' ? 'selected' : ''}>Serial順</option>
                                        <option value="project-asc" ${currentFilters.sort === 'project-asc' ? 'selected' : ''}>案件順</option>
                                    </select>
                                </div>
                                <button onclick="clearFilters()" class="px-3 py-1.5 sm:py-2 bg-slate-200 text-slate-700 text-sm rounded-lg hover:bg-slate-300">クリア</button>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <input type="text" id="filterSearch" value="${currentFilters.search}" onkeydown="if(event.key==='Enter'){applyFilters();event.target.blur();}" placeholder="Serial/製品名/案件番号で検索" class="flex-1 px-3 py-2 text-sm border rounded-lg">
                                <button onclick="applyFilters()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">検索</button>
                            </div>
                        </div>

                        <!-- 在庫リスト -->
                        <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border overflow-hidden">
                            <div class="p-3 sm:p-4 border-b bg-slate-50 flex justify-between items-center">
                                <h2 class="font-bold text-sm sm:text-base text-slate-900">在庫一覧（${filtered.length}件）</h2>
                                <button onclick="showArchiveModal()" class="text-xs sm:text-sm text-slate-600 hover:text-slate-800">アーカイブ</button>
                            </div>
                            
                            <!-- 案件ごと折りたたみ表示 -->
                            <div>
                                ${filtered.length === 0 ? `
                                    <div class="px-4 py-8 text-center text-slate-500 text-sm">データがありません</div>
                                ` : (() => {
                                    const groups = groupByProject(filtered);
                                    return Object.keys(groups).map(project => {
                                        const items = groups[project];
                                        const isExpanded = expandedProjects[project];
                                        const statusCounts = {
                                            waiting: items.filter(i => i.status === '入庫待ち').length,
                                            inStock: items.filter(i => i.status === '在庫中').length,
                                            shipped: items.filter(i => i.status === '出庫済').length,
                                            issue: items.filter(i => i.status === '不具合').length
                                        };
                                        return `
                                            <div class="border-b last:border-b-0">
                                                <div onclick="toggleProject('${project}')" class="p-3 sm:p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 active:bg-slate-100">
                                                    <div class="flex items-center gap-2 sm:gap-3">
                                                        <span class="text-slate-400">${isExpanded ? '▼' : '▶'}</span>
                                                        <span class="font-semibold text-blue-600 text-sm sm:text-base">${project}</span>
                                                        <span class="text-xs sm:text-sm text-slate-500">(${items.length}件)</span>
                                                    </div>
                                                    <div class="flex gap-1 sm:gap-2">
                                                        ${statusCounts.waiting > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-amber-100 text-amber-700">待${statusCounts.waiting}</span>` : ''}
                                                        ${statusCounts.inStock > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-emerald-100 text-emerald-700">庫${statusCounts.inStock}</span>` : ''}
                                                        ${statusCounts.shipped > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">出${statusCounts.shipped}</span>` : ''}
                                                        ${statusCounts.issue > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-red-100 text-red-700">不${statusCounts.issue}</span>` : ''}
                                                    </div>
                                                </div>
                                                ${isExpanded ? `
                                                    <!-- PC: テーブル表示 -->
                                                    <div class="hidden md:block bg-slate-50 border-t">
                                                        <table class="w-full">
                                                            <thead class="bg-slate-100">
                                                                <tr>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">Serial</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">種別</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">製品名</th>
                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700">棚番</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">入庫日</th>
                                                                    <th class="px-3 py-2 text-right text-xs font-semibold text-slate-700">原価(税込)</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">ステータス</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">出庫先</th>
                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700">操作</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="divide-y bg-white">
                                                                ${items.map(item => `
                                                                    <tr class="hover:bg-slate-50">
                                                                        <td class="px-3 py-2 font-mono font-semibold text-sm text-slate-900">${item.serial}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600">${item.category}</td>
                                                                        <td class="px-3 py-2 text-xs">${item.productName}</td>
                                                                        <td class="px-3 py-2 text-center text-xs font-semibold text-purple-600">${item.shelfNo || '-'}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600">${item.receiveDate || '-'}</td>
                                                                        <td class="px-3 py-2 text-xs text-right font-semibold">${item.costJPY ? '¥' + Number(item.costJPY).toLocaleString() : '-'}</td>
                                                                        <td class="px-3 py-2">
                                                                            <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                                        </td>
                                                                        <td class="px-3 py-2 text-xs">${item.shipProject || '-'}</td>
                                                                        <td class="px-3 py-2 text-center">
                                                                            <div class="flex gap-1 justify-center">
                                                                                ${item.status === '入庫待ち' ? `
                                                                                    <button onclick="event.stopPropagation();showReceiveModal('${item.id}')" class="px-2 py-1 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">入庫</button>
                                                                                ` : ''}
                                                                                ${item.status === '在庫中' ? `
                                                                                    <button onclick="event.stopPropagation();showShipModal('${item.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">出庫</button>
                                                                                ` : ''}
                                                                                <button onclick="event.stopPropagation();editItem('${item.id}')" class="px-2 py-1 bg-slate-200 text-slate-700 text-xs rounded hover:bg-slate-300">編集</button>
                                                                                ${item.status === '出庫済' ? `
                                                                                    <button onclick="event.stopPropagation();archiveItem('${item.id}')" class="px-2 py-1 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">保管</button>
                                                                                ` : ''}
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <!-- スマホ: カード表示 -->
                                                    <div class="md:hidden bg-slate-50">
                                                        ${items.map(item => `
                                                            <div class="p-3 border-t border-slate-200">
                                                                <div class="flex justify-between items-start mb-2">
                                                                    <div>
                                                                        <p class="font-mono font-bold text-sm text-slate-900">${item.serial}</p>
                                                                        <p class="text-xs text-slate-500">${item.category}</p>
                                                                    </div>
                                                                    <div class="flex items-center gap-2">
                                                                        ${item.shelfNo ? `<span class="px-1.5 py-0.5 rounded text-xs font-semibold bg-purple-100 text-purple-700">棚${item.shelfNo}</span>` : ''}
                                                                        <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-xs text-slate-800 mb-1">${item.productName}</p>
                                                                <div class="flex justify-between items-center text-xs text-slate-500 mb-2">
                                                                    <span>入庫: ${item.receiveDate || '-'}</span>
                                                                    <span>原価: ${item.costJPY ? '¥' + Number(item.costJPY).toLocaleString() : '-'}</span>
                                                                </div>
                                                                <div class="flex gap-2">
                                                                    ${item.status === '入庫待ち' ? `
                                                                        <button onclick="event.stopPropagation();showReceiveModal('${item.id}')" class="flex-1 px-3 py-1.5 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">入庫</button>
                                                                    ` : ''}
                                                                    ${item.status === '在庫中' ? `
                                                                        <button onclick="event.stopPropagation();showShipModal('${item.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">出庫</button>
                                                                    ` : ''}
                                                                    <button onclick="event.stopPropagation();editItem('${item.id}')" class="px-3 py-1.5 bg-slate-200 text-slate-700 text-xs rounded hover:bg-slate-300">編集</button>
                                                                    ${item.status === '出庫済' ? `
                                                                        <button onclick="event.stopPropagation();archiveItem('${item.id}')" class="px-3 py-1.5 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">保管</button>
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function applyFilters() {
            const categoryEl = document.getElementById('filterCategory');
            const statusEl = document.getElementById('filterStatus');
            const searchEl = document.getElementById('filterSearch');
            const sortEl = document.getElementById('filterSort');
            const shelfNoEl = document.getElementById('filterShelfNo');
            
            if (categoryEl) currentFilters.category = categoryEl.value;
            if (statusEl) currentFilters.status = statusEl.value;
            if (searchEl) currentFilters.search = searchEl.value;
            if (sortEl) currentFilters.sort = sortEl.value;
            if (shelfNoEl) currentFilters.shelfNo = shelfNoEl.value;
            renderMain();
        }

        function clearFilters() {
            currentFilters = { category: '', status: '', search: '', sort: 'orderDate-desc', shelfNo: '' };
            expandedProjects = {};
            renderMain();
        }

        // 在庫追加モーダル
        function showAddInventoryModal() {
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'addModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">在庫追加</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Serial <span class="text-red-500">*</span></label>
                                <input type="text" id="addSerial" class="w-full px-3 py-2 border rounded-lg" placeholder="YS0554-1">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">種別 <span class="text-red-500">*</span></label>
                                <select id="addCategory" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">選択してください</option>
                                    ${CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">製品名 <span class="text-red-500">*</span></label>
                                <input type="text" id="addProductName" class="w-full px-3 py-2 border rounded-lg" placeholder="製品名を入力">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">発注案件番号</label>
                                <input type="text" id="addOrderProject" class="w-full px-3 py-2 border rounded-lg" placeholder="AD-1682">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">発注日</label>
                                <input type="date" id="addOrderDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">数量（複数台の場合）</label>
                                <input type="number" id="addQuantity" class="w-full px-3 py-2 border rounded-lg" value="1" min="1">
                                <p class="text-xs text-slate-500 mt-1">複数の場合、Serial-1, Serial-2... と連番で追加されます</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">備考</label>
                                <textarea id="addNote" class="w-full px-3 py-2 border rounded-lg" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('addModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">キャンセル</button>
                            <button onclick="submitAddInventory()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">追加</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitAddInventory() {
            const serial = document.getElementById('addSerial').value.trim();
            const category = document.getElementById('addCategory').value;
            const productName = document.getElementById('addProductName').value.trim();
            const orderProject = document.getElementById('addOrderProject').value.trim();
            const orderDate = document.getElementById('addOrderDate').value;
            const quantity = parseInt(document.getElementById('addQuantity').value) || 1;
            const note = document.getElementById('addNote').value.trim();

            if (!serial || !category || !productName) {
                alert('Serial、種別、製品名は必須です');
                return;
            }

            for (let i = 1; i <= quantity; i++) {
                const itemSerial = quantity > 1 ? `${serial}-${i}` : serial;
                inventory.push({
                    id: Date.now().toString() + '-' + i,
                    serial: itemSerial,
                    category,
                    productName,
                    orderProject,
                    orderDate,
                    receiveDate: '',
                    status: '入庫待ち',
                    shipDate: '',
                    shipProject: '',
                    costJPY: '',
                    note
                });
            }

            saveData();
            closeModal('addModal');
            renderMain();
        }

        // 入庫モーダル
        function showReceiveModal(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'receiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4">入庫処理</h3>
                        <p class="text-sm text-slate-600 mb-2">Serial: <span class="font-mono font-semibold">${item.serial}</span></p>
                        <p class="text-sm text-slate-600 mb-4">${item.productName}</p>
                        <div>
                            <label class="block text-sm font-semibold mb-1">入庫日 <span class="text-red-500">*</span></label>
                            <input type="date" id="receiveDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('receiveModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">キャンセル</button>
                            <button onclick="submitReceive('${id}')" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">入庫</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitReceive(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const receiveDate = document.getElementById('receiveDate').value;

            if (!receiveDate) {
                alert('入庫日を入力してください');
                return;
            }

            item.receiveDate = receiveDate;
            item.status = '在庫中';
            
            saveData();
            closeModal('receiveModal');
            renderMain();
        }

        // 出庫モーダル
        function showShipModal(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'shipModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4">出庫処理</h3>
                        <p class="text-sm text-slate-600 mb-2">Serial: <span class="font-mono font-semibold">${item.serial}</span></p>
                        <p class="text-sm text-slate-600 mb-4">${item.productName}</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">出庫先案件番号 <span class="text-red-500">*</span></label>
                                <input type="text" id="shipProject" class="w-full px-3 py-2 border rounded-lg" value="${item.orderProject || ''}" placeholder="AD-1700">
                                <p class="text-xs text-slate-500 mt-1">発注案件と異なる場合は変更してください</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">出庫日</label>
                                <input type="date" id="shipDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('shipModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">キャンセル</button>
                            <button onclick="submitShip('${id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">出庫</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitShip(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const shipProject = document.getElementById('shipProject').value.trim();
            const shipDate = document.getElementById('shipDate').value;

            if (!shipProject) {
                alert('出庫先案件番号を入力してください');
                return;
            }

            item.shipProject = shipProject;
            item.shipDate = shipDate;
            item.status = '出庫済';
            
            saveData();
            closeModal('shipModal');
            renderMain();
        }

        // 編集モーダル
        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const modal = document.createElement('div');
            modal.id = 'editModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">在庫編集</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Serial</label>
                                <input type="text" id="editSerial" class="w-full px-3 py-2 border rounded-lg" value="${item.serial}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">種別</label>
                                <select id="editCategory" class="w-full px-3 py-2 border rounded-lg">
                                    ${CATEGORIES.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">製品名</label>
                                <input type="text" id="editProductName" class="w-full px-3 py-2 border rounded-lg" value="${item.productName}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">棚番</label>
                                <select id="editShelfNo" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">未設定</option>
                                    ${SHELF_NUMBERS.map(n => `<option value="${n}" ${item.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">発注案件番号</label>
                                <input type="text" id="editOrderProject" class="w-full px-3 py-2 border rounded-lg" value="${item.orderProject}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">発注日</label>
                                <input type="date" id="editOrderDate" class="w-full px-3 py-2 border rounded-lg" value="${item.orderDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">入庫日</label>
                                <input type="date" id="editReceiveDate" class="w-full px-3 py-2 border rounded-lg" value="${item.receiveDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">取得金（税込円）</label>
                                <input type="number" id="editCostJPY" class="w-full px-3 py-2 border rounded-lg" value="${item.costJPY || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ステータス</label>
                                <select id="editStatus" class="w-full px-3 py-2 border rounded-lg">
                                    ${STATUSES.map(s => `<option value="${s}" ${item.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">出庫日</label>
                                <input type="date" id="editShipDate" class="w-full px-3 py-2 border rounded-lg" value="${item.shipDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">出庫先案件</label>
                                <input type="text" id="editShipProject" class="w-full px-3 py-2 border rounded-lg" value="${item.shipProject}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">備考</label>
                                <textarea id="editNote" class="w-full px-3 py-2 border rounded-lg" rows="2">${item.note}</textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('editModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">キャンセル</button>
                            <button onclick="deleteItem('${id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">削除</button>
                            <button onclick="submitEdit('${id}')" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">保存</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitEdit(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            item.serial = document.getElementById('editSerial').value.trim();
            item.category = document.getElementById('editCategory').value;
            item.productName = document.getElementById('editProductName').value.trim();
            item.shelfNo = document.getElementById('editShelfNo').value;
            item.orderProject = document.getElementById('editOrderProject').value.trim();
            item.orderDate = document.getElementById('editOrderDate').value;
            item.receiveDate = document.getElementById('editReceiveDate').value;
            item.costJPY = document.getElementById('editCostJPY').value;
            item.status = document.getElementById('editStatus').value;
            item.shipDate = document.getElementById('editShipDate').value;
            item.shipProject = document.getElementById('editShipProject').value.trim();
            item.note = document.getElementById('editNote').value.trim();

            saveData();
            closeModal('editModal');
            renderMain();
        }

        function deleteItem(id) {
            if (!confirm('この在庫を削除しますか？')) return;
            inventory = inventory.filter(i => i.id !== id);
            saveData();
            closeModal('editModal');
            renderMain();
        }

        // アーカイブ処理
        function archiveItem(id) {
            if (!confirm('この在庫をアーカイブしますか？')) return;
            
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            archivedInventory.push(item);
            inventory = inventory.filter(i => i.id !== id);
            
            saveData();
            renderMain();
        }

        // アーカイブ一覧モーダル
        function showArchiveModal() {
            const modal = document.createElement('div');
            modal.id = 'archiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">アーカイブ一覧（${archivedInventory.length}件）</h3>
                            <button onclick="closeModal('archiveModal')" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm">Serial</th>
                                        <th class="px-3 py-2 text-left text-sm">種別</th>
                                        <th class="px-3 py-2 text-left text-sm">製品名</th>
                                        <th class="px-3 py-2 text-left text-sm">発注案件</th>
                                        <th class="px-3 py-2 text-left text-sm">出庫先</th>
                                        <th class="px-3 py-2 text-left text-sm">出庫日</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${archivedInventory.length === 0 ? `
                                        <tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">アーカイブはありません</td></tr>
                                    ` : archivedInventory.map(item => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-3 py-2 font-mono text-sm">${item.serial}</td>
                                            <td class="px-3 py-2 text-sm">${item.category}</td>
                                            <td class="px-3 py-2 text-sm">${item.productName}</td>
                                            <td class="px-3 py-2 text-sm">${item.orderProject}</td>
                                            <td class="px-3 py-2 text-sm">${item.shipProject}</td>
                                            <td class="px-3 py-2 text-sm">${item.shipDate}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        // API読み込み確認と初期化
        function checkAndInit() {
            if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                gapiLoaded();
                gisLoaded();
            } else {
                setTimeout(checkAndInit, 100);
            }
        }
        
        // DOM読み込み完了後に初期化
        document.addEventListener('DOMContentLoaded', checkAndInit);
    </script>
</body>
</html>
