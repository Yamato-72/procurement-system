<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap');
        * { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-emerald-600 mx-auto mb-4"></div>
                <p class="text-slate-600 text-lg">åˆæœŸåŒ–ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';
        const PARENT_FOLDER_ID = '1EvObQiCJgxJCzd_kQJ1PNbOUMD5P-Zxp';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let inventory = [];
        let archivedInventory = [];
        let folderCache = {};
        let lastUpdated = null; // æœ€çµ‚æ›´æ–°æ—¥æ™‚
        let isDarkMode = localStorage.getItem('darkMode') === 'true'; // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹
        let bulkSelectMode = false; // ä¸€æ‹¬é¸æŠãƒ¢ãƒ¼ãƒ‰
        let selectedItems = new Set(); // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ID

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            document.documentElement.classList.toggle('dark', isDarkMode);
            renderMain();
        }

        // ç¨®åˆ¥ãƒªã‚¹ãƒˆ
        const CATEGORIES = [
            'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤',
            'å±‹å¤–',
            'å±‹å†…',
            'STUDIA',
            'ãƒãƒˆãƒªã‚¯ã‚¹',
            'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼',
            'ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·',
            'å‘¨è¾ºæ©Ÿå™¨'
        ];

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚¹ãƒˆ
        const STATUSES = ['å…¥åº«å¾…ã¡', 'åœ¨åº«ä¸­', 'å‡ºåº«æ¸ˆ', 'ä¸å…·åˆ'];

        // ä¿ç®¡å ´æ‰€ãƒªã‚¹ãƒˆ
        const LOCATIONS = ['è“®ç”°', 'æ±äº¬', 'å¤§é˜ª'];

        // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿
        let currentFilters = {
            category: '',
            status: '',
            search: '',
            sort: 'orderDate-desc',
            shelfNo: '',
            receiveDateFrom: '',
            receiveDateTo: '',
            shipProject: '',
            costRange: '',
            noShelf: false,
            location: ''
        };

        // è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿é–‹é–‰çŠ¶æ…‹
        let showDetailFilters = false;

        // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ï¼ˆæ¡ˆä»¶ç•ªå·ã”ã¨ï¼‰
        let expandedProjects = {};

        // æ£šç•ªãƒªã‚¹ãƒˆï¼ˆ1ã€œ30ï¼‰
        const SHELF_NUMBERS = Array.from({length: 30}, (_, i) => String(i + 1));

        // åŸä¾¡å¸¯ãƒªã‚¹ãƒˆ
        const COST_RANGES = [
            { value: '', label: 'ã™ã¹ã¦' },
            { value: '0-50000', label: '5ä¸‡å††æœªæº€' },
            { value: '50000-100000', label: '5ã€œ10ä¸‡å††' },
            { value: '100000-300000', label: '10ã€œ30ä¸‡å††' },
            { value: '300000-', label: '30ä¸‡å††ä»¥ä¸Š' }
        ];

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    'https://sheets.googleapis.com/$discovery/rest?version=v4',
                    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                ],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    accessToken = resp.access_token;
                    sessionStorage.setItem('googleAccessToken', accessToken);
                    loadData();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) {
                    accessToken = savedToken;
                    gapi.client.setToken({ access_token: accessToken });
                    loadData();
                } else {
                    renderSignIn();
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = resp.access_token;
                sessionStorage.setItem('googleAccessToken', accessToken);
                await loadData();
            };

            if (accessToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            accessToken = null;
            sessionStorage.removeItem('googleAccessToken');
            gapi.client.setToken(null);
            renderSignIn();
        }

        async function findFolderUrl(projectNumber) {
            if (folderCache[projectNumber]) {
                return folderCache[projectNumber];
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name = '${projectNumber}' and '${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
                    fields: 'files(id, name, webViewLink)',
                    pageSize: 1,
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true,
                    corpora: 'allDrives'
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    const url = files[0].webViewLink;
                    folderCache[projectNumber] = url;
                    return url;
                }
                return null;
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        async function loadFolderUrls() {
            const projectNumbers = [...new Set(inventory.map(i => i.orderProject).filter(p => p && p !== 'æœªè¨­å®š'))];
            for (const projectNumber of projectNumbers) {
                if (!folderCache[projectNumber]) {
                    await findFolderUrl(projectNumber);
                }
            }
            renderMain();
        }

        function renderSignIn() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100">
                    <div class="bg-white p-10 rounded-2xl shadow-xl max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-emerald-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-slate-800 mb-2">åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                            <p class="text-slate-500 mb-8">å…¥å‡ºåº«ãƒ»æ£šå¸ã—ç®¡ç†</p>
                            <button onclick="handleAuthClick()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-slate-200 text-slate-700 px-6 py-4 rounded-xl font-semibold hover:bg-slate-50 hover:border-slate-300 transition-all">
                                <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        async function loadData() {
            try {
                showStatus('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                
                // åœ¨åº«ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
                try {
                    const inventoryResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A2:N',
                    });
                    const inventoryRows = inventoryResponse.result.values || [];
                    inventory = inventoryRows.map(row => ({
                        id: row[0] || '',
                        serial: row[1] || '',
                        category: row[2] || '',
                        productName: row[3] || '',
                        orderProject: row[4] || '',
                        orderDate: row[5] || '',
                        receiveDate: row[6] || '',
                        status: row[7] || 'å…¥åº«å¾…ã¡',
                        shipDate: row[8] || '',
                        shipProject: row[9] || '',
                        costJPY: row[10] || '',
                        note: row[11] || '',
                        shelfNo: row[12] || '',
                        location: row[13] || ''
                    }));
                } catch (e) {
                    console.log('åœ¨åº«ã‚·ãƒ¼ãƒˆãŒãªã„ãŸã‚æ–°è¦ä½œæˆã—ã¾ã™');
                    inventory = [];
                    await createInventorySheet();
                }

                // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
                try {
                    const archiveResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A2:N',
                    });
                    const archiveRows = archiveResponse.result.values || [];
                    archivedInventory = archiveRows.map(row => ({
                        id: row[0] || '',
                        serial: row[1] || '',
                        category: row[2] || '',
                        productName: row[3] || '',
                        orderProject: row[4] || '',
                        orderDate: row[5] || '',
                        receiveDate: row[6] || '',
                        status: row[7] || '',
                        shipDate: row[8] || '',
                        shipProject: row[9] || '',
                        costJPY: row[10] || '',
                        note: row[11] || '',
                        shelfNo: row[12] || '',
                        location: row[13] || ''
                    }));
                } catch (e) {
                    console.log('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚·ãƒ¼ãƒˆãŒãªã„ãŸã‚æ–°è¦ä½œæˆã—ã¾ã™');
                    archivedInventory = [];
                    await createArchiveSheet();
                }

                lastUpdated = new Date();
                showStatus('');
                renderMain();
                
                // ãƒ•ã‚©ãƒ«ãƒ€URLã‚’éåŒæœŸã§èª­ã¿è¾¼ã¿
                loadFolderUrls();
            } catch (err) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        async function createInventorySheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: 'åœ¨åº«' }
                            }
                        }]
                    }
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A1:M1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¡ˆä»¶', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«å…ˆæ¡ˆä»¶', 'å–å¾—é‡‘(ç¨è¾¼)', 'å‚™è€ƒ', 'æ£šç•ª']]
                    }
                });
            } catch (e) {
                console.log('ã‚·ãƒ¼ãƒˆä½œæˆã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢å­˜ã®å¯èƒ½æ€§ï¼‰:', e);
            }
        }

        async function createArchiveSheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–' }
                            }
                        }]
                    }
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A1:M1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¡ˆä»¶', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«å…ˆæ¡ˆä»¶', 'å–å¾—é‡‘(ç¨è¾¼)', 'å‚™è€ƒ', 'æ£šç•ª']]
                    }
                });
            } catch (e) {
                console.log('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚·ãƒ¼ãƒˆä½œæˆã‚¹ã‚­ãƒƒãƒ—:', e);
            }
        }

        async function saveData() {
            try {
                showStatus('ä¿å­˜ä¸­...');
                
                const inventoryData = [
                    ['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¡ˆä»¶', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«å…ˆæ¡ˆä»¶', 'å–å¾—é‡‘(ç¨è¾¼)', 'å‚™è€ƒ', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€'],
                    ...inventory.map(item => [
                        item.id,
                        item.serial,
                        item.category,
                        item.productName,
                        item.orderProject,
                        item.orderDate,
                        item.receiveDate,
                        item.status,
                        item.shipDate,
                        item.shipProject,
                        item.costJPY,
                        item.note,
                        item.shelfNo,
                        item.location
                    ])
                ];
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A1',
                    valueInputOption: 'RAW',
                    resource: { values: inventoryData }
                });

                const archiveData = [
                    ['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¡ˆä»¶', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«å…ˆæ¡ˆä»¶', 'å–å¾—é‡‘(ç¨è¾¼)', 'å‚™è€ƒ', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€'],
                    ...archivedInventory.map(item => [
                        item.id,
                        item.serial,
                        item.category,
                        item.productName,
                        item.orderProject,
                        item.orderDate,
                        item.receiveDate,
                        item.status,
                        item.shipDate,
                        item.shipProject,
                        item.costJPY,
                        item.note,
                        item.shelfNo,
                        item.location
                    ])
                ];
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A1',
                    valueInputOption: 'RAW',
                    resource: { values: archiveData }
                });

                showStatus('ä¿å­˜å®Œäº†');
                setTimeout(() => showStatus(''), 2000);
            } catch (err) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        function showStatus(message) {
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.textContent = message;
        }

        function getFilteredInventory() {
            const today = new Date().toISOString().split('T')[0];
            
            let result = inventory.filter(item => {
                if (currentFilters.category && item.category !== currentFilters.category) return false;
                if (currentFilters.status && item.status !== currentFilters.status) return false;
                if (currentFilters.shelfNo && item.shelfNo !== currentFilters.shelfNo) return false;
                
                // å…¥åº«æ—¥ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿
                if (currentFilters.receiveDateFrom && item.receiveDate < currentFilters.receiveDateFrom) return false;
                if (currentFilters.receiveDateTo && item.receiveDate > currentFilters.receiveDateTo) return false;
                
                // å‡ºåº«å…ˆæ¡ˆä»¶ãƒ•ã‚£ãƒ«ã‚¿
                if (currentFilters.shipProject && !item.shipProject.toLowerCase().includes(currentFilters.shipProject.toLowerCase())) return false;
                
                // åŸä¾¡å¸¯ãƒ•ã‚£ãƒ«ã‚¿
                if (currentFilters.costRange) {
                    const cost = Number(item.costJPY) || 0;
                    const [min, max] = currentFilters.costRange.split('-').map(v => v ? Number(v) : null);
                    if (min !== null && cost < min) return false;
                    if (max !== null && cost >= max) return false;
                }
                
                // ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿: æ£šæœªè¨­å®š
                if (currentFilters.noShelf && item.shelfNo) return false;
                
                // ä¿ç®¡å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿
                if (currentFilters.location && item.location !== currentFilters.location) return false;
                
                if (currentFilters.search) {
                    const search = currentFilters.search.toLowerCase();
                    const matchSerial = item.serial.toLowerCase().includes(search);
                    const matchProduct = item.productName.toLowerCase().includes(search);
                    const matchProject = item.orderProject.toLowerCase().includes(search) || item.shipProject.toLowerCase().includes(search);
                    if (!matchSerial && !matchProduct && !matchProject) return false;
                }
                return true;
            });

            // ã‚½ãƒ¼ãƒˆ
            const sortValue = currentFilters.sort || 'orderDate-desc';
            const parts = sortValue.split('-');
            const sortKey = parts[0];
            const sortOrder = parts[1] || 'desc';
            
            result.sort((a, b) => {
                let valA, valB;
                switch(sortKey) {
                    case 'orderDate':
                        valA = a.orderDate || '9999';
                        valB = b.orderDate || '9999';
                        break;
                    case 'serial':
                        valA = a.serial || '';
                        valB = b.serial || '';
                        break;
                    case 'project':
                        valA = a.orderProject || '';
                        valB = b.orderProject || '';
                        break;
                    default:
                        valA = a.orderDate || '9999';
                        valB = b.orderDate || '9999';
                }
                
                let comparison = valA.localeCompare(valB);
                return sortOrder === 'asc' ? comparison : -comparison;
            });

            return result;
        }

        // æ¡ˆä»¶ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        function groupByProject(items) {
            const groups = {};
            items.forEach(item => {
                const project = item.orderProject || 'æœªè¨­å®š';
                if (!groups[project]) {
                    groups[project] = [];
                }
                groups[project].push(item);
            });
            return groups;
        }

        // æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«
        function toggleProject(project) {
            expandedProjects[project] = !expandedProjects[project];
            renderMain();
        }

        function getSummary() {
            const inStockItems = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            const inStockValue = inStockItems.reduce((sum, i) => sum + (Number(i.costJPY) || 0), 0);
            const noShelfCount = inStockItems.filter(i => !i.shelfNo).length;
            const tokyoCount = inventory.filter(i => i.location === 'æ±äº¬' && i.status === 'åœ¨åº«ä¸­').length;
            const osakaCount = inventory.filter(i => i.location === 'å¤§é˜ª' && i.status === 'åœ¨åº«ä¸­').length;
            return {
                total: inventory.length,
                waiting: inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').length,
                inStock: inStockItems.length,
                inStockValue: inStockValue,
                shipped: inventory.filter(i => i.status === 'å‡ºåº«æ¸ˆ').length,
                issue: inventory.filter(i => i.status === 'ä¸å…·åˆ').length,
                noShelf: noShelfCount,
                tokyo: tokyoCount,
                osaka: osakaCount
            };
        }

        function getStatusClass(status) {
            switch(status) {
                case 'å…¥åº«å¾…ã¡': return 'bg-amber-100 text-amber-700';
                case 'åœ¨åº«ä¸­': return 'bg-emerald-100 text-emerald-700';
                case 'å‡ºåº«æ¸ˆ': return 'bg-blue-100 text-blue-700';
                case 'ä¸å…·åˆ': return 'bg-red-100 text-red-700';
                default: return 'bg-slate-100 text-slate-700';
            }
        }

        function renderMain() {
            const summary = getSummary();
            const filtered = getFilteredInventory();
            const lastUpdatedText = lastUpdated ? lastUpdated.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) : '-';
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
                    <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="max-w-7xl mx-auto px-3 sm:px-6 py-3 sm:py-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                                    <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">å…¥å‡ºåº«ãƒ»æ£šå¸ã—ç®¡ç†</p>
                                </div>
                                <div class="flex items-center gap-1 sm:gap-3">
                                    <span id="status" class="text-xs sm:text-sm text-emerald-600 dark:text-emerald-400 hidden sm:inline"></span>
                                    <button onclick="toggleDarkMode()" class="p-1.5 sm:p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
                                        ${isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                                    </button>
                                    <a href="index.html" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700">èª¿é”</a>
                                    <button onclick="toggleBulkSelectMode()" class="px-2 sm:px-3 py-1.5 sm:py-2 ${bulkSelectMode ? 'bg-amber-500' : 'bg-slate-500'} text-white text-xs sm:text-sm rounded-lg hover:opacity-90">
                                        <span class="hidden sm:inline">${bulkSelectMode ? 'é¸æŠä¸­' : 'ä¸€æ‹¬'}</span>
                                        <span class="sm:hidden">â˜‘</span>
                                    </button>
                                    <button onclick="showAddInventoryModal()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-emerald-600 text-white text-xs sm:text-sm rounded-lg hover:bg-emerald-700">+ è¿½åŠ </button>
                                    <button onclick="handleSignoutClick()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-600 text-white text-xs sm:text-sm rounded-lg hover:bg-slate-700">
                                        <span class="hidden sm:inline">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</span>
                                        <span class="sm:hidden">â†ª</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mt-2 text-xs text-slate-500 dark:text-slate-400">
                                <span>æœ€çµ‚æ›´æ–°: ${lastUpdatedText}</span>
                                <button onclick="loadData()" class="flex items-center gap-1 hover:text-emerald-600 dark:hover:text-emerald-400">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    æ›´æ–°
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <main class="max-w-7xl mx-auto px-3 sm:px-6 py-4 sm:py-8">
                        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
                        ${(summary.noShelf > 0 || summary.waiting > 0 || summary.issue > 0) ? `
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${summary.noShelf > 0 ? `
                                    <button onclick="quickFilter('noShelf')" class="flex items-center gap-1 px-3 py-1.5 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 text-xs sm:text-sm rounded-lg hover:bg-amber-200 dark:hover:bg-amber-900/70 border border-amber-300 dark:border-amber-700">
                                        âš ï¸ æ£šæœªè¨­å®š ${summary.noShelf}ä»¶
                                    </button>
                                ` : ''}
                                ${summary.waiting > 0 ? `
                                    <span class="flex items-center gap-1 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs sm:text-sm rounded-lg border border-blue-300 dark:border-blue-700">
                                        ğŸ“¦ å…¥åº«å¾…ã¡ ${summary.waiting}ä»¶
                                    </span>
                                ` : ''}
                                ${summary.issue > 0 ? `
                                    <span class="flex items-center gap-1 px-3 py-1.5 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 text-xs sm:text-sm rounded-lg border border-red-300 dark:border-red-700">
                                        ğŸ”´ ä¸å…·åˆ ${summary.issue}ä»¶
                                    </span>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- ã‚µãƒãƒªãƒ¼ -->
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 sm:gap-4 mb-4 sm:mb-6">
                            <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-emerald-200 dark:border-emerald-700">
                                <p class="text-emerald-700 dark:text-emerald-400 text-xs sm:text-sm">åœ¨åº«ä¸­</p>
                                <p class="text-lg sm:text-2xl font-bold text-emerald-600 dark:text-emerald-400">${summary.inStock}</p>
                            </div>
                            <div class="bg-amber-50 dark:bg-amber-900/30 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-amber-200 dark:border-amber-700">
                                <p class="text-amber-700 dark:text-amber-400 text-xs sm:text-sm">å…¥åº«å¾…</p>
                                <p class="text-lg sm:text-2xl font-bold text-amber-600 dark:text-amber-400">${summary.waiting}</p>
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-blue-200 dark:border-blue-700">
                                <p class="text-blue-700 dark:text-blue-400 text-xs sm:text-sm">å‡ºåº«æ¸ˆ</p>
                                <p class="text-lg sm:text-2xl font-bold text-blue-600 dark:text-blue-400">${summary.shipped}</p>
                            </div>
                            <div class="bg-red-50 dark:bg-red-900/30 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border border-red-200 dark:border-red-700 hidden sm:block">
                                <p class="text-red-700 dark:text-red-400 text-xs sm:text-sm">ä¸å…·åˆ</p>
                                <p class="text-lg sm:text-2xl font-bold text-red-600 dark:text-red-400">${summary.issue}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border dark:border-slate-700 hidden sm:block">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm">ç·åœ¨åº«</p>
                                <p class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">${summary.total}</p>
                            </div>
                        </div>

                        <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿ -->
                        <div class="flex flex-wrap items-center gap-2 mb-3 sm:mb-4">
                            <span class="text-slate-400" title="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ">âš¡</span>
                            <button onclick="quickFilter('multi')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.category === 'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤' ? 'bg-purple-500 text-white' : 'bg-purple-50 text-purple-600 hover:bg-purple-100'}">
                                ãƒãƒ«ãƒ
                            </button>
                            <button onclick="quickFilter('blackboard')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.category === 'STUDIA' ? 'bg-slate-700 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                                STUDIA
                            </button>
                            <button onclick="quickFilter('outdoor')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.category === 'å±‹å¤–' ? 'bg-orange-500 text-white' : 'bg-orange-50 text-orange-600 hover:bg-orange-100'}">
                                å±‹å¤–
                            </button>
                            <button onclick="quickFilter('tokyo')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.location === 'æ±äº¬' ? 'bg-rose-500 text-white' : 'bg-rose-50 text-rose-600 hover:bg-rose-100'}">
                                æ±äº¬
                            </button>
                            <button onclick="quickFilter('osaka')" class="px-3 py-1 text-xs sm:text-sm rounded-full ${currentFilters.location === 'å¤§é˜ª' ? 'bg-teal-500 text-white' : 'bg-teal-50 text-teal-600 hover:bg-teal-100 dark:bg-teal-900/30 dark:text-teal-400'}">
                                å¤§é˜ª
                            </button>
                        </div>

                        <!-- åŸºæœ¬ãƒ•ã‚£ãƒ«ã‚¿ -->
                        <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-sm border dark:border-slate-700 mb-4 sm:mb-6">
                            <div class="flex flex-wrap gap-2 sm:gap-4 items-end">
                                <div class="w-1/4 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 block mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                    <select id="filterStatus" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                        <option value="">ã™ã¹ã¦</option>
                                        ${STATUSES.map(s => `<option value="${s}" ${currentFilters.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/3 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 block mb-1">ç¨®åˆ¥</label>
                                    <select id="filterCategory" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                        <option value="">ã™ã¹ã¦</option>
                                        ${CATEGORIES.map(c => `<option value="${c}" ${currentFilters.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/3 sm:w-auto">
                                    <label class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 block mb-1">ä¸¦ã³æ›¿ãˆ</label>
                                    <select id="filterSort" onchange="applyFilters()" class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                        <option value="orderDate-desc" ${currentFilters.sort === 'orderDate-desc' ? 'selected' : ''}>æ–°ã—ã„é †</option>
                                        <option value="orderDate-asc" ${currentFilters.sort === 'orderDate-asc' ? 'selected' : ''}>å¤ã„é †</option>
                                        <option value="serial-asc" ${currentFilters.sort === 'serial-asc' ? 'selected' : ''}>Serialé †</option>
                                        <option value="project-asc" ${currentFilters.sort === 'project-asc' ? 'selected' : ''}>æ¡ˆä»¶é †</option>
                                    </select>
                                </div>
                                <button onclick="clearFilters()" class="px-3 py-1.5 sm:py-2 bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-white text-sm rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500">ã‚¯ãƒªã‚¢</button>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <input type="text" id="filterSearch" value="${currentFilters.search}" onkeydown="if(event.key==='Enter'){applyFilters();event.target.blur();}" placeholder="Serial/è£½å“å/æ¡ˆä»¶ç•ªå·ã§æ¤œç´¢" class="flex-1 px-3 py-2 text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 rounded-lg">
                                <button onclick="applyFilters()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">æ¤œç´¢</button>
                            </div>
                            
                            <!-- è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå€‰åº«æ‹…å½“è€…å‘ã‘ï¼‰ -->
                            <div class="mt-3 border-t dark:border-slate-600 pt-3">
                                <button onclick="toggleDetailFilters()" class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 flex items-center gap-1">
                                    <span>${showDetailFilters ? 'â–¼' : 'â–¶'}</span>
                                    <span>è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå€‰åº«æ‹…å½“è€…å‘ã‘ï¼‰</span>
                                </button>
                                ${showDetailFilters ? `
                                    <div class="mt-3 grid grid-cols-2 sm:grid-cols-5 gap-3">
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">æ£šç•ª</label>
                                            <select id="filterShelfNo" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                                <option value="">ã™ã¹ã¦</option>
                                                ${SHELF_NUMBERS.map(n => `<option value="${n}" ${currentFilters.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">å…¥åº«æ—¥ï¼ˆé–‹å§‹ï¼‰</label>
                                            <input type="date" id="filterReceiveDateFrom" value="${currentFilters.receiveDateFrom}" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">å…¥åº«æ—¥ï¼ˆçµ‚äº†ï¼‰</label>
                                            <input type="date" id="filterReceiveDateTo" value="${currentFilters.receiveDateTo}" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">å‡ºåº«å…ˆæ¡ˆä»¶</label>
                                            <input type="text" id="filterShipProject" value="${currentFilters.shipProject}" onchange="applyFilters()" placeholder="AD-1700" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-600 block mb-1">åŸä¾¡å¸¯</label>
                                            <select id="filterCostRange" onchange="applyFilters()" class="w-full px-2 py-1.5 text-sm border rounded-lg">
                                                ${COST_RANGES.map(r => `<option value="${r.value}" ${currentFilters.costRange === r.value ? 'selected' : ''}>${r.label}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        <button onclick="quickFilter('noShelf')" class="px-3 py-1.5 text-xs sm:text-sm rounded-lg border ${currentFilters.noShelf ? 'bg-amber-600 text-white border-amber-600' : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'}">
                                            âš ï¸ æ£šæœªè¨­å®šã®ã¿
                                        </button>
                                    </div>
                                    <!-- åœ¨åº«ç·é¡ï¼ˆæ£šå¸ã—ç”¨ï¼‰ -->
                                    <div class="mt-3 bg-emerald-50 rounded-lg p-3 border border-emerald-200 flex justify-between items-center">
                                        <div>
                                            <p class="text-emerald-700 text-xs sm:text-sm">åœ¨åº«ç·é¡ï¼ˆæ£šå¸ã—ç”¨ï¼‰</p>
                                            <p class="text-lg sm:text-xl font-bold text-emerald-700">Â¥${summary.inStockValue.toLocaleString()}</p>
                                        </div>
                                        <p class="text-xs sm:text-sm text-emerald-600">${summary.inStock}ä»¶</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- åœ¨åº«ãƒªã‚¹ãƒˆ -->
                        <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border overflow-hidden">
                            <div class="p-3 sm:p-4 border-b bg-slate-50 flex justify-between items-center">
                                <h2 class="font-bold text-sm sm:text-base text-slate-900">åœ¨åº«ä¸€è¦§ï¼ˆ${filtered.length}ä»¶ï¼‰</h2>
                                <button onclick="showArchiveModal()" class="text-xs sm:text-sm text-slate-600 hover:text-slate-800">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
                            </div>
                            
                            <!-- æ¡ˆä»¶ã”ã¨æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤º -->
                            <div>
                                ${filtered.length === 0 ? `
                                    <div class="px-4 py-8 text-center text-slate-500 text-sm">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                                ` : (() => {
                                    const groups = groupByProject(filtered);
                                    return Object.keys(groups).map(project => {
                                        const items = groups[project];
                                        const isExpanded = expandedProjects[project];
                                        const statusCounts = {
                                            waiting: items.filter(i => i.status === 'å…¥åº«å¾…ã¡').length,
                                            inStock: items.filter(i => i.status === 'åœ¨åº«ä¸­').length,
                                            shipped: items.filter(i => i.status === 'å‡ºåº«æ¸ˆ').length,
                                            issue: items.filter(i => i.status === 'ä¸å…·åˆ').length
                                        };
                                        const folderUrl = folderCache[project] || null;
                                        return `
                                            <div class="border-b last:border-b-0">
                                                <div onclick="toggleProject('${project}')" class="p-3 sm:p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 active:bg-slate-100">
                                                    <div class="flex items-center gap-2 sm:gap-3">
                                                        <span class="text-slate-400">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                                                        <span class="font-semibold text-blue-600 text-sm sm:text-base">${project}</span>
                                                        <span class="text-xs sm:text-sm text-slate-500">(${items.length}ä»¶)</span>
                                                        ${folderUrl ? `
                                                            <a href="${folderUrl}" target="_blank" onclick="event.stopPropagation()" class="text-blue-500 hover:text-blue-700" title="Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‚’é–‹ã">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                                                            </a>
                                                        ` : (project !== 'æœªè¨­å®š' ? `
                                                            <span class="text-slate-300" title="ãƒ•ã‚©ãƒ«ãƒ€æœªæ¤œå‡º">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                                                            </span>
                                                        ` : '')}
                                                    </div>
                                                    <div class="flex gap-1 sm:gap-2">
                                                        ${statusCounts.waiting > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-amber-100 text-amber-700">å¾…${statusCounts.waiting}</span>` : ''}
                                                        ${statusCounts.inStock > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-emerald-100 text-emerald-700">åº«${statusCounts.inStock}</span>` : ''}
                                                        ${statusCounts.shipped > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">å‡º${statusCounts.shipped}</span>` : ''}
                                                        ${statusCounts.issue > 0 ? `<span class="px-1.5 sm:px-2 py-0.5 rounded text-xs bg-red-100 text-red-700">ä¸${statusCounts.issue}</span>` : ''}
                                                    </div>
                                                </div>
                                                ${isExpanded ? `
                                                    <!-- PC: ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º -->
                                                    <div class="hidden md:block bg-slate-50 border-t">
                                                        <table class="w-full">
                                                            <thead class="bg-slate-100">
                                                                <tr>
                                                                    ${bulkSelectMode ? `<th class="px-2 py-2 text-center w-8"><input type="checkbox" onclick="toggleSelectAll('${project}')" class="w-4 h-4 rounded"></th>` : ''}
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">Serial</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">ç¨®åˆ¥</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">è£½å“å</th>
                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700">æ£šç•ª</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">å…¥åº«æ—¥</th>
                                                                    <th class="px-3 py-2 text-right text-xs font-semibold text-slate-700">åŸä¾¡(ç¨è¾¼)</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700">å‡ºåº«å…ˆ</th>
                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-slate-700">æ“ä½œ</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="divide-y bg-white">
                                                                ${items.map(item => `
                                                                    <tr class="hover:bg-slate-50 ${selectedItems.has(item.id) ? 'bg-amber-50' : ''}">
                                                                        ${bulkSelectMode ? `<td class="px-2 py-2 text-center"><input type="checkbox" ${selectedItems.has(item.id) ? 'checked' : ''} onclick="toggleSelectItem('${item.id}')" class="w-4 h-4 rounded"></td>` : ''}
                                                                        <td class="px-3 py-2 font-mono font-semibold text-sm text-slate-900">${item.serial}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600">${item.category}</td>
                                                                        <td class="px-3 py-2 text-xs">${item.productName}</td>
                                                                        <td class="px-3 py-2 text-center text-xs font-semibold text-purple-600">${item.shelfNo || '-'}</td>
                                                                        <td class="px-3 py-2 text-xs text-slate-600">${item.receiveDate || '-'}</td>
                                                                        <td class="px-3 py-2 text-xs text-right font-semibold">${item.costJPY ? 'Â¥' + Number(item.costJPY).toLocaleString() : '-'}</td>
                                                                        <td class="px-3 py-2">
                                                                            <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                                            ${item.location === 'æ±äº¬' ? '<span class="ml-1 px-1.5 py-0.5 rounded text-xs font-semibold bg-rose-100 text-rose-600">æ±äº¬</span>' : ''}
                                                                            ${item.location === 'å¤§é˜ª' ? '<span class="ml-1 px-1.5 py-0.5 rounded text-xs font-semibold bg-teal-100 text-teal-600">å¤§é˜ª</span>' : ''}
                                                                        </td>
                                                                        <td class="px-3 py-2 text-xs">${item.shipProject || '-'}</td>
                                                                        <td class="px-3 py-2 text-center">
                                                                            <div class="flex gap-1 justify-center">
                                                                                ${item.status === 'å…¥åº«å¾…ã¡' ? `
                                                                                    <button onclick="event.stopPropagation();showReceiveModal('${item.id}')" class="px-2 py-1 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">å…¥åº«</button>
                                                                                ` : ''}
                                                                                ${item.status === 'åœ¨åº«ä¸­' ? `
                                                                                    <button onclick="event.stopPropagation();showShipModal('${item.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å‡ºåº«</button>
                                                                                ` : ''}
                                                                                <button onclick="event.stopPropagation();editItem('${item.id}')" class="px-2 py-1 bg-slate-200 text-slate-700 text-xs rounded hover:bg-slate-300">ç·¨é›†</button>
                                                                                ${item.status === 'å‡ºåº«æ¸ˆ' ? `
                                                                                    <button onclick="event.stopPropagation();archiveItem('${item.id}')" class="px-2 py-1 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">ä¿ç®¡</button>
                                                                                ` : ''}
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <!-- ã‚¹ãƒãƒ›: ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
                                                    <div class="md:hidden bg-slate-50">
                                                        ${items.map(item => `
                                                            <div class="p-3 border-t border-slate-200 ${selectedItems.has(item.id) ? 'bg-amber-50' : ''}">
                                                                <div class="flex justify-between items-start mb-2">
                                                                    <div class="flex items-center gap-2">
                                                                        ${bulkSelectMode ? `<input type="checkbox" ${selectedItems.has(item.id) ? 'checked' : ''} onclick="toggleSelectItem('${item.id}')" class="w-4 h-4 rounded">` : ''}
                                                                        <div>
                                                                            <p class="font-mono font-bold text-sm text-slate-900">${item.serial}</p>
                                                                            <p class="text-xs text-slate-500">${item.category}</p>
                                                                        </div>
                                                                    </div>
                                                                    <div class="flex items-center gap-1">
                                                                        ${item.shelfNo ? `<span class="px-1.5 py-0.5 rounded text-xs font-semibold bg-purple-100 text-purple-700">æ£š${item.shelfNo}</span>` : ''}
                                                                        ${item.location === 'æ±äº¬' ? '<span class="px-1.5 py-0.5 rounded text-xs font-semibold bg-rose-100 text-rose-600">æ±äº¬</span>' : ''}
                                                                        ${item.location === 'å¤§é˜ª' ? '<span class="px-1.5 py-0.5 rounded text-xs font-semibold bg-teal-100 text-teal-600">å¤§é˜ª</span>' : ''}
                                                                        <span class="px-2 py-0.5 rounded text-xs font-semibold ${getStatusClass(item.status)}">${item.status}</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-xs text-slate-800 mb-1">${item.productName}</p>
                                                                <div class="flex justify-between items-center text-xs text-slate-500 mb-2">
                                                                    <span>å…¥åº«: ${item.receiveDate || '-'}</span>
                                                                    <span>åŸä¾¡: ${item.costJPY ? 'Â¥' + Number(item.costJPY).toLocaleString() : '-'}</span>
                                                                </div>
                                                                <div class="flex gap-2">
                                                                    ${item.status === 'å…¥åº«å¾…ã¡' ? `
                                                                        <button onclick="event.stopPropagation();showReceiveModal('${item.id}')" class="flex-1 px-3 py-1.5 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">å…¥åº«</button>
                                                                    ` : ''}
                                                                    ${item.status === 'åœ¨åº«ä¸­' ? `
                                                                        <button onclick="event.stopPropagation();showShipModal('${item.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å‡ºåº«</button>
                                                                    ` : ''}
                                                                    <button onclick="event.stopPropagation();editItem('${item.id}')" class="px-3 py-1.5 bg-slate-200 text-slate-700 text-xs rounded hover:bg-slate-300">ç·¨é›†</button>
                                                                    ${item.status === 'å‡ºåº«æ¸ˆ' ? `
                                                                        <button onclick="event.stopPropagation();archiveItem('${item.id}')" class="px-3 py-1.5 bg-slate-500 text-white text-xs rounded hover:bg-slate-600">ä¿ç®¡</button>
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                            </div>
                        </div>
                    </main>
                </div>
                ${bulkSelectMode && selectedItems.size > 0 ? `
                    <div class="fixed bottom-0 left-0 right-0 bg-amber-500 text-white p-3 shadow-lg z-50">
                        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-2">
                            <span class="font-semibold text-sm">${selectedItems.size}ä»¶é¸æŠä¸­</span>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="showBulkShelfModal()" class="px-3 py-1.5 bg-purple-600 text-white text-xs sm:text-sm rounded hover:bg-purple-700">æ£šç•ªå¤‰æ›´</button>
                                <button onclick="showBulkLocationModal()" class="px-3 py-1.5 bg-teal-600 text-white text-xs sm:text-sm rounded hover:bg-teal-700">å ´æ‰€å¤‰æ›´</button>
                                <button onclick="bulkReceive()" class="px-3 py-1.5 bg-emerald-600 text-white text-xs sm:text-sm rounded hover:bg-emerald-700">ä¸€æ‹¬å…¥åº«</button>
                                <button onclick="showBulkShipModal()" class="px-3 py-1.5 bg-blue-600 text-white text-xs sm:text-sm rounded hover:bg-blue-700">ä¸€æ‹¬å‡ºåº«</button>
                                <button onclick="cancelBulkSelect()" class="px-3 py-1.5 bg-slate-600 text-white text-xs sm:text-sm rounded hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // ä¸€æ‹¬é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function toggleBulkSelectMode() {
            bulkSelectMode = !bulkSelectMode;
            if (!bulkSelectMode) {
                selectedItems.clear();
            }
            renderMain();
        }

        // ã‚¢ã‚¤ãƒ†ãƒ é¸æŠåˆ‡æ›¿
        function toggleSelectItem(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            renderMain();
        }

        // æ¡ˆä»¶å†…å…¨é¸æŠ
        function toggleSelectAll(project) {
            const filtered = getFilteredInventory();
            const projectItems = filtered.filter(i => (i.orderProject || 'æœªè¨­å®š') === project);
            const allSelected = projectItems.every(i => selectedItems.has(i.id));
            
            if (allSelected) {
                projectItems.forEach(i => selectedItems.delete(i.id));
            } else {
                projectItems.forEach(i => selectedItems.add(i.id));
            }
            renderMain();
        }

        // é¸æŠã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelBulkSelect() {
            bulkSelectMode = false;
            selectedItems.clear();
            renderMain();
        }

        // ä¸€æ‹¬æ£šç•ªå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkShelfModal() {
            const modal = document.createElement('div');
            modal.id = 'bulkShelfModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬æ£šç•ªå¤‰æ›´ï¼ˆ${selectedItems.size}ä»¶ï¼‰</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ£šç•ª</label>
                            <select id="bulkShelfNo" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="">æœªè¨­å®š</option>
                                ${SHELF_NUMBERS.map(n => `<option value="${n}">${n}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitBulkShelf()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">å¤‰æ›´</button>
                            <button onclick="closeModal('bulkShelfModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitBulkShelf() {
            const shelfNo = document.getElementById('bulkShelfNo').value;
            selectedItems.forEach(id => {
                const item = inventory.find(i => i.id === id);
                if (item) item.shelfNo = shelfNo;
            });
            saveData();
            closeModal('bulkShelfModal');
            cancelBulkSelect();
        }

        // ä¸€æ‹¬ä¿ç®¡å ´æ‰€å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkLocationModal() {
            const modal = document.createElement('div');
            modal.id = 'bulkLocationModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬å ´æ‰€å¤‰æ›´ï¼ˆ${selectedItems.size}ä»¶ï¼‰</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ä¿ç®¡å ´æ‰€</label>
                            <select id="bulkLocation" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="">è“®ç”°ï¼ˆé€šå¸¸ï¼‰</option>
                                <option value="æ±äº¬">æ±äº¬</option>
                                <option value="å¤§é˜ª">å¤§é˜ª</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitBulkLocation()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">å¤‰æ›´</button>
                            <button onclick="closeModal('bulkLocationModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitBulkLocation() {
            const location = document.getElementById('bulkLocation').value;
            selectedItems.forEach(id => {
                const item = inventory.find(i => i.id === id);
                if (item) item.location = location;
            });
            saveData();
            closeModal('bulkLocationModal');
            cancelBulkSelect();
        }

        // ä¸€æ‹¬å…¥åº«
        function bulkReceive() {
            const waitingItems = Array.from(selectedItems).filter(id => {
                const item = inventory.find(i => i.id === id);
                return item && item.status === 'å…¥åº«å¾…ã¡';
            });
            
            if (waitingItems.length === 0) {
                alert('å…¥åº«å¾…ã¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!confirm(`${waitingItems.length}ä»¶ã‚’å…¥åº«ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            
            const today = new Date().toISOString().split('T')[0];
            waitingItems.forEach(id => {
                const item = inventory.find(i => i.id === id);
                if (item) {
                    item.status = 'åœ¨åº«ä¸­';
                    item.receiveDate = today;
                }
            });
            
            saveData();
            cancelBulkSelect();
        }

        // ä¸€æ‹¬å‡ºåº«ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBulkShipModal() {
            const inStockItems = Array.from(selectedItems).filter(id => {
                const item = inventory.find(i => i.id === id);
                return item && item.status === 'åœ¨åº«ä¸­';
            });
            
            if (inStockItems.length === 0) {
                alert('åœ¨åº«ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'bulkShipModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white">ä¸€æ‹¬å‡ºåº«ï¼ˆ${inStockItems.length}ä»¶ï¼‰</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå·</label>
                            <input type="text" id="bulkShipProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="AD-1700">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‡ºåº«æ—¥</label>
                            <input type="date" id="bulkShipDate" value="${today}" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="submitBulkShip()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å‡ºåº«</button>
                            <button onclick="closeModal('bulkShipModal')" class="flex-1 px-4 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-white rounded-lg hover:bg-slate-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitBulkShip() {
            const shipProject = document.getElementById('bulkShipProject').value.trim();
            const shipDate = document.getElementById('bulkShipDate').value;
            
            if (!shipProject) {
                alert('å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const inStockItems = Array.from(selectedItems).filter(id => {
                const item = inventory.find(i => i.id === id);
                return item && item.status === 'åœ¨åº«ä¸­';
            });
            
            inStockItems.forEach(id => {
                const item = inventory.find(i => i.id === id);
                if (item) {
                    item.status = 'å‡ºåº«æ¸ˆ';
                    item.shipProject = shipProject;
                    item.shipDate = shipDate;
                }
            });
            
            saveData();
            closeModal('bulkShipModal');
            cancelBulkSelect();
        }

        function applyFilters() {
            const categoryEl = document.getElementById('filterCategory');
            const statusEl = document.getElementById('filterStatus');
            const searchEl = document.getElementById('filterSearch');
            const sortEl = document.getElementById('filterSort');
            const shelfNoEl = document.getElementById('filterShelfNo');
            const receiveDateFromEl = document.getElementById('filterReceiveDateFrom');
            const receiveDateToEl = document.getElementById('filterReceiveDateTo');
            const shipProjectEl = document.getElementById('filterShipProject');
            const costRangeEl = document.getElementById('filterCostRange');
            
            if (categoryEl) currentFilters.category = categoryEl.value;
            if (statusEl) currentFilters.status = statusEl.value;
            if (searchEl) currentFilters.search = searchEl.value;
            if (sortEl) currentFilters.sort = sortEl.value;
            if (shelfNoEl) currentFilters.shelfNo = shelfNoEl.value;
            if (receiveDateFromEl) currentFilters.receiveDateFrom = receiveDateFromEl.value;
            if (receiveDateToEl) currentFilters.receiveDateTo = receiveDateToEl.value;
            if (shipProjectEl) currentFilters.shipProject = shipProjectEl.value;
            if (costRangeEl) currentFilters.costRange = costRangeEl.value;
            renderMain();
        }

        function clearFilters() {
            currentFilters = { 
                category: '', 
                status: '', 
                search: '', 
                sort: 'orderDate-desc', 
                shelfNo: '',
                receiveDateFrom: '',
                receiveDateTo: '',
                shipProject: '',
                costRange: '',
                noShelf: false,
                location: ''
            };
            expandedProjects = {};
            showDetailFilters = false;
            renderMain();
        }

        function quickFilter(type) {
            // ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿ã¯ãƒˆã‚°ãƒ«å¼
            if (type === 'noShelf') {
                currentFilters.noShelf = !currentFilters.noShelf;
                currentFilters.category = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'multi') {
                if (currentFilters.category === 'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤';
                }
                currentFilters.noShelf = false;
                currentFilters.location = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'blackboard') {
                if (currentFilters.category === 'STUDIA') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'STUDIA';
                }
                currentFilters.noShelf = false;
                currentFilters.location = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'outdoor') {
                if (currentFilters.category === 'å±‹å¤–') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'å±‹å¤–';
                }
                currentFilters.noShelf = false;
                currentFilters.location = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'indoor') {
                if (currentFilters.category === 'å±‹å†…') {
                    currentFilters.category = '';
                } else {
                    currentFilters.category = 'å±‹å†…';
                }
                currentFilters.noShelf = false;
                currentFilters.location = '';
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'tokyo') {
                if (currentFilters.location === 'æ±äº¬') {
                    currentFilters.location = '';
                } else {
                    currentFilters.location = 'æ±äº¬';
                }
                currentFilters.category = '';
                currentFilters.noShelf = false;
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            } else if (type === 'osaka') {
                if (currentFilters.location === 'å¤§é˜ª') {
                    currentFilters.location = '';
                } else {
                    currentFilters.location = 'å¤§é˜ª';
                }
                currentFilters.category = '';
                currentFilters.noShelf = false;
                if (currentFilters.status === 'ä¸å…·åˆ') currentFilters.status = '';
            }
            renderMain();
        }

        function toggleDetailFilters() {
            showDetailFilters = !showDetailFilters;
            renderMain();
        }

        // åœ¨åº«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showAddInventoryModal() {
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'addModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">åœ¨åº«è¿½åŠ </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Serial <span class="text-red-500">*</span></label>
                                <input type="text" id="addSerial" class="w-full px-3 py-2 border rounded-lg" placeholder="YS0554-1">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ç¨®åˆ¥ <span class="text-red-500">*</span></label>
                                <select id="addCategory" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    ${CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">è£½å“å <span class="text-red-500">*</span></label>
                                <input type="text" id="addProductName" class="w-full px-3 py-2 border rounded-lg" placeholder="è£½å“åã‚’å…¥åŠ›">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ç™ºæ³¨æ¡ˆä»¶ç•ªå·</label>
                                <input type="text" id="addOrderProject" class="w-full px-3 py-2 border rounded-lg" placeholder="AD-1682">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ç™ºæ³¨æ—¥</label>
                                <input type="date" id="addOrderDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">æ•°é‡ï¼ˆè¤‡æ•°å°ã®å ´åˆï¼‰</label>
                                <input type="number" id="addQuantity" class="w-full px-3 py-2 border rounded-lg" value="1" min="1">
                                <p class="text-xs text-slate-500 mt-1">è¤‡æ•°ã®å ´åˆã€Serial-1, Serial-2... ã¨é€£ç•ªã§è¿½åŠ ã•ã‚Œã¾ã™</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">å‚™è€ƒ</label>
                                <textarea id="addNote" class="w-full px-3 py-2 border rounded-lg" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('addModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitAddInventory()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">è¿½åŠ </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitAddInventory() {
            const serial = document.getElementById('addSerial').value.trim();
            const category = document.getElementById('addCategory').value;
            const productName = document.getElementById('addProductName').value.trim();
            const orderProject = document.getElementById('addOrderProject').value.trim();
            const orderDate = document.getElementById('addOrderDate').value;
            const quantity = parseInt(document.getElementById('addQuantity').value) || 1;
            const note = document.getElementById('addNote').value.trim();

            if (!serial || !category || !productName) {
                alert('Serialã€ç¨®åˆ¥ã€è£½å“åã¯å¿…é ˆã§ã™');
                return;
            }

            for (let i = 1; i <= quantity; i++) {
                const itemSerial = quantity > 1 ? `${serial}-${i}` : serial;
                inventory.push({
                    id: Date.now().toString() + '-' + i,
                    serial: itemSerial,
                    category,
                    productName,
                    orderProject,
                    orderDate,
                    receiveDate: '',
                    status: 'å…¥åº«å¾…ã¡',
                    shipDate: '',
                    shipProject: '',
                    costJPY: '',
                    note
                });
            }

            saveData();
            closeModal('addModal');
            renderMain();
        }

        // å…¥åº«ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showReceiveModal(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'receiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4">å…¥åº«å‡¦ç†</h3>
                        <p class="text-sm text-slate-600 mb-2">Serial: <span class="font-mono font-semibold">${item.serial}</span></p>
                        <p class="text-sm text-slate-600 mb-4">${item.productName}</p>
                        <div>
                            <label class="block text-sm font-semibold mb-1">å…¥åº«æ—¥ <span class="text-red-500">*</span></label>
                            <input type="date" id="receiveDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('receiveModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitReceive('${id}')" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">å…¥åº«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitReceive(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const receiveDate = document.getElementById('receiveDate').value;

            if (!receiveDate) {
                alert('å…¥åº«æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            item.receiveDate = receiveDate;
            item.status = 'åœ¨åº«ä¸­';
            
            saveData();
            closeModal('receiveModal');
            renderMain();
        }

        // å‡ºåº«ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showShipModal(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.id = 'shipModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4">å‡ºåº«å‡¦ç†</h3>
                        <p class="text-sm text-slate-600 mb-2">Serial: <span class="font-mono font-semibold">${item.serial}</span></p>
                        <p class="text-sm text-slate-600 mb-4">${item.productName}</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå· <span class="text-red-500">*</span></label>
                                <input type="text" id="shipProject" class="w-full px-3 py-2 border rounded-lg" value="${item.orderProject || ''}" placeholder="AD-1700">
                                <p class="text-xs text-slate-500 mt-1">ç™ºæ³¨æ¡ˆä»¶ã¨ç•°ãªã‚‹å ´åˆã¯å¤‰æ›´ã—ã¦ãã ã•ã„</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">å‡ºåº«æ—¥</label>
                                <input type="date" id="shipDate" class="w-full px-3 py-2 border rounded-lg" value="${today}">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('shipModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitShip('${id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å‡ºåº«</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitShip(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const shipProject = document.getElementById('shipProject').value.trim();
            const shipDate = document.getElementById('shipDate').value;

            if (!shipProject) {
                alert('å‡ºåº«å…ˆæ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            item.shipProject = shipProject;
            item.shipDate = shipDate;
            item.status = 'å‡ºåº«æ¸ˆ';
            
            saveData();
            closeModal('shipModal');
            renderMain();
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const modal = document.createElement('div');
            modal.id = 'editModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">åœ¨åº«ç·¨é›†</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Serial</label>
                                <input type="text" id="editSerial" class="w-full px-3 py-2 border rounded-lg" value="${item.serial}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ç¨®åˆ¥</label>
                                <select id="editCategory" class="w-full px-3 py-2 border rounded-lg">
                                    ${CATEGORIES.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">è£½å“å</label>
                                <input type="text" id="editProductName" class="w-full px-3 py-2 border rounded-lg" value="${item.productName}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">æ£šç•ª</label>
                                <select id="editShelfNo" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">æœªè¨­å®š</option>
                                    ${SHELF_NUMBERS.map(n => `<option value="${n}" ${item.shelfNo === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ä¿ç®¡å ´æ‰€</label>
                                <select id="editLocation" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="" ${!item.location || item.location === 'è“®ç”°' ? 'selected' : ''}>è“®ç”°ï¼ˆé€šå¸¸ï¼‰</option>
                                    <option value="æ±äº¬" ${item.location === 'æ±äº¬' ? 'selected' : ''}>æ±äº¬</option>
                                    <option value="å¤§é˜ª" ${item.location === 'å¤§é˜ª' ? 'selected' : ''}>å¤§é˜ª</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ç™ºæ³¨æ¡ˆä»¶ç•ªå·</label>
                                <input type="text" id="editOrderProject" class="w-full px-3 py-2 border rounded-lg" value="${item.orderProject}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ç™ºæ³¨æ—¥</label>
                                <input type="date" id="editOrderDate" class="w-full px-3 py-2 border rounded-lg" value="${item.orderDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">å…¥åº«æ—¥</label>
                                <input type="date" id="editReceiveDate" class="w-full px-3 py-2 border rounded-lg" value="${item.receiveDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">å–å¾—é‡‘ï¼ˆç¨è¾¼å††ï¼‰</label>
                                <input type="number" id="editCostJPY" class="w-full px-3 py-2 border rounded-lg" value="${item.costJPY || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="editStatus" class="w-full px-3 py-2 border rounded-lg">
                                    ${STATUSES.map(s => `<option value="${s}" ${item.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">å‡ºåº«æ—¥</label>
                                <input type="date" id="editShipDate" class="w-full px-3 py-2 border rounded-lg" value="${item.shipDate}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">å‡ºåº«å…ˆæ¡ˆä»¶</label>
                                <input type="text" id="editShipProject" class="w-full px-3 py-2 border rounded-lg" value="${item.shipProject}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">å‚™è€ƒ</label>
                                <textarea id="editNote" class="w-full px-3 py-2 border rounded-lg" rows="2">${item.note}</textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('editModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="deleteItem('${id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">å‰Šé™¤</button>
                            <button onclick="submitEdit('${id}')" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitEdit(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            item.serial = document.getElementById('editSerial').value.trim();
            item.category = document.getElementById('editCategory').value;
            item.productName = document.getElementById('editProductName').value.trim();
            item.shelfNo = document.getElementById('editShelfNo').value;
            item.location = document.getElementById('editLocation').value;
            item.orderProject = document.getElementById('editOrderProject').value.trim();
            item.orderDate = document.getElementById('editOrderDate').value;
            item.receiveDate = document.getElementById('editReceiveDate').value;
            item.costJPY = document.getElementById('editCostJPY').value;
            item.status = document.getElementById('editStatus').value;
            item.shipDate = document.getElementById('editShipDate').value;
            item.shipProject = document.getElementById('editShipProject').value.trim();
            item.note = document.getElementById('editNote').value.trim();

            saveData();
            closeModal('editModal');
            renderMain();
        }

        function deleteItem(id) {
            if (!confirm('ã“ã®åœ¨åº«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            inventory = inventory.filter(i => i.id !== id);
            saveData();
            closeModal('editModal');
            renderMain();
        }

        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†
        function archiveItem(id) {
            if (!confirm('ã“ã®åœ¨åº«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            archivedInventory.push(item);
            inventory = inventory.filter(i => i.id !== id);
            
            saveData();
            renderMain();
        }

        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showArchiveModal() {
            const modal = document.createElement('div');
            modal.id = 'archiveModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸€è¦§ï¼ˆ${archivedInventory.length}ä»¶ï¼‰</h3>
                            <button onclick="closeModal('archiveModal')" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm">Serial</th>
                                        <th class="px-3 py-2 text-left text-sm">ç¨®åˆ¥</th>
                                        <th class="px-3 py-2 text-left text-sm">è£½å“å</th>
                                        <th class="px-3 py-2 text-left text-sm">ç™ºæ³¨æ¡ˆä»¶</th>
                                        <th class="px-3 py-2 text-left text-sm">å‡ºåº«å…ˆ</th>
                                        <th class="px-3 py-2 text-left text-sm">å‡ºåº«æ—¥</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${archivedInventory.length === 0 ? `
                                        <tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>
                                    ` : archivedInventory.map(item => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-3 py-2 font-mono text-sm">${item.serial}</td>
                                            <td class="px-3 py-2 text-sm">${item.category}</td>
                                            <td class="px-3 py-2 text-sm">${item.productName}</td>
                                            <td class="px-3 py-2 text-sm">${item.orderProject}</td>
                                            <td class="px-3 py-2 text-sm">${item.shipProject}</td>
                                            <td class="px-3 py-2 text-sm">${item.shipDate}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        // APIèª­ã¿è¾¼ã¿ç¢ºèªã¨åˆæœŸåŒ–
        function checkAndInit() {
            if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                gapiLoaded();
                gisLoaded();
            } else {
                setTimeout(checkAndInit, 100);
            }
        }
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', checkAndInit);
    </script>
</body>
</html>
