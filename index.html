<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª¿é”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
        // PDF.js workerè¨­å®š
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap');
        * { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-slate-600 text-lg">åˆæœŸåŒ–ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        const PRODUCT_MASTER_ID = '1YnEJ5LEYBwZJ2zDYnjUpkpjnB2naHFVAtPdzcv81nvI'; // è£½å“ãƒã‚¹ã‚¿
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';
        const PARENT_FOLDER_ID = '1EvObQiCJgxJCzd_kQJ1PNbOUMD5P-Zxp';
        const IMPORT_PERMIT_FOLDER_ID = '1YELi1u_fn1NiH09P_CONfBlUNQ_DtjwL'; // è¼¸å…¥è¨±å¯æ›¸ãƒ•ã‚©ãƒ«ãƒ€
        const INVOICE_FOLDER_ID = '1NzYjGGFzbNdG2wBYT1nreiehPH_TpRJr'; // æµ·å¤–è«‹æ±‚æ›¸ãƒ•ã‚©ãƒ«ãƒ€

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let suppliers = [];
        let projects = [];
        let productMaster = []; // è£½å“ãƒã‚¹ã‚¿
        let nextSerial = 554; // YS0554ã‹ã‚‰é–‹å§‹
        let showSupplierSection = false; // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹
        let showUnpaidSection = false; // æœªæ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹
        let expandedProjects = {}; // æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®å±•é–‹çŠ¶æ…‹
        let lastUpdated = null; // æœ€çµ‚æ›´æ–°æ—¥æ™‚
        let isDarkMode = localStorage.getItem('darkMode') === 'true'; // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹
        let processedPermitFiles = []; // å‡¦ç†æ¸ˆã¿è¼¸å…¥è¨±å¯æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ID
        
        // è£½å“ãƒã‚¹ã‚¿ã®ã‚·ãƒ¼ãƒˆä¸€è¦§
        const PRODUCT_MASTER_SHEETS = [
            { name: 'LCD', category: 'ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤' },
            { name: 'LED', category: 'LEDãƒ“ã‚¸ãƒ§ãƒ³' },
            { name: 'LED_others', category: 'LEDã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼' },
            { name: 'matrix-switcher', category: 'ãƒãƒˆãƒªã‚¯ã‚¹' },
            { name: 'TVwall_controller', category: 'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤' },
            { name: 'STUDIA', category: 'STUDIA' },
            { name: 'OPS', category: 'OPS' },
            { name: 'dongle', category: 'å‘¨è¾ºæ©Ÿå™¨' },
            { name: 'e-board_stand', category: 'ã‚¹ã‚¿ãƒ³ãƒ‰ãƒ»ä»€å™¨' },
            { name: 'player', category: 'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼' }
        ];
        
        // ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹
        let projectFilter = {
            status: 'all',       // all, æœªç€æ‰‹, æ”¯æ‰•ä¸­, æ”¯æ‰•æ¸ˆ, å…¥åº«å®Œäº†
            supplier: 'all',     // all or supplier id
            hideArchived: true   // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆå…¥åº«å®Œäº†ï¼‰ã‚’éè¡¨ç¤º
        };

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            document.documentElement.classList.toggle('dark', isDarkMode);
            renderMain();
        }

        // ä¸­å›½ã®ç¥æ—¥ï¼ˆ2025å¹´ãƒ»2026å¹´ï¼‰
        const chinaHolidays = [
            // 2025å¹´
            '2025-01-01', // å…ƒæ—¦
            '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', '2025-02-03', '2025-02-04', // æ˜¥ç¯€
            '2025-04-04', '2025-04-05', '2025-04-06', // æ¸…æ˜ç¯€
            '2025-05-01', '2025-05-02', '2025-05-03', '2025-05-04', '2025-05-05', // åŠ´åƒç¯€
            '2025-05-31', '2025-06-01', '2025-06-02', // ç«¯åˆç¯€
            '2025-10-01', '2025-10-02', '2025-10-03', '2025-10-04', '2025-10-05', '2025-10-06', '2025-10-07', // å›½æ…¶ç¯€
            // 2026å¹´
            '2026-01-01', // å…ƒæ—¦
            '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', '2026-02-23', // æ˜¥ç¯€
            '2026-04-04', '2026-04-05', '2026-04-06', // æ¸…æ˜ç¯€
            '2026-05-01', '2026-05-02', '2026-05-03', // åŠ´åƒç¯€
            '2026-06-19', '2026-06-20', '2026-06-21', // ç«¯åˆç¯€
            '2026-10-01', '2026-10-02', '2026-10-03', '2026-10-04', '2026-10-05', '2026-10-06', '2026-10-07', // å›½æ…¶ç¯€
        ];

        // å–¶æ¥­æ—¥è¨ˆç®—ï¼ˆæ—¥æ›œã¨ä¸­å›½ç¥æ—¥ã‚’é™¤å¤–ï¼‰
        function addWorkingDays(startDate, days) {
            let date = new Date(startDate);
            date.setDate(date.getDate() + 1); // ç¿Œæ—¥ã‹ã‚‰é–‹å§‹
            let count = 0;
            
            while (count < days) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                
                // æ—¥æ›œæ—¥(0)ã¨ä¸­å›½ç¥æ—¥ã‚’é™¤å¤–
                if (dayOfWeek !== 0 && !chinaHolidays.includes(dateStr)) {
                    count++;
                }
                
                if (count < days) {
                    date.setDate(date.getDate() + 1);
                }
            }
            
            return date;
        }

        // Serialç•ªå·ã‚’ç”Ÿæˆ
        function generateSerial(quantity) {
            const serialNum = nextSerial;
            nextSerial++;
            const serialStr = 'YS' + String(serialNum).padStart(4, '0');
            
            if (quantity <= 1) {
                return serialStr;
            } else {
                return `${serialStr}(1-${quantity})`;
            }
        }

        // Serialç•ªå·ã®æ•°å€¤éƒ¨åˆ†ã‚’å–å¾—
        function getSerialNumber(serial) {
            const match = serial.match(/YS(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        // è£½å“åã‹ã‚‰ç¨®åˆ¥ã‚’è‡ªå‹•åˆ¤å®š
        function detectCategory(productName) {
            const name = (productName || '').toLowerCase();
            
            if (name.includes('video wall') || name.includes('videowall') || name.includes('ãƒ“ãƒ‡ã‚ªã‚¦ã‚©ãƒ¼ãƒ«')) {
                return 'Video Wall';
            }
            if (name.includes('touch') || name.includes('ã‚¿ãƒƒãƒ')) {
                return 'ã‚¿ãƒƒãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤';
            }
            if (name.includes('outdoor') || name.includes('å±‹å¤–') || name.includes('è‡ªç«‹')) {
                return 'å±‹å¤–ã‚µã‚¤ãƒãƒ¼ã‚¸';
            }
            if (name.includes('led') || name.includes('ã‚¨ãƒ«ã‚¤ãƒ¼ãƒ‡ã‚£ãƒ¼')) {
                return 'LEDãƒ“ã‚¸ãƒ§ãƒ³';
            }
            if (name.includes('stb') || name.includes('player') || name.includes('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼')) {
                return 'STB';
            }
            if (name.includes('display') || name.includes('monitor') || name.includes('ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤') || name.includes('ãƒ¢ãƒ‹ã‚¿ãƒ¼') || name.includes('ã‚¤ãƒ³ãƒ')) {
                return 'ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤';
            }
            if (name.includes('stand') || name.includes('ã‚¹ã‚¿ãƒ³ãƒ‰') || name.includes('ä»€å™¨')) {
                return 'ã‚¹ã‚¿ãƒ³ãƒ‰ãƒ»ä»€å™¨';
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            return 'ãã®ä»–';
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    'https://sheets.googleapis.com/$discovery/rest?version=v4',
                    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                ],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    accessToken = resp.access_token;
                    sessionStorage.setItem('googleAccessToken', accessToken);
                    loadData();
                    renderMain();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) {
                    accessToken = savedToken;
                    gapi.client.setToken({ access_token: accessToken });
                    loadData();
                    renderMain();
                } else {
                    renderSignIn();
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = resp.access_token;
                sessionStorage.setItem('googleAccessToken', accessToken);
                await loadData();
                renderMain();
            };

            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                sessionStorage.removeItem('googleAccessToken');
                accessToken = null;
            }
            gapi.client.setToken(null);
            suppliers = [];
            projects = [];
            renderSignIn();
        }

        let folderCache = {};

        async function findFolderUrl(projectNumber) {
            if (folderCache[projectNumber]) {
                return folderCache[projectNumber];
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name = '${projectNumber}' and '${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
                    fields: 'files(id, name, webViewLink)',
                    pageSize: 1,
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true,
                    corpora: 'allDrives'
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    const url = files[0].webViewLink;
                    folderCache[projectNumber] = url;
                    return url;
                }
                return null;
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        async function loadFolderUrls() {
            for (const project of projects) {
                const projectNumberFull = formatProjectNumber(project);
                if (!folderCache[projectNumberFull]) {
                    await findFolderUrl(projectNumberFull);
                }
            }
            renderMain();
        }

        async function loadData() {
            try {
                showStatus('èª­ã¿è¾¼ã¿ä¸­...');
                
                const supplierResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A2:C',
                });
                const supplierRows = supplierResponse.result.values || [];
                suppliers = supplierRows.map(row => ({
                    id: parseInt(row[0] || Date.now()),
                    name: row[1] || '',
                    paymentPatterns: JSON.parse(row[2] || '[{"name":"æ¨™æº–","rates":[50,50]}]')
                }));

                const projectResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A2:M',
                });
                const projectRows = projectResponse.result.values || [];
                projects = projectRows.map(row => {
                    // æ–°å½¢å¼: ID, æ¥é ­è¾, ç•ªå·, ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID, è£½å“å, ç·é¡USD, ãƒ‡ãƒã‚¸ãƒƒãƒˆäºˆå®š, Serial, æ•°é‡, WorkingDays, é›†è·äºˆå®šæ—¥, ç™ºæ³¨æ—¥, è«¸è²»ç”¨
                    let projectPrefix = row[1] || 'AD';
                    let projectNumber = parseInt(row[2]) || 0;
                    
                    // å¤ã„å½¢å¼ã®å ´åˆï¼ˆrow[1]ãŒ"AD-1234"ã®ã‚ˆã†ãªå½¢å¼ï¼‰
                    if (row[1] && row[1].match(/^[A-Z]+-\d+$/i)) {
                        const match = row[1].match(/^([A-Z]+)-(\d+)$/i);
                        if (match) {
                            projectPrefix = match[1].toUpperCase();
                            projectNumber = parseInt(match[2]) || 0;
                        }
                    } else if (row[1] && row[1].endsWith('-')) {
                        // ãƒã‚¤ãƒ•ãƒ³ä»˜ãã®æ¥é ­è¾ã®å ´åˆã€ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»
                        projectPrefix = row[1].slice(0, -1).toUpperCase();
                    }
                    
                    // æ–°å½¢å¼ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆrow[3]ãŒã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼IDã£ã½ã„ã‹ã©ã†ã‹ï¼‰
                    const isNewFormat = row[3] && (row[3].length > 10 || !isNaN(parseInt(row[3])));
                    
                    const data = {
                        id: row[0] || String(Date.now()),
                        projectPrefix: projectPrefix,
                        projectNumber: projectNumber,
                        supplierId: parseInt(row[3] || 0),
                        productName: row[4] || '',
                        totalAmount: parseFloat(row[5] || 0),
                        depositSchedule: [],
                        serial: (row[7] && row[7] !== '[]') ? row[7] : '',
                        quantity: parseInt(row[8] || 1),
                        workingDays: parseInt(row[9] || 30),
                        pickupDate: (row[10] && row[10].includes('-')) ? row[10] : '',  // æ—¥ä»˜å½¢å¼ã®ã¿
                        registeredDate: row[11] || '',
                        expenses: [],
                        receivedComplete: row[13] === 'true' || row[13] === true
                    };
                    
                    // è«¸è²»ç”¨ã‚’ãƒ‘ãƒ¼ã‚¹
                    try {
                        data.expenses = JSON.parse(row[12] || '[]');
                    } catch (e) {
                        data.expenses = [];
                    }
                    
                    const supplier = suppliers.find(s => s.id === data.supplierId);
                    try {
                        data.depositSchedule = JSON.parse(row[6] || '[]');
                    } catch (e) {
                        if (supplier) {
                            const defaultPattern = supplier.paymentPatterns[0] || {rates: [50, 50]};
                            data.depositSchedule = defaultPattern.rates.map((rate, idx) => ({
                                depositNumber: idx + 1,
                                percentage: rate,
                                amountUSD: (data.totalAmount * rate / 100),
                                paid: false,
                                paidDate: null,
                                exchangeRate: null,
                                amountJPY: null
                            }));
                        }
                    }
                    
                    // nextSerialã‚’æ›´æ–°
                    if (data.serial) {
                        const serialNum = getSerialNumber(data.serial);
                        if (serialNum >= nextSerial) {
                            nextSerial = serialNum + 1;
                        }
                    }
                    
                    return data;
                });

                lastUpdated = new Date();
                showStatus('åŒæœŸå®Œäº†');
                setTimeout(() => showStatus(''), 2000);
                renderMain();
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¡ˆä»¶æŒ‡å®šãŒã‚ã‚Œã°è©²å½“æ¡ˆä»¶ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                checkUrlParams();
                
                // ãƒ•ã‚©ãƒ«ãƒ€URLã‚’éåŒæœŸã§å–å¾—
                loadFolderUrls();
                
                // è£½å“ãƒã‚¹ã‚¿ã‚’éåŒæœŸã§èª­ã¿è¾¼ã¿
                loadProductMaster();
            } catch (err) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }
        
        // è£½å“ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadProductMaster() {
            try {
                productMaster = [];
                
                for (const sheet of PRODUCT_MASTER_SHEETS) {
                    try {
                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: PRODUCT_MASTER_ID,  // è£½å“ãƒã‚¹ã‚¿
                            range: `${sheet.name}!A1:Z`,
                        });
                        
                        const rows = response.result.values || [];
                        if (rows.length < 2) continue;
                        
                        const headers = rows[0];
                        const pnFullIndex = headers.indexOf('pn_full');
                        const pnIndex = headers.indexOf('pn');
                        const typeIndex = headers.indexOf('type');
                        const categoryIndex = headers.indexOf('category');
                        const supplierIndex = headers.indexOf('supplier');
                        const isActiveIndex = headers.indexOf('is_active');
                        const inchIndex = headers.indexOf('inch');
                        
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            const isActive = isActiveIndex >= 0 ? row[isActiveIndex] : 'TRUE';
                            
                            // is_active ãŒ FALSE ãªã‚‰ ã‚¹ã‚­ãƒƒãƒ—
                            if (isActive === 'FALSE' || isActive === false) continue;
                            
                            const pnFull = pnFullIndex >= 0 ? row[pnFullIndex] : '';
                            const pn = pnIndex >= 0 ? row[pnIndex] : '';
                            
                            if (!pnFull && !pn) continue;
                            
                            productMaster.push({
                                pn: pn || '',
                                pnFull: pnFull || pn || '',
                                type: typeIndex >= 0 ? row[typeIndex] : '',
                                category: categoryIndex >= 0 ? row[categoryIndex] : sheet.category,
                                supplier: supplierIndex >= 0 ? row[supplierIndex] : '',
                                inch: inchIndex >= 0 ? row[inchIndex] : '',
                                sheetName: sheet.name
                            });
                        }
                    } catch (e) {
                        console.log(`ã‚·ãƒ¼ãƒˆ ${sheet.name} ã®èª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—:`, e.message);
                    }
                }
                
                // é‡è¤‡ã‚’é™¤å»ï¼ˆpn_fullãƒ™ãƒ¼ã‚¹ï¼‰
                const seen = new Set();
                productMaster = productMaster.filter(p => {
                    if (seen.has(p.pnFull)) return false;
                    seen.add(p.pnFull);
                    return true;
                });
                
                console.log(`è£½å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${productMaster.length}ä»¶`);
            } catch (err) {
                console.error('è£½å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        async function saveData() {
            if (!accessToken) return;
            try {
                showStatus('ä¿å­˜ä¸­...');
                
                const supplierData = [
                    ['ID', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å', 'æ”¯æ‰•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³'],
                    ...suppliers.map(s => [s.id, s.name, JSON.stringify(s.paymentPatterns)])
                ];
                // ã¾ãšã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ›¸ãè¾¼ã¿ï¼ˆå‰Šé™¤ã•ã‚ŒãŸè¡Œã‚‚åæ˜ ï¼‰
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A:Z'
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A1',
                    valueInputOption: 'RAW',
                    resource: { values: supplierData }
                });

                const projectData = [
                    ['ID', 'æ¥é ­è¾', 'ç•ªå·', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID', 'è£½å“å', 'ç·é¡USD', 'ãƒ‡ãƒã‚¸ãƒƒãƒˆäºˆå®š', 'Serial', 'æ•°é‡', 'WorkingDays', 'é›†è·äºˆå®šæ—¥', 'ç™ºæ³¨æ—¥', 'è«¸è²»ç”¨', 'å…¥åº«å®Œäº†'],
                    ...projects.map(p => [
                        p.id, 
                        p.projectPrefix || 'AD', 
                        p.projectNumber, 
                        p.supplierId, 
                        p.productName, 
                        p.totalAmount, 
                        JSON.stringify(p.depositSchedule), 
                        p.serial || '', 
                        p.quantity || 1, 
                        p.workingDays || 30, 
                        p.pickupDate || '',
                        p.registeredDate || '',
                        JSON.stringify(p.expenses || []),
                        p.receivedComplete ? 'true' : ''
                    ])
                ];
                // ã¾ãšã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ›¸ãè¾¼ã¿ï¼ˆå‰Šé™¤ã•ã‚ŒãŸè¡Œã‚‚åæ˜ ï¼‰
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A:Z'
                });
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A1',
                    valueInputOption: 'RAW',
                    resource: { values: projectData }
                });

                showStatus('ä¿å­˜å®Œäº†');
                setTimeout(() => showStatus(''), 2000);
            } catch (err) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        function addSupplier(name, paymentPatterns) {
            suppliers.push({ id: Date.now(), name, paymentPatterns });
            saveData();
        }

        async function addProject(projectNumberInput, supplierId, productName, totalAmount, quantity, workingDays, category, patternIndex = 0) {
            // æ¡ˆä»¶ç•ªå·ã‚’è§£æï¼ˆAD-1234 å½¢å¼ã¾ãŸã¯ 1234 å½¢å¼ï¼‰
            const parsed = parseProjectNumberString(projectNumberInput);
            
            const supplier = suppliers.find(s => s.id === parseInt(supplierId));
            let depositRates = [50, 50]; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            if (supplier && supplier.paymentPatterns && supplier.paymentPatterns[patternIndex]) {
                depositRates = supplier.paymentPatterns[patternIndex].rates;
            }
            const depositSchedule = depositRates.map((rate, idx) => ({
                depositNumber: idx + 1,
                percentage: rate,
                amountUSD: (parseFloat(totalAmount) * rate / 100),
                paid: false,
                paidDate: null,
                exchangeRate: null,
                amountJPY: null
            }));
            
            const serial = generateSerial(quantity);
            
            // æ¡ˆä»¶ç™»éŒ²æ—¥ã‹ã‚‰é›†è·äºˆå®šæ—¥ã‚’è¨ˆç®—
            const today = new Date();
            const pickupDate = addWorkingDays(today, workingDays);
            const pickupDateStr = pickupDate.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            
            const projectNumberFull = `${parsed.prefix}-${parsed.number}`;
            
            projects.push({
                id: String(Date.now()),
                projectPrefix: parsed.prefix,
                projectNumber: parsed.number,
                supplierId: parseInt(supplierId),
                productName,
                totalAmount: parseFloat(totalAmount),
                depositSchedule: depositSchedule,
                serial: serial,
                quantity: quantity,
                workingDays: workingDays,
                pickupDate: pickupDateStr,
                registeredDate: todayStr,
                expenses: [] // è«¸è²»ç”¨ï¼ˆå›½éš›é€æ–™ã€é–¢ç¨ã€æ¶ˆè²»ç¨ãªã©ï¼‰
            });
            saveData();

            // åœ¨åº«ã‚·ãƒ¼ãƒˆã«ã‚‚è¿½åŠ 
            if (category) {
                await addToInventory(serial, category, productName, projectNumberFull, todayStr, quantity);
            }
        }

        // åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã™ã‚‹é–¢æ•°
        async function addToInventory(serial, category, productName, projectNumber, orderDate, quantity, supplierId = '') {
            try {
                // æ¡ˆä»¶ç•ªå·ã‚’åˆ†è§£
                const parsed = parseProjectNumberString(projectNumber);
                
                // æ—¢å­˜ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let existingInventory = [];
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A2:Q',
                    });
                    existingInventory = response.result.values || [];
                } catch (e) {
                    // ã‚·ãƒ¼ãƒˆãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆï¼ˆæ–°å½¢å¼17åˆ—ï¼‰
                    await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            requests: [{
                                addSheet: {
                                    properties: { title: 'åœ¨åº«' }
                                }
                            }]
                        }
                    });
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A1:Q1',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¥é ­è¾', 'ç™ºæ³¨ç•ªå·', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«æ¥é ­è¾', 'å‡ºåº«ç•ªå·', 'å–å¾—é‡‘(ç¨è¾¼)', 'å‚™è€ƒ', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID']]
                        }
                    });
                }

                // è¿½åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆæ–°å½¢å¼17åˆ—ï¼‰
                const baseSerial = serial.replace(/\(.*\)/, ''); // YS0554(1-4) â†’ YS0554
                const newRows = [];
                
                for (let i = 1; i <= quantity; i++) {
                    const itemSerial = quantity > 1 ? `${baseSerial}-${i}` : baseSerial;
                    
                    newRows.push([
                        Date.now().toString() + '-' + i,  // ID
                        itemSerial,                        // Serial
                        category,                          // ç¨®åˆ¥
                        productName,                       // è£½å“å
                        parsed.prefix,                     // ç™ºæ³¨æ¥é ­è¾
                        padProjectNumber(parsed.number),   // ç™ºæ³¨ç•ªå·ï¼ˆ4æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
                        orderDate,                         // ç™ºæ³¨æ—¥
                        '',                                // å…¥åº«æ—¥
                        'å…¥åº«å¾…ã¡',                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                        '',                                // å‡ºåº«æ—¥
                        '',                                // å‡ºåº«æ¥é ­è¾
                        '',                                // å‡ºåº«ç•ªå·
                        '',                                // å–å¾—é‡‘
                        '',                                // å‚™è€ƒ
                        '',                                // æ£šç•ª
                        '',                                // ä¿ç®¡å ´æ‰€
                        supplierId                         // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID
                    ]);
                }

                // åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ 
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A:Q',
                    valueInputOption: 'RAW',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: newRows
                    }
                });

            } catch (err) {
                console.error('åœ¨åº«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        async function markPaymentPaid(projectId, depositNumber, paidDate, exchangeRate) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (project) {
                const deposit = project.depositSchedule.find(d => d.depositNumber === depositNumber);
                if (deposit) {
                    deposit.paid = true;
                    deposit.paidDate = paidDate;
                    deposit.exchangeRate = parseFloat(exchangeRate);
                    deposit.amountJPY = deposit.amountUSD * parseFloat(exchangeRate);
                    saveData();
                    
                    // å…¨æ”¯æ‰•ã„å®Œäº†ã‹ãƒã‚§ãƒƒã‚¯
                    const allPaid = project.depositSchedule.every(d => d.paid);
                    if (allPaid) {
                        await updateInventoryCost(project);
                    }
                }
            }
        }
        
        // åœ¨åº«ã®å–å¾—é‡‘ã‚’æ›´æ–°
        async function updateInventoryCost(project) {
            try {
                // è£½å“ä»£ï¼ˆãƒ‡ãƒã‚¸ãƒƒãƒˆåˆè¨ˆï¼‰ã®ã¿ã€‚è«¸è²»ç”¨ã¯å«ã‚ãªã„
                const depositTotal = project.depositSchedule.reduce((sum, d) => sum + (d.amountJPY || 0), 0);
                
                // 1å°ã‚ãŸã‚Šã®å–å¾—é‡‘
                const quantity = project.quantity || 1;
                const costPerUnit = Math.round(depositTotal / quantity);
                
                if (costPerUnit <= 0) return;
                
                // åœ¨åº«ã‚·ãƒ¼ãƒˆã‹ã‚‰è©²å½“ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A2:Q',
                });
                const rows = response.result.values || [];
                
                // æ¡ˆä»¶ç•ªå·ãŒä¸€è‡´ã™ã‚‹è¡Œã‚’æ¢ã™
                const projectPrefix = project.projectPrefix || 'AD';
                const projectNumber = String(project.projectNumber).padStart(4, '0');
                const updates = [];
                
                rows.forEach((row, idx) => {
                    const rowPrefix = row[4] || '';
                    const rowNumber = String(row[5] || '').padStart(4, '0');
                    
                    if (rowPrefix.toUpperCase() === projectPrefix.toUpperCase() && rowNumber === projectNumber) {
                        // è¡Œç•ªå·ï¼ˆ1å§‹ã¾ã‚Šã€ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†+1ï¼‰
                        const rowNum = idx + 2;
                        updates.push({
                            range: `åœ¨åº«!M${rowNum}`,
                            values: [[costPerUnit]]
                        });
                    }
                });
                
                if (updates.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            valueInputOption: 'RAW',
                            data: updates
                        }
                    });
                    console.log(`åœ¨åº«å–å¾—é‡‘ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${projectPrefix}-${projectNumber} â†’ Â¥${costPerUnit.toLocaleString()} Ã— ${updates.length}å°`);
                    showStatus(`åœ¨åº«ã®å–å¾—é‡‘ã‚’æ›´æ–°ã—ã¾ã—ãŸ: Â¥${costPerUnit.toLocaleString()}/å°`);
                    setTimeout(() => showStatus(''), 3000);
                }
            } catch (e) {
                console.error('åœ¨åº«å–å¾—é‡‘ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            }
        }
        
        // ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆä¿®æ­£ï¼ˆæ”¯æ‰•ã„æ¸ˆã¿ã®å ´åˆï¼‰
        async function editPaymentRate(projectId, depositNumber) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;
            
            const deposit = project.depositSchedule.find(d => d.depositNumber === depositNumber);
            if (!deposit || !deposit.paid) return;
            
            const currentRate = deposit.exchangeRate || '';
            const newRate = prompt(`ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆå††/USDï¼‰ã‚’å…¥åŠ›:\n\nç¾åœ¨: Â¥${currentRate || 'æœªè¨­å®š'}\nUSDé‡‘é¡: $${deposit.amountUSD?.toFixed(2) || 0}`, currentRate || '');
            
            if (!newRate) return;
            
            const rate = parseFloat(newRate);
            if (isNaN(rate) || rate <= 0) {
                alert('æœ‰åŠ¹ãªç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            deposit.exchangeRate = rate;
            deposit.amountJPY = deposit.amountUSD * rate;
            
            await saveData();
            renderMain();
            showStatus('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            setTimeout(() => showStatus(''), 2000);
        }
        
        // ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆè¨­å®šï¼ˆæœªè¨­å®šã®å ´åˆã€æ”¯æ‰•æ—¥ã‹ã‚‰è‡ªå‹•å–å¾—ã‚’è©¦ã¿ã‚‹ï¼‰
        async function fixExchangeRate(projectId, depositNumber) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;
            
            const deposit = project.depositSchedule.find(d => d.depositNumber === depositNumber);
            if (!deposit || !deposit.paid) return;
            
            // æ”¯æ‰•æ—¥ãŒã‚ã‚Œã°è‡ªå‹•å–å¾—ã‚’è©¦ã¿ã‚‹
            let suggestedRate = null;
            if (deposit.paidDate) {
                showStatus('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—ä¸­...');
                suggestedRate = await getExchangeRate(deposit.paidDate);
            }
            
            let rate;
            if (suggestedRate) {
                const useAuto = confirm(`æ”¯æ‰•æ—¥(${deposit.paidDate})ã®ãƒ¬ãƒ¼ãƒˆ: Â¥${suggestedRate.toFixed(2)}\n\nã“ã®ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ`);
                if (useAuto) {
                    rate = suggestedRate;
                } else {
                    const input = prompt('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆå††/USDï¼‰:', suggestedRate.toFixed(2));
                    rate = input ? parseFloat(input) : null;
                }
            } else {
                const input = prompt(`ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆå††/USDï¼‰ã‚’å…¥åŠ›:\n\nUSDé‡‘é¡: $${deposit.amountUSD?.toFixed(2) || 0}`);
                rate = input ? parseFloat(input) : null;
            }
            
            if (!rate || isNaN(rate) || rate <= 0) {
                showStatus('');
                return;
            }
            
            deposit.exchangeRate = rate;
            deposit.amountJPY = deposit.amountUSD * rate;
            
            await saveData();
            renderMain();
            showStatus('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã—ãŸ');
            setTimeout(() => showStatus(''), 2000);
        }

        function exportCSV() {
            const headers = ['æ¡ˆä»¶ç•ªå·', 'è£½å“å', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼', 'æ”¯æ‰•å›', 'æ”¯æ‰•äºˆå®šé¡(USD)', 'æ”¯æ‰•çŠ¶æ³', 'æ”¯æ‰•æ—¥', 'ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ', 'æ”¯æ‰•é¡(JPY)'];
            const rows = projects.flatMap(p => {
                const supplier = suppliers.find(s => s.id === p.supplierId);
                return (p.depositSchedule || []).map(dep => [
                    formatProjectNumber(p), 
                    p.productName, 
                    supplier?.name || '', 
                    dep.depositNumber,
                    (dep.amountUSD || 0).toFixed(2),
                    dep.paid ? 'å®Œäº†' : 'æœªæ‰•',
                    dep.paidDate || '',
                    dep.exchangeRate || '',
                    dep.amountJPY || ''
                ]);
            });
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `procurement_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function showStatus(msg) {
            const el = document.getElementById('status');
            if (el) el.textContent = msg;
        }

        // æ¡ˆä»¶ç•ªå·ã®è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¾‹: AD-0001ï¼‰4æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
        function formatProjectNumber(project) {
            if (!project) return '';
            const prefix = project.projectPrefix || 'AD';
            const number = project.projectNumber || 0;
            // 4æ¡ä»¥ä¸‹ã¯4æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã€5æ¡ä»¥ä¸Šã¯ãã®ã¾ã¾
            const numStr = String(number);
            const paddedNum = numStr.length <= 4 ? numStr.padStart(4, '0') : numStr;
            return `${prefix}-${paddedNum}`;
        }

        // æ¡ˆä»¶ç•ªå·æ–‡å­—åˆ—ã‹ã‚‰prefix/numberã‚’åˆ†è§£
        function parseProjectNumberString(str) {
            if (!str) return { prefix: 'AD', number: 0 };
            const match = str.match(/^([A-Z]+)-?(\d+)$/i);
            if (match) {
                return { prefix: match[1].toUpperCase(), number: parseInt(match[2]) };
            }
            // æ•°å­—ã®ã¿ã®å ´åˆ
            const numMatch = str.match(/^(\d+)$/);
            if (numMatch) {
                return { prefix: 'AD', number: parseInt(numMatch[1]) };
            }
            return { prefix: 'AD', number: 0 };
        }

        // ç•ªå·ã‚’4æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆä¿å­˜ç”¨ï¼‰
        function padProjectNumber(num) {
            const numStr = String(num || 0);
            return numStr.length <= 4 ? numStr.padStart(4, '0') : numStr;
        }

        function formatJPY(amount) {
            return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(amount || 0);
        }

        function renderSignIn() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 flex items-center justify-center p-6">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
                        <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">èª¿é”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                        <p class="text-slate-600 dark:text-slate-400 mb-6">ãƒ‡ã‚¸ã‚¿ãƒ«ã‚µã‚¤ãƒãƒ¼ã‚¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</p>
                        <p class="text-slate-700 dark:text-slate-300 mb-6">Google Sheetsã¨é€£æºã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚<br>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                        <button onclick="handleAuthClick()" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Googleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
                    </div>
                </div>`;
        }

        function renderMain() {
            const fiscalStart = new Date('2025-07-01');
            const fiscalEnd = new Date('2026-06-30');
            const fiscalPayments = projects.flatMap(p => 
                (p.depositSchedule || []).filter(dep => {
                    if (!dep.paid || !dep.paidDate) return false;
                    const d = new Date(dep.paidDate);
                    return d >= fiscalStart && d <= fiscalEnd;
                }).map(dep => ({ ...dep, project: p }))
            );
            const totalJPY = fiscalPayments.reduce((sum, p) => sum + (p.amountJPY || 0), 0);

            // å‰æœŸã®è¨ˆç®—
            const prevFiscalStart = new Date('2024-07-01');
            const prevFiscalEnd = new Date('2025-06-30');
            const prevFiscalPayments = projects.flatMap(p => 
                (p.depositSchedule || []).filter(dep => {
                    if (!dep.paid || !dep.paidDate) return false;
                    const d = new Date(dep.paidDate);
                    return d >= prevFiscalStart && d <= prevFiscalEnd;
                }).map(dep => ({ ...dep, project: p }))
            );
            const prevTotalJPY = prevFiscalPayments.reduce((sum, p) => sum + (p.amountJPY || 0), 0);

            const lastUpdatedText = lastUpdated ? lastUpdated.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) : '-';
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆè¨ˆç®—
            const pendingPayments = projects.filter(p => (p.depositSchedule || []).some(d => !d.paid)).length;
            const upcomingPickups = projects.filter(p => {
                if (!p.pickupDate) return false;
                const pickup = new Date(p.pickupDate);
                const today = new Date();
                const diff = (pickup - today) / (1000 * 60 * 60 * 24);
                return diff >= 0 && diff <= 7;
            }).length;
            
            // æœªæ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆä¸€è¦§ã‚’è¨ˆç®—
            const unpaidDeposits = [];
            projects.forEach(p => {
                const supplier = suppliers.find(s => s.id === p.supplierId);
                (p.depositSchedule || []).forEach((dep, idx) => {
                    if (!dep.paid) {
                        const orderDate = p.orderDate ? new Date(p.orderDate) : null;
                        const today = new Date();
                        const daysSinceOrder = orderDate ? Math.floor((today - orderDate) / (1000 * 60 * 60 * 24)) : null;
                        unpaidDeposits.push({
                            project: p,
                            supplier: supplier,
                            deposit: dep,
                            depositIndex: idx,
                            daysSinceOrder: daysSinceOrder
                        });
                    }
                });
            });
            // ç™ºæ³¨æ—¥ãŒå¤ã„é †ã«ã‚½ãƒ¼ãƒˆ
            unpaidDeposits.sort((a, b) => (b.daysSinceOrder || 0) - (a.daysSinceOrder || 0));
            const unpaidTotal = unpaidDeposits.reduce((sum, u) => sum + (u.deposit.amountJPY || 0), 0);
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
                    <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="max-w-7xl mx-auto px-3 sm:px-6 py-3 sm:py-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">èª¿é”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                                    <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">ãƒ‡ã‚¸ã‚¿ãƒ«ã‚µã‚¤ãƒãƒ¼ã‚¸</p>
                                </div>
                                <div class="flex items-center gap-1 sm:gap-3">
                                    <span id="status" class="text-xs sm:text-sm text-blue-600 dark:text-blue-400 hidden sm:inline"></span>
                                    <button onclick="toggleDarkMode()" class="p-1.5 sm:p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
                                        ${isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                                    </button>
                                    <div class="relative">
                                        <button onclick="toggleToolsMenu()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-purple-600 text-white text-xs sm:text-sm rounded-lg hover:bg-purple-700">
                                            <span class="hidden sm:inline">ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«</span>
                                            <span class="sm:hidden">ğŸ› ï¸</span>
                                        </button>
                                        <div id="toolsMenu" class="hidden absolute right-0 mt-2 w-52 bg-white dark:bg-slate-800 rounded-lg shadow-lg border dark:border-slate-700 z-50">
                                            <button onclick="syncInvoices()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white rounded-t-lg font-semibold text-blue-600 dark:text-blue-400">ğŸ“„ æµ·å¤–è«‹æ±‚æ›¸ã‚’åŒæœŸ</button>
                                            <button onclick="syncImportPermits()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white font-semibold text-orange-600 dark:text-orange-400">ğŸ”„ è¼¸å…¥è¨±å¯æ›¸ã‚’åŒæœŸ</button>
                                            <hr class="border-slate-200 dark:border-slate-700">
                                            <button onclick="showSupplierSummary()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white">ğŸ“Š ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ</button>
                                            <button onclick="showExchangeSimulator()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white">ğŸ’± ç‚ºæ›¿è¨ˆç®—</button>
                                            <button onclick="exportCSV()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white rounded-b-lg">ğŸ“¥ CSVå‡ºåŠ›</button>
                                        </div>
                                    </div>
                                    <a href="inventory.html" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-teal-600 text-white text-xs sm:text-sm rounded-lg hover:bg-teal-700">åœ¨åº«</a>
                                    <button onclick="handleSignoutClick()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-600 text-white text-xs sm:text-sm rounded-lg hover:bg-slate-700">
                                        <span class="hidden sm:inline">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</span>
                                        <span class="sm:hidden">â†ª</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mt-2 text-xs text-slate-500 dark:text-slate-400">
                                <span>æœ€çµ‚æ›´æ–°: ${lastUpdatedText}</span>
                                <button onclick="loadData()" class="flex items-center gap-1 hover:text-blue-600 dark:hover:text-blue-400">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    æ›´æ–°
                                </button>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-7xl mx-auto px-3 sm:px-6 py-4 sm:py-8">
                        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
                        ${(pendingPayments > 0 || upcomingPickups > 0) ? `
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${pendingPayments > 0 ? `
                                    <span class="flex items-center gap-1 px-3 py-1.5 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 text-xs sm:text-sm rounded-lg border border-amber-300 dark:border-amber-700">
                                        ğŸ’° æ”¯æ‰•å¾…ã¡ ${pendingPayments}ä»¶
                                    </span>
                                ` : ''}
                                ${upcomingPickups > 0 ? `
                                    <span class="flex items-center gap-1 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs sm:text-sm rounded-lg border border-blue-300 dark:border-blue-700">
                                        ğŸšš é›†è·äºˆå®šï¼ˆ7æ—¥ä»¥å†…ï¼‰ ${upcomingPickups}ä»¶
                                    </span>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- æœªæ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆä¸€è¦§ -->
                        ${unpaidDeposits.length > 0 ? `
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl shadow-sm border dark:border-slate-700 mb-4 sm:mb-6">
                                <button onclick="toggleUnpaidSection()" class="w-full p-3 sm:p-4 flex justify-between items-center text-left hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-lg sm:rounded-xl">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">ğŸ’°</span>
                                        <h2 class="font-bold text-sm sm:text-base text-slate-900 dark:text-white">æœªæ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆ</h2>
                                        <span class="px-2 py-0.5 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 text-xs rounded-full">${unpaidDeposits.length}ä»¶</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm font-semibold text-slate-600 dark:text-slate-300">${formatJPY(unpaidTotal)}</span>
                                        <span class="text-slate-400">${showUnpaidSection ? 'â–¼' : 'â–¶'}</span>
                                    </div>
                                </button>
                                ${showUnpaidSection ? `
                                    <div class="border-t dark:border-slate-700">
                                        <div class="overflow-x-auto">
                                            <table class="w-full">
                                                <thead class="bg-slate-50 dark:bg-slate-700/50">
                                                    <tr>
                                                        <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600 dark:text-slate-300">æ¡ˆä»¶</th>
                                                        <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600 dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</th>
                                                        <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600 dark:text-slate-300">ãƒ‡ãƒã‚¸ãƒƒãƒˆ</th>
                                                        <th class="px-3 py-2 text-right text-xs font-semibold text-slate-600 dark:text-slate-300">é‡‘é¡(ç¨è¾¼)</th>
                                                        <th class="px-3 py-2 text-right text-xs font-semibold text-slate-600 dark:text-slate-300">çµŒéæ—¥æ•°</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y dark:divide-slate-700">
                                                    ${unpaidDeposits.map(u => `
                                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer" onclick="scrollToProject(${u.project.id})">
                                                            <td class="px-3 py-2">
                                                                <span class="font-mono font-semibold text-sm text-blue-600 dark:text-blue-400">${formatProjectNumber(u.project)}</span>
                                                                <p class="text-xs text-slate-500 dark:text-slate-400 truncate max-w-32">${u.project.productName || ''}</p>
                                                            </td>
                                                            <td class="px-3 py-2 text-sm dark:text-slate-300">${u.supplier?.name || '-'}</td>
                                                            <td class="px-3 py-2 text-sm dark:text-slate-300">
                                                                ${u.deposit.percentage}%
                                                                <span class="text-xs text-slate-400">(${u.depositIndex + 1}å›ç›®)</span>
                                                            </td>
                                                            <td class="px-3 py-2 text-sm text-right font-semibold dark:text-white">
                                                                ${u.deposit.amountJPY ? formatJPY(u.deposit.amountJPY) : '-'}
                                                            </td>
                                                            <td class="px-3 py-2 text-sm text-right ${u.daysSinceOrder > 60 ? 'text-red-600 dark:text-red-400 font-semibold' : u.daysSinceOrder > 30 ? 'text-amber-600 dark:text-amber-400' : 'text-slate-600 dark:text-slate-400'}">
                                                                ${u.daysSinceOrder !== null ? u.daysSinceOrder + 'æ—¥' : '-'}
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-6 mb-4 sm:mb-8">
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm border dark:border-slate-700">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm mb-1 sm:mb-2">ä»ŠæœŸæ”¯æ‰•</p>
                                <p class="text-base sm:text-2xl font-bold text-slate-900 dark:text-white">${formatJPY(totalJPY)}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 hidden sm:block">2025/07 - 2026/06</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm border dark:border-slate-700">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm mb-1 sm:mb-2">å‰æœŸæ”¯æ‰•</p>
                                <p class="text-base sm:text-2xl font-bold text-slate-500 dark:text-slate-300">${formatJPY(prevTotalJPY)}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 hidden sm:block">2024/07 - 2025/06</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm border dark:border-slate-700">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm mb-1 sm:mb-2">æ¡ˆä»¶æ•°</p>
                                <p class="text-xl sm:text-3xl font-bold text-slate-900 dark:text-white">${projects.length}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm border dark:border-slate-700">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm mb-1 sm:mb-2">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</p>
                                <p class="text-xl sm:text-3xl font-bold text-slate-900 dark:text-white">${suppliers.length}</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-4 sm:p-6 shadow-sm border dark:border-slate-700 mb-4 sm:mb-8">
                            <button onclick="toggleSupplierSection()" class="w-full flex justify-between items-center text-left">
                                <h2 class="text-base sm:text-xl font-bold text-slate-900 dark:text-white">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ç®¡ç†</h2>
                                <span class="text-slate-400">${showSupplierSection ? 'â–¼' : 'â–¶'}</span>
                            </button>
                            ${showSupplierSection ? `
                                <div class="mt-3 sm:mt-4">
                                    <button onclick="showAddSupplierForm()" class="mb-3 sm:mb-4 px-3 sm:px-4 py-1.5 sm:py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">+ è¿½åŠ </button>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                        ${suppliers.map(s => `
                                            <div class="p-3 sm:p-4 border dark:border-slate-600 rounded-lg hover:border-blue-300 transition-colors">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div class="flex-1">
                                                        <h3 class="font-bold text-sm sm:text-lg dark:text-white">${s.name}</h3>
                                                        <div class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 mt-1">
                                                            ${(s.paymentPatterns || []).map(p => `
                                                                <span class="inline-block mr-2 mb-1 px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded">${p.name}: ${p.rates.join('â†’')}%</span>
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-1 sm:gap-2">
                                                        <button onclick="editSupplier(${s.id})" class="px-2 sm:px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded hover:bg-blue-700" title="ç·¨é›†">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                        </button>
                                                        <button onclick="deleteSupplier(${s.id})" class="px-2 sm:px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded hover:bg-red-700" title="å‰Šé™¤">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">${suppliers.length}ä»¶ã®ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</p>
                            `}
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-4 sm:p-6 shadow-sm border dark:border-slate-700">
                            <div class="flex flex-wrap justify-between items-center gap-2 mb-3 sm:mb-4">
                                <h2 class="text-base sm:text-xl font-bold text-slate-900 dark:text-white">æ¡ˆä»¶ç®¡ç†</h2>
                                <button onclick="showAddProjectForm()" class="px-3 sm:px-4 py-1.5 sm:py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">+ æ–°è¦æ¡ˆä»¶</button>
                            </div>
                            
                            <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
                            <div class="flex flex-wrap gap-2 mb-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                                <select id="filterStatus" onchange="applyProjectFilter()" class="px-2 py-1 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="all">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                                    <option value="æœªç€æ‰‹">ğŸ“ æœªç€æ‰‹</option>
                                    <option value="æ”¯æ‰•ä¸­">ğŸ’° æ”¯æ‰•ä¸­</option>
                                    <option value="æ”¯æ‰•æ¸ˆ">ğŸ’µ æ”¯æ‰•æ¸ˆ</option>
                                    <option value="å…¥åº«å®Œäº†">âœ… å…¥åº«å®Œäº†</option>
                                </select>
                                <select id="filterSupplier" onchange="applyProjectFilter()" class="px-2 py-1 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="all">å…¨ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</option>
                                    ${suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                                <label class="flex items-center gap-1 text-sm dark:text-slate-300">
                                    <input type="checkbox" id="filterHideArchived" ${projectFilter.hideArchived ? 'checked' : ''} onchange="applyProjectFilter()">
                                    å®Œäº†ã‚’éè¡¨ç¤º
                                </label>
                                <span class="text-xs text-slate-500 dark:text-slate-400 ml-auto">${getFilteredProjects().length}/${projects.length}ä»¶</span>
                            </div>
                            
                            <div class="space-y-3 sm:space-y-4">
                                ${getFilteredProjects().map(p => {
                                    const supplier = suppliers.find(s => s.id === p.supplierId);
                                    const paidCount = (p.depositSchedule || []).filter(d => d.paid).length;
                                    const totalPaid = (p.depositSchedule || []).filter(d => d.paid).reduce((sum, d) => sum + (d.amountJPY || 0), 0);
                                    const nextPayment = (p.depositSchedule || []).find(d => !d.paid);
                                    const allPaid = paidCount === (p.depositSchedule || []).length && paidCount > 0;
                                    const unitPrice = allPaid && (p.quantity || 1) > 0 ? Math.round(totalPaid / (p.quantity || 1)) : null;
                                    
                                    // é›†è·äºˆå®šæ—¥ã‚’è¡¨ç¤º
                                    const pickupDateDisplay = p.pickupDate ? p.pickupDate.replace(/-/g, '/') : 'æœªè¨­å®š';
                                    const isExpanded = expandedProjects[p.id];
                                    
                                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•åˆ¤å®š
                                    const projectStatus = getProjectStatus(p);
                                    
                                    return `<div id="project-${p.id}" class="border-2 rounded-lg transition-all ${nextPayment ? 'border-amber-300 bg-amber-50 dark:bg-amber-900/30 dark:border-amber-600' : 'border-green-300 bg-green-50 dark:bg-green-900/30 dark:border-green-600'}">
                                        <div class="p-3 sm:p-5 cursor-pointer" onclick="toggleProject('${p.id}')">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                                        <span class="text-slate-400">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                                                        <h3 class="font-bold text-base sm:text-xl text-slate-900 dark:text-white">${formatProjectNumber(p)}</h3>
                                                        <span class="px-2 py-0.5 text-xs rounded-full ${projectStatus.color}">${projectStatus.icon} ${projectStatus.status}</span>
                                                        <button onclick="event.stopPropagation();editProjectDetails('${p.id}')" class="p-1 text-slate-400 hover:text-blue-600" title="ç·¨é›†">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                        </button>
                                                        <button onclick="event.stopPropagation();showTemplateModal('${p.id}')" class="p-1 text-slate-400 hover:text-purple-600" title="è¤‡è£½">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                                        </button>
                                                        <button onclick="event.stopPropagation();deleteProject('${p.id}')" class="p-1 text-slate-400 hover:text-red-600" title="å‰Šé™¤">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                        </button>
                                                        <button onclick="event.stopPropagation();openInventoryForProject('${formatProjectNumber(p)}')" class="p-1 text-slate-400 hover:text-emerald-600" title="åœ¨åº«ã‚’è¦‹ã‚‹">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                                                        </button>
                                                        ${folderCache[formatProjectNumber(p)] ? `
                                                            <a href="${folderCache[formatProjectNumber(p)]}" target="_blank" onclick="event.stopPropagation()" class="text-blue-600 hover:text-blue-800" title="Driveã‚’é–‹ã">
                                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2z"/></svg>
                                                            </a>
                                                        ` : `
                                                            <span class="text-slate-300 dark:text-slate-600" title="ãƒ•ã‚©ãƒ«ãƒ€æœªæ¤œå‡º">
                                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2z"/></svg>
                                                            </span>
                                                        `}
                                                    </div>
                                                    <p class="text-xs sm:text-sm text-slate-700 dark:text-slate-300 ml-6">${p.productName}</p>
                                                    ${!isExpanded ? `
                                                        <p class="text-xs text-slate-500 dark:text-slate-400 ml-6">${supplier?.name || ''} / $${(p.totalAmount || 0).toLocaleString()} / é›†è·: ${pickupDateDisplay}</p>
                                                    ` : ''}
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-sm sm:text-lg font-bold text-slate-900 dark:text-white">${formatJPY(totalPaid)}</p>
                                                    <p class="text-xs sm:text-sm ${paidCount === (p.depositSchedule || []).length ? 'text-green-600 font-semibold' : 'text-amber-600 font-semibold'}">
                                                        ${paidCount}/${(p.depositSchedule || []).length}å›
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        ${isExpanded ? `
                                            <div class="px-3 sm:px-5 pb-3 sm:pb-5 border-t border-slate-200">
                                                <div class="pt-3 sm:pt-4 mb-3 sm:mb-4">
                                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs sm:text-sm text-slate-600 mb-2">
                                                        <span>ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼: ${supplier?.name || 'Unknown'}</span>
                                                        <span>ç·é¡: $${(p.totalAmount || 0).toLocaleString()}</span>
                                                        <span>æ•°é‡: ${p.quantity || 1}</span>
                                                    </div>
                                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs sm:text-sm text-slate-600">
                                                        <span>Serial: <span class="font-mono font-semibold">${p.serial || 'æœªè¨­å®š'}</span></span>
                                                        <span>é›†è·: <span class="font-semibold text-blue-600">${pickupDateDisplay}</span></span>
                                                        ${unitPrice ? `<span class="text-green-600 font-semibold">å˜ä¾¡: ${formatJPY(unitPrice)}</span>` : ''}
                                                    </div>
                                                    <button onclick="event.stopPropagation();copyInvoiceText('${p.id}')" class="mt-2 px-2 sm:px-3 py-1 bg-purple-600 text-white text-xs sm:text-sm rounded hover:bg-purple-700 inline-flex items-center gap-1" title="ã‚³ãƒ”ãƒ¼">
                                                        <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                                        ã‚³ãƒ”ãƒ¼
                                                    </button>
                                                </div>
                                                
                                                ${nextPayment ? `
                                                    <div class="bg-white dark:bg-slate-700 border-2 border-amber-400 dark:border-amber-500 rounded-lg p-3 sm:p-4 mb-3">
                                                        <p class="text-xs sm:text-sm font-semibold text-amber-700 dark:text-amber-300 mb-2">ğŸ“‹ æ¬¡å›æ”¯æ‰•äºˆå®š</p>
                                                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
                                                            <div>
                                                                <p class="font-bold text-sm sm:text-lg text-slate-900 dark:text-white">ç¬¬${nextPayment.depositNumber}å›: $${(nextPayment.amountUSD || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                                                <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400">(${nextPayment.percentage}%)</p>
                                                            </div>
                                                            <button onclick="event.stopPropagation();markPaymentComplete('${p.id}', ${nextPayment.depositNumber})" class="px-3 sm:px-4 py-1.5 sm:py-2 bg-emerald-600 text-white text-xs sm:text-sm font-semibold rounded-lg hover:bg-emerald-700">
                                                                æ”¯æ‰•å®Œäº†
                                                            </button>
                                                        </div>
                                                    </div>
                                                ` : `
                                                    <div class="bg-white dark:bg-slate-700 border-2 border-green-400 dark:border-green-500 rounded-lg p-3 sm:p-4 mb-3">
                                                        <p class="text-green-700 dark:text-green-300 text-xs sm:text-sm font-semibold text-center">âœ“ ã™ã¹ã¦ã®æ”¯æ‰•ã„ãŒå®Œäº†</p>
                                                        ${unitPrice ? `<p class="text-green-600 dark:text-green-400 text-xs sm:text-sm text-center mt-1">å˜ä¾¡: ${formatJPY(unitPrice)}</p>` : ''}
                                                    </div>
                                                `}
                                                
                                                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3 sm:p-4">
                                                    <p class="text-xs sm:text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2 sm:mb-3">æ”¯æ‰•å±¥æ­´</p>
                                                    <div class="space-y-2">
                                                        ${(p.depositSchedule || []).map(dep => `
                                                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center p-2 sm:p-3 ${dep.paid ? 'bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700' : 'bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500'} rounded">
                                                                <div class="flex-1">
                                                                    <span class="font-semibold text-xs sm:text-sm text-slate-900 dark:text-white">ç¬¬${dep.depositNumber}å›</span>
                                                                    <span class="text-xs sm:text-sm text-slate-600 dark:text-slate-300 ml-2 sm:ml-3">$${(dep.amountUSD || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${dep.percentage}%)</span>
                                                                    ${dep.paid ? `
                                                                        <div class="text-xs text-slate-600 dark:text-slate-400 mt-1">
                                                                            ${dep.paidDate || ''} | Â¥${dep.exchangeRate ? dep.exchangeRate.toFixed(2) : '-'} | ${dep.amountJPY ? formatJPY(dep.amountJPY) : 'Â¥-'}
                                                                        </div>
                                                                    ` : ''}
                                                                </div>
                                                                <div class="flex items-center gap-2">
                                                                    ${dep.paid && (!dep.exchangeRate || !dep.amountJPY) ? `
                                                                        <button onclick="event.stopPropagation();fixExchangeRate('${p.id}', ${dep.depositNumber})" 
                                                                                class="px-2 py-0.5 bg-amber-500 text-white text-xs rounded hover:bg-amber-600" title="ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®š">
                                                                            Â¥è¨­å®š
                                                                        </button>
                                                                    ` : ''}
                                                                    ${dep.paid ? `
                                                                        <button onclick="event.stopPropagation();editPaymentRate('${p.id}', ${dep.depositNumber})" 
                                                                                class="p-1 text-slate-400 hover:text-blue-600" title="ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆä¿®æ­£">
                                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                                                        </button>
                                                                    ` : ''}
                                                                    <span class="px-2 sm:px-3 py-0.5 sm:py-1 rounded text-xs sm:text-sm font-semibold ${dep.paid ? 'bg-green-600 text-white' : 'bg-slate-300 dark:bg-slate-500 text-slate-600 dark:text-slate-200'}">
                                                                        ${dep.paid ? 'å®Œäº†' : 'æœªæ‰•'}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                                
                                                <!-- è«¸è²»ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                                                <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-3 sm:p-4 mt-3">
                                                    <div class="flex justify-between items-center mb-2 sm:mb-3">
                                                        <p class="text-xs sm:text-sm font-semibold text-orange-700 dark:text-orange-400">ğŸ“¦ è«¸è²»ç”¨ï¼ˆå›½éš›é€æ–™ãƒ»é–¢ç¨ç­‰ï¼‰</p>
                                                        <button onclick="event.stopPropagation();showAddExpenseModal('${p.id}')" class="px-2 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700">+ è¿½åŠ </button>
                                                    </div>
                                                    ${(p.expenses || []).length > 0 ? `
                                                        <div class="space-y-2">
                                                            ${(p.expenses || []).map((exp, idx) => `
                                                                <div class="flex justify-between items-center p-2 bg-white dark:bg-slate-800 border border-orange-200 dark:border-orange-700 rounded">
                                                                    <div class="flex-1">
                                                                        <span class="font-semibold text-xs sm:text-sm text-slate-900 dark:text-white">${exp.type}</span>
                                                                        <span class="text-xs text-slate-500 dark:text-slate-400 ml-2">${exp.payee || ''}</span>
                                                                        <div class="text-xs text-slate-600 dark:text-slate-400 mt-0.5">${exp.paidDate || 'æœªæ‰•'}</div>
                                                                    </div>
                                                                    <div class="text-right flex items-center gap-2">
                                                                        <span class="font-bold text-sm text-orange-700 dark:text-orange-400">${formatJPY(exp.amountJPY)}</span>
                                                                        <button onclick="event.stopPropagation();deleteExpense('${p.id}', ${idx})" class="p-1 text-slate-400 hover:text-red-600" title="å‰Šé™¤">
                                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            `).join('')}
                                                            <div class="flex justify-between items-center pt-2 border-t border-orange-200 dark:border-orange-700">
                                                                <span class="text-xs font-semibold text-orange-700 dark:text-orange-400">è«¸è²»ç”¨åˆè¨ˆ</span>
                                                                <span class="font-bold text-sm text-orange-700 dark:text-orange-400">${formatJPY((p.expenses || []).reduce((sum, e) => sum + (e.amountJPY || 0), 0))}</span>
                                                            </div>
                                                        </div>
                                                    ` : `
                                                        <p class="text-xs text-slate-500 dark:text-slate-400 text-center py-2">è«¸è²»ç”¨ã®ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                                                    `}
                                                </div>
                                                
                                                <!-- ç·åŸä¾¡ã‚µãƒãƒªãƒ¼ -->
                                                ${(() => {
                                                    const depositTotal = (p.depositSchedule || []).filter(d => d.paid).reduce((sum, d) => sum + (d.amountJPY || 0), 0);
                                                    const expenseTotal = (p.expenses || []).reduce((sum, e) => sum + (e.amountJPY || 0), 0);
                                                    const grandTotal = depositTotal + expenseTotal;
                                                    const qty = p.quantity || 1;
                                                    const unitCost = qty > 0 ? Math.round(grandTotal / qty) : 0;
                                                    return grandTotal > 0 ? `
                                                        <div class="bg-slate-800 dark:bg-slate-900 rounded-lg p-3 sm:p-4 mt-3">
                                                            <p class="text-xs text-slate-400 mb-2">ç·åŸä¾¡ã‚µãƒãƒªãƒ¼</p>
                                                            <div class="grid grid-cols-2 gap-2 text-sm">
                                                                <div>
                                                                    <span class="text-slate-400">è£½å“ä»£é‡‘:</span>
                                                                    <span class="text-white ml-2">${formatJPY(depositTotal)}</span>
                                                                </div>
                                                                <div>
                                                                    <span class="text-slate-400">è«¸è²»ç”¨:</span>
                                                                    <span class="text-orange-400 ml-2">${formatJPY(expenseTotal)}</span>
                                                                </div>
                                                                <div class="col-span-2 pt-2 border-t border-slate-700">
                                                                    <span class="text-slate-300 font-semibold">ç·åŸä¾¡:</span>
                                                                    <span class="text-emerald-400 font-bold text-lg ml-2">${formatJPY(grandTotal)}</span>
                                                                    <span class="text-slate-400 text-xs ml-2">(å˜ä¾¡: ${formatJPY(unitCost)})</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ` : '';
                                                })()}
                                            </div>
                                        ` : ''}
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </main>
                </div>`;
        }

        async function getExchangeRate(date) {
            try {
                // Frankfurter APIã§éå»æ—¥ã®ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
                const dateStr = new Date(date).toISOString().split('T')[0];
                const response = await fetch(`https://api.frankfurter.app/${dateStr}?from=USD&to=JPY`);
                const data = await response.json();
                return data.rates.JPY;
            } catch (error) {
                console.error('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€æ–°ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
                try {
                    const fallbackResponse = await fetch('https://api.frankfurter.app/latest?from=USD&to=JPY');
                    const fallbackData = await fallbackResponse.json();
                    return fallbackData.rates.JPY;
                } catch (e) {
                    return null;
                }
            }
        }

        async function markPaymentComplete(projectId, depositNumber) {
            const paidDate = prompt('æ”¯æ‰•æ—¥ (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!paidDate) return;
            
            showStatus('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—ä¸­...');
            const autoRate = await getExchangeRate(paidDate);
            
            let exchangeRate;
            if (autoRate) {
                const useAutoRate = confirm(`${paidDate}ã®ãƒ¬ãƒ¼ãƒˆ: Â¥${autoRate.toFixed(2)}\n\nã“ã®ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨æ‰‹å‹•å…¥åŠ›ã«ãªã‚Šã¾ã™ï¼‰`);
                if (useAutoRate) {
                    exchangeRate = autoRate;
                } else {
                    exchangeRate = parseFloat(prompt('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ (JPY/USD):', autoRate.toFixed(2)));
                }
            } else {
                exchangeRate = parseFloat(prompt('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ (JPY/USD):'));
            }
            
            if (!exchangeRate) return;
            
            await markPaymentPaid(projectId, depositNumber, paidDate, exchangeRate);
            renderMain();
        }

        function toggleSupplierSection() {
            showSupplierSection = !showSupplierSection;
            renderMain();
        }
        
        function toggleUnpaidSection() {
            showUnpaidSection = !showUnpaidSection;
            renderMain();
        }
        
        function scrollToProject(projectId) {
            // æœªæ‰•ã„ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
            showUnpaidSection = false;
            // è©²å½“æ¡ˆä»¶ã‚’å±•é–‹çŠ¶æ…‹ã«ã™ã‚‹
            expandedProjects[projectId] = true;
            renderMain();
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                const el = document.getElementById('project-' + projectId);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('ring-2', 'ring-blue-500');
                    setTimeout(() => el.classList.remove('ring-2', 'ring-blue-500'), 2000);
                }
            }, 100);
        }

        function toggleProject(projectId) {
            expandedProjects[projectId] = !expandedProjects[projectId];
            renderMain();
        }

        function editSupplier(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            
            const name = prompt('ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å:', supplier.name);
            if (!name) return;
            
            // æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ç¤º
            const existingPatterns = (supplier.paymentPatterns || []).map((p, idx) => 
                `${idx + 1}. ${p.name}: ${p.rates.join('â†’')}%`
            ).join('\n');
            
            const action = prompt(`ç¾åœ¨ã®æ”¯æ‰•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³:\n${existingPatterns}\n\næ“ä½œã‚’é¸æŠ:\n1: ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ \n2: ãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤\n3: åå‰å¤‰æ›´ã®ã¿\n\nç•ªå·ã‚’å…¥åŠ›:`, '3');
            
            if (action === '1') {
                // ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ 
                const patternName = prompt('æ–°ã—ã„æ”¯æ‰•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³å:', '');
                if (!patternName) return;
                
                const count = parseInt(prompt(`ã€Œ${patternName}ã€ã®ãƒ‡ãƒã‚¸ãƒƒãƒˆå›æ•°:`, '1'));
                if (!count || count < 1) return;
                
                const rates = [];
                let total = 0;
                
                for (let i = 0; i < count; i++) {
                    const rate = parseFloat(prompt(`ç¬¬${i + 1}å›ç›®ã®ãƒ‡ãƒã‚¸ãƒƒãƒˆå‰²åˆ (%):\næ®‹ã‚Š: ${100 - total}%`, count === 1 ? '100' : ''));
                    if (rate === null || rate === '' || isNaN(rate)) return;
                    rates.push(rate);
                    total += rate;
                }
                
                if (Math.abs(total - 100) > 0.01) {
                    alert(`ã‚¨ãƒ©ãƒ¼: åˆè¨ˆãŒ${total}%ã§ã™ã€‚100%ã«ãªã‚‹ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                supplier.paymentPatterns.push({ name: patternName, rates });
            } else if (action === '2') {
                // ãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤
                if (supplier.paymentPatterns.length <= 1) {
                    alert('æœ€ä½1ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }
                const delIdx = parseInt(prompt('å‰Šé™¤ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ç•ªå·:', '')) - 1;
                if (delIdx >= 0 && delIdx < supplier.paymentPatterns.length) {
                    supplier.paymentPatterns.splice(delIdx, 1);
                }
            }
            
            supplier.name = name;
            
            saveData();
            renderMain();
        }

        function deleteSupplier(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            
            // é–¢é€£ã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚‹ã‹ç¢ºèª
            const relatedProjects = projects.filter(p => p.supplierId === supplierId);
            if (relatedProjects.length > 0) {
                alert(`ã‚¨ãƒ©ãƒ¼: ã“ã®ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã«ã¯${relatedProjects.length}ä»¶ã®æ¡ˆä»¶ãŒç´ä»˜ã„ã¦ã„ã¾ã™ã€‚\nå…ˆã«æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            if (!confirm(`ã€Œ${supplier.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            
            suppliers = suppliers.filter(s => s.id !== supplierId);
            saveData();
            renderMain();
        }

        // åœ¨åº«ã«é€ã‚‹æ©Ÿèƒ½
        async function sendToInventory(projectId) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;

            // ç¨®åˆ¥ã‚’é¸æŠ
            const categories = [
                'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤',
                'å±‹å¤–',
                'å±‹å†…',
                'é›»å­é»’æ¿',
                'ãƒãƒˆãƒªã‚¯ã‚¹',
                'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼',
                'ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·',
                'å‘¨è¾ºæ©Ÿå™¨'
            ];

            const categoryIndex = prompt(
                `ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆç•ªå·å…¥åŠ›ï¼‰:\n\n` +
                categories.map((c, i) => `${i + 1}. ${c}`).join('\n') +
                `\n\næ¡ˆä»¶: ${formatProjectNumber(project)}\nè£½å“: ${project.productName}\næ•°é‡: ${project.quantity || 1}å°`
            );
            
            if (!categoryIndex) return;
            const category = categories[parseInt(categoryIndex) - 1];
            if (!category) {
                alert('æ­£ã—ã„ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const quantity = project.quantity || 1;
            const serial = project.serial || '';

            // åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ 
            try {
                showStatus('åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ ä¸­...');

                // æ—¢å­˜ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let existingInventory = [];
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A2:Q',
                    });
                    existingInventory = response.result.values || [];
                } catch (e) {
                    // ã‚·ãƒ¼ãƒˆãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆï¼ˆæ–°å½¢å¼17åˆ—ï¼‰
                    await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            requests: [{
                                addSheet: {
                                    properties: { title: 'åœ¨åº«' }
                                }
                            }]
                        }
                    });
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A1:Q1',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¥é ­è¾', 'ç™ºæ³¨ç•ªå·', 'ç™ºæ³¨æ—¥', 'å…¥åº«æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«æ¥é ­è¾', 'å‡ºåº«ç•ªå·', 'å–å¾—é‡‘(ç¨è¾¼)', 'å‚™è€ƒ', 'æ£šç•ª', 'ä¿ç®¡å ´æ‰€', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID']]
                        }
                    });
                }

                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆSerialç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                const existingSerials = existingInventory.map(row => row[1]);
                const baseSerial = serial ? serial.replace(/\(.*\)/, '') : ''; // YS0554(1-4) â†’ YS0554
                
                // è¿½åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆæ–°å½¢å¼17åˆ—ï¼‰
                const newRows = [];
                const today = new Date().toISOString().split('T')[0];
                
                for (let i = 1; i <= quantity; i++) {
                    const itemSerial = baseSerial ? (quantity > 1 ? `${baseSerial}-${i}` : baseSerial) : '';
                    
                    // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆSerialç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„ï¼‰
                    if (itemSerial && existingSerials.includes(itemSerial)) {
                        continue; // ã‚¹ã‚­ãƒƒãƒ—
                    }
                    
                    newRows.push([
                        Date.now().toString() + '-' + i,  // ID
                        itemSerial,                        // Serial
                        category,                          // ç¨®åˆ¥
                        project.productName,               // è£½å“å
                        project.projectPrefix || 'AD',     // ç™ºæ³¨æ¥é ­è¾
                        padProjectNumber(project.projectNumber), // ç™ºæ³¨ç•ªå·ï¼ˆ4æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
                        today,                             // ç™ºæ³¨æ—¥
                        '',                                // å…¥åº«æ—¥
                        'å…¥åº«å¾…ã¡',                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                        '',                                // å‡ºåº«æ—¥
                        '',                                // å‡ºåº«æ¥é ­è¾
                        '',                                // å‡ºåº«ç•ªå·
                        '',                                // å–å¾—é‡‘
                        '',                                // å‚™è€ƒ
                        '',                                // æ£šç•ª
                        '',                                // ä¿ç®¡å ´æ‰€
                        project.supplierId || ''           // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID
                    ]);
                }

                if (newRows.length === 0) {
                    alert('ã™ã¹ã¦ã®SerialãŒæ—¢ã«åœ¨åº«ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                    showStatus('');
                    return;
                }

                // åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ 
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A:Q',
                    valueInputOption: 'RAW',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: newRows
                    }
                });

                showStatus('');
                alert(`åœ¨åº«ã«${newRows.length}ä»¶è¿½åŠ ã—ã¾ã—ãŸï¼\n\nåœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã€Œå…¥åº«ã€å‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`);
                
            } catch (err) {
                console.error('åœ¨åº«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('');
                alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        function showAddSupplierForm() {
            const name = prompt('ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å:');
            if (!name) return;
            
            const paymentPatterns = [];
            let addMore = true;
            
            while (addMore) {
                const patternName = prompt(`æ”¯æ‰•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³å (ä¾‹: æ¨™æº–, 100%å‰æ‰•ã„):`, paymentPatterns.length === 0 ? 'æ¨™æº–' : '');
                if (!patternName) break;
                
                const count = parseInt(prompt(`ã€Œ${patternName}ã€ã®ãƒ‡ãƒã‚¸ãƒƒãƒˆå›æ•°:`, '2'));
                if (!count || count < 1) break;
                
                const rates = [];
                let total = 0;
                
                for (let i = 0; i < count; i++) {
                    const rate = parseFloat(prompt(`ç¬¬${i + 1}å›ç›®ã®ãƒ‡ãƒã‚¸ãƒƒãƒˆå‰²åˆ (%):\næ®‹ã‚Š: ${100 - total}%`, count === 1 ? '100' : ''));
                    if (rate === null || rate === '' || isNaN(rate)) {
                        alert('å…¥åŠ›ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                        return;
                    }
                    rates.push(rate);
                    total += rate;
                }
                
                if (Math.abs(total - 100) > 0.01) {
                    alert(`ã‚¨ãƒ©ãƒ¼: åˆè¨ˆãŒ${total}%ã§ã™ã€‚100%ã«ãªã‚‹ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                paymentPatterns.push({ name: patternName, rates });
                
                addMore = confirm('åˆ¥ã®æ”¯æ‰•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ');
            }
            
            if (paymentPatterns.length === 0) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®æ”¯æ‰•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }
            
            addSupplier(name, paymentPatterns);
            renderMain();
        }

        // é€£ç¶šç™»éŒ²ç”¨ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿
        let pendingItems = [];

        function showAddProjectForm() {
            if (suppliers.length === 0) {
                alert('å…ˆã«ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
            pendingItems = [];
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
            const modal = document.createElement('div');
            modal.id = 'projectModal';
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
                    <div style="background:white;padding:24px;border-radius:12px;width:550px;max-width:95%;max-height:90vh;overflow-y:auto;">
                        <h3 style="font-size:18px;font-weight:bold;margin-bottom:16px;">æ–°è¦æ¡ˆä»¶ç™»éŒ²ï¼ˆé€£ç¶šç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼‰</h3>
                        
                        <!-- æ¡ˆä»¶åŸºæœ¬æƒ…å ±ï¼ˆå›ºå®šï¼‰ -->
                        <div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:16px;">
                            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                                <div style="flex:1;min-width:150px;">
                                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;">æ¡ˆä»¶ç•ªå·</label>
                                    <div style="display:flex;gap:4px;">
                                        <select id="modalProjectPrefix" style="width:70px;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px;">
                                            <option value="AD">AD</option>
                                            <option value="SP">SP</option>
                                        </select>
                                        <input type="text" id="modalProjectNumber" placeholder="0001" style="width:80px;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px;">
                                    </div>
                                </div>
                                <div style="flex:1;min-width:150px;">
                                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</label>
                                    <select id="modalSupplierId" onchange="onSupplierChange()" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px;">
                                        <option value="">-- é¸æŠ --</option>
                                        ${suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div style="flex:1;min-width:120px;">
                                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;">æ”¯æ‰•æ¡ä»¶</label>
                                    <select id="modalPaymentPattern" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px;">
                                        <option value="0">-- ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼é¸æŠå¾Œ --</option>
                                    </select>
                                </div>
                                <div style="flex:1;min-width:100px;">
                                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;">Working Days</label>
                                    <input type="number" id="modalWorkingDays" value="30" min="1" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- è£½å“å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                        <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;">
                            <div style="display:flex;gap:8px;margin-bottom:8px;">
                                <div style="flex:1;">
                                    <label style="display:block;font-size:12px;color:#666;margin-bottom:2px;">ç¨®åˆ¥</label>
                                    <select id="modalCategory" onchange="filterProductByCategory()" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px;">
                                        <option value="">-- é¸æŠ --</option>
                                        <option value="å±‹å†…">å±‹å†…</option>
                                        <option value="å±‹å¤–">å±‹å¤–</option>
                                        <option value="ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤">ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</option>
                                        <option value="LEDãƒ“ã‚¸ãƒ§ãƒ³">LEDãƒ“ã‚¸ãƒ§ãƒ³</option>
                                        <option value="STUDIA">STUDIA</option>
                                        <option value="ãƒãƒˆãƒªã‚¯ã‚¹">ãƒãƒˆãƒªã‚¯ã‚¹</option>
                                        <option value="OPS">OPS</option>
                                        <option value="ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼">ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼</option>
                                        <option value="ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·">ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·</option>
                                        <option value="å‘¨è¾ºæ©Ÿå™¨">å‘¨è¾ºæ©Ÿå™¨</option>
                                    </select>
                                </div>
                                <div style="flex:1;">
                                    <label style="display:block;font-size:12px;color:#666;margin-bottom:2px;">æ•°é‡</label>
                                    <input type="number" id="modalQuantity" value="1" min="1" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px;">
                                </div>
                                <div style="flex:1;">
                                    <label style="display:block;font-size:12px;color:#666;margin-bottom:2px;">é‡‘é¡(USD)</label>
                                    <input type="number" id="modalTotalAmount" placeholder="0" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom:8px;">
                                <label style="display:block;font-size:12px;color:#666;margin-bottom:2px;">å‹å¼æ¤œç´¢</label>
                                <input type="text" id="modalProductSearch" placeholder="å‹ç•ªã§æ¤œç´¢..." 
                                       oninput="filterProductList()"
                                       style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px;">
                            </div>
                            
                            <div style="margin-bottom:8px;">
                                <select id="modalProductSelect" onchange="onProductSelect(this.value)" 
                                        style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px;" size="4">
                                    <option value="">-- å‹å¼ã‚’é¸æŠ --</option>
                                </select>
                                <p style="font-size:11px;color:#666;margin-top:2px;" id="productMasterCount">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒ»ç¨®åˆ¥ã§çµã‚Šè¾¼ã¿å¯èƒ½</p>
                            </div>
                            
                            <div style="margin-bottom:8px;">
                                <label style="display:block;font-size:12px;color:#666;margin-bottom:2px;">è£½å“åï¼ˆæ‰‹å‹•å…¥åŠ›å¯ï¼‰</label>
                                <input type="text" id="modalProductName" placeholder="å‹å¼é¸æŠã§è‡ªå‹•å…¥åŠ›" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px;">
                            </div>
                            
                            <button onclick="addPendingItem()" style="width:100%;padding:8px;border:none;border-radius:4px;background:#10b981;color:white;cursor:pointer;font-size:14px;">
                                ï¼‹ ã“ã®è£½å“ã‚’è¿½åŠ 
                            </button>
                        </div>
                        
                        <!-- è¿½åŠ æ¸ˆã¿æ˜ç´°ä¸€è¦§ -->
                        <div id="pendingItemsList" style="margin-bottom:16px;">
                            <p style="font-size:12px;color:#666;text-align:center;">è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                        </div>
                        
                        <!-- åˆè¨ˆè¡¨ç¤º -->
                        <div id="pendingTotal" style="background:#f1f5f9;padding:8px 12px;border-radius:4px;margin-bottom:16px;display:none;">
                            <span style="font-weight:bold;">åˆè¨ˆ:</span> <span id="pendingTotalAmount">$0</span>
                        </div>
                        
                        <div style="display:flex;gap:8px;justify-content:flex-end;">
                            <button onclick="closeProjectModal()" style="padding:8px 16px;border:1px solid #ccc;border-radius:6px;background:white;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitProjectForm()" id="submitBtn" style="padding:8px 16px;border:none;border-radius:6px;background:#2563eb;color:white;cursor:pointer;" disabled>ç™»éŒ²ï¼ˆ0ä»¶ï¼‰</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«è£½å“ãƒªã‚¹ãƒˆã‚’åˆæœŸè¡¨ç¤º
            setTimeout(() => filterProductList(), 100);
        }
        
        // è£½å“ã‚’ä¸€æ™‚ãƒªã‚¹ãƒˆã«è¿½åŠ 
        function addPendingItem() {
            const category = document.getElementById('modalCategory').value;
            const productName = document.getElementById('modalProductName').value.trim();
            const quantity = parseInt(document.getElementById('modalQuantity').value) || 1;
            const totalAmount = parseFloat(document.getElementById('modalTotalAmount').value) || 0;
            
            if (!category) {
                alert('ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!productName) {
                alert('è£½å“åã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (totalAmount <= 0) {
                alert('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            pendingItems.push({
                category,
                productName,
                quantity,
                totalAmount
            });
            
            // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç¨®åˆ¥ä»¥å¤–ï¼‰
            document.getElementById('modalProductName').value = '';
            document.getElementById('modalQuantity').value = '1';
            document.getElementById('modalTotalAmount').value = '';
            document.getElementById('modalProductSearch').value = '';
            filterProductList();
            
            renderPendingItems();
        }
        
        // ä¸€æ™‚ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
        function removePendingItem(index) {
            pendingItems.splice(index, 1);
            renderPendingItems();
        }
        
        // ä¸€æ™‚ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function renderPendingItems() {
            const listEl = document.getElementById('pendingItemsList');
            const totalEl = document.getElementById('pendingTotal');
            const totalAmountEl = document.getElementById('pendingTotalAmount');
            const submitBtn = document.getElementById('submitBtn');
            
            if (pendingItems.length === 0) {
                listEl.innerHTML = '<p style="font-size:12px;color:#666;text-align:center;">è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                totalEl.style.display = 'none';
                submitBtn.disabled = true;
                submitBtn.textContent = 'ç™»éŒ²ï¼ˆ0ä»¶ï¼‰';
                return;
            }
            
            let total = 0;
            listEl.innerHTML = pendingItems.map((item, i) => {
                total += item.totalAmount;
                return `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:#f8fafc;border-radius:4px;margin-bottom:4px;">
                        <div style="flex:1;">
                            <span style="font-size:13px;font-weight:500;">${item.productName}</span>
                            <span style="font-size:12px;color:#666;margin-left:8px;">${item.category} Ã— ${item.quantity}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:13px;font-weight:500;">$${item.totalAmount.toLocaleString()}</span>
                            <button onclick="removePendingItem(${i})" style="padding:2px 6px;border:none;background:#ef4444;color:white;border-radius:4px;cursor:pointer;font-size:12px;">Ã—</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            totalEl.style.display = 'block';
            totalAmountEl.textContent = `$${total.toLocaleString()}`;
            submitBtn.disabled = false;
            submitBtn.textContent = `ç™»éŒ²ï¼ˆ${pendingItems.length}ä»¶ï¼‰`;
        }
        
        // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒ»ç¨®åˆ¥ã§è£½å“ãƒªã‚¹ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿
        function filterProductList() {
            const searchText = document.getElementById('modalProductSearch')?.value || '';
            const supplierId = document.getElementById('modalSupplierId')?.value;
            const category = document.getElementById('modalCategory')?.value;
            const select = document.getElementById('modalProductSelect');
            
            if (!select) return;
            
            console.log('filterProductList called:', { productMasterCount: productMaster.length, supplierId, category, searchText });
            
            const search = searchText.toLowerCase();
            
            // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åã‚’å–å¾—
            const supplier = suppliers.find(s => s.id === parseInt(supplierId));
            const supplierName = supplier?.name?.toLowerCase() || '';
            
            // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆé¸æŠè‚¢ â†’ ãƒã‚¹ã‚¿ã®å€¤ï¼‰
            const categoryMap = {
                'å±‹å†…': ['å±‹å†…'],
                'å±‹å¤–': ['å±‹å¤–'],
                'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤': ['ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤'],
                'LEDãƒ“ã‚¸ãƒ§ãƒ³': ['å±‹å¤–LED', 'å±‹å†…LED', 'LEDãƒ“ã‚¸ãƒ§ãƒ³'],
                'STUDIA': ['STUDIA'],
                'ãƒãƒˆãƒªã‚¯ã‚¹': ['ãƒãƒˆãƒªã‚¯ã‚¹'],
                'OPS': ['OPS'],
                'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼': ['ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼'],
                'ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·': ['ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·'],
                'å‘¨è¾ºæ©Ÿå™¨': ['å‘¨è¾ºæ©Ÿå™¨', 'LEDã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼']
            };
            const matchCategories = category ? (categoryMap[category] || [category]) : [];
            
            let filtered = productMaster.filter(p => {
                // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
                if (supplierId && supplierName) {
                    const pSupplier = p.supplier.toLowerCase();
                    if (!pSupplier.includes(supplierName) && !supplierName.includes(pSupplier)) {
                        return false;
                    }
                }
                
                // ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
                if (category && matchCategories.length > 0) {
                    const pCategory = p.category || '';
                    const matched = matchCategories.some(c => pCategory === c);
                    if (!matched) {
                        return false;
                    }
                }
                
                // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
                if (search) {
                    if (!p.pnFull.toLowerCase().includes(search) && 
                        !p.pn.toLowerCase().includes(search)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log('filtered count:', filtered.length);
            
            // æœ€å¤§50ä»¶
            filtered = filtered.slice(0, 50);
            
            select.innerHTML = '<option value="">-- å‹å¼ã‚’é¸æŠ --</option>' + 
                filtered.map(p => 
                    `<option value="${p.pnFull}">${p.pnFull}</option>`
                ).join('');
            
            // ä»¶æ•°è¡¨ç¤ºã‚’æ›´æ–°
            const countEl = document.getElementById('productMasterCount');
            if (countEl) {
                if (productMaster.length === 0) {
                    countEl.textContent = 'è£½å“ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                } else {
                    countEl.textContent = `${filtered.length}ä»¶è¡¨ç¤ºï¼ˆå…¨${productMaster.length}ä»¶ï¼‰`;
                }
            }
        }
        
        // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å¤‰æ›´æ™‚
        // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼é¸æŠæ™‚ã«æ”¯æ‰•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ›´æ–°
        function onSupplierChange() {
            const supplierId = document.getElementById('modalSupplierId').value;
            const patternSelect = document.getElementById('modalPaymentPattern');
            
            if (!supplierId) {
                patternSelect.innerHTML = '<option value="0">-- ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼é¸æŠå¾Œ --</option>';
            } else {
                const supplier = suppliers.find(s => s.id === parseInt(supplierId));
                if (supplier && supplier.paymentPatterns) {
                    patternSelect.innerHTML = supplier.paymentPatterns.map((p, idx) => 
                        `<option value="${idx}">${p.name} (${p.rates.join('â†’')}%)</option>`
                    ).join('');
                } else {
                    patternSelect.innerHTML = '<option value="0">æ¨™æº–</option>';
                }
            }
            
            // è£½å“ãƒªã‚¹ãƒˆã‚‚ãƒ•ã‚£ãƒ«ã‚¿
            filterProductBySupplier();
        }
        
        function filterProductBySupplier() {
            filterProductList();
        }
        
        // ç¨®åˆ¥å¤‰æ›´æ™‚
        function filterProductByCategory() {
            filterProductList();
        }
        
        // è£½å“é¸æŠæ™‚ã®å‡¦ç†
        function onProductSelect(pnFull) {
            if (!pnFull) return;
            
            const product = productMaster.find(p => p.pnFull === pnFull);
            if (!product) return;
            
            // è£½å“åã‚’è¨­å®š
            document.getElementById('modalProductName').value = pnFull;
        }

        function closeProjectModal() {
            const modal = document.getElementById('projectModal');
            if (modal) modal.remove();
            pendingItems = [];
        }

        async function submitProjectForm() {
            const projectPrefix = document.getElementById('modalProjectPrefix').value;
            const projectNumber = document.getElementById('modalProjectNumber').value.trim();
            const supplierId = document.getElementById('modalSupplierId').value;
            const workingDays = parseInt(document.getElementById('modalWorkingDays').value) || 30;
            const patternIndex = parseInt(document.getElementById('modalPaymentPattern').value) || 0;
            
            if (!projectNumber) {
                alert('æ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!supplierId) {
                alert('ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (pendingItems.length === 0) {
                alert('è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            
            showStatus(`ç™»éŒ²ä¸­... (0/${pendingItems.length})`);
            
            // æ¥é ­è¾ã¨ç•ªå·ã‚’çµåˆ
            const projectNumberFull = `${projectPrefix}-${projectNumber}`;
            
            // å„è£½å“ã‚’é †ç•ªã«ç™»éŒ²
            for (let i = 0; i < pendingItems.length; i++) {
                const item = pendingItems[i];
                showStatus(`ç™»éŒ²ä¸­... (${i + 1}/${pendingItems.length})`);
                await addProject(
                    projectNumberFull, 
                    supplierId, 
                    item.productName, 
                    item.totalAmount, 
                    item.quantity, 
                    workingDays, 
                    item.category,
                    patternIndex
                );
            }
            
            closeProjectModal();
            showStatus(`${pendingItems.length}ä»¶ã®è£½å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
            setTimeout(() => showStatus(''), 3000);
            renderMain();
        }

        // ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        function generateInvoiceText(project) {
            const pickupDateDisplay = project.pickupDate ? project.pickupDate.replace(/-/g, '/') : 'æœªè¨­å®š';
            
            let text = `PJç•ªå·ï¼š${formatProjectNumber(project)}\n`;
            text += `Serialï¼š${project.serial || ''}\n`;
            text += `é›†è·äºˆå®šæ—¥ï¼š${pickupDateDisplay}\n\n`;
            
            project.depositSchedule.forEach(dep => {
                text += `${dep.percentage}%  $${dep.amountUSD.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            });
            
            return text.trim();
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyInvoiceText(projectId) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;
            
            const text = generateInvoiceText(project);
            navigator.clipboard.writeText(text).then(() => {
                showStatus('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                setTimeout(() => showStatus(''), 2000);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // æ¡ˆä»¶ç·¨é›†ï¼ˆSerialã€æ•°é‡ã€WorkingDaysã€é›†è·äºˆå®šæ—¥ï¼‰
        function editProjectDetails(projectId) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;
            const supplier = suppliers.find(s => s.id === project.supplierId);
            
            const modal = document.createElement('div');
            modal.id = 'editProjectModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">âœï¸ æ¡ˆä»¶ç·¨é›† - ${formatProjectNumber(project)}</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ¥é ­è¾</label>
                                <select id="editProjectPrefix" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="AD" ${(project.projectPrefix || 'AD') === 'AD' ? 'selected' : ''}>AD</option>
                                    <option value="SP" ${project.projectPrefix === 'SP' ? 'selected' : ''}>SP</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç•ªå·</label>
                                <input type="number" id="editProjectNumber" value="${project.projectNumber || ''}" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è£½å“å</label>
                                <input type="text" id="editProductName" value="${project.productName || ''}" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</label>
                                <select id="editSupplierId" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="">-- é¸æŠ --</option>
                                    ${suppliers.map(s => `<option value="${s.id}" ${s.id === project.supplierId ? 'selected' : ''}>${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç·é¡ (USD)</label>
                                <input type="number" id="editTotalAmount" value="${project.totalAmount || 0}" step="0.01" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ•°é‡</label>
                                <input type="number" id="editQuantity" value="${project.quantity || 1}" min="1" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">Serial</label>
                                <input type="text" id="editSerial" value="${project.serial || ''}" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç™ºæ³¨æ—¥</label>
                                <input type="date" id="editRegisteredDate" value="${project.registeredDate || ''}" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">Working Days</label>
                                <input type="number" id="editWorkingDays" value="${project.workingDays || 30}" min="1" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">é›†è·äºˆå®šæ—¥</label>
                                <input type="date" id="editPickupDate" value="${project.pickupDate || ''}" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                        </div>
                        
                        <!-- ãƒ‡ãƒã‚¸ãƒƒãƒˆç·¨é›† -->
                        <div class="mt-6 border-t dark:border-slate-700 pt-4">
                            <h4 class="text-sm font-bold mb-3 dark:text-white">ğŸ’° ãƒ‡ãƒã‚¸ãƒƒãƒˆæƒ…å ±</h4>
                            <div id="editDepositSection" class="space-y-3">
                                ${(project.depositSchedule || []).map((d, idx) => `
                                    <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-sm font-semibold dark:text-white">ç¬¬${idx + 1}å› (${d.percentage}%)</span>
                                            <label class="flex items-center gap-1 ml-auto">
                                                <input type="checkbox" id="editDepPaid_${idx}" ${d.paid ? 'checked' : ''} onchange="toggleEditDepositFields(${idx})" class="rounded">
                                                <span class="text-xs dark:text-slate-300">æ”¯æ‰•æ¸ˆ</span>
                                            </label>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-xs text-slate-500 dark:text-slate-400">USD</label>
                                                <input type="number" id="editDepUSD_${idx}" value="${d.amountUSD || ''}" step="0.01" oninput="calcDepositJPY(${idx})" class="w-full px-2 py-1 text-sm border rounded dark:bg-slate-600 dark:border-slate-500 dark:text-white">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 dark:text-slate-400">æ”¯æ‰•æ—¥</label>
                                                <input type="date" id="editDepDate_${idx}" value="${d.paidDate || ''}" ${!d.paid ? 'disabled' : ''} class="w-full px-2 py-1 text-sm border rounded dark:bg-slate-600 dark:border-slate-500 dark:text-white disabled:opacity-50">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 dark:text-slate-400">ãƒ¬ãƒ¼ãƒˆ</label>
                                                <input type="number" id="editDepRate_${idx}" value="${d.exchangeRate || ''}" step="0.01" oninput="calcDepositJPY(${idx})" ${!d.paid ? 'disabled' : ''} class="w-full px-2 py-1 text-sm border rounded dark:bg-slate-600 dark:border-slate-500 dark:text-white disabled:opacity-50">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 dark:text-slate-400">JPY <span class="text-emerald-600">(è‡ªå‹•è¨ˆç®—)</span></label>
                                                <input type="number" id="editDepJPY_${idx}" value="${d.amountJPY || ''}" ${!d.paid ? 'disabled' : ''} class="w-full px-2 py-1 text-sm border rounded dark:bg-slate-600 dark:border-slate-500 dark:text-white disabled:opacity-50 bg-emerald-50 dark:bg-emerald-900/30">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-3 p-2 bg-blue-50 dark:bg-blue-900/30 rounded text-sm">
                                <span class="text-slate-600 dark:text-slate-300">æ”¯æ‰•ç·é¡: </span>
                                <span id="editDepTotalJPY" class="font-bold text-blue-600 dark:text-blue-400">Â¥0</span>
                            </div>
                        </div>
                        
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-4">â€» æ¡ˆä»¶ç•ªå·ã‚„Serialå¤‰æ›´æ™‚ã¯åœ¨åº«ã‚·ãƒ¼ãƒˆã‚‚è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™</p>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeEditProjectModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitEditProject('${projectId}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // åˆæœŸè¡¨ç¤ºæ™‚ã«ç·é¡ã‚’è¨ˆç®—
            setTimeout(() => updateDepositTotal(), 0);
        }

        function closeEditProjectModal() {
            const modal = document.getElementById('editProjectModal');
            if (modal) modal.remove();
        }

        function submitEditProject(projectId) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;
            
            const oldSerial = project.serial;
            const oldProjectNumberFull = formatProjectNumber(project);
            
            // å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°
            const newProjectPrefix = document.getElementById('editProjectPrefix').value;
            const newProjectNumber = parseInt(document.getElementById('editProjectNumber').value) || 0;
            const newSerial = document.getElementById('editSerial').value.trim();
            const newQuantity = parseInt(document.getElementById('editQuantity').value) || 1;
            const newTotalAmount = parseFloat(document.getElementById('editTotalAmount').value) || 0;
            
            project.projectPrefix = newProjectPrefix;
            project.projectNumber = newProjectNumber;
            project.productName = document.getElementById('editProductName').value.trim();
            project.supplierId = parseInt(document.getElementById('editSupplierId').value) || null;
            project.totalAmount = newTotalAmount;
            project.quantity = newQuantity;
            project.serial = newSerial;
            project.registeredDate = document.getElementById('editRegisteredDate').value;
            project.workingDays = parseInt(document.getElementById('editWorkingDays').value) || 30;
            project.pickupDate = document.getElementById('editPickupDate').value;
            
            // ãƒ‡ãƒã‚¸ãƒƒãƒˆæƒ…å ±ã‚’æ›´æ–°
            (project.depositSchedule || []).forEach((dep, idx) => {
                dep.paid = document.getElementById(`editDepPaid_${idx}`)?.checked || false;
                dep.amountUSD = parseFloat(document.getElementById(`editDepUSD_${idx}`)?.value) || 0;
                dep.paidDate = document.getElementById(`editDepDate_${idx}`)?.value || null;
                dep.exchangeRate = parseFloat(document.getElementById(`editDepRate_${idx}`)?.value) || null;
                dep.amountJPY = parseFloat(document.getElementById(`editDepJPY_${idx}`)?.value) || null;
            });
            
            const newProjectNumberFull = formatProjectNumber(project);
            
            saveData();
            closeEditProjectModal();
            renderMain();
            
            // Serialã¾ãŸã¯æ¡ˆä»¶ç•ªå·ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€åœ¨åº«ã‚·ãƒ¼ãƒˆã‚‚æ›´æ–°
            if (oldSerial !== newSerial || oldProjectNumberFull !== newProjectNumberFull) {
                updateInventoryFromProject(oldProjectNumberFull, oldSerial, newProjectNumberFull, newSerial, newQuantity);
            }
            
            // æ”¯æ‰•ã„æƒ…å ±ãŒã‚ã‚Œã°åœ¨åº«ã®å–å¾—é‡‘ã‚’æ›´æ–°ï¼ˆå…¨é¡æ”¯æ‰•æ¸ˆã¿ã§ãªãã¦ã‚‚OKï¼‰
            const totalJPY = (project.depositSchedule || []).reduce((sum, d) => sum + (d.amountJPY || 0), 0);
            if (totalJPY > 0) {
                updateInventoryCostFromProject(project);
            }
        }
        
        // æ”¯æ‰•ã„å®Œäº†æ™‚ã«åœ¨åº«ã®å–å¾—é‡‘ã‚’æ›´æ–°
        async function updateInventoryCostFromProject(project) {
            try {
                const totalJPY = (project.depositSchedule || []).reduce((sum, d) => sum + (d.amountJPY || 0), 0);
                const expenseTotal = (project.expenses || []).reduce((sum, e) => sum + (parseFloat(e.amountJPY) || 0), 0);
                const grandTotal = totalJPY + expenseTotal;
                const quantity = project.quantity || 1;
                const costPerItem = Math.round(grandTotal / quantity);
                
                if (costPerItem <= 0) return;
                
                const projectNumber = formatProjectNumber(project);
                const parsed = parseProjectNumberString(projectNumber);
                
                // åœ¨åº«ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A2:Q',
                });
                const rows = response.result.values || [];
                
                // è©²å½“æ¡ˆä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢ã—ã¦æ›´æ–°
                const updates = [];
                rows.forEach((row, idx) => {
                    if (row[4] === parsed.prefix && row[5] === String(parsed.number)) {
                        updates.push({
                            range: `åœ¨åº«!M${idx + 2}`,
                            values: [[costPerItem]]
                        });
                    }
                });
                
                if (updates.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            valueInputOption: 'RAW',
                            data: updates
                        }
                    });
                    showStatus(`âœ… åœ¨åº«ã®å–å¾—é‡‘ã‚’æ›´æ–°ï¼ˆÂ¥${costPerItem.toLocaleString()}/å° Ã— ${updates.length}å°ï¼‰`);
                    setTimeout(() => showStatus(''), 3000);
                }
            } catch (err) {
                console.error('åœ¨åº«å–å¾—é‡‘æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
            }
        }
        
        // ãƒ‡ãƒã‚¸ãƒƒãƒˆç·¨é›†ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
        function toggleEditDepositFields(idx) {
            const paid = document.getElementById(`editDepPaid_${idx}`).checked;
            document.getElementById(`editDepDate_${idx}`).disabled = !paid;
            document.getElementById(`editDepRate_${idx}`).disabled = !paid;
            document.getElementById(`editDepJPY_${idx}`).disabled = !paid;
            updateDepositTotal();
        }
        
        // USD Ã— ãƒ¬ãƒ¼ãƒˆ â†’ JPY è‡ªå‹•è¨ˆç®—
        function calcDepositJPY(idx) {
            const usd = parseFloat(document.getElementById(`editDepUSD_${idx}`)?.value) || 0;
            const rate = parseFloat(document.getElementById(`editDepRate_${idx}`)?.value) || 0;
            const jpyField = document.getElementById(`editDepJPY_${idx}`);
            if (jpyField && usd > 0 && rate > 0) {
                jpyField.value = Math.round(usd * rate);
            }
            updateDepositTotal();
        }
        
        // æ”¯æ‰•ç·é¡ã‚’æ›´æ–°
        function updateDepositTotal() {
            let total = 0;
            let idx = 0;
            while (document.getElementById(`editDepJPY_${idx}`)) {
                const jpy = parseFloat(document.getElementById(`editDepJPY_${idx}`).value) || 0;
                total += jpy;
                idx++;
            }
            const totalEl = document.getElementById('editDepTotalJPY');
            if (totalEl) {
                totalEl.textContent = 'Â¥' + total.toLocaleString();
            }
        }

        // åœ¨åº«ã‚·ãƒ¼ãƒˆã®æ¡ˆä»¶æƒ…å ±æ›´æ–°ï¼ˆSerialã€æ¡ˆä»¶ç•ªå·ï¼‰
        async function updateInventoryFromProject(oldProjectNumber, oldSerial, newProjectNumber, newSerial, quantity) {
            try {
                showStatus('åœ¨åº«ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­...');
                
                // æ–°ã—ã„æ¡ˆä»¶ç•ªå·ã‚’åˆ†è§£
                const newParsed = parseProjectNumberString(newProjectNumber);
                
                // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæ–°å½¢å¼16åˆ—ï¼‰
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A2:Q',
                });
                const rows = response.result.values || [];
                
                let updateCount = 0;
                
                rows.forEach((row, index) => {
                    // æ–°å½¢å¼: æ¥é ­è¾ï¼ˆEåˆ—ï¼‰+ ç•ªå·ï¼ˆFåˆ—ï¼‰ã‚’çµåˆã—ã¦æ¯”è¼ƒ
                    const itemProjectNumber = formatProjectNumber({
                        projectPrefix: row[4] || '',
                        projectNumber: row[5] || ''
                    });
                    const itemSerial = row[1] || ''; // Serialï¼ˆBåˆ—ï¼‰
                    
                    // æ—§æ¡ˆä»¶ç•ªå·ã«ä¸€è‡´ã™ã‚‹å ´åˆ
                    if (itemProjectNumber === oldProjectNumber) {
                        // æ¡ˆä»¶ç•ªå·ã‚’æ›´æ–°ï¼ˆæ–°å½¢å¼ï¼šæ¥é ­è¾ãƒ»ç•ªå·ã‚’åˆ¥ã€…ã«ï¼‰
                        row[4] = newParsed.prefix;
                        row[5] = padProjectNumber(newParsed.number);
                        
                        // Serialã‚‚å¤‰æ›´ã•ã‚Œã¦ã„ã‚Œã°æ›´æ–°
                        if (oldSerial !== newSerial && itemSerial.startsWith(oldSerial.split('(')[0])) {
                            const branchMatch = itemSerial.match(/\((\d+)\)$/);
                            if (branchMatch) {
                                row[1] = `${newSerial.split('(')[0]}(${branchMatch[1]})`;
                            } else {
                                row[1] = newSerial;
                            }
                        }
                        updateCount++;
                    }
                });
                
                if (updateCount > 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A2:Q',
                        valueInputOption: 'RAW',
                        resource: { values: rows }
                    });
                    
                    showStatus(`åœ¨åº«ã‚·ãƒ¼ãƒˆ ${updateCount}ä»¶ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
                    setTimeout(() => showStatus(''), 3000);
                } else {
                    showStatus('');
                }
            } catch (error) {
                console.error('åœ¨åº«ã‚·ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('åœ¨åº«ã‚·ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ==================== æ–°æ©Ÿèƒ½ ====================

        // ãƒ„ãƒ¼ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
        function toggleToolsMenu() {
            const menu = document.getElementById('toolsMenu');
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeToolsMenuOnClickOutside);
                }, 0);
            }
        }

        function closeToolsMenuOnClickOutside(e) {
            const menu = document.getElementById('toolsMenu');
            if (menu && !menu.contains(e.target) && !e.target.closest('button[onclick="toggleToolsMenu()"]')) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeToolsMenuOnClickOutside);
            }
        }

        // 1. æ¡ˆä»¶ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½
        function showTemplateModal(projectId) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;

            const modal = document.createElement('div');
            modal.id = 'templateModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ“‹ æ¡ˆä»¶ã‚’è¤‡è£½</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">ã€Œ${project.productName}ã€ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ–°ã—ã„æ¡ˆä»¶ç•ªå· <span class="text-red-500">*</span></label>
                                <div class="flex gap-2">
                                    <select id="templateProjectPrefix" class="w-20 px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="AD" ${(project.projectPrefix || 'AD') === 'AD' ? 'selected' : ''}>AD</option>
                                        <option value="SP" ${project.projectPrefix === 'SP' ? 'selected' : ''}>SP</option>
                                    </select>
                                    <input type="text" id="templateProjectNumber" class="flex-1 px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="0001">
                                </div>
                                <p class="text-xs text-slate-500 mt-1">4æ¡ã®ç•ªå·ã‚’å…¥åŠ›</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è£½å“å</label>
                                <input type="text" id="templateProductName" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${project.productName}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç·é¡ï¼ˆUSDï¼‰</label>
                                <input type="number" id="templateTotalAmount" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${project.totalAmount}" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ•°é‡</label>
                                <input type="number" id="templateQuantity" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${project.quantity || 1}" min="1">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('templateModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitTemplate('${project.id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">è¤‡è£½</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitTemplate(originalProjectId) {
            const original = projects.find(p => String(p.id) === String(originalProjectId));
            if (!original) return;

            const projectPrefix = document.getElementById('templateProjectPrefix').value;
            const projectNumber = document.getElementById('templateProjectNumber').value.trim();
            const productName = document.getElementById('templateProductName').value.trim();
            const totalAmount = document.getElementById('templateTotalAmount').value;
            const quantity = document.getElementById('templateQuantity').value;

            if (!projectNumber) {
                alert('æ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æ¥é ­è¾ã¨ç•ªå·ã‚’çµåˆ
            const projectNumberFull = `${projectPrefix}-${projectNumber}`;

            // å…ƒã®æ¡ˆä»¶ã¨åŒã˜ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒ»Working Daysã§æ–°è¦ä½œæˆ
            await addProject(projectNumberFull, original.supplierId, productName, totalAmount, quantity, original.workingDays || 30, null);
            
            closeModal('templateModal');
            renderMain();
        }

        // 2. ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ
        function showSupplierSummary() {
            toggleToolsMenu();

            const summaryBySupplier = {};
            
            suppliers.forEach(s => {
                summaryBySupplier[s.id] = {
                    name: s.name,
                    projectCount: 0,
                    totalUSD: 0,
                    paidUSD: 0,
                    unpaidUSD: 0,
                    paidJPY: 0
                };
            });

            projects.forEach(p => {
                const summary = summaryBySupplier[p.supplierId];
                if (!summary) return;
                
                summary.projectCount++;
                summary.totalUSD += p.totalAmount || 0;
                
                (p.depositSchedule || []).forEach(dep => {
                    if (dep.paid) {
                        summary.paidUSD += dep.amountUSD || 0;
                        summary.paidJPY += dep.amountJPY || 0;
                    } else {
                        summary.unpaidUSD += dep.amountUSD || 0;
                    }
                });
            });

            const modal = document.createElement('div');
            modal.id = 'supplierSummaryModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ“Š ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b-2 dark:border-slate-600">
                                        <th class="py-2 text-left dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</th>
                                        <th class="py-2 text-right dark:text-slate-300">æ¡ˆä»¶æ•°</th>
                                        <th class="py-2 text-right dark:text-slate-300">ç·é¡(USD)</th>
                                        <th class="py-2 text-right dark:text-slate-300">æ”¯æ‰•æ¸ˆ(USD)</th>
                                        <th class="py-2 text-right dark:text-slate-300">æœªæ‰•(USD)</th>
                                        <th class="py-2 text-right dark:text-slate-300">æ”¯æ‰•æ¸ˆ(JPY)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.values(summaryBySupplier).filter(s => s.projectCount > 0).map(s => `
                                        <tr class="border-b dark:border-slate-700">
                                            <td class="py-3 font-semibold dark:text-white">${s.name}</td>
                                            <td class="py-3 text-right dark:text-white">${s.projectCount}</td>
                                            <td class="py-3 text-right dark:text-white">$${s.totalUSD.toLocaleString()}</td>
                                            <td class="py-3 text-right text-green-600">$${s.paidUSD.toLocaleString()}</td>
                                            <td class="py-3 text-right text-amber-600">$${s.unpaidUSD.toLocaleString()}</td>
                                            <td class="py-3 text-right dark:text-white">${formatJPY(s.paidJPY)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr class="border-t-2 dark:border-slate-500 font-bold">
                                        <td class="py-3 dark:text-white">åˆè¨ˆ</td>
                                        <td class="py-3 text-right dark:text-white">${Object.values(summaryBySupplier).reduce((s, v) => s + v.projectCount, 0)}</td>
                                        <td class="py-3 text-right dark:text-white">$${Object.values(summaryBySupplier).reduce((s, v) => s + v.totalUSD, 0).toLocaleString()}</td>
                                        <td class="py-3 text-right text-green-600">$${Object.values(summaryBySupplier).reduce((s, v) => s + v.paidUSD, 0).toLocaleString()}</td>
                                        <td class="py-3 text-right text-amber-600">$${Object.values(summaryBySupplier).reduce((s, v) => s + v.unpaidUSD, 0).toLocaleString()}</td>
                                        <td class="py-3 text-right dark:text-white">${formatJPY(Object.values(summaryBySupplier).reduce((s, v) => s + v.paidJPY, 0))}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button onclick="closeModal('supplierSummaryModal')" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 3. ç‚ºæ›¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚·ãƒ³ãƒ—ãƒ«å¤‰æ›é›»å“ï¼‰
        function showExchangeSimulator() {
            toggleToolsMenu();

            const modal = document.createElement('div');
            modal.id = 'exchangeSimModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ’± ç‚ºæ›¿è¨ˆç®—</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">é‡‘é¡ï¼ˆUSDï¼‰</label>
                                <input type="number" id="simUSD" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white text-lg" placeholder="1000.00" step="0.01" oninput="updateExchangeCalc()">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆå††/USDï¼‰</label>
                                <input type="number" id="simRate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="150.00" step="0.01" value="150" oninput="updateExchangeCalc()">
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="setSimRate(140)" class="px-2 py-1.5 bg-slate-200 dark:bg-slate-600 rounded text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥140</button>
                                <button onclick="setSimRate(145)" class="px-2 py-1.5 bg-slate-200 dark:bg-slate-600 rounded text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥145</button>
                                <button onclick="setSimRate(150)" class="px-2 py-1.5 bg-slate-200 dark:bg-slate-600 rounded text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥150</button>
                                <button onclick="setSimRate(155)" class="px-2 py-1.5 bg-slate-200 dark:bg-slate-600 rounded text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥155</button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="fetchCurrentRate()" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">ğŸ“¡ ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆå–å¾—</button>
                            </div>
                        </div>
                        
                        <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-lg p-4 mt-4">
                            <p class="text-sm text-emerald-700 dark:text-emerald-400">æ›ç®—çµæœï¼ˆJPYï¼‰</p>
                            <p class="text-3xl font-bold text-emerald-700 dark:text-emerald-400" id="simResultJPY">Â¥0</p>
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button onclick="closeModal('exchangeSimModal')" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function setSimRate(rate) {
            document.getElementById('simRate').value = rate;
            updateExchangeCalc();
        }

        async function fetchCurrentRate() {
            showStatus('ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ä¸­...');
            const rate = await getExchangeRate(new Date().toISOString().split('T')[0]);
            if (rate) {
                document.getElementById('simRate').value = rate.toFixed(2);
                updateExchangeCalc();
            }
            showStatus('');
        }

        function updateExchangeCalc() {
            const usd = parseFloat(document.getElementById('simUSD').value) || 0;
            const rate = parseFloat(document.getElementById('simRate').value) || 0;
            const jpy = usd * rate;
            document.getElementById('simResultJPY').textContent = formatJPY(jpy);
        }

        // 4. æ¡ˆä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•æ›´æ–°
        function getProjectStatus(project) {
            const deposits = project.depositSchedule || [];
            const allPaid = deposits.length > 0 && deposits.every(d => d.paid);
            const somePaid = deposits.some(d => d.paid);
            
            // å…¥åº«å®Œäº†ãƒ•ãƒ©ã‚°ãŒtrueãªã‚‰å…¥åº«å®Œäº†
            if (project.receivedComplete) {
                return { status: 'å…¥åº«å®Œäº†', color: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300', icon: 'âœ…' };
            }
            
            // é›†è·äºˆå®šæ—¥ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            const today = new Date();
            const pickupDate = project.pickupDate ? new Date(project.pickupDate) : null;
            const isPickupPassed = pickupDate && pickupDate < today;

            if (allPaid && isPickupPassed) {
                return { status: 'å…¥åº«å®Œäº†', color: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300', icon: 'âœ…' };
            } else if (allPaid) {
                return { status: 'æ”¯æ‰•æ¸ˆ', color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300', icon: 'ğŸ’µ' };
            } else if (somePaid) {
                return { status: 'æ”¯æ‰•ä¸­', color: 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300', icon: 'ğŸ’°' };
            } else {
                return { status: 'æœªç€æ‰‹', color: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300', icon: 'ğŸ“' };
            }
        }

        // 5. ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
        function getFilteredProjects() {
            return projects.filter(p => {
                const status = getProjectStatus(p).status;
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
                if (projectFilter.status !== 'all' && status !== projectFilter.status) {
                    return false;
                }
                
                // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿
                if (projectFilter.supplier !== 'all' && p.supplierId !== parseInt(projectFilter.supplier)) {
                    return false;
                }
                
                // å®Œäº†éè¡¨ç¤º
                if (projectFilter.hideArchived && status === 'å…¥åº«å®Œäº†') {
                    return false;
                }
                
                return true;
            });
        }

        function applyProjectFilter() {
            projectFilter.status = document.getElementById('filterStatus').value;
            projectFilter.supplier = document.getElementById('filterSupplier').value;
            projectFilter.hideArchived = document.getElementById('filterHideArchived').checked;
            renderMain();
        }

        // åœ¨åº«ç”»é¢ã¸ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆæ¡ˆä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
        function openInventoryForProject(projectNumber) {
            window.open(`inventory.html?project=${encodeURIComponent(projectNumber)}`, '_blank');
        }
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è©²å½“æ¡ˆä»¶ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectParam = urlParams.get('project');
            
            if (projectParam) {
                // æ¡ˆä»¶ç•ªå·ã‚’ãƒ‘ãƒ¼ã‚¹
                const match = projectParam.match(/^([A-Z]+)-(\d+)$/i);
                if (match) {
                    const prefix = match[1].toUpperCase();
                    const number = parseInt(match[2]);
                    
                    // è©²å½“æ¡ˆä»¶ã‚’æ¤œç´¢
                    const project = projects.find(p => 
                        p.projectPrefix === prefix && p.projectNumber === number
                    );
                    
                    if (project) {
                        // æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã‚’å±•é–‹ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        setTimeout(() => {
                            expandedProjects[project.id] = true;
                            renderMain();
                            setTimeout(() => {
                                scrollToProject(project.id);
                            }, 100);
                        }, 300);
                    } else {
                        showStatus(`æ¡ˆä»¶ ${projectParam} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                        setTimeout(() => showStatus(''), 3000);
                    }
                }
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆå±¥æ­´ã‚’æ±šã•ãªã„ï¼‰
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // 6. æ¡ˆä»¶å‰Šé™¤æ©Ÿèƒ½
        function deleteProject(projectId) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;
            
            const hasPaidDeposits = (project.depositSchedule || []).some(d => d.paid);
            
            let confirmMessage = `æ¡ˆä»¶ã€Œ${formatProjectNumber(project)}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nè£½å“: ${project.productName}`;
            if (hasPaidDeposits) {
                confirmMessage += '\n\nâš ï¸ ã“ã®æ¡ˆä»¶ã«ã¯æ”¯æ‰•ã„æ¸ˆã¿ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã™ã€‚';
            }
            
            if (!confirm(confirmMessage)) return;
            
            // äºŒé‡ç¢ºèªï¼ˆæ”¯æ‰•ã„æ¸ˆã¿ãŒã‚ã‚‹å ´åˆï¼‰
            if (hasPaidDeposits) {
                if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\næ”¯æ‰•ã„å±¥æ­´ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
            }
            
            projects = projects.filter(p => String(p.id) !== String(projectId));
            saveData();
            renderMain();
        }
        
        // åœ¨åº«ã‚·ãƒ¼ãƒˆã‹ã‚‰è©²å½“æ¡ˆä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
        async function deleteInventoryByProject(project) {
            try {
                // ã‚·ãƒ¼ãƒˆIDã‚’å–å¾—
                const sheetMeta = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID,
                });
                const inventorySheet = sheetMeta.result.sheets.find(s => s.properties.title === 'åœ¨åº«');
                if (!inventorySheet) {
                    console.error('åœ¨åº«ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                const sheetId = inventorySheet.properties.sheetId;
                
                // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A2:Q',
                });
                const rows = response.result.values || [];
                
                const projectPrefix = (project.projectPrefix || 'AD').toUpperCase();
                const projectNum = String(project.projectNumber).padStart(4, '0');
                
                // å‰Šé™¤å¯¾è±¡ã®è¡Œç•ªå·ã‚’åé›†ï¼ˆ1å§‹ã¾ã‚Šã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ¬¡ã‹ã‚‰ï¼‰
                const rowsToDelete = [];
                rows.forEach((row, idx) => {
                    const rowPrefix = (row[4] || '').toUpperCase();
                    const rowNumber = String(row[5] || '').padStart(4, '0');
                    if (rowPrefix === projectPrefix && rowNumber === projectNum) {
                        rowsToDelete.push(idx + 2); // idx=0 â†’ è¡Œ2ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¡Œ1ï¼‰
                    }
                });
                
                if (rowsToDelete.length === 0) return;
                
                // å¾Œã‚ã®è¡Œã‹ã‚‰å‰Šé™¤ï¼ˆé™é †ã‚½ãƒ¼ãƒˆï¼‰â€»å‰ã‹ã‚‰æ¶ˆã™ã¨è¡Œç•ªå·ãŒãšã‚Œã‚‹ãŸã‚
                rowsToDelete.sort((a, b) => b - a);
                
                const requests = rowsToDelete.map(rowNum => ({
                    deleteDimension: {
                        range: {
                            sheetId: sheetId,
                            dimension: 'ROWS',
                            startIndex: rowNum - 1, // 0å§‹ã¾ã‚Šã«å¤‰æ›
                            endIndex: rowNum        // 1è¡Œã ã‘å‰Šé™¤
                        }
                    }
                }));
                
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: { requests }
                });
                
                console.log(`åœ¨åº«ã‹ã‚‰ ${rowsToDelete.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆè¡Œå˜ä½å‰Šé™¤ï¼‰`);
            } catch (e) {
                console.error('åœ¨åº«å‰Šé™¤ã«å¤±æ•—:', e);
            }
        }

        // 7. è«¸è²»ç”¨ç®¡ç†
        function showAddExpenseModal(projectId) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;

            const modal = document.createElement('div');
            modal.id = 'expenseModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ“¦ è«¸è²»ç”¨ã‚’è¿½åŠ </h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">æ¡ˆä»¶: ${formatProjectNumber(project)}</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è²»ç”¨ç¨®åˆ¥ <span class="text-red-500">*</span></label>
                                <select id="expenseType" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="å›½éš›é€æ–™">å›½éš›é€æ–™</option>
                                    <option value="é–¢ç¨">é–¢ç¨</option>
                                    <option value="è¼¸å…¥æ¶ˆè²»ç¨">è¼¸å…¥æ¶ˆè²»ç¨</option>
                                    <option value="é€šé–¢æ‰‹æ•°æ–™">é€šé–¢æ‰‹æ•°æ–™</option>
                                    <option value="å›½å†…é…é€æ–™">å›½å†…é…é€æ–™</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">é‡‘é¡ï¼ˆå††ï¼‰ <span class="text-red-500">*</span></label>
                                <input type="number" id="expenseAmount" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="45000" step="1">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ”¯æ‰•å…ˆ</label>
                                <input type="text" id="expensePayee" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="ABCç‰©æµã€ç¨é–¢ãªã©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ”¯æ‰•æ—¥</label>
                                <input type="date" id="expensePaidDate" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">å‚™è€ƒ</label>
                                <input type="text" id="expenseNote" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="ä»»æ„">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('expenseModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitExpense(${projectId})" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">è¿½åŠ </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitExpense(projectId) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;

            const type = document.getElementById('expenseType').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const payee = document.getElementById('expensePayee').value.trim();
            const paidDate = document.getElementById('expensePaidDate').value;
            const note = document.getElementById('expenseNote').value.trim();

            if (!amount || amount <= 0) {
                alert('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!project.expenses) {
                project.expenses = [];
            }

            project.expenses.push({
                id: Date.now(),
                type: type,
                amountJPY: amount,
                payee: payee,
                paidDate: paidDate,
                note: note
            });

            saveData();
            closeModal('expenseModal');
            renderMain();
        }

        function deleteExpense(projectId, expenseIndex) {
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project || !project.expenses) return;

            const expense = project.expenses[expenseIndex];
            if (!confirm(`ã€Œ${expense.type}ã€(${formatJPY(expense.amountJPY)}) ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            project.expenses.splice(expenseIndex, 1);
            saveData();
            renderMain();
        }

        // 8. æµ·å¤–è«‹æ±‚æ›¸ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ï¼‰ãƒ‰ãƒ©ã‚¤ãƒ–åŒæœŸ
        async function syncInvoices() {
            toggleToolsMenu();
            
            const modal = document.createElement('div');
            modal.id = 'syncInvoiceModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ“„ æµ·å¤–è«‹æ±‚æ›¸ãƒ•ã‚©ãƒ«ãƒ€ã‚’åŒæœŸ</h3>
                        
                        <div id="invoiceSyncLoading" class="text-center py-8">
                            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-3"></div>
                            <p class="text-slate-600 dark:text-slate-400">ãƒ‰ãƒ©ã‚¤ãƒ–ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</p>
                        </div>
                        
                        <div id="invoiceSyncResult" class="hidden">
                            <div id="invoiceFileList" class="space-y-2 mb-4 max-h-96 overflow-y-auto">
                            </div>
                            <div id="invoiceSyncSummary" class="bg-slate-100 dark:bg-slate-700 rounded-lg p-4 mb-4">
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closeModal('syncInvoiceModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">é–‰ã˜ã‚‹</button>
                            <button id="invoiceSyncProcessBtn" onclick="processSelectedInvoices()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 hidden">é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–è¾¼</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            await scanInvoiceFolder();
        }

        let invoiceFilesToProcess = [];

        async function scanInvoiceFolder() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${INVOICE_FOLDER_ID}' in parents and mimeType = 'application/pdf' and trashed = false`,
                    fields: 'files(id, name, createdTime, webViewLink)',
                    orderBy: 'createdTime desc',
                    pageSize: 50
                });
                
                const files = response.result.files || [];
                document.getElementById('invoiceSyncLoading').classList.add('hidden');
                document.getElementById('invoiceSyncResult').classList.remove('hidden');
                
                if (files.length === 0) {
                    document.getElementById('invoiceFileList').innerHTML = `
                        <p class="text-center text-slate-500 dark:text-slate-400 py-4">PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                    `;
                    document.getElementById('invoiceSyncSummary').innerHTML = `
                        <p class="text-sm text-slate-600 dark:text-slate-400">
                            ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã«PDFã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br>
                            <span class="text-xs">ãƒ•ã‚¡ã‚¤ãƒ«åå½¢å¼: <code class="bg-slate-200 dark:bg-slate-600 px-1 rounded">YYMM_æµ·å¤–è«‹æ±‚æ›¸_AD-XXXX_ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å_è£½å“å.pdf</code></span>
                        </p>
                    `;
                    return;
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
                invoiceFilesToProcess = files.map(file => {
                    const parsed = parseInvoiceFileName(file.name);
                    
                    // æ¡ˆä»¶ç•ªå·ã§æ—¢å­˜ãƒã‚§ãƒƒã‚¯
                    let existingProject = null;
                    if (parsed.projectNumber) {
                        const pn = parseProjectNumberString(parsed.projectNumber);
                        existingProject = projects.find(p => 
                            (p.projectPrefix || 'AD') === pn.prefix && 
                            parseInt(p.projectNumber) === pn.number
                        );
                    }
                    
                    // æ—¢ã«åŒã˜æ¡ˆä»¶ç•ªå·ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°ç™»éŒ²æ¸ˆã¿ã¨ã™ã‚‹
                    const alreadyRegistered = !!existingProject;
                    
                    return {
                        ...file,
                        ...parsed,
                        existingProject,
                        alreadyRegistered,
                        selected: !alreadyRegistered && parsed.projectNumber
                    };
                });
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
                const listEl = document.getElementById('invoiceFileList');
                listEl.innerHTML = invoiceFilesToProcess.map((file, idx) => `
                    <div class="flex items-center gap-3 p-3 rounded-lg border ${file.alreadyRegistered ? 'bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600' : file.existingProject ? 'bg-amber-50 dark:bg-amber-900/20 border-amber-300 dark:border-amber-700' : file.projectNumber ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-700' : 'bg-red-50 dark:bg-red-900/20 border-red-300 dark:border-red-700'}">
                        <input type="checkbox" id="invoiceFile${idx}" ${file.selected ? 'checked' : ''} ${file.alreadyRegistered ? 'disabled' : ''} class="rounded" onchange="updateInvoiceSyncSummary()">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium dark:text-white truncate">${file.name}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                ${file.alreadyRegistered ? 'âœ“ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç™»éŒ²æ¸ˆã¿' : file.existingProject ? `âš ï¸ ${file.projectNumber} ã¯æ—¢å­˜ï¼ˆä¸Šæ›¸ãæ³¨æ„ï¼‰` : file.projectNumber ? `ğŸ†• ${file.projectNumber} / ${file.supplierName || '?'}` : 'âŒ æ¡ˆä»¶ç•ªå·ä¸æ˜'}
                            </p>
                        </div>
                        <a href="${file.webViewLink}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs">é–‹ã</a>
                    </div>
                `).join('');
                
                updateInvoiceSyncSummary();
                
            } catch (error) {
                console.error('ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('invoiceSyncLoading').innerHTML = `
                    <p class="text-red-600">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚¤ãƒ³ãƒœã‚¤ã‚¹æƒ…å ±ã‚’æŠ½å‡º
        // ä¾‹: 2512_æµ·å¤–è«‹æ±‚æ›¸_AD-1681_ZEMSO_VW_55_20pcs.pdf
        function parseInvoiceFileName(fileName) {
            const result = {
                projectNumber: null,
                supplierName: null
            };
            
            // AD-XXXX ãƒ‘ã‚¿ãƒ¼ãƒ³
            const projectMatch = fileName.match(/_(AD-\d+)/i);
            if (projectMatch) {
                result.projectNumber = projectMatch[1].toUpperCase();
            }
            
            // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åï¼ˆAD-XXXXã®å¾Œã®éƒ¨åˆ†ï¼‰
            const supplierMatch = fileName.match(/_AD-\d+_([^_]+)/i);
            if (supplierMatch) {
                result.supplierName = supplierMatch[1];
            }
            
            return result;
        }

        function updateInvoiceSyncSummary() {
            const selectedCount = invoiceFilesToProcess.filter((f, idx) => {
                const cb = document.getElementById(`invoiceFile${idx}`);
                return cb && cb.checked && !f.alreadyRegistered;
            }).length;
            
            const registeredCount = invoiceFilesToProcess.filter(f => f.alreadyRegistered).length;
            const unmatchedCount = invoiceFilesToProcess.filter(f => !f.projectNumber && !f.alreadyRegistered).length;
            
            document.getElementById('invoiceSyncSummary').innerHTML = `
                <div class="flex flex-wrap gap-4 text-sm">
                    <span class="text-slate-600 dark:text-slate-400">ğŸ“„ å…¨${invoiceFilesToProcess.length}ä»¶</span>
                    <span class="text-emerald-600">âœ“ ç™»éŒ²æ¸ˆã¿ ${registeredCount}ä»¶</span>
                    <span class="text-amber-600">âš ï¸ æ¡ˆä»¶ç•ªå·ä¸æ˜ ${unmatchedCount}ä»¶</span>
                    <span class="text-blue-600 font-semibold">é¸æŠä¸­ ${selectedCount}ä»¶</span>
                </div>
            `;
            
            const btn = document.getElementById('invoiceSyncProcessBtn');
            if (selectedCount > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `é¸æŠã—ãŸ ${selectedCount} ä»¶ã‚’å–è¾¼`;
            } else {
                btn.classList.add('hidden');
            }
        }

        async function processSelectedInvoices() {
            const selectedFiles = invoiceFilesToProcess.filter((f, idx) => {
                const cb = document.getElementById(`invoiceFile${idx}`);
                return cb && cb.checked && !f.alreadyRegistered && f.projectNumber;
            });
            
            if (selectedFiles.length === 0) return;
            
            document.getElementById('invoiceSyncProcessBtn').disabled = true;
            document.getElementById('invoiceSyncProcessBtn').textContent = 'å‡¦ç†ä¸­...';
            
            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;
            
            for (const file of selectedFiles) {
                try {
                    // æ¡ˆä»¶ç•ªå·ã‚’åˆ†è§£
                    const parsed = parseProjectNumberString(file.projectNumber);
                    
                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼šåŒã˜æ¡ˆä»¶ç•ªå·ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹
                    const existingProject = projects.find(p => 
                        (p.projectPrefix || 'AD') === parsed.prefix && 
                        parseInt(p.projectNumber) === parsed.number
                    );
                    
                    if (existingProject) {
                        console.log(`ã‚¹ã‚­ãƒƒãƒ—: ${file.projectNumber} ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿`);
                        skippedCount++;
                        continue;
                    }
                    
                    // ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ—¢ã«ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆsourceFileã§åˆ¤å®šï¼‰
                    const registeredFromFile = projects.find(p => p.sourceFile === file.name);
                    if (registeredFromFile) {
                        console.log(`ã‚¹ã‚­ãƒƒãƒ—: ${file.name} ã¯æ—¢ã«å–è¾¼æ¸ˆã¿`);
                        skippedCount++;
                        continue;
                    }
                    
                    // PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è§£æ
                    const pdfData = await downloadDriveFile(file.id);
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    
                    const invoiceData = parseInvoicePdf(fullText);
                    
                    // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢ã¾ãŸã¯ä½œæˆ
                    let supplier = suppliers.find(s => 
                        s.name.toUpperCase().includes(file.supplierName?.toUpperCase() || '') ||
                        (file.supplierName && file.supplierName.toUpperCase().includes(s.name.toUpperCase()))
                    );
                    
                    if (!supplier && file.supplierName) {
                        // æ–°è¦ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ç™»éŒ²
                        supplier = {
                            id: Date.now(),
                            name: file.supplierName,
                            contact: '',
                            note: 'ã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ˆã‚Šè‡ªå‹•ç™»éŒ²'
                        };
                        suppliers.push(supplier);
                    }
                    
                    // æ”¯æ‰•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆ
                    const totalAmount = invoiceData.totalAmount || 0;
                    const paymentTerms = invoiceData.paymentTerms || [30, 65, 5];
                    const depositSchedule = paymentTerms.map((pct, idx) => ({
                        depositNumber: idx + 1,
                        percentage: pct,
                        amountUSD: Math.round(totalAmount * pct / 100 * 100) / 100,
                        paid: false,
                        paidDate: null,
                        exchangeRate: null,
                        amountJPY: null
                    }));
                    
                    // é›†è·äºˆå®šæ—¥è¨ˆç®—
                    const workingDays = invoiceData.workingDays || 20;
                    const today = new Date();
                    const pickupDate = addWorkingDays(today, workingDays);
                    const todayStr = today.toISOString().split('T')[0];
                    
                    // è£½å“åã‹ã‚‰ç¨®åˆ¥ã‚’åˆ¤å®š
                    const productName = invoiceData.productName || file.name.split('_').slice(4).join('_').replace('.pdf', '');
                    const category = detectCategory(productName);
                    
                    // Serialç”Ÿæˆ
                    const quantity = invoiceData.quantity || 1;
                    const serial = generateSerial(quantity);
                    
                    // æ¡ˆä»¶ç™»éŒ²ï¼ˆæ–°å½¢å¼ï¼šprojectPrefix + projectNumberï¼‰
                    const projectNumberFull = `${parsed.prefix}-${parsed.number}`;
                    projects.push({
                        id: String(Date.now()) + String(Math.random()).slice(2, 8),
                        projectPrefix: parsed.prefix,
                        projectNumber: parsed.number,
                        supplierId: supplier?.id || null,
                        productName: productName,
                        totalAmount: totalAmount,
                        depositSchedule: depositSchedule,
                        serial: serial,
                        quantity: quantity,
                        workingDays: workingDays,
                        pickupDate: pickupDate.toISOString().split('T')[0],
                        registeredDate: todayStr,
                        expenses: [],
                        invoiceNo: invoiceData.invoiceNo || '',
                        sourceFile: file.name
                    });
                    
                    // åœ¨åº«ã‚·ãƒ¼ãƒˆã«ã‚‚è¿½åŠ 
                    if (category) {
                        await addToInventory(serial, category, productName, projectNumberFull, todayStr, quantity);
                    }
                    
                    successCount++;
                } catch (error) {
                    console.error(`ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${file.name}`, error);
                    errorCount++;
                }
            }
            
            await saveData();
            closeModal('syncInvoiceModal');
            renderMain();
            
            let msg = `å–è¾¼å®Œäº†ï¼\næ–°è¦æ¡ˆä»¶ç™»éŒ²: ${successCount}ä»¶`;
            if (skippedCount > 0) msg += `\nã‚¹ã‚­ãƒƒãƒ—ï¼ˆé‡è¤‡ï¼‰: ${skippedCount}ä»¶`;
            if (errorCount > 0) msg += `\nã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`;
            alert(msg);
        }

        // ã‚¤ãƒ³ãƒœã‚¤ã‚¹PDFã‚’è§£æï¼ˆZEMSOãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œï¼‰
        function parseInvoicePdf(text) {
            const result = {
                invoiceNo: null,
                totalAmount: 0,
                quantity: 1,
                productName: null,
                paymentTerms: [],
                workingDays: 20
            };
            
            // Invoice No.: "Invoice No.: ZEMSO-20251114-Q001"
            const invoiceMatch = text.match(/Invoice\s*No\.?\s*:?\s*([A-Z0-9\-]+)/i);
            if (invoiceMatch) {
                result.invoiceNo = invoiceMatch[1];
            }
            
            // Totalé‡‘é¡: "Total US$19,354.00" ï¼ˆè¡Œå˜ä½ã§ãƒãƒƒãƒï¼‰
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã® "Unit Price Total" ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚ã€US$å¿…é ˆ
            const totalMatch = text.match(/^Total\s+US\$([\d,]+\.\d{2})/im) ||
                               text.match(/Total\s+US\$([\d,]+\.\d{2})/i) ||
                               text.match(/Total\s*:\s*US\$([\d,]+\.\d{2})/i);
            if (totalMatch) {
                result.totalAmount = parseFloat(totalMatch[1].replace(/,/g, ''));
            }
            
            // æ•°é‡: ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ä¸»è¦è£½å“ï¼ˆæœ€å¤§é‡‘é¡ã®è¡Œï¼‰ã®æ•°é‡ã‚’å–å¾—
            // ãƒ‘ã‚¿ãƒ¼ãƒ³: "20 US$866.00 US$17,320.00" ã®ã‚ˆã†ãªè¡Œ
            const lineItems = [];
            const itemPattern = /(\d+)\s+US\$([\d,]+\.\d{2})\s+US\$([\d,]+\.\d{2})/g;
            let itemMatch;
            while ((itemMatch = itemPattern.exec(text)) !== null) {
                const qty = parseInt(itemMatch[1]);
                const unitPrice = parseFloat(itemMatch[2].replace(/,/g, ''));
                const total = parseFloat(itemMatch[3].replace(/,/g, ''));
                if (qty > 0 && total > 0) {
                    lineItems.push({ qty, unitPrice, total });
                }
            }
            
            // æœ€å¤§é‡‘é¡ã®è¡Œã®æ•°é‡ã‚’æ¡ç”¨ï¼ˆä¸»è¦è£½å“ï¼‰
            if (lineItems.length > 0) {
                const mainItem = lineItems.reduce((max, item) => 
                    item.total > max.total ? item : max, lineItems[0]);
                result.quantity = mainItem.qty;
            }
            
            // Payment terms: "30% deposit, 65% payment before shipment, 5% balance"
            const paymentMatch = text.match(/(\d+)%\s*deposit[^0-9]*(\d+)%[^0-9]*(?:payment|before)[^0-9]*(\d+)%/i);
            if (paymentMatch) {
                result.paymentTerms = [
                    parseInt(paymentMatch[1]),
                    parseInt(paymentMatch[2]),
                    parseInt(paymentMatch[3])
                ];
            } else {
                // åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³: æ•°å­—%ã‚’é †ç•ªã«æŠ½å‡ºï¼ˆãŸã ã—100%ãªã©ã¯é™¤å¤–ï¼‰
                const pctMatches = text.match(/\b([1-9]\d?)%/g);
                if (pctMatches && pctMatches.length >= 2) {
                    result.paymentTerms = pctMatches.slice(0, 3).map(p => parseInt(p));
                }
            }
            
            // Working days: "20 working days" or "20 wording days"
            const daysMatch = text.match(/(\d+)\s*(?:working|wording)\s*days/i);
            if (daysMatch) {
                result.workingDays = parseInt(daysMatch[1]);
            }
            
            // è£½å“å: "55'' Indoor LCD Video Wall" ãƒ‘ã‚¿ãƒ¼ãƒ³
            const productMatch = text.match(/(\d+[''"]?\s*(?:Indoor|Outdoor)?\s*(?:LCD|LED)?\s*(?:Video\s*Wall|Display|Monitor|Touch\s*(?:Screen|Frame)?)[^\n]*)/i);
            if (productMatch) {
                result.productName = productMatch[1].trim().substring(0, 50);
            }
            
            return result;
        }

        // 9. è¼¸å…¥è¨±å¯æ›¸ãƒ‰ãƒ©ã‚¤ãƒ–åŒæœŸ
        async function syncImportPermits() {
            toggleToolsMenu();
            
            const modal = document.createElement('div');
            modal.id = 'syncPermitModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ”„ è¼¸å…¥è¨±å¯æ›¸ãƒ•ã‚©ãƒ«ãƒ€ã‚’åŒæœŸ</h3>
                        
                        <div id="syncLoading" class="text-center py-8">
                            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-orange-600 mx-auto mb-3"></div>
                            <p class="text-slate-600 dark:text-slate-400">ãƒ‰ãƒ©ã‚¤ãƒ–ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</p>
                        </div>
                        
                        <div id="syncResult" class="hidden">
                            <div id="syncFileList" class="space-y-2 mb-4 max-h-96 overflow-y-auto">
                            </div>
                            <div id="syncSummary" class="bg-slate-100 dark:bg-slate-700 rounded-lg p-4 mb-4">
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closeModal('syncPermitModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">é–‰ã˜ã‚‹</button>
                            <button id="syncProcessBtn" onclick="processSelectedPermits()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50 hidden">é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–è¾¼</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ãƒ‰ãƒ©ã‚¤ãƒ–ã‚’ã‚¹ã‚­ãƒ£ãƒ³
            await scanPermitFolder();
        }

        let permitFilesToProcess = [];

        async function scanPermitFolder() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${IMPORT_PERMIT_FOLDER_ID}' in parents and mimeType = 'application/pdf' and trashed = false`,
                    fields: 'files(id, name, createdTime, webViewLink)',
                    orderBy: 'createdTime desc',
                    pageSize: 50
                });
                
                const files = response.result.files || [];
                document.getElementById('syncLoading').classList.add('hidden');
                document.getElementById('syncResult').classList.remove('hidden');
                
                if (files.length === 0) {
                    document.getElementById('syncFileList').innerHTML = `
                        <p class="text-center text-slate-500 dark:text-slate-400 py-4">PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                    `;
                    document.getElementById('syncSummary').innerHTML = `
                        <p class="text-sm text-slate-600 dark:text-slate-400">
                            ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã«PDFã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br>
                            <span class="text-xs">ãƒ•ã‚¡ã‚¤ãƒ«åå½¢å¼: <code class="bg-slate-200 dark:bg-slate-600 px-1 rounded">YYMMDD_è¼¸å…¥è¨±å¯æ›¸_AD-XXXX.pdf</code></span>
                        </p>
                    `;
                    return;
                }
                
                // å‡¦ç†æ¸ˆã¿ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                permitFilesToProcess = files.map(file => {
                    const projectNumberFromFile = extractProjectNumberFromFileName(file.name);
                    const matchedProject = projectNumberFromFile ? projects.find(p => 
                        formatProjectNumber(p).toUpperCase() === projectNumberFromFile.toUpperCase()
                    ) : null;
                    
                    // ã™ã§ã«å‡¦ç†æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæ¡ˆä»¶ã®è«¸è²»ç”¨ã«åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«åã®å‚™è€ƒãŒã‚ã‚‹ã‹ï¼‰
                    const alreadyProcessed = matchedProject && (matchedProject.expenses || []).some(e => 
                        e.note && e.note.includes(file.name)
                    );
                    
                    return {
                        ...file,
                        projectNumber: projectNumberFromFile,
                        matchedProject,
                        alreadyProcessed,
                        selected: !alreadyProcessed && matchedProject
                    };
                });
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
                const listEl = document.getElementById('syncFileList');
                listEl.innerHTML = permitFilesToProcess.map((file, idx) => `
                    <div class="flex items-center gap-3 p-3 rounded-lg border ${file.alreadyProcessed ? 'bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600' : file.matchedProject ? 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-300 dark:border-emerald-700' : 'bg-amber-50 dark:bg-amber-900/20 border-amber-300 dark:border-amber-700'}">
                        <input type="checkbox" id="syncFile${idx}" ${file.selected ? 'checked' : ''} ${file.alreadyProcessed ? 'disabled' : ''} class="rounded" onchange="updateSyncSummary()">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium dark:text-white truncate">${file.name}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                ${file.alreadyProcessed ? 'âœ“ å–è¾¼æ¸ˆã¿' : file.matchedProject ? `â†’ ${file.matchedProject.projectNumber}` : 'âš ï¸ æ¡ˆä»¶ä¸æ˜'}
                            </p>
                        </div>
                        <a href="${file.webViewLink}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs">é–‹ã</a>
                    </div>
                `).join('');
                
                updateSyncSummary();
                
            } catch (error) {
                console.error('ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('syncLoading').innerHTML = `
                    <p class="text-red-600">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                `;
            }
        }

        function updateSyncSummary() {
            const selectedCount = permitFilesToProcess.filter((f, idx) => {
                const cb = document.getElementById(`syncFile${idx}`);
                return cb && cb.checked && !f.alreadyProcessed;
            }).length;
            
            const processedCount = permitFilesToProcess.filter(f => f.alreadyProcessed).length;
            const unmatchedCount = permitFilesToProcess.filter(f => !f.matchedProject && !f.alreadyProcessed).length;
            
            document.getElementById('syncSummary').innerHTML = `
                <div class="flex flex-wrap gap-4 text-sm">
                    <span class="text-slate-600 dark:text-slate-400">ğŸ“„ å…¨${permitFilesToProcess.length}ä»¶</span>
                    <span class="text-emerald-600">âœ“ å–è¾¼æ¸ˆã¿ ${processedCount}ä»¶</span>
                    <span class="text-amber-600">âš ï¸ æ¡ˆä»¶ä¸æ˜ ${unmatchedCount}ä»¶</span>
                    <span class="text-orange-600 font-semibold">é¸æŠä¸­ ${selectedCount}ä»¶</span>
                </div>
            `;
            
            const btn = document.getElementById('syncProcessBtn');
            if (selectedCount > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `é¸æŠã—ãŸ ${selectedCount} ä»¶ã‚’å–è¾¼`;
            } else {
                btn.classList.add('hidden');
            }
        }

        async function processSelectedPermits() {
            const selectedFiles = permitFilesToProcess.filter((f, idx) => {
                const cb = document.getElementById(`syncFile${idx}`);
                return cb && cb.checked && !f.alreadyProcessed && f.matchedProject;
            });
            
            if (selectedFiles.length === 0) return;
            
            document.getElementById('syncProcessBtn').disabled = true;
            document.getElementById('syncProcessBtn').textContent = 'å‡¦ç†ä¸­...';
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const file of selectedFiles) {
                try {
                    // PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è§£æ
                    const pdfData = await downloadDriveFile(file.id);
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    
                    const parsedData = parseImportPermit(fullText);
                    const project = file.matchedProject;
                    
                    if (!project.expenses) {
                        project.expenses = [];
                    }
                    
                    const permitDate = parsedData.permitDate || new Date().toISOString().split('T')[0];
                    
                    // è«¸è²»ç”¨ã‚’è¿½åŠ 
                    parsedData.expenses.forEach((exp, idx) => {
                        project.expenses.push({
                            id: Date.now() + idx,
                            type: exp.type,
                            amountJPY: exp.amount,
                            payee: exp.type === 'å›½éš›é‹è³ƒ' || exp.type === 'ä¿é™ºæ–™' ? 'ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ãƒ¼' : 'ç¨é–¢',
                            paidDate: permitDate,
                            note: `${file.name} ã‚ˆã‚Šè‡ªå‹•å–è¾¼`
                        });
                    });
                    
                    successCount++;
                } catch (error) {
                    console.error(`ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${file.name}`, error);
                    errorCount++;
                }
            }
            
            await saveData();
            closeModal('syncPermitModal');
            renderMain();
            
            alert(`å–è¾¼å®Œäº†ï¼\næˆåŠŸ: ${successCount}ä»¶\n${errorCount > 0 ? `ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶` : ''}`);
        }

        async function downloadDriveFile(fileId) {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ArrayBufferã«å¤‰æ›
            const text = response.body;
            const bytes = new Uint8Array(text.length);
            for (let i = 0; i < text.length; i++) {
                bytes[i] = text.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // 9. æ‰‹å‹•PDFèª­è¾¼ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showImportPermitModal() {
            toggleToolsMenu();
            
            const modal = document.createElement('div');
            modal.id = 'importPermitModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ“„ è¼¸å…¥è¨±å¯æ›¸ã‚’èª­ã¿è¾¼ã‚€</h3>
                        
                        <div id="importPermitUpload" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center mb-4">
                            <input type="file" id="permitPdfInput" accept=".pdf" class="hidden" onchange="handlePermitPdfUpload(event)">
                            <label for="permitPdfInput" class="cursor-pointer">
                                <div class="text-4xl mb-2">ğŸ“„</div>
                                <p class="text-slate-600 dark:text-slate-400">ã‚¯ãƒªãƒƒã‚¯ã—ã¦PDFã‚’é¸æŠ</p>
                                <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">ã¾ãŸã¯ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                            </label>
                        </div>
                        
                        <div id="importPermitResult" class="hidden">
                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-4 mb-4">
                                <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">ğŸ“‹ èª­ã¿å–ã‚Šçµæœ</p>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <span class="text-slate-500 dark:text-slate-400">è¨±å¯æ—¥:</span>
                                        <span id="permitDate" class="ml-2 font-semibold dark:text-white">-</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-500 dark:text-slate-400">ä»•å…¥æ›¸ç•ªå·:</span>
                                        <span id="permitInvoiceNo" class="ml-2 font-mono text-xs dark:text-white">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 mb-4">
                                <p class="text-sm font-semibold text-orange-700 dark:text-orange-400 mb-3">ğŸ’° è«¸è²»ç”¨</p>
                                <div class="space-y-2" id="permitExpensesList">
                                </div>
                                <div class="flex justify-between items-center pt-3 mt-3 border-t border-orange-200 dark:border-orange-700">
                                    <span class="font-semibold text-orange-700 dark:text-orange-400">åˆè¨ˆ</span>
                                    <span id="permitTotal" class="font-bold text-lg text-orange-700 dark:text-orange-400">Â¥0</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-2 dark:text-slate-300">å¯¾è±¡æ¡ˆä»¶ã‚’é¸æŠ</label>
                                <select id="permitTargetProject" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="">-- æ¡ˆä»¶ã‚’é¸æŠ --</option>
                                    ${projects.map(p => `<option value="${p.id}">${formatProjectNumber(p)} - ${p.productName}</option>`).join('')}
                                </select>
                                <p id="permitAutoMatch" class="text-xs text-emerald-600 dark:text-emerald-400 mt-1 hidden">âœ“ ä»•å…¥æ›¸ç•ªå·ã‹ã‚‰è‡ªå‹•ãƒãƒƒãƒã—ã¾ã—ãŸ</p>
                            </div>
                        </div>
                        
                        <div id="importPermitLoading" class="hidden text-center py-8">
                            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-orange-600 mx-auto mb-3"></div>
                            <p class="text-slate-600 dark:text-slate-400">PDFè§£æä¸­...</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closeModal('importPermitModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button id="permitSubmitBtn" onclick="submitPermitExpenses()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>è«¸è²»ç”¨ã«è¿½åŠ </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
            const uploadArea = document.getElementById('importPermitUpload');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-orange-500', 'bg-orange-50');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-orange-500', 'bg-orange-50');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-orange-500', 'bg-orange-50');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    processPermitPdf(file);
                }
            });
        }

        function handlePermitPdfUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processPermitPdf(file);
            }
        }

        // è§£æçµæœã‚’ä¸€æ™‚ä¿å­˜
        let parsedPermitData = null;

        async function processPermitPdf(file) {
            document.getElementById('importPermitUpload').classList.add('hidden');
            document.getElementById('importPermitLoading').classList.remove('hidden');
            
            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ¡ˆä»¶ç•ªå·ã‚’æŠ½å‡º
                const projectNumberFromFile = extractProjectNumberFromFileName(file.name);
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                // è§£æ
                parsedPermitData = parseImportPermit(fullText);
                parsedPermitData.projectNumberFromFile = projectNumberFromFile;
                displayPermitResult(parsedPermitData);
                
            } catch (error) {
                console.error('PDFè§£æã‚¨ãƒ©ãƒ¼:', error);
                alert('PDFã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                document.getElementById('importPermitUpload').classList.remove('hidden');
            }
            
            document.getElementById('importPermitLoading').classList.add('hidden');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ¡ˆä»¶ç•ªå·ã‚’æŠ½å‡º
        // ä¾‹: "251015_è¼¸å…¥è¨±å¯æ›¸_AD-1750.pdf" â†’ "AD-1750"
        function extractProjectNumberFromFileName(fileName) {
            // AD-æ•°å­— ã¾ãŸã¯æ•°å­—ã®ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã™
            const patterns = [
                /_(AD-\d+)/i,           // _AD-1750
                /_(AS-\d+)/i,           // _AS-1234
                /_(\d{4,})/,            // _1750 (4æ¡ä»¥ä¸Šã®æ•°å­—)
            ];
            
            for (const pattern of patterns) {
                const match = fileName.match(pattern);
                if (match) {
                    return match[1].toUpperCase();
                }
            }
            return null;
        }

        function parseImportPermit(text) {
            const result = {
                permitDate: null,
                invoiceNo: null,
                expenses: [],
                freight: 0,
                insurance: 0,
                customsDuty: 0,
                consumptionTax: 0,
                localConsumptionTax: 0,
                totalTax: 0
            };
            
            // è¨±å¯æ—¥: "è¼¸å…¥è¨±å¯æ—¥ 2025/10/15" ãƒ‘ã‚¿ãƒ¼ãƒ³
            const permitDateMatch = text.match(/è¼¸å…¥è¨±å¯æ—¥\s*(\d{4}\/\d{1,2}\/\d{1,2})/);
            if (permitDateMatch) {
                result.permitDate = permitDateMatch[1].replace(/\//g, '-');
            }
            
            // ä»•å…¥æ›¸ç•ªå·: "ä»•å…¥æ›¸ç•ªå· B - OKV..." ãƒ‘ã‚¿ãƒ¼ãƒ³
            const invoiceMatch = text.match(/ä»•å…¥æ›¸ç•ªå·\s*[A-Z]?\s*[-ï¼]?\s*([A-Z0-9]+)/i);
            if (invoiceMatch) {
                result.invoiceNo = invoiceMatch[1];
            }
            
            // é‹è³ƒ: "é‹è³ƒ A JPY - 255,682" or "é‹è³ƒ A JPY 255,682"
            const freightMatch = text.match(/é‹è³ƒ\s*[A-Z]?\s*JPY\s*[-ï¼]?\s*([\d,]+)/);
            if (freightMatch) {
                result.freight = parseInt(freightMatch[1].replace(/,/g, ''));
            }
            
            // ä¿é™º: "ä¿é™º A JPY - 33,405"
            const insuranceMatch = text.match(/ä¿é™º\s*[A-Z]?\s*JPY\s*[-ï¼]?\s*([\d,]+)/);
            if (insuranceMatch) {
                result.insurance = parseInt(insuranceMatch[1].replace(/,/g, ''));
            }
            
            // é–¢ç¨: "D é–¢ç¨ Â¥0" or "é–¢ç¨ Â¥123,456"
            const dutyMatch = text.match(/[D]?\s*é–¢ç¨\s*Â¥?([\d,]+)/);
            if (dutyMatch) {
                result.customsDuty = parseInt(dutyMatch[1].replace(/,/g, ''));
            }
            
            // æ¶ˆè²»ç¨: "F æ¶ˆè²»ç¨ Â¥916,000"
            const consumptionMatch = text.match(/[F]?\s*æ¶ˆè²»ç¨\s*Â¥?([\d,]+)/);
            if (consumptionMatch) {
                result.consumptionTax = parseInt(consumptionMatch[1].replace(/,/g, ''));
            }
            
            // åœ°æ–¹æ¶ˆè²»ç¨: "A åœ°æ–¹æ¶ˆè²»ç¨ Â¥258,300"
            const localTaxMatch = text.match(/[A]?\s*åœ°æ–¹æ¶ˆè²»ç¨\s*Â¥?([\d,]+)/);
            if (localTaxMatch) {
                result.localConsumptionTax = parseInt(localTaxMatch[1].replace(/,/g, ''));
            }
            
            // ç´ç¨é¡åˆè¨ˆ
            const totalMatch = text.match(/ç´ç¨é¡åˆè¨ˆ\s*Â¥?([\d,]+)/);
            if (totalMatch) {
                result.totalTax = parseInt(totalMatch[1].replace(/,/g, ''));
            }
            
            // è«¸è²»ç”¨ãƒªã‚¹ãƒˆä½œæˆ
            if (result.freight > 0) {
                result.expenses.push({ type: 'å›½éš›é‹è³ƒ', amount: result.freight, checked: true });
            }
            if (result.insurance > 0) {
                result.expenses.push({ type: 'ä¿é™ºæ–™', amount: result.insurance, checked: true });
            }
            if (result.customsDuty > 0) {
                result.expenses.push({ type: 'é–¢ç¨', amount: result.customsDuty, checked: true });
            }
            if (result.consumptionTax > 0) {
                result.expenses.push({ type: 'æ¶ˆè²»ç¨', amount: result.consumptionTax, checked: true });
            }
            if (result.localConsumptionTax > 0) {
                result.expenses.push({ type: 'åœ°æ–¹æ¶ˆè²»ç¨', amount: result.localConsumptionTax, checked: true });
            }
            
            return result;
        }

        function displayPermitResult(data) {
            document.getElementById('importPermitResult').classList.remove('hidden');
            
            // è¨±å¯æ—¥
            document.getElementById('permitDate').textContent = data.permitDate || 'èª­å–ä¸å¯';
            
            // ä»•å…¥æ›¸ç•ªå·
            document.getElementById('permitInvoiceNo').textContent = data.invoiceNo || 'èª­å–ä¸å¯';
            
            // è«¸è²»ç”¨ãƒªã‚¹ãƒˆ
            const listEl = document.getElementById('permitExpensesList');
            listEl.innerHTML = data.expenses.map((exp, idx) => `
                <div class="flex justify-between items-center p-2 bg-white dark:bg-slate-800 rounded border border-orange-200 dark:border-orange-700">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="permitExp${idx}" ${exp.checked ? 'checked' : ''} onchange="updatePermitTotal()" class="rounded">
                        <span class="text-sm dark:text-white">${exp.type}</span>
                    </label>
                    <span class="font-semibold text-orange-700 dark:text-orange-400">${formatJPY(exp.amount)}</span>
                </div>
            `).join('');
            
            updatePermitTotal();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ¡ˆä»¶ã‚’è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°
            const selectEl = document.getElementById('permitTargetProject');
            const autoMatchEl = document.getElementById('permitAutoMatch');
            
            if (data.projectNumberFromFile) {
                // æ¡ˆä»¶ç•ªå·ã§æ¤œç´¢
                const matchedProject = projects.find(p => 
                    formatProjectNumber(p).toUpperCase() === data.projectNumberFromFile.toUpperCase() ||
                    formatProjectNumber(p).toUpperCase().includes(data.projectNumberFromFile.toUpperCase())
                );
                
                if (matchedProject) {
                    selectEl.value = matchedProject.id;
                    autoMatchEl.textContent = `âœ“ ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã€Œ${data.projectNumberFromFile}ã€ã‚’è‡ªå‹•æ¤œå‡ºã—ã¾ã—ãŸ`;
                    autoMatchEl.classList.remove('hidden');
                } else {
                    autoMatchEl.textContent = `âš ï¸ ã€Œ${data.projectNumberFromFile}ã€ã«ä¸€è‡´ã™ã‚‹æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`;
                    autoMatchEl.classList.remove('hidden');
                    autoMatchEl.classList.remove('text-emerald-600', 'dark:text-emerald-400');
                    autoMatchEl.classList.add('text-amber-600', 'dark:text-amber-400');
                }
            }
            
            document.getElementById('permitSubmitBtn').disabled = false;
        }

        function updatePermitTotal() {
            if (!parsedPermitData) return;
            
            let total = 0;
            parsedPermitData.expenses.forEach((exp, idx) => {
                const checkbox = document.getElementById(`permitExp${idx}`);
                if (checkbox && checkbox.checked) {
                    total += exp.amount;
                }
            });
            
            document.getElementById('permitTotal').textContent = formatJPY(total);
        }

        function submitPermitExpenses() {
            const projectId = document.getElementById('permitTargetProject').value;
            if (!projectId) {
                alert('å¯¾è±¡æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const project = projects.find(p => String(p.id) === String(projectId));
            if (!project) return;
            
            if (!project.expenses) {
                project.expenses = [];
            }
            
            const permitDate = parsedPermitData.permitDate || new Date().toISOString().split('T')[0];
            
            // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸè«¸è²»ç”¨ã‚’è¿½åŠ 
            parsedPermitData.expenses.forEach((exp, idx) => {
                const checkbox = document.getElementById(`permitExp${idx}`);
                if (checkbox && checkbox.checked) {
                    project.expenses.push({
                        id: Date.now() + idx,
                        type: exp.type,
                        amountJPY: exp.amount,
                        payee: exp.type === 'å›½éš›é‹è³ƒ' || exp.type === 'ä¿é™ºæ–™' ? 'ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ãƒ¼' : 'ç¨é–¢',
                        paidDate: permitDate,
                        note: 'è¼¸å…¥è¨±å¯æ›¸ã‚ˆã‚Šè‡ªå‹•å–è¾¼'
                    });
                }
            });
            
            saveData();
            closeModal('importPermitModal');
            renderMain();
            
            // å¯¾è±¡æ¡ˆä»¶ã‚’å±•é–‹
            expandedProjects[project.id] = true;
            renderMain();
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        window.onload = () => {
            if (typeof gapi !== 'undefined') gapiLoaded();
            if (typeof google !== 'undefined') gisLoaded();
        };
    </script>
</body>
</html>
