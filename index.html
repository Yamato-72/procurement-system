<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª¿é”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap');
        * { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-slate-600 text-lg">åˆæœŸåŒ–ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';
        const PARENT_FOLDER_ID = '1EvObQiCJgxJCzd_kQJ1PNbOUMD5P-Zxp';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let suppliers = [];
        let projects = [];
        let nextSerial = 554; // YS0554ã‹ã‚‰é–‹å§‹
        let showSupplierSection = false; // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹
        let expandedProjects = {}; // æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®å±•é–‹çŠ¶æ…‹
        let lastUpdated = null; // æœ€çµ‚æ›´æ–°æ—¥æ™‚
        let isDarkMode = localStorage.getItem('darkMode') === 'true'; // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            document.documentElement.classList.toggle('dark', isDarkMode);
            renderMain();
        }

        // ä¸­å›½ã®ç¥æ—¥ï¼ˆ2025å¹´ãƒ»2026å¹´ï¼‰
        const chinaHolidays = [
            // 2025å¹´
            '2025-01-01', // å…ƒæ—¦
            '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', '2025-02-03', '2025-02-04', // æ˜¥ç¯€
            '2025-04-04', '2025-04-05', '2025-04-06', // æ¸…æ˜ç¯€
            '2025-05-01', '2025-05-02', '2025-05-03', '2025-05-04', '2025-05-05', // åŠ´åƒç¯€
            '2025-05-31', '2025-06-01', '2025-06-02', // ç«¯åˆç¯€
            '2025-10-01', '2025-10-02', '2025-10-03', '2025-10-04', '2025-10-05', '2025-10-06', '2025-10-07', // å›½æ…¶ç¯€
            // 2026å¹´
            '2026-01-01', // å…ƒæ—¦
            '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', '2026-02-23', // æ˜¥ç¯€
            '2026-04-04', '2026-04-05', '2026-04-06', // æ¸…æ˜ç¯€
            '2026-05-01', '2026-05-02', '2026-05-03', // åŠ´åƒç¯€
            '2026-06-19', '2026-06-20', '2026-06-21', // ç«¯åˆç¯€
            '2026-10-01', '2026-10-02', '2026-10-03', '2026-10-04', '2026-10-05', '2026-10-06', '2026-10-07', // å›½æ…¶ç¯€
        ];

        // å–¶æ¥­æ—¥è¨ˆç®—ï¼ˆæ—¥æ›œã¨ä¸­å›½ç¥æ—¥ã‚’é™¤å¤–ï¼‰
        function addWorkingDays(startDate, days) {
            let date = new Date(startDate);
            date.setDate(date.getDate() + 1); // ç¿Œæ—¥ã‹ã‚‰é–‹å§‹
            let count = 0;
            
            while (count < days) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                
                // æ—¥æ›œæ—¥(0)ã¨ä¸­å›½ç¥æ—¥ã‚’é™¤å¤–
                if (dayOfWeek !== 0 && !chinaHolidays.includes(dateStr)) {
                    count++;
                }
                
                if (count < days) {
                    date.setDate(date.getDate() + 1);
                }
            }
            
            return date;
        }

        // Serialç•ªå·ã‚’ç”Ÿæˆ
        function generateSerial(quantity) {
            const serialNum = nextSerial;
            nextSerial++;
            const serialStr = 'YS' + String(serialNum).padStart(4, '0');
            
            if (quantity <= 1) {
                return serialStr;
            } else {
                return `${serialStr}(1-${quantity})`;
            }
        }

        // Serialç•ªå·ã®æ•°å€¤éƒ¨åˆ†ã‚’å–å¾—
        function getSerialNumber(serial) {
            const match = serial.match(/YS(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    'https://sheets.googleapis.com/$discovery/rest?version=v4',
                    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                ],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    accessToken = resp.access_token;
                    sessionStorage.setItem('googleAccessToken', accessToken);
                    loadData();
                    renderMain();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) {
                    accessToken = savedToken;
                    gapi.client.setToken({ access_token: accessToken });
                    loadData();
                    renderMain();
                } else {
                    renderSignIn();
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = resp.access_token;
                sessionStorage.setItem('googleAccessToken', accessToken);
                await loadData();
                renderMain();
            };

            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                sessionStorage.removeItem('googleAccessToken');
                accessToken = null;
            }
            gapi.client.setToken(null);
            suppliers = [];
            projects = [];
            renderSignIn();
        }

        let folderCache = {};

        async function findFolderUrl(projectNumber) {
            if (folderCache[projectNumber]) {
                return folderCache[projectNumber];
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name = '${projectNumber}' and '${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
                    fields: 'files(id, name, webViewLink)',
                    pageSize: 1,
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true,
                    corpora: 'allDrives'
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    const url = files[0].webViewLink;
                    folderCache[projectNumber] = url;
                    return url;
                }
                return null;
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        async function loadFolderUrls() {
            for (const project of projects) {
                if (!folderCache[project.projectNumber]) {
                    await findFolderUrl(project.projectNumber);
                }
            }
            renderMain();
        }

        async function loadData() {
            try {
                showStatus('èª­ã¿è¾¼ã¿ä¸­...');
                
                const supplierResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A2:D',
                });
                const supplierRows = supplierResponse.result.values || [];
                suppliers = supplierRows.map(row => ({
                    id: parseInt(row[0] || Date.now()),
                    name: row[1] || '',
                    depositCount: parseInt(row[2] || 2),
                    depositRates: JSON.parse(row[3] || '[50,50]')
                }));

                const projectResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A2:J',
                });
                const projectRows = projectResponse.result.values || [];
                projects = projectRows.map(row => {
                    const data = {
                        id: parseInt(row[0] || Date.now()),
                        projectNumber: row[1] || '',
                        supplierId: parseInt(row[2] || 0),
                        productName: row[3] || '',
                        totalAmount: parseFloat(row[4] || 0),
                        depositSchedule: [],
                        serial: row[6] || '',
                        quantity: parseInt(row[7] || 1),
                        workingDays: parseInt(row[8] || 30),
                        pickupDate: row[9] || ''
                    };
                    
                    const supplier = suppliers.find(s => s.id === data.supplierId);
                    if (supplier) {
                        try {
                            data.depositSchedule = JSON.parse(row[5] || '[]');
                        } catch (e) {
                            data.depositSchedule = supplier.depositRates.map((rate, idx) => ({
                                depositNumber: idx + 1,
                                percentage: rate,
                                amountUSD: (data.totalAmount * rate / 100),
                                paid: false,
                                paidDate: null,
                                exchangeRate: null,
                                amountJPY: null
                            }));
                        }
                    }
                    
                    // nextSerialã‚’æ›´æ–°
                    if (data.serial) {
                        const serialNum = getSerialNumber(data.serial);
                        if (serialNum >= nextSerial) {
                            nextSerial = serialNum + 1;
                        }
                    }
                    
                    return data;
                });

                lastUpdated = new Date();
                showStatus('åŒæœŸå®Œäº†');
                setTimeout(() => showStatus(''), 2000);
                renderMain();
                
                // ãƒ•ã‚©ãƒ«ãƒ€URLã‚’éåŒæœŸã§å–å¾—
                loadFolderUrls();
            } catch (err) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        async function saveData() {
            if (!accessToken) return;
            try {
                showStatus('ä¿å­˜ä¸­...');
                
                const supplierData = [
                    ['ID', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å', 'ãƒ‡ãƒã‚¸ãƒƒãƒˆå›æ•°', 'ãƒ‡ãƒã‚¸ãƒƒãƒˆç‡'],
                    ...suppliers.map(s => [s.id, s.name, s.depositCount, JSON.stringify(s.depositRates)])
                ];
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A1',
                    valueInputOption: 'RAW',
                    resource: { values: supplierData }
                });

                const projectData = [
                    ['ID', 'æ¡ˆä»¶ç•ªå·', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ID', 'è£½å“å', 'ç·é¡USD', 'ãƒ‡ãƒã‚¸ãƒƒãƒˆäºˆå®š', 'Serial', 'æ•°é‡', 'WorkingDays', 'é›†è·äºˆå®šæ—¥'],
                    ...projects.map(p => [p.id, p.projectNumber, p.supplierId, p.productName, p.totalAmount, JSON.stringify(p.depositSchedule), p.serial || '', p.quantity || 1, p.workingDays || 30, p.pickupDate || ''])
                ];
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A1',
                    valueInputOption: 'RAW',
                    resource: { values: projectData }
                });

                showStatus('ä¿å­˜å®Œäº†');
                setTimeout(() => showStatus(''), 2000);
            } catch (err) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        function addSupplier(name, depositCount, depositRates) {
            suppliers.push({ id: Date.now(), name, depositCount, depositRates });
            saveData();
        }

        async function addProject(projectNumber, supplierId, productName, totalAmount, quantity, workingDays, category) {
            const supplier = suppliers.find(s => s.id === parseInt(supplierId));
            const depositSchedule = supplier ? supplier.depositRates.map((rate, idx) => ({
                depositNumber: idx + 1,
                percentage: rate,
                amountUSD: (parseFloat(totalAmount) * rate / 100),
                paid: false,
                paidDate: null,
                exchangeRate: null,
                amountJPY: null
            })) : [];
            
            const serial = generateSerial(quantity);
            
            // æ¡ˆä»¶ç™»éŒ²æ—¥ã‹ã‚‰é›†è·äºˆå®šæ—¥ã‚’è¨ˆç®—
            const today = new Date();
            const pickupDate = addWorkingDays(today, workingDays);
            const pickupDateStr = pickupDate.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            
            projects.push({
                id: Date.now(),
                projectNumber,
                supplierId: parseInt(supplierId),
                productName,
                totalAmount: parseFloat(totalAmount),
                depositSchedule: depositSchedule,
                serial: serial,
                quantity: quantity,
                workingDays: workingDays,
                pickupDate: pickupDateStr,
                registeredDate: todayStr
            });
            saveData();

            // åœ¨åº«ã‚·ãƒ¼ãƒˆã«ã‚‚è¿½åŠ 
            if (category) {
                await addToInventory(serial, category, productName, projectNumber, todayStr, quantity);
            }
        }

        // åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã™ã‚‹é–¢æ•°
        async function addToInventory(serial, category, productName, projectNumber, orderDate, quantity) {
            try {
                // æ—¢å­˜ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let existingInventory = [];
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A2:L',
                    });
                    existingInventory = response.result.values || [];
                } catch (e) {
                    // ã‚·ãƒ¼ãƒˆãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
                    await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            requests: [{
                                addSheet: {
                                    properties: { title: 'åœ¨åº«' }
                                }
                            }]
                        }
                    });
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A1:L1',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¡ˆä»¶', 'ç™ºæ³¨æ—¥', 'å–å¾—æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«å…ˆæ¡ˆä»¶', 'å–å¾—é‡‘(ç¨è¾¼)', 'å‚™è€ƒ']]
                        }
                    });
                }

                // è¿½åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const baseSerial = serial.replace(/\(.*\)/, ''); // YS0554(1-4) â†’ YS0554
                const newRows = [];
                
                for (let i = 1; i <= quantity; i++) {
                    const itemSerial = quantity > 1 ? `${baseSerial}-${i}` : baseSerial;
                    
                    newRows.push([
                        Date.now().toString() + '-' + i,  // ID
                        itemSerial,                        // Serial
                        category,                          // ç¨®åˆ¥
                        productName,                       // è£½å“å
                        projectNumber,                     // ç™ºæ³¨æ¡ˆä»¶
                        orderDate,                         // ç™ºæ³¨æ—¥
                        '',                                // å–å¾—æ—¥ï¼ˆå…¥åº«æ™‚ã«å…¥åŠ›ï¼‰
                        'å…¥åº«å¾…ã¡',                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                        '',                                // å‡ºåº«æ—¥
                        '',                                // å‡ºåº«å…ˆæ¡ˆä»¶
                        '',                                // å–å¾—é‡‘
                        ''                                 // å‚™è€ƒ
                    ]);
                }

                // åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ 
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A:L',
                    valueInputOption: 'RAW',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: newRows
                    }
                });

            } catch (err) {
                console.error('åœ¨åº«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        function markPaymentPaid(projectId, depositNumber, paidDate, exchangeRate) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                const deposit = project.depositSchedule.find(d => d.depositNumber === depositNumber);
                if (deposit) {
                    deposit.paid = true;
                    deposit.paidDate = paidDate;
                    deposit.exchangeRate = parseFloat(exchangeRate);
                    deposit.amountJPY = deposit.amountUSD * parseFloat(exchangeRate);
                    saveData();
                }
            }
        }

        function exportCSV() {
            const headers = ['æ¡ˆä»¶ç•ªå·', 'è£½å“å', 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼', 'æ”¯æ‰•å›', 'æ”¯æ‰•äºˆå®šé¡(USD)', 'æ”¯æ‰•çŠ¶æ³', 'æ”¯æ‰•æ—¥', 'ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ', 'æ”¯æ‰•é¡(JPY)'];
            const rows = projects.flatMap(p => {
                const supplier = suppliers.find(s => s.id === p.supplierId);
                return (p.depositSchedule || []).map(dep => [
                    p.projectNumber, 
                    p.productName, 
                    supplier?.name || '', 
                    dep.depositNumber,
                    (dep.amountUSD || 0).toFixed(2),
                    dep.paid ? 'å®Œäº†' : 'æœªæ‰•',
                    dep.paidDate || '',
                    dep.exchangeRate || '',
                    dep.amountJPY || ''
                ]);
            });
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `procurement_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function showStatus(msg) {
            const el = document.getElementById('status');
            if (el) el.textContent = msg;
        }

        function formatJPY(amount) {
            return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(amount || 0);
        }

        function renderSignIn() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 flex items-center justify-center p-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
                        <h1 class="text-3xl font-bold text-slate-900 mb-2">èª¿é”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                        <p class="text-slate-600 mb-6">ãƒ‡ã‚¸ã‚¿ãƒ«ã‚µã‚¤ãƒãƒ¼ã‚¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</p>
                        <p class="text-slate-700 mb-6">Google Sheetsã¨é€£æºã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚<br>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                        <button onclick="handleAuthClick()" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Googleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
                    </div>
                </div>`;
        }

        function renderMain() {
            const fiscalStart = new Date('2025-07-01');
            const fiscalEnd = new Date('2026-06-30');
            const fiscalPayments = projects.flatMap(p => 
                (p.depositSchedule || []).filter(dep => {
                    if (!dep.paid || !dep.paidDate) return false;
                    const d = new Date(dep.paidDate);
                    return d >= fiscalStart && d <= fiscalEnd;
                }).map(dep => ({ ...dep, project: p }))
            );
            const totalJPY = fiscalPayments.reduce((sum, p) => sum + (p.amountJPY || 0), 0);

            // å‰æœŸã®è¨ˆç®—
            const prevFiscalStart = new Date('2024-07-01');
            const prevFiscalEnd = new Date('2025-06-30');
            const prevFiscalPayments = projects.flatMap(p => 
                (p.depositSchedule || []).filter(dep => {
                    if (!dep.paid || !dep.paidDate) return false;
                    const d = new Date(dep.paidDate);
                    return d >= prevFiscalStart && d <= prevFiscalEnd;
                }).map(dep => ({ ...dep, project: p }))
            );
            const prevTotalJPY = prevFiscalPayments.reduce((sum, p) => sum + (p.amountJPY || 0), 0);

            const lastUpdatedText = lastUpdated ? lastUpdated.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) : '-';
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆè¨ˆç®—
            const pendingPayments = projects.filter(p => (p.depositSchedule || []).some(d => !d.paid)).length;
            const upcomingPickups = projects.filter(p => {
                if (!p.pickupDate) return false;
                const pickup = new Date(p.pickupDate);
                const today = new Date();
                const diff = (pickup - today) / (1000 * 60 * 60 * 24);
                return diff >= 0 && diff <= 7;
            }).length;
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
                    <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="max-w-7xl mx-auto px-3 sm:px-6 py-3 sm:py-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">èª¿é”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                                    <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">ãƒ‡ã‚¸ã‚¿ãƒ«ã‚µã‚¤ãƒãƒ¼ã‚¸</p>
                                </div>
                                <div class="flex items-center gap-1 sm:gap-3">
                                    <span id="status" class="text-xs sm:text-sm text-blue-600 dark:text-blue-400 hidden sm:inline"></span>
                                    <button onclick="toggleDarkMode()" class="p-1.5 sm:p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
                                        ${isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                                    </button>
                                    <div class="relative">
                                        <button onclick="toggleToolsMenu()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-purple-600 text-white text-xs sm:text-sm rounded-lg hover:bg-purple-700">
                                            <span class="hidden sm:inline">ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«</span>
                                            <span class="sm:hidden">ğŸ› ï¸</span>
                                        </button>
                                        <div id="toolsMenu" class="hidden absolute right-0 mt-2 w-52 bg-white dark:bg-slate-800 rounded-lg shadow-lg border dark:border-slate-700 z-50">
                                            <button onclick="showSupplierSummary()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white rounded-t-lg">ğŸ“Š ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ</button>
                                            <button onclick="showExchangeSimulator()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white">ğŸ’± ç‚ºæ›¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                                            <button onclick="exportCSV()" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-white rounded-b-lg">ğŸ“¥ CSVå‡ºåŠ›</button>
                                        </div>
                                    </div>
                                    <a href="inventory.html" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-teal-600 text-white text-xs sm:text-sm rounded-lg hover:bg-teal-700">åœ¨åº«</a>
                                    <button onclick="handleSignoutClick()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-600 text-white text-xs sm:text-sm rounded-lg hover:bg-slate-700">
                                        <span class="hidden sm:inline">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</span>
                                        <span class="sm:hidden">â†ª</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mt-2 text-xs text-slate-500 dark:text-slate-400">
                                <span>æœ€çµ‚æ›´æ–°: ${lastUpdatedText}</span>
                                <button onclick="loadData()" class="flex items-center gap-1 hover:text-blue-600 dark:hover:text-blue-400">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    æ›´æ–°
                                </button>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-7xl mx-auto px-3 sm:px-6 py-4 sm:py-8">
                        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
                        ${(pendingPayments > 0 || upcomingPickups > 0) ? `
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${pendingPayments > 0 ? `
                                    <span class="flex items-center gap-1 px-3 py-1.5 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 text-xs sm:text-sm rounded-lg border border-amber-300 dark:border-amber-700">
                                        ğŸ’° æ”¯æ‰•å¾…ã¡ ${pendingPayments}ä»¶
                                    </span>
                                ` : ''}
                                ${upcomingPickups > 0 ? `
                                    <span class="flex items-center gap-1 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs sm:text-sm rounded-lg border border-blue-300 dark:border-blue-700">
                                        ğŸšš é›†è·äºˆå®šï¼ˆ7æ—¥ä»¥å†…ï¼‰ ${upcomingPickups}ä»¶
                                    </span>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-6 mb-4 sm:mb-8">
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm border dark:border-slate-700">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm mb-1 sm:mb-2">ä»ŠæœŸæ”¯æ‰•</p>
                                <p class="text-base sm:text-2xl font-bold text-slate-900 dark:text-white">${formatJPY(totalJPY)}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 hidden sm:block">2025/07 - 2026/06</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm border dark:border-slate-700">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm mb-1 sm:mb-2">å‰æœŸæ”¯æ‰•</p>
                                <p class="text-base sm:text-2xl font-bold text-slate-500 dark:text-slate-300">${formatJPY(prevTotalJPY)}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 hidden sm:block">2024/07 - 2025/06</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm border dark:border-slate-700">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm mb-1 sm:mb-2">æ¡ˆä»¶æ•°</p>
                                <p class="text-xl sm:text-3xl font-bold text-slate-900 dark:text-white">${projects.length}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm border dark:border-slate-700">
                                <p class="text-slate-600 dark:text-slate-400 text-xs sm:text-sm mb-1 sm:mb-2">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</p>
                                <p class="text-xl sm:text-3xl font-bold text-slate-900 dark:text-white">${suppliers.length}</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-4 sm:p-6 shadow-sm border dark:border-slate-700 mb-4 sm:mb-8">
                            <button onclick="toggleSupplierSection()" class="w-full flex justify-between items-center text-left">
                                <h2 class="text-base sm:text-xl font-bold text-slate-900 dark:text-white">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ç®¡ç†</h2>
                                <span class="text-slate-400">${showSupplierSection ? 'â–¼' : 'â–¶'}</span>
                            </button>
                            ${showSupplierSection ? `
                                <div class="mt-3 sm:mt-4">
                                    <button onclick="showAddSupplierForm()" class="mb-3 sm:mb-4 px-3 sm:px-4 py-1.5 sm:py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">+ è¿½åŠ </button>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                        ${suppliers.map(s => `
                                            <div class="p-3 sm:p-4 border dark:border-slate-600 rounded-lg hover:border-blue-300 transition-colors">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div class="flex-1">
                                                        <h3 class="font-bold text-sm sm:text-lg dark:text-white">${s.name}</h3>
                                                        <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400">ãƒ‡ãƒã‚¸ãƒƒãƒˆ: ${s.depositCount}å›</p>
                                                        <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400">å‰²åˆ: ${s.depositRates.join('%, ')}%</p>
                                                    </div>
                                                    <div class="flex gap-1 sm:gap-2">
                                                        <button onclick="editSupplier(${s.id})" class="px-2 sm:px-3 py-1 bg-blue-600 text-white text-xs sm:text-sm rounded hover:bg-blue-700" title="ç·¨é›†">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                        </button>
                                                        <button onclick="deleteSupplier(${s.id})" class="px-2 sm:px-3 py-1 bg-red-600 text-white text-xs sm:text-sm rounded hover:bg-red-700" title="å‰Šé™¤">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">${suppliers.length}ä»¶ã®ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</p>
                            `}
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl p-4 sm:p-6 shadow-sm border dark:border-slate-700">
                            <h2 class="text-base sm:text-xl font-bold text-slate-900 dark:text-white mb-3 sm:mb-4">æ¡ˆä»¶ç®¡ç†</h2>
                            <button onclick="showAddProjectForm()" class="mb-3 sm:mb-4 px-3 sm:px-4 py-1.5 sm:py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">+ æ–°è¦æ¡ˆä»¶</button>
                            <div class="space-y-3 sm:space-y-4">
                                ${projects.map(p => {
                                    const supplier = suppliers.find(s => s.id === p.supplierId);
                                    const paidCount = (p.depositSchedule || []).filter(d => d.paid).length;
                                    const totalPaid = (p.depositSchedule || []).filter(d => d.paid).reduce((sum, d) => sum + (d.amountJPY || 0), 0);
                                    const nextPayment = (p.depositSchedule || []).find(d => !d.paid);
                                    const allPaid = paidCount === (p.depositSchedule || []).length && paidCount > 0;
                                    const unitPrice = allPaid && (p.quantity || 1) > 0 ? Math.round(totalPaid / (p.quantity || 1)) : null;
                                    
                                    // é›†è·äºˆå®šæ—¥ã‚’è¡¨ç¤º
                                    const pickupDateDisplay = p.pickupDate ? p.pickupDate.replace(/-/g, '/') : 'æœªè¨­å®š';
                                    const isExpanded = expandedProjects[p.id];
                                    
                                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•åˆ¤å®š
                                    const projectStatus = getProjectStatus(p);
                                    
                                    return `<div class="border-2 rounded-lg ${nextPayment ? 'border-amber-300 bg-amber-50 dark:bg-amber-900/30 dark:border-amber-600' : 'border-green-300 bg-green-50 dark:bg-green-900/30 dark:border-green-600'}">
                                        <div class="p-3 sm:p-5 cursor-pointer" onclick="toggleProject(${p.id})">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <span class="text-slate-400">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                                                        <h3 class="font-bold text-base sm:text-xl text-slate-900">${p.projectNumber}</h3>
                                                        <span class="px-2 py-0.5 text-xs rounded-full ${projectStatus.color}">${projectStatus.icon} ${projectStatus.status}</span>
                                                        <button onclick="event.stopPropagation();editProjectDetails(${p.id})" class="p-1 text-slate-400 hover:text-blue-600" title="ç·¨é›†">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                        </button>
                                                        <button onclick="event.stopPropagation();showTemplateModal(${p.id})" class="p-1 text-slate-400 hover:text-purple-600" title="è¤‡è£½">
                                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                                        </button>
                                                        ${folderCache[p.projectNumber] ? `
                                                            <a href="${folderCache[p.projectNumber]}" target="_blank" onclick="event.stopPropagation()" class="text-blue-600 hover:text-blue-800" title="Driveã‚’é–‹ã">
                                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2z"/></svg>
                                                            </a>
                                                        ` : `
                                                            <span class="text-slate-300" title="ãƒ•ã‚©ãƒ«ãƒ€æœªæ¤œå‡º">
                                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2z"/></svg>
                                                            </span>
                                                        `}
                                                    </div>
                                                    <p class="text-xs sm:text-sm text-slate-700 ml-6">${p.productName}</p>
                                                    ${!isExpanded ? `
                                                        <p class="text-xs text-slate-500 ml-6">${supplier?.name || ''} / $${(p.totalAmount || 0).toLocaleString()} / é›†è·: ${pickupDateDisplay}</p>
                                                    ` : ''}
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-sm sm:text-lg font-bold text-slate-900">${formatJPY(totalPaid)}</p>
                                                    <p class="text-xs sm:text-sm ${paidCount === (p.depositSchedule || []).length ? 'text-green-600 font-semibold' : 'text-amber-600 font-semibold'}">
                                                        ${paidCount}/${(p.depositSchedule || []).length}å›
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        ${isExpanded ? `
                                            <div class="px-3 sm:px-5 pb-3 sm:pb-5 border-t border-slate-200">
                                                <div class="pt-3 sm:pt-4 mb-3 sm:mb-4">
                                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs sm:text-sm text-slate-600 mb-2">
                                                        <span>ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼: ${supplier?.name || 'Unknown'}</span>
                                                        <span>ç·é¡: $${(p.totalAmount || 0).toLocaleString()}</span>
                                                        <span>æ•°é‡: ${p.quantity || 1}</span>
                                                    </div>
                                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs sm:text-sm text-slate-600">
                                                        <span>Serial: <span class="font-mono font-semibold">${p.serial || 'æœªè¨­å®š'}</span></span>
                                                        <span>é›†è·: <span class="font-semibold text-blue-600">${pickupDateDisplay}</span></span>
                                                        ${unitPrice ? `<span class="text-green-600 font-semibold">å˜ä¾¡: ${formatJPY(unitPrice)}</span>` : ''}
                                                    </div>
                                                    <button onclick="event.stopPropagation();copyInvoiceText(${p.id})" class="mt-2 px-2 sm:px-3 py-1 bg-purple-600 text-white text-xs sm:text-sm rounded hover:bg-purple-700 inline-flex items-center gap-1" title="ã‚³ãƒ”ãƒ¼">
                                                        <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                                        ã‚³ãƒ”ãƒ¼
                                                    </button>
                                                </div>
                                                
                                                ${nextPayment ? `
                                                    <div class="bg-white border-2 border-amber-400 rounded-lg p-3 sm:p-4 mb-3">
                                                        <p class="text-xs sm:text-sm font-semibold text-amber-700 mb-2">ğŸ“‹ æ¬¡å›æ”¯æ‰•äºˆå®š</p>
                                                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
                                                            <div>
                                                                <p class="font-bold text-sm sm:text-lg text-slate-900">ç¬¬${nextPayment.depositNumber}å›: $${(nextPayment.amountUSD || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                                                <p class="text-xs sm:text-sm text-slate-600">(${nextPayment.percentage}%)</p>
                                                            </div>
                                                            <button onclick="event.stopPropagation();markPaymentComplete(${p.id}, ${nextPayment.depositNumber})" class="px-3 sm:px-4 py-1.5 sm:py-2 bg-emerald-600 text-white text-xs sm:text-sm font-semibold rounded-lg hover:bg-emerald-700">
                                                                æ”¯æ‰•å®Œäº†
                                                            </button>
                                                        </div>
                                                    </div>
                                                ` : `
                                                    <div class="bg-white border-2 border-green-400 rounded-lg p-3 sm:p-4 mb-3">
                                                        <p class="text-green-700 text-xs sm:text-sm font-semibold text-center">âœ“ ã™ã¹ã¦ã®æ”¯æ‰•ã„ãŒå®Œäº†</p>
                                                        ${unitPrice ? `<p class="text-green-600 text-xs sm:text-sm text-center mt-1">å˜ä¾¡: ${formatJPY(unitPrice)}</p>` : ''}
                                                    </div>
                                                `}
                                                
                                                <div class="bg-slate-50 rounded-lg p-3 sm:p-4">
                                                    <p class="text-xs sm:text-sm font-semibold text-slate-700 mb-2 sm:mb-3">æ”¯æ‰•å±¥æ­´</p>
                                                    <div class="space-y-2">
                                                        ${(p.depositSchedule || []).map(dep => `
                                                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center p-2 sm:p-3 ${dep.paid ? 'bg-green-100 border border-green-300' : 'bg-white border border-slate-200'} rounded">
                                                                <div class="flex-1">
                                                                    <span class="font-semibold text-xs sm:text-sm text-slate-900">ç¬¬${dep.depositNumber}å›</span>
                                                                    <span class="text-xs sm:text-sm text-slate-600 ml-2 sm:ml-3">$${(dep.amountUSD || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${dep.percentage}%)</span>
                                                                    ${dep.paid ? `
                                                                        <div class="text-xs text-slate-600 mt-1">
                                                                            ${dep.paidDate} | Â¥${dep.exchangeRate} | ${formatJPY(dep.amountJPY)}
                                                                        </div>
                                                                    ` : ''}
                                                                </div>
                                                                <span class="px-2 sm:px-3 py-0.5 sm:py-1 rounded text-xs sm:text-sm font-semibold ${dep.paid ? 'bg-green-600 text-white' : 'bg-slate-300 text-slate-600'}">
                                                                    ${dep.paid ? 'å®Œäº†' : 'æœªæ‰•'}
                                                                </span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </main>
                </div>`;
        }

        async function getExchangeRate(date) {
            try {
                // Frankfurter APIã§éå»æ—¥ã®ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
                const dateStr = new Date(date).toISOString().split('T')[0];
                const response = await fetch(`https://api.frankfurter.app/${dateStr}?from=USD&to=JPY`);
                const data = await response.json();
                return data.rates.JPY;
            } catch (error) {
                console.error('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€æ–°ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
                try {
                    const fallbackResponse = await fetch('https://api.frankfurter.app/latest?from=USD&to=JPY');
                    const fallbackData = await fallbackResponse.json();
                    return fallbackData.rates.JPY;
                } catch (e) {
                    return null;
                }
            }
        }

        async function markPaymentComplete(projectId, depositNumber) {
            const paidDate = prompt('æ”¯æ‰•æ—¥ (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!paidDate) return;
            
            showStatus('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—ä¸­...');
            const autoRate = await getExchangeRate(paidDate);
            
            let exchangeRate;
            if (autoRate) {
                const useAutoRate = confirm(`${paidDate}ã®ãƒ¬ãƒ¼ãƒˆ: Â¥${autoRate.toFixed(2)}\n\nã“ã®ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨æ‰‹å‹•å…¥åŠ›ã«ãªã‚Šã¾ã™ï¼‰`);
                if (useAutoRate) {
                    exchangeRate = autoRate;
                } else {
                    exchangeRate = parseFloat(prompt('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ (JPY/USD):', autoRate.toFixed(2)));
                }
            } else {
                exchangeRate = parseFloat(prompt('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ (JPY/USD):'));
            }
            
            if (!exchangeRate) return;
            
            markPaymentPaid(projectId, depositNumber, exchangeRate);
            renderMain();
        }

        function toggleSupplierSection() {
            showSupplierSection = !showSupplierSection;
            renderMain();
        }

        function toggleProject(projectId) {
            expandedProjects[projectId] = !expandedProjects[projectId];
            renderMain();
        }

        function editSupplier(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            
            const name = prompt('ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å:', supplier.name);
            if (!name) return;
            
            const count = parseInt(prompt('ãƒ‡ãƒã‚¸ãƒƒãƒˆå›æ•°:', supplier.depositCount));
            if (!count || count < 1) return;
            
            const rates = [];
            let total = 0;
            
            for (let i = 0; i < count; i++) {
                const defaultRate = supplier.depositRates[i] || '';
                const rate = parseFloat(prompt(`ç¬¬${i + 1}å›ç›®ã®ãƒ‡ãƒã‚¸ãƒƒãƒˆå‰²åˆ (%):\næ®‹ã‚Š: ${100 - total}%`, defaultRate));
                if (rate === null || rate === '' || isNaN(rate)) {
                    alert('å…¥åŠ›ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                    return;
                }
                rates.push(rate);
                total += rate;
            }
            
            if (Math.abs(total - 100) > 0.01) {
                alert(`ã‚¨ãƒ©ãƒ¼: åˆè¨ˆãŒ${total}%ã§ã™ã€‚100%ã«ãªã‚‹ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            supplier.name = name;
            supplier.depositCount = count;
            supplier.depositRates = rates;
            
            // é–¢é€£ã™ã‚‹æ¡ˆä»¶ã®ãƒ‡ãƒã‚¸ãƒƒãƒˆäºˆå®šã‚’æ›´æ–°
            projects.forEach(p => {
                if (p.supplierId === supplierId) {
                    p.depositSchedule = rates.map((rate, idx) => {
                        const existingDeposit = p.depositSchedule[idx];
                        return {
                            depositNumber: idx + 1,
                            percentage: rate,
                            amountUSD: (p.totalAmount * rate / 100),
                            paid: existingDeposit ? existingDeposit.paid : false,
                            paidDate: existingDeposit ? existingDeposit.paidDate : null,
                            exchangeRate: existingDeposit ? existingDeposit.exchangeRate : null,
                            amountJPY: existingDeposit && existingDeposit.paid ? 
                                (p.totalAmount * rate / 100) * existingDeposit.exchangeRate : null
                        };
                    });
                }
            });
            
            saveData();
            renderMain();
        }

        function deleteSupplier(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            
            // é–¢é€£ã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚‹ã‹ç¢ºèª
            const relatedProjects = projects.filter(p => p.supplierId === supplierId);
            if (relatedProjects.length > 0) {
                alert(`ã‚¨ãƒ©ãƒ¼: ã“ã®ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã«ã¯${relatedProjects.length}ä»¶ã®æ¡ˆä»¶ãŒç´ä»˜ã„ã¦ã„ã¾ã™ã€‚\nå…ˆã«æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            if (!confirm(`ã€Œ${supplier.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            
            suppliers = suppliers.filter(s => s.id !== supplierId);
            saveData();
            renderMain();
        }

        // åœ¨åº«ã«é€ã‚‹æ©Ÿèƒ½
        async function sendToInventory(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            // ç¨®åˆ¥ã‚’é¸æŠ
            const categories = [
                'ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤',
                'å±‹å¤–',
                'å±‹å†…',
                'é›»å­é»’æ¿',
                'ãƒãƒˆãƒªã‚¯ã‚¹',
                'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼',
                'ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·',
                'å‘¨è¾ºæ©Ÿå™¨'
            ];

            const categoryIndex = prompt(
                `ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆç•ªå·å…¥åŠ›ï¼‰:\n\n` +
                categories.map((c, i) => `${i + 1}. ${c}`).join('\n') +
                `\n\næ¡ˆä»¶: ${project.projectNumber}\nè£½å“: ${project.productName}\næ•°é‡: ${project.quantity || 1}å°`
            );
            
            if (!categoryIndex) return;
            const category = categories[parseInt(categoryIndex) - 1];
            if (!category) {
                alert('æ­£ã—ã„ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const quantity = project.quantity || 1;
            const serial = project.serial || '';
            
            if (!serial) {
                alert('SerialãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ¡ˆä»¶ã‚’ç·¨é›†ã—ã¦Serialã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ 
            try {
                showStatus('åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ ä¸­...');

                // æ—¢å­˜ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let existingInventory = [];
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A2:L',
                    });
                    existingInventory = response.result.values || [];
                } catch (e) {
                    // ã‚·ãƒ¼ãƒˆãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
                    await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            requests: [{
                                addSheet: {
                                    properties: { title: 'åœ¨åº«' }
                                }
                            }]
                        }
                    });
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«!A1:L1',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['ID', 'Serial', 'ç¨®åˆ¥', 'è£½å“å', 'ç™ºæ³¨æ¡ˆä»¶', 'ç™ºæ³¨æ—¥', 'å–å¾—æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡ºåº«æ—¥', 'å‡ºåº«å…ˆæ¡ˆä»¶', 'å–å¾—é‡‘(ç¨è¾¼)', 'å‚™è€ƒ']]
                        }
                    });
                }

                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const existingSerials = existingInventory.map(row => row[1]);
                const baseSerial = serial.replace(/\(.*\)/, ''); // YS0554(1-4) â†’ YS0554
                
                // è¿½åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const newRows = [];
                const today = new Date().toISOString().split('T')[0];
                
                for (let i = 1; i <= quantity; i++) {
                    const itemSerial = quantity > 1 ? `${baseSerial}-${i}` : baseSerial;
                    
                    // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (existingSerials.includes(itemSerial)) {
                        continue; // ã‚¹ã‚­ãƒƒãƒ—
                    }
                    
                    newRows.push([
                        Date.now().toString() + '-' + i,  // ID
                        itemSerial,                        // Serial
                        category,                          // ç¨®åˆ¥
                        project.productName,               // è£½å“å
                        project.projectNumber,             // ç™ºæ³¨æ¡ˆä»¶
                        today,                             // ç™ºæ³¨æ—¥
                        '',                                // å–å¾—æ—¥ï¼ˆå…¥åº«æ™‚ã«å…¥åŠ›ï¼‰
                        'å…¥åº«å¾…ã¡',                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                        '',                                // å‡ºåº«æ—¥
                        '',                                // å‡ºåº«å…ˆæ¡ˆä»¶
                        '',                                // å–å¾—é‡‘
                        ''                                 // å‚™è€ƒ
                    ]);
                }

                if (newRows.length === 0) {
                    alert('ã™ã¹ã¦ã®SerialãŒæ—¢ã«åœ¨åº«ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                    showStatus('');
                    return;
                }

                // åœ¨åº«ã‚·ãƒ¼ãƒˆã«è¿½åŠ 
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A:L',
                    valueInputOption: 'RAW',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: newRows
                    }
                });

                showStatus('');
                alert(`åœ¨åº«ã«${newRows.length}ä»¶è¿½åŠ ã—ã¾ã—ãŸï¼\n\nåœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã€Œå…¥åº«ã€å‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`);
                
            } catch (err) {
                console.error('åœ¨åº«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('');
                alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        function showAddSupplierForm() {
            const name = prompt('ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼å:');
            if (!name) return;
            const count = parseInt(prompt('ãƒ‡ãƒã‚¸ãƒƒãƒˆå›æ•°:', '2'));
            if (!count || count < 1) return;
            
            const rates = [];
            let total = 0;
            
            for (let i = 0; i < count; i++) {
                const rate = parseFloat(prompt(`ç¬¬${i + 1}å›ç›®ã®ãƒ‡ãƒã‚¸ãƒƒãƒˆå‰²åˆ (%):\næ®‹ã‚Š: ${100 - total}%`, ''));
                if (rate === null || rate === '' || isNaN(rate)) {
                    alert('å…¥åŠ›ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                    return;
                }
                rates.push(rate);
                total += rate;
            }
            
            if (Math.abs(total - 100) > 0.01) {
                alert(`ã‚¨ãƒ©ãƒ¼: åˆè¨ˆãŒ${total}%ã§ã™ã€‚100%ã«ãªã‚‹ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            addSupplier(name, count, rates);
            renderMain();
        }

        function showAddProjectForm() {
            if (suppliers.length === 0) {
                alert('å…ˆã«ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
            const modal = document.createElement('div');
            modal.id = 'projectModal';
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
                    <div style="background:white;padding:24px;border-radius:12px;width:450px;max-width:90%;max-height:90vh;overflow-y:auto;">
                        <h3 style="font-size:18px;font-weight:bold;margin-bottom:16px;">æ–°è¦æ¡ˆä»¶ç™»éŒ²</h3>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">æ¡ˆä»¶ç•ªå·</label>
                            <input type="text" id="modalProjectNumber" placeholder="ä¾‹: AD-0001" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</label>
                            <select id="modalSupplierId" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                                ${suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">è£½å“å</label>
                            <input type="text" id="modalProductName" placeholder="è£½å“åã‚’å…¥åŠ›" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">ç·é¡ (USD)</label>
                            <input type="number" id="modalTotalAmount" placeholder="ä¾‹: 10000" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">æ•°é‡ï¼ˆæç•ªç”¨ï¼‰</label>
                            <input type="number" id="modalQuantity" value="1" min="1" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                            <p style="font-size:12px;color:#666;margin-top:4px;">1ã®å ´åˆ: YS0554ã€4ã®å ´åˆ: YS0554(1-4)</p>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">Working Daysï¼ˆå–¶æ¥­æ—¥æ•°ï¼‰</label>
                            <input type="number" id="modalWorkingDays" value="30" min="1" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                            <p style="font-size:12px;color:#666;margin-top:4px;">ç™»éŒ²æ—¥ã‹ã‚‰é›†è·äºˆå®šæ—¥ã¾ã§ã®å–¶æ¥­æ—¥æ•°</p>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">ç¨®åˆ¥ï¼ˆåœ¨åº«ç®¡ç†ç”¨ï¼‰</label>
                            <select id="modalCategory" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤">ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</option>
                                <option value="å±‹å¤–">å±‹å¤–</option>
                                <option value="å±‹å†…">å±‹å†…</option>
                                <option value="é›»å­é»’æ¿">é›»å­é»’æ¿</option>
                                <option value="ãƒãƒˆãƒªã‚¯ã‚¹">ãƒãƒˆãƒªã‚¯ã‚¹</option>
                                <option value="ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼">ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼</option>
                                <option value="ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·">ã‚¹ã‚¿ãƒ³ãƒ‰/é‡‘å…·</option>
                                <option value="å‘¨è¾ºæ©Ÿå™¨">å‘¨è¾ºæ©Ÿå™¨</option>
                            </select>
                            <p style="font-size:12px;color:#666;margin-top:4px;">é¸æŠã™ã‚‹ã¨åœ¨åº«ã‚·ãƒ¼ãƒˆã«è‡ªå‹•è¿½åŠ ã•ã‚Œã¾ã™</p>
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end;">
                            <button onclick="closeProjectModal()" style="padding:8px 16px;border:1px solid #ccc;border-radius:6px;background:white;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitProjectForm()" style="padding:8px 16px;border:none;border-radius:6px;background:#2563eb;color:white;cursor:pointer;">ç™»éŒ²</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeProjectModal() {
            const modal = document.getElementById('projectModal');
            if (modal) modal.remove();
        }

        async function submitProjectForm() {
            const projectNumber = document.getElementById('modalProjectNumber').value;
            const supplierId = document.getElementById('modalSupplierId').value;
            const productName = document.getElementById('modalProductName').value;
            const totalAmount = document.getElementById('modalTotalAmount').value;
            const quantity = parseInt(document.getElementById('modalQuantity').value) || 1;
            const workingDays = parseInt(document.getElementById('modalWorkingDays').value) || 30;
            const category = document.getElementById('modalCategory').value;
            
            if (!projectNumber || !supplierId || !totalAmount) {
                alert('æ¡ˆä»¶ç•ªå·ã€ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã€ç·é¡ã¯å¿…é ˆã§ã™');
                return;
            }

            if (!category) {
                alert('ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆåœ¨åº«ç®¡ç†ã«å¿…è¦ã§ã™ï¼‰');
                return;
            }
            
            showStatus('ç™»éŒ²ä¸­...');
            await addProject(projectNumber, supplierId, productName, totalAmount, quantity, workingDays, category);
            closeProjectModal();
            showStatus('');
            renderMain();
        }

        // ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        function generateInvoiceText(project) {
            const pickupDateDisplay = project.pickupDate ? project.pickupDate.replace(/-/g, '/') : 'æœªè¨­å®š';
            
            let text = `PJç•ªå·ï¼š${project.projectNumber}\n`;
            text += `Serialï¼š${project.serial || ''}\n`;
            text += `é›†è·äºˆå®šæ—¥ï¼š${pickupDateDisplay}\n\n`;
            
            project.depositSchedule.forEach(dep => {
                text += `${dep.percentage}%  $${dep.amountUSD.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            });
            
            return text.trim();
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyInvoiceText(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const text = generateInvoiceText(project);
            navigator.clipboard.writeText(text).then(() => {
                showStatus('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                setTimeout(() => showStatus(''), 2000);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // æ¡ˆä»¶ç·¨é›†ï¼ˆSerialã€æ•°é‡ã€WorkingDaysã€é›†è·äºˆå®šæ—¥ï¼‰
        function editProjectDetails(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const modal = document.createElement('div');
            modal.id = 'editProjectModal';
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
                    <div style="background:white;padding:24px;border-radius:12px;width:400px;max-width:90%;">
                        <h3 style="font-size:18px;font-weight:bold;margin-bottom:16px;">æ¡ˆä»¶è©³ç´°ç·¨é›† - ${project.projectNumber}</h3>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">Serial</label>
                            <input type="text" id="editSerial" value="${project.serial || ''}" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">æ•°é‡ï¼ˆæç•ªç”¨ï¼‰</label>
                            <input type="number" id="editQuantity" value="${project.quantity || 1}" min="1" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">Working Days</label>
                            <input type="number" id="editWorkingDays" value="${project.workingDays || 30}" min="1" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:14px;margin-bottom:4px;">é›†è·äºˆå®šæ—¥</label>
                            <input type="date" id="editPickupDate" value="${project.pickupDate || ''}" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end;">
                            <button onclick="closeEditProjectModal()" style="padding:8px 16px;border:1px solid #ccc;border-radius:6px;background:white;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitEditProject(${projectId})" style="padding:8px 16px;border:none;border-radius:6px;background:#2563eb;color:white;cursor:pointer;">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeEditProjectModal() {
            const modal = document.getElementById('editProjectModal');
            if (modal) modal.remove();
        }

        function submitEditProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            project.serial = document.getElementById('editSerial').value;
            project.quantity = parseInt(document.getElementById('editQuantity').value) || 1;
            project.workingDays = parseInt(document.getElementById('editWorkingDays').value) || 30;
            project.pickupDate = document.getElementById('editPickupDate').value;
            
            saveData();
            closeEditProjectModal();
            renderMain();
        }

        // ==================== æ–°æ©Ÿèƒ½ ====================

        // ãƒ„ãƒ¼ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
        function toggleToolsMenu() {
            const menu = document.getElementById('toolsMenu');
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeToolsMenuOnClickOutside);
                }, 0);
            }
        }

        function closeToolsMenuOnClickOutside(e) {
            const menu = document.getElementById('toolsMenu');
            if (menu && !menu.contains(e.target) && !e.target.closest('button[onclick="toggleToolsMenu()"]')) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeToolsMenuOnClickOutside);
            }
        }

        // 1. æ¡ˆä»¶ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½
        function showTemplateModal(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const modal = document.createElement('div');
            modal.id = 'templateModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ“‹ æ¡ˆä»¶ã‚’è¤‡è£½</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">ã€Œ${project.productName}ã€ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ–°ã—ã„æ¡ˆä»¶ç•ªå· <span class="text-red-500">*</span></label>
                                <input type="text" id="templateProjectNumber" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="AD-1800">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">è£½å“å</label>
                                <input type="text" id="templateProductName" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${project.productName}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">ç·é¡ï¼ˆUSDï¼‰</label>
                                <input type="number" id="templateTotalAmount" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${project.totalAmount}" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1 dark:text-slate-300">æ•°é‡</label>
                                <input type="number" id="templateQuantity" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${project.quantity || 1}" min="1">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeModal('templateModal')" class="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitTemplate(${project.id})" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">è¤‡è£½</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitTemplate(originalProjectId) {
            const original = projects.find(p => p.id === originalProjectId);
            if (!original) return;

            const projectNumber = document.getElementById('templateProjectNumber').value.trim();
            const productName = document.getElementById('templateProductName').value.trim();
            const totalAmount = document.getElementById('templateTotalAmount').value;
            const quantity = document.getElementById('templateQuantity').value;

            if (!projectNumber) {
                alert('æ¡ˆä»¶ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å…ƒã®æ¡ˆä»¶ã¨åŒã˜ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ãƒ»Working Daysã§æ–°è¦ä½œæˆ
            await addProject(projectNumber, original.supplierId, productName, totalAmount, quantity, original.workingDays || 30, null);
            
            closeModal('templateModal');
            renderMain();
        }

        // 2. ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ
        function showSupplierSummary() {
            toggleToolsMenu();

            const summaryBySupplier = {};
            
            suppliers.forEach(s => {
                summaryBySupplier[s.id] = {
                    name: s.name,
                    projectCount: 0,
                    totalUSD: 0,
                    paidUSD: 0,
                    unpaidUSD: 0,
                    paidJPY: 0
                };
            });

            projects.forEach(p => {
                const summary = summaryBySupplier[p.supplierId];
                if (!summary) return;
                
                summary.projectCount++;
                summary.totalUSD += p.totalAmount || 0;
                
                (p.depositSchedule || []).forEach(dep => {
                    if (dep.paid) {
                        summary.paidUSD += dep.amountUSD || 0;
                        summary.paidJPY += dep.amountJPY || 0;
                    } else {
                        summary.unpaidUSD += dep.amountUSD || 0;
                    }
                });
            });

            const modal = document.createElement('div');
            modal.id = 'supplierSummaryModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ“Š ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b-2 dark:border-slate-600">
                                        <th class="py-2 text-left dark:text-slate-300">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</th>
                                        <th class="py-2 text-right dark:text-slate-300">æ¡ˆä»¶æ•°</th>
                                        <th class="py-2 text-right dark:text-slate-300">ç·é¡(USD)</th>
                                        <th class="py-2 text-right dark:text-slate-300">æ”¯æ‰•æ¸ˆ(USD)</th>
                                        <th class="py-2 text-right dark:text-slate-300">æœªæ‰•(USD)</th>
                                        <th class="py-2 text-right dark:text-slate-300">æ”¯æ‰•æ¸ˆ(JPY)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.values(summaryBySupplier).filter(s => s.projectCount > 0).map(s => `
                                        <tr class="border-b dark:border-slate-700">
                                            <td class="py-3 font-semibold dark:text-white">${s.name}</td>
                                            <td class="py-3 text-right dark:text-white">${s.projectCount}</td>
                                            <td class="py-3 text-right dark:text-white">$${s.totalUSD.toLocaleString()}</td>
                                            <td class="py-3 text-right text-green-600">$${s.paidUSD.toLocaleString()}</td>
                                            <td class="py-3 text-right text-amber-600">$${s.unpaidUSD.toLocaleString()}</td>
                                            <td class="py-3 text-right dark:text-white">${formatJPY(s.paidJPY)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr class="border-t-2 dark:border-slate-500 font-bold">
                                        <td class="py-3 dark:text-white">åˆè¨ˆ</td>
                                        <td class="py-3 text-right dark:text-white">${Object.values(summaryBySupplier).reduce((s, v) => s + v.projectCount, 0)}</td>
                                        <td class="py-3 text-right dark:text-white">$${Object.values(summaryBySupplier).reduce((s, v) => s + v.totalUSD, 0).toLocaleString()}</td>
                                        <td class="py-3 text-right text-green-600">$${Object.values(summaryBySupplier).reduce((s, v) => s + v.paidUSD, 0).toLocaleString()}</td>
                                        <td class="py-3 text-right text-amber-600">$${Object.values(summaryBySupplier).reduce((s, v) => s + v.unpaidUSD, 0).toLocaleString()}</td>
                                        <td class="py-3 text-right dark:text-white">${formatJPY(Object.values(summaryBySupplier).reduce((s, v) => s + v.paidJPY, 0))}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button onclick="closeModal('supplierSummaryModal')" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 3. ç‚ºæ›¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function showExchangeSimulator() {
            toggleToolsMenu();

            // æœªæ‰•ã„ã®åˆè¨ˆã‚’è¨ˆç®—
            let totalUnpaidUSD = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach(dep => {
                    if (!dep.paid) {
                        totalUnpaidUSD += dep.amountUSD || 0;
                    }
                });
            });

            const modal = document.createElement('div');
            modal.id = 'exchangeSimModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">ğŸ’± ç‚ºæ›¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
                        <div class="bg-slate-100 dark:bg-slate-700 rounded-lg p-4 mb-4">
                            <p class="text-sm text-slate-600 dark:text-slate-400">æœªæ‰•ã„ç·é¡ï¼ˆUSDï¼‰</p>
                            <p class="text-2xl font-bold dark:text-white">$${totalUnpaidUSD.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2 dark:text-slate-300">ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã§è©¦ç®—</label>
                            <div class="flex gap-2">
                                <input type="number" id="simRate" class="flex-1 px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="150.00" step="0.01" value="150">
                                <span class="flex items-center text-slate-600 dark:text-slate-400">å††/USD</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <button onclick="setSimRate(140)" class="px-3 py-2 bg-slate-200 dark:bg-slate-600 rounded-lg text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥140</button>
                            <button onclick="setSimRate(145)" class="px-3 py-2 bg-slate-200 dark:bg-slate-600 rounded-lg text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥145</button>
                            <button onclick="setSimRate(150)" class="px-3 py-2 bg-slate-200 dark:bg-slate-600 rounded-lg text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥150</button>
                            <button onclick="setSimRate(155)" class="px-3 py-2 bg-slate-200 dark:bg-slate-600 rounded-lg text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥155</button>
                            <button onclick="setSimRate(160)" class="px-3 py-2 bg-slate-200 dark:bg-slate-600 rounded-lg text-sm hover:bg-slate-300 dark:hover:bg-slate-500 dark:text-white">Â¥160</button>
                            <button onclick="fetchCurrentRate()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">ç¾åœ¨</button>
                        </div>
                        <div id="simResult" class="bg-emerald-50 dark:bg-emerald-900/30 rounded-lg p-4">
                            <p class="text-sm text-emerald-700 dark:text-emerald-400">è©¦ç®—çµæœï¼ˆJPYï¼‰</p>
                            <p class="text-2xl font-bold text-emerald-700 dark:text-emerald-400" id="simResultJPY">${formatJPY(totalUnpaidUSD * 150)}</p>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button onclick="closeModal('exchangeSimModal')" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // ãƒ¬ãƒ¼ãƒˆå¤‰æ›´æ™‚ã«å†è¨ˆç®—
            document.getElementById('simRate').addEventListener('input', () => updateSimResult(totalUnpaidUSD));
        }

        function setSimRate(rate) {
            document.getElementById('simRate').value = rate;
            // æœªæ‰•ã„ç·é¡ã‚’å†è¨ˆç®—
            let totalUnpaidUSD = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach(dep => {
                    if (!dep.paid) totalUnpaidUSD += dep.amountUSD || 0;
                });
            });
            updateSimResult(totalUnpaidUSD);
        }

        async function fetchCurrentRate() {
            showStatus('ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ä¸­...');
            const rate = await getExchangeRate(new Date().toISOString().split('T')[0]);
            if (rate) {
                document.getElementById('simRate').value = rate.toFixed(2);
                let totalUnpaidUSD = 0;
                projects.forEach(p => {
                    (p.depositSchedule || []).forEach(dep => {
                        if (!dep.paid) totalUnpaidUSD += dep.amountUSD || 0;
                    });
                });
                updateSimResult(totalUnpaidUSD);
            }
            showStatus('');
        }

        function updateSimResult(totalUnpaidUSD) {
            const rate = parseFloat(document.getElementById('simRate').value) || 0;
            const jpy = totalUnpaidUSD * rate;
            document.getElementById('simResultJPY').textContent = formatJPY(jpy);
        }

        // 4. æ¡ˆä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•æ›´æ–°
        function getProjectStatus(project) {
            const deposits = project.depositSchedule || [];
            const allPaid = deposits.length > 0 && deposits.every(d => d.paid);
            const somePaid = deposits.some(d => d.paid);
            
            // é›†è·äºˆå®šæ—¥ãƒã‚§ãƒƒã‚¯
            const today = new Date();
            const pickupDate = project.pickupDate ? new Date(project.pickupDate) : null;
            const isPickupPassed = pickupDate && pickupDate < today;

            if (allPaid && isPickupPassed) {
                return { status: 'å…¥åº«å®Œäº†', color: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300', icon: 'âœ…' };
            } else if (allPaid) {
                return { status: 'é›†è·å¾…ã¡', color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300', icon: 'ğŸšš' };
            } else if (somePaid) {
                return { status: 'æ”¯æ‰•ä¸­', color: 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300', icon: 'ğŸ’°' };
            } else {
                return { status: 'æœªç€æ‰‹', color: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300', icon: 'ğŸ“' };
            }
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        window.onload = () => {
            if (typeof gapi !== 'undefined') gapiLoaded();
            if (typeof google !== 'undefined') gisLoaded();
        };
    </script>
</body>
</html>
