<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ヤマトサイネージ支払・在庫・売上管理ダッシュボード">
    <title>YS調達ナビ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%232383e2'/><stop offset='100%25' stop-color='%231a5fb4'/></linearGradient></defs><circle cx='16' cy='16' r='15' fill='url(%23g)'/><polygon points='16,4 18,14 16,16 14,14' fill='%23fff'/><polygon points='16,28 14,18 16,16 18,18' fill='%23fff' opacity='0.6'/><circle cx='16' cy='16' r='2.5' fill='%23fff'/></svg>">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="dashboard">
        <!-- ヘッダー -->
        <header class="flex items-center justify-between px-4 py-2 border-b border-def">
            <div class="flex items-center gap-2">
                <div class="w-7 h-7 rounded-lg flex items-center justify-center" style="background:var(--blue-bg)">
                    <i data-lucide="compass" class="w-4 h-4" style="color:var(--blue)"></i>
                </div>
                <span class="font-semibold">YS調達ナビ</span>
                <span class="t-sub text-xs" id="lastUpdate"></span>
            </div>
            <div class="flex items-center gap-1 text-xs">
                <a href="index.html" class="hover-bg p-1.5 sm:px-2 sm:py-1.5 t-sub flex items-center gap-1" title="支払ナビ">
                    <i data-lucide="credit-card" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">支払</span>
                </a>
                <a href="inventory.html" class="hover-bg p-1.5 sm:px-2 sm:py-1.5 t-sub flex items-center gap-1" title="在庫ナビ">
                    <i data-lucide="package" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">在庫</span>
                </a>
                <button onclick="loadData()" class="hover-bg p-1.5 t-sub" title="更新"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                <button onclick="toggleDarkMode()" class="hover-bg p-1.5 t-sub" title="ダークモード"><i data-lucide="moon" class="w-4 h-4"></i></button>
                <button onclick="signOut()" class="hover-bg p-1.5 t-sub" title="サインアウト"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </header>

        <!-- ログイン -->
        <div id="loginSection" class="flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4" style="background:var(--blue-bg)">
                    <i data-lucide="compass" class="w-8 h-8" style="color:var(--blue)"></i>
                </div>
                <p class="text-sm mb-4">Googleアカウントでログイン</p>
                <button onclick="handleAuth()" class="btn btn-primary px-5 py-2">ログイン</button>
            </div>
        </div>

        <!-- メイン -->
        <div id="mainContent" class="main-grid hidden">

            <!-- KPIバー -->
            <div class="kpi-bar" style="grid-column: 1 / -1;">
                <div class="kpi" onclick="showKpiPopover(event, 'inStock')">
                    <div class="kpi-icon" style="background:var(--blue-bg)"><i data-lucide="package" class="w-4 h-4" style="color:var(--blue)"></i></div>
                    <div class="kpi-value" id="kpiInStock">-</div>
                    <div class="kpi-label">在庫中</div>
                    <div class="kpi-sub t-sub" id="kpiInStockSub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'waiting')">
                    <div class="kpi-icon" style="background:var(--orange-bg)"><i data-lucide="truck" class="w-4 h-4" style="color:var(--orange)"></i></div>
                    <div class="kpi-value" id="kpiWaiting">-</div>
                    <div class="kpi-label">入庫待ち</div>
                    <div class="kpi-sub" style="color:var(--orange)" id="kpiWaitingSub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'unpaid')">
                    <div class="kpi-icon" style="background:var(--red-bg)"><i data-lucide="wallet" class="w-4 h-4" style="color:var(--red)"></i></div>
                    <div class="kpi-value" id="kpiUnpaid">-</div>
                    <div class="kpi-label">未払い</div>
                    <div class="kpi-sub t-sub" id="kpiUnpaidSub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'payment')">
                    <div class="kpi-icon" style="background:var(--green-bg)"><i data-lucide="credit-card" class="w-4 h-4" style="color:var(--green)"></i></div>
                    <div class="kpi-value" id="kpiThisMonth">-</div>
                    <div class="kpi-label">今月支払</div>
                    <div class="kpi-sub" id="kpiThisMonthSub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'stay')">
                    <div class="kpi-icon" style="background:var(--purple-bg)"><i data-lucide="clock" class="w-4 h-4" style="color:var(--purple)"></i></div>
                    <div class="kpi-value" id="kpiAvgStay">-</div>
                    <div class="kpi-label">平均滞留</div>
                    <div class="kpi-sub" id="kpiAvgStaySub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'turnover')">
                    <div class="kpi-icon" style="background:var(--yellow-bg)"><i data-lucide="refresh-cw" class="w-4 h-4" style="color:var(--yellow)"></i></div>
                    <div class="kpi-value" id="kpiTurnover">-</div>
                    <div class="kpi-label">回転率</div>
                    <div class="kpi-sub t-sub">回/月</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'sales')">
                    <div class="kpi-icon" style="background:var(--green-bg)"><i data-lucide="bar-chart-2" class="w-4 h-4" style="color:var(--green)"></i></div>
                    <div class="kpi-value" id="kpiSales7">-</div>
                    <div class="kpi-label">7期売上</div>
                    <div class="kpi-sub" id="kpiSales7Sub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'overdue')">
                    <div class="kpi-icon" style="background:var(--red-bg)"><i data-lucide="alert-triangle" class="w-4 h-4" style="color:var(--red)"></i></div>
                    <div class="kpi-value" id="kpiOverdue">-</div>
                    <div class="kpi-label">支払遅延</div>
                    <div class="kpi-sub" id="kpiOverdueSub">-</div>
                </div>
                <div class="kpi" style="background:var(--bg);cursor:default">
                    <div class="flex items-center gap-1 mb-2"><i data-lucide="activity" class="w-4 h-4" style="color:var(--green)"></i><span class="text-xs font-medium">ヘルス</span></div>
                    <div id="healthMini" class="text-xs space-y-1"></div>
                </div>
            </div>

            <!-- グラフ2つ（売上） -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <div class="flex items-center gap-1 mb-2">
                        <i data-lucide="trending-up" class="w-3.5 h-3.5" style="color:var(--green)"></i>
                        <span class="text-xs font-medium">売上推移（6ヶ月）</span>
                    </div>
                    <div class="h-28"><canvas id="salesChart"></canvas></div>
                </div>
                <div>
                    <div class="flex items-center gap-1 mb-2">
                        <i data-lucide="pie-chart" class="w-3.5 h-3.5" style="color:var(--purple)"></i>
                        <span class="text-xs font-medium">カテゴリ別売上</span>
                    </div>
                    <div class="h-28"><canvas id="salesCategoryChart"></canvas></div>
                </div>
            </div>

            <!-- スケジュール -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded flex items-center justify-center" style="background:var(--blue-bg)">
                            <i data-lucide="calendar" class="w-3.5 h-3.5" style="color:var(--blue)"></i>
                        </div>
                        <span class="font-medium text-sm">今週</span>
                    </div>
                    <span class="text-xs t-sub" id="weekRange"></span>
                </div>
                <div id="timeline" class="flex-1 overflow-auto text-xs space-y-1"></div>
            </div>

            <!-- 未払い一覧 -->
            <div class="flex flex-col">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-6 h-6 rounded flex items-center justify-center" style="background:var(--red-bg)">
                        <i data-lucide="wallet" class="w-3.5 h-3.5" style="color:var(--red)"></i>
                    </div>
                    <span class="font-medium text-sm">未払い一覧</span>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="mini-table">
                        <thead><tr><th>案件</th><th>金額</th><th>経過</th><th>状態</th></tr></thead>
                        <tbody id="unpaidTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- グラフ2つ -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <div class="flex items-center gap-1 mb-2">
                        <i data-lucide="bar-chart-2" class="w-3.5 h-3.5" style="color:var(--green)"></i>
                        <span class="text-xs font-medium">支払い予定（4週）</span>
                    </div>
                    <div class="h-28"><canvas id="forecastChart"></canvas></div>
                </div>
                <div>
                    <div class="flex items-center gap-1 mb-2">
                        <i data-lucide="trending-up" class="w-3.5 h-3.5" style="color:var(--purple)"></i>
                        <span class="text-xs font-medium">入出庫推移</span>
                    </div>
                    <div class="h-28"><canvas id="flowChart"></canvas></div>
                </div>
            </div>

            <!-- 滞留 & アクション -->
            <div class="flex flex-col gap-3">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-5 h-5 rounded flex items-center justify-center" style="background:var(--yellow-bg)">
                            <i data-lucide="clock" class="w-3 h-3" style="color:var(--yellow)"></i>
                        </div>
                        <span class="font-medium text-xs">長期滞留</span>
                    </div>
                    <div id="staleList" class="text-xs space-y-1 overflow-auto" style="max-height:90px"></div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-5 h-5 rounded flex items-center justify-center" style="background:var(--green-bg)">
                            <i data-lucide="zap" class="w-3 h-3" style="color:var(--green)"></i>
                        </div>
                        <span class="font-medium text-xs">クイックアクション</span>
                    </div>
                    <div id="quickActions" class="text-xs space-y-1 overflow-auto" style="max-height:90px"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- ポップオーバー -->
    <div id="popover" class="popover">
        <div class="popover-title"><i data-lucide="info" class="w-4 h-4"></i><span id="popoverTitle">-</span></div>
        <div class="popover-content" id="popoverContent"></div>
    </div>

    <!-- ナレッジボタン -->
    <div id="knowledgeBtn" class="fixed bottom-4 right-4 hidden">
        <button onclick="showKnowledgeModal()" class="flex items-center gap-2 px-3 py-2 rounded-lg shadow-lg text-sm hover:opacity-90" style="background:var(--purple);color:#fff">
            <i data-lucide="book-open" class="w-4 h-4"></i>
            <span>ナレッジ</span>
            <span class="px-1.5 py-0.5 rounded text-xs" style="background:rgba(255,255,255,0.2)" id="knowledgeCount">0</span>
        </button>
    </div>

    <!-- ナレッジモーダル -->
    <div id="knowledgeModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
        <div class="rounded-lg max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col" style="background:var(--bg)">
            <div class="p-3 flex justify-between items-center border-b border-def">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded flex items-center justify-center" style="background:var(--purple-bg)">
                        <i data-lucide="book-open" class="w-3.5 h-3.5" style="color:var(--purple)"></i>
                    </div>
                    <span class="font-medium text-sm">ナレッジ</span>
                </div>
                <button onclick="closeKnowledgeModal()" class="hover-bg p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div id="knowledgeList" class="flex-1 overflow-auto p-3 space-y-2 text-sm"></div>
            <div class="p-3 border-t border-def">
                <div class="flex gap-2">
                    <input type="text" id="newKnowledge" placeholder="新しいナレッジを追加..." class="flex-1 text-sm">
                    <button onclick="addKnowledgeEntry()" class="btn btn-primary">追加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Common JS -->
    <script src="js/common/config.js"></script>
    <script src="js/common/utils.js"></script>
    <script src="js/common/darkmode.js"></script>

    <!-- Page JS -->
    <script src="js/pages/dashboard.js"></script>

    <!-- Google Auth Inline (必要) -->
    <script>
        function handleAuth() {
            google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (r) => {
                    if (r.access_token) {
                        accessToken = r.access_token;
                        sessionStorage.setItem('googleAccessToken', accessToken);
                        gapi.client.setToken({ access_token: accessToken });
                        showMain();
                        loadData();
                    }
                }
            }).requestAccessToken();
        }
    </script>
</body>
</html>
