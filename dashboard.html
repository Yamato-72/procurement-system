<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSèª¿é”ãƒŠãƒ“ - èª¿é”ãƒ»åœ¨åº«ç®¡ç†</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%233b82f6'/><text x='50' y='65' font-size='45' text-anchor='middle' fill='white'>ğŸ§­</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');
        * { font-family: 'Noto Sans JP', sans-serif; }
        .card { @apply bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700; }
        .timeline-item { position: relative; padding-left: 24px; }
        .timeline-item::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -8px; width: 2px; background: #e2e8f0; }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; border-radius: 50%; border: 3px solid; }
        @keyframes pulse-border { 0%, 100% { border-color: rgba(59,130,246,0.5); } 50% { border-color: rgba(59,130,246,1); } }
        .ai-thinking { animation: pulse-border 1.5s ease-in-out infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .typing-cursor::after { content: 'â–‹'; animation: blink 0.8s infinite; color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen bg-slate-100 dark:bg-slate-900">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="sticky top-0 z-40 bg-white/95 dark:bg-slate-800/95 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 px-4 sm:px-6 py-3">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white">ğŸ§­ YSèª¿é”ãƒŠãƒ“</h1>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1" id="lastUpdate">èª¿é”ãƒ»åœ¨åº«ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
                </div>
                <div class="flex gap-2 items-center">
                    <a href="index.html" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">èª¿é”ç®¡ç†</a>
                    <a href="inventory.html" class="px-4 py-2 border border-blue-600 text-blue-600 dark:text-blue-400 dark:border-blue-400 text-sm rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/30">åœ¨åº«ç®¡ç†</a>
                    <button onclick="loadData()" class="px-4 py-2 bg-slate-600 text-white text-sm rounded-lg hover:bg-slate-700">ğŸ”„</button>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="p-4 sm:p-6">
            <!-- ãƒ­ã‚°ã‚¤ãƒ³å‰ -->
            <div id="loginSection" class="card p-8 text-center">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/50 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">ğŸ§­</span></div>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-2">YSèª¿é”ãƒŠãƒ“</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-6">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button onclick="handleAuth()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="mainContent" class="hidden space-y-6">
                <!-- AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ -->
                <div class="card p-4 sm:p-6 border-2 border-blue-200 dark:border-blue-800" id="aiAdvisorCard">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center"><span class="text-xl">ğŸ¤–</span></div>
                            <div>
                                <h2 class="font-bold text-slate-900 dark:text-white">AI ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400">ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦æ”¹å–„ææ¡ˆ</p>
                            </div>
                        </div>
                        <button onclick="requestAIAnalysis()" class="px-3 py-1.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-sm rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/70 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            åˆ†æã™ã‚‹
                        </button>
                    </div>
                    <div id="aiAdvice" class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4 min-h-[80px]">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">ã€Œåˆ†æã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€AIãŒãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™</p>
                    </div>
                </div>

                <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="card p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="window.location.href='inventory.html?status=åœ¨åº«ä¸­'">
                        <div class="flex items-start justify-between">
                            <div><p class="text-slate-500 dark:text-slate-400 text-sm">åœ¨åº«ä¸­</p><p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="statInStock">-</p></div>
                            <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/50 rounded-lg flex items-center justify-center"><span class="text-xl">ğŸ“¦</span></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700"><p class="text-xs text-slate-500 dark:text-slate-400" id="statInStockDetail">-</p></div>
                    </div>
                    <div class="card p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="window.location.href='inventory.html?status=å…¥åº«å¾…ã¡'">
                        <div class="flex items-start justify-between">
                            <div><p class="text-slate-500 dark:text-slate-400 text-sm">å…¥åº«å¾…ã¡</p><p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="statWaiting">-</p></div>
                            <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/50 rounded-lg flex items-center justify-center"><span class="text-xl">ğŸšš</span></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700"><p class="text-xs text-amber-600 dark:text-amber-400 font-medium" id="statWaitingDetail">-</p></div>
                    </div>
                    <div class="card p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="window.location.href='index.html'">
                        <div class="flex items-start justify-between">
                            <div><p class="text-slate-500 dark:text-slate-400 text-sm">æœªæ‰•ã„</p><p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="statUnpaid">-</p></div>
                            <div class="w-10 h-10 bg-red-100 dark:bg-red-900/50 rounded-lg flex items-center justify-center"><span class="text-xl">ğŸ’°</span></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700"><p class="text-xs text-red-600 dark:text-red-400 font-medium" id="statUnpaidDetail">-</p></div>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-start justify-between">
                            <div><p class="text-slate-500 dark:text-slate-400 text-sm">ä»Šæœˆæ”¯æ‰•ã„</p><p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="statThisMonth">-</p></div>
                            <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/50 rounded-lg flex items-center justify-center"><span class="text-xl">ğŸ“Š</span></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700"><p class="text-xs text-slate-500 dark:text-slate-400" id="statThisMonthDetail">-</p></div>
                    </div>
                </div>

                <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ & ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card p-4 sm:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2"><span>ğŸ“…</span> ä»Šé€±ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
                            <span class="text-xs text-slate-500 dark:text-slate-400" id="timelineWeek">-</span>
                        </div>
                        <div id="timeline" class="space-y-3"><p class="text-slate-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</p></div>
                    </div>
                    <div class="card p-4 sm:p-6">
                        <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-4"><span>ğŸ¥</span> ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</h3>
                        <div id="healthCheck" class="space-y-3"><p class="text-slate-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</p></div>
                    </div>
                </div>

                <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="card p-4 sm:p-6">
                    <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-4"><span>âš¡</span> ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                    <div id="quickActions" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"><p class="text-slate-400 text-sm col-span-full">èª­ã¿è¾¼ã¿ä¸­...</p></div>
                </div>

                <!-- ã‚°ãƒ©ãƒ• -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-4 sm:p-6">
                        <h3 class="font-bold text-slate-900 dark:text-white mb-4">æœˆåˆ¥å…¥å‡ºåº«æ¨ç§»</h3>
                        <div class="h-48"><canvas id="flowChart"></canvas></div>
                    </div>
                    <div class="card p-4 sm:p-6">
                        <h3 class="font-bold text-slate-900 dark:text-white mb-4">æœˆåˆ¥æ”¯æ‰•ã„é¡</h3>
                        <div class="h-48"><canvas id="paymentChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        let accessToken = null, inventory = [], archivedInventory = [], projects = [], suppliers = [], charts = {};

        function init() {
            initDarkMode();
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) { accessToken = savedToken; gapi.client.setToken({ access_token: accessToken }); showMain(); loadData(); }
            });
        }

        function handleAuth() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (r) => { if (r.access_token) { accessToken = r.access_token; sessionStorage.setItem('googleAccessToken', accessToken); gapi.client.setToken({ access_token: accessToken }); showMain(); loadData(); } }
            });
            client.requestAccessToken();
        }

        function showMain() { document.getElementById('loginSection').classList.add('hidden'); document.getElementById('mainContent').classList.remove('hidden'); }

        async function loadData() {
            if (!accessToken) return;
            try {
                const [supRes, prjRes, invRes] = await Promise.all([
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A2:C' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'æ¡ˆä»¶!A2:N' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'åœ¨åº«!A2:Q' })
                ]);
                suppliers = (supRes.result.values || []).map(r => ({ id: parseInt(r[0] || 0), name: r[1] || '', paymentPatterns: JSON.parse(r[2] || '[]') }));
                projects = (prjRes.result.values || []).map(r => ({ id: r[0], projectPrefix: r[1] || 'AD', projectNumber: parseInt(r[2]) || 0, supplierId: parseInt(r[3] || 0), productName: r[4] || '', totalAmount: parseFloat(r[5] || 0), depositSchedule: JSON.parse(r[6] || '[]'), serial: r[7] || '', quantity: parseInt(r[8] || 1), workingDays: parseInt(r[9] || 30), pickupDate: r[10] || '', registeredDate: r[11] || '', expenses: JSON.parse(r[12] || '[]'), receivedComplete: r[13] === 'true' }));
                inventory = (invRes.result.values || []).map(r => ({ id: r[0] || '', serial: r[1] || '', category: r[2] || '', productName: r[3] || '', orderPrefix: r[4] || '', orderNumber: r[5] || '', orderDate: r[6] || '', receiveDate: r[7] || '', status: r[8] || '', shipDate: r[9] || '', shipPrefix: r[10] || '', shipNumber: r[11] || '', costJPY: r[12] || '', note: r[13] || '', shelfNo: r[14] || '', location: r[15] || '', supplierId: r[16] || '' }));
                try { const arcRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A2:Q' }); archivedInventory = (arcRes.result.values || []).map(r => ({ receiveDate: r[7] || '', shipDate: r[9] || '' })); } catch(e) { archivedInventory = []; }
                updateSummary(); updateTimeline(); updateHealthCheck(); updateQuickActions(); updateCharts();
                document.getElementById('lastUpdate').textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}`;
            } catch (err) { console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err); }
        }

        function updateSummary() {
            const today = new Date(), inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­'), waiting = inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡');
            const inStockValue = inStock.reduce((s, i) => s + (parseInt(i.costJPY) || 0), 0);
            const weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);
            const arrivingThisWeek = projects.filter(p => { if (!p.pickupDate || p.receivedComplete) return false; const d = new Date(p.pickupDate); return d >= today && d <= weekEnd; });
            let unpaidTotal = 0, unpaidCount = 0, urgentCount = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach((d, idx) => { if (!d.paid) { unpaidTotal += d.amountJPY || (d.amountUSD * 150) || 0; unpaidCount++; if (idx === 0 && p.registeredDate && Math.floor((today - new Date(p.registeredDate)) / 86400000) > 30) urgentCount++; } }); });
            const thisMonth = today.toISOString().slice(0, 7); let thisMonthTotal = 0, thisMonthCount = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate && d.paidDate.startsWith(thisMonth)) { thisMonthTotal += d.amountJPY || 0; thisMonthCount++; } }); });
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1).toISOString().slice(0, 7); let lastMonthTotal = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate && d.paidDate.startsWith(lastMonth)) lastMonthTotal += d.amountJPY || 0; }); });
            const momChange = lastMonthTotal > 0 ? Math.round((thisMonthTotal - lastMonthTotal) / lastMonthTotal * 100) : 0;

            document.getElementById('statInStock').textContent = inStock.length + 'ä»¶';
            document.getElementById('statInStockDetail').textContent = `ç·é¡ Â¥${inStockValue.toLocaleString()}`;
            document.getElementById('statWaiting').textContent = waiting.length + 'ä»¶';
            document.getElementById('statWaitingDetail').textContent = arrivingThisWeek.length > 0 ? `ğŸ”¥ ä»Šé€±åˆ°ç€äºˆå®š ${arrivingThisWeek.length}ä»¶` : 'ä»Šé€±ã®åˆ°ç€äºˆå®šãªã—';
            document.getElementById('statUnpaid').textContent = `Â¥${Math.round(unpaidTotal/10000)}ä¸‡`;
            document.getElementById('statUnpaidDetail').textContent = urgentCount > 0 ? `âš ï¸ 30æ—¥è¶…é ${urgentCount}ä»¶` : `${unpaidCount}ä»¶ã®æ”¯æ‰•ã„å¾…ã¡`;
            document.getElementById('statThisMonth').textContent = `Â¥${Math.round(thisMonthTotal/10000)}ä¸‡`;
            document.getElementById('statThisMonthDetail').innerHTML = `${thisMonthCount}ä»¶ / <span class="${momChange >= 0 ? 'text-red-500' : 'text-emerald-500'}">å‰æœˆæ¯” ${momChange >= 0 ? '+' : ''}${momChange}%</span>`;
        }

        function updateTimeline() {
            const today = new Date(); today.setHours(0,0,0,0); const weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);
            const weekEndDisp = new Date(today); weekEndDisp.setDate(weekEndDisp.getDate() + 6);
            document.getElementById('timelineWeek').textContent = `${today.getMonth()+1}/${today.getDate()} - ${weekEndDisp.getMonth()+1}/${weekEndDisp.getDate()}`;
            const events = [];
            projects.forEach(p => {
                if (p.pickupDate && !p.receivedComplete) { const d = new Date(p.pickupDate); if (d >= today && d <= weekEnd) events.push({ date: d, icon: 'ğŸšš', color: 'border-amber-500 bg-amber-100 dark:bg-amber-900/50', title: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')} é›†è·`, detail: p.productName, link: `index.html?project=${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}` }); }
                if (p.registeredDate) { (p.depositSchedule || []).forEach((dep, idx) => { if (dep.paid) return; let due; if (idx === 0) { due = new Date(p.registeredDate); due.setDate(due.getDate() + 7); } else if (p.pickupDate) { due = new Date(p.pickupDate); due.setDate(due.getDate() - 7); } if (due && due >= today && due <= weekEnd) events.push({ date: due, icon: 'ğŸ’°', color: 'border-red-500 bg-red-100 dark:bg-red-900/50', title: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')} æ”¯æ‰•ã„`, detail: `${dep.percentage}% ($${(dep.amountUSD || 0).toLocaleString()})`, link: `index.html?project=${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}` }); }); }
            });
            events.sort((a, b) => a.date - b.date);
            const container = document.getElementById('timeline');
            if (events.length === 0) { container.innerHTML = '<div class="text-center py-8 text-slate-400"><span class="text-4xl">ğŸ“­</span><p class="mt-2">ä»Šé€±ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p></div>'; return; }
            const grouped = {}; events.forEach(e => { const k = e.date.toISOString().split('T')[0]; if (!grouped[k]) grouped[k] = []; grouped[k].push(e); });
            let html = '';
            Object.entries(grouped).forEach(([ds, de]) => {
                const d = new Date(ds), isToday = d.toDateString() === today.toDateString(), dn = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
                html += `<div class="timeline-item"><div class="timeline-dot ${isToday ? 'border-blue-500 bg-blue-500' : 'border-slate-300 bg-white dark:bg-slate-700'}"></div><div class="mb-1"><span class="text-sm font-semibold ${isToday ? 'text-blue-600 dark:text-blue-400' : 'text-slate-600 dark:text-slate-400'}">${d.getMonth()+1}/${d.getDate()} (${dn})${isToday ? ' <span class="ml-1 px-1.5 py-0.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs rounded">ä»Šæ—¥</span>' : ''}</span></div>`;
                de.forEach(e => { html += `<a href="${e.link}" class="block mt-2 p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><div class="flex items-center gap-2"><span class="w-6 h-6 rounded-full ${e.color} flex items-center justify-center text-sm">${e.icon}</span><span class="font-medium text-sm text-slate-900 dark:text-white">${e.title}</span></div><p class="text-xs text-slate-500 dark:text-slate-400 mt-1 ml-8">${e.detail}</p></a>`; });
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function updateHealthCheck() {
            const today = new Date(), checks = [];
            const noShelf = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && !i.shelfNo).length;
            if (noShelf > 0) checks.push({ status: 'warning', icon: 'ğŸ“', text: `æ£šç•ªæœªè¨­å®š ${noShelf}ä»¶`, link: 'inventory.html?noShelf=1' });
            const stale = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && i.receiveDate && Math.floor((today - new Date(i.receiveDate)) / 86400000) >= 60).length;
            if (stale > 0) checks.push({ status: 'warning', icon: 'â°', text: `é•·æœŸæ»ç•™(60æ—¥+) ${stale}ä»¶`, link: 'inventory.html?status=åœ¨åº«ä¸­' });
            let overdueCount = 0; projects.forEach(p => { if (p.registeredDate && (p.depositSchedule || [])[0] && !(p.depositSchedule || [])[0].paid && Math.floor((today - new Date(p.registeredDate)) / 86400000) > 30) overdueCount++; });
            if (overdueCount > 0) checks.push({ status: 'error', icon: 'ğŸš¨', text: `æ”¯æ‰•ã„30æ—¥è¶…é ${overdueCount}ä»¶`, link: 'index.html' });
            const issues = inventory.filter(i => i.status === 'ä¸å…·åˆ').length;
            if (issues > 0) checks.push({ status: 'error', icon: 'ğŸ”´', text: `ä¸å…·åˆåœ¨åº« ${issues}ä»¶`, link: 'inventory.html?status=ä¸å…·åˆ' });
            if (checks.length === 0) checks.push({ status: 'ok', icon: 'âœ…', text: 'å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ' });
            const container = document.getElementById('healthCheck');
            container.innerHTML = checks.map(c => {
                const bg = c.status === 'error' ? 'bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800' : c.status === 'warning' ? 'bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-800' : 'bg-emerald-50 dark:bg-emerald-900/30 border-emerald-200 dark:border-emerald-800';
                const tc = c.status === 'error' ? 'text-red-700 dark:text-red-300' : c.status === 'warning' ? 'text-amber-700 dark:text-amber-300' : 'text-emerald-700 dark:text-emerald-300';
                return c.link ? `<a href="${c.link}" class="block p-3 rounded-lg border ${bg} hover:opacity-80"><div class="flex items-center gap-2"><span>${c.icon}</span><span class="text-sm font-medium ${tc}">${c.text}</span></div></a>` : `<div class="p-3 rounded-lg border ${bg}"><div class="flex items-center gap-2"><span>${c.icon}</span><span class="text-sm font-medium ${tc}">${c.text}</span></div></div>`;
            }).join('');
        }

        function updateQuickActions() {
            const actions = [];
            inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').slice(0, 3).forEach(item => { actions.push({ icon: 'ğŸ“¦', title: `${item.serial} ã‚’å…¥åº«`, detail: item.productName.slice(0, 20), color: 'bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300', link: `inventory.html?search=${item.serial}` }); });
            const unpaidProjects = []; projects.forEach(p => { const u = (p.depositSchedule || []).find(d => !d.paid); if (u && p.registeredDate) unpaidProjects.push({ p, u, d: new Date(p.registeredDate) }); });
            unpaidProjects.sort((a, b) => a.d - b.d).slice(0, 3).forEach(({ p, u }) => { const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}`; actions.push({ icon: 'ğŸ’³', title: `${pn} æ”¯æ‰•ã„`, detail: `${u.percentage}% ($${(u.amountUSD || 0).toLocaleString()})`, color: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300', link: `index.html?project=${pn}` }); });
            const container = document.getElementById('quickActions');
            if (actions.length === 0) { container.innerHTML = '<p class="text-slate-400 text-sm col-span-full text-center py-4">å®Ÿè¡Œå¾…ã¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‰</p>'; return; }
            container.innerHTML = actions.slice(0, 6).map(a => `<a href="${a.link}" class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50"><div class="w-10 h-10 rounded-lg ${a.color} flex items-center justify-center flex-shrink-0"><span class="text-lg">${a.icon}</span></div><div class="min-w-0"><p class="font-medium text-sm text-slate-900 dark:text-white truncate">${a.title}</p><p class="text-xs text-slate-500 dark:text-slate-400 truncate">${a.detail}</p></div></a>`).join('');
        }

        function updateCharts() {
            const now = new Date(), allItems = [...inventory, ...archivedInventory], months = [];
            for (let i = 5; i >= 0; i--) { const d = new Date(now.getFullYear(), now.getMonth() - i, 1); months.push({ key: d.toISOString().slice(0, 7), label: `${d.getMonth() + 1}æœˆ`, receive: 0, ship: 0, payment: 0 }); }
            allItems.forEach(item => { if (item.receiveDate) { const m = months.find(m => m.key === item.receiveDate.slice(0, 7)); if (m) m.receive++; } if (item.shipDate) { const m = months.find(m => m.key === item.shipDate.slice(0, 7)); if (m) m.ship++; } });
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate) { const m = months.find(m => m.key === d.paidDate.slice(0, 7)); if (m) m.payment += d.amountJPY || 0; } }); });
            if (charts.flow) charts.flow.destroy();
            charts.flow = new Chart(document.getElementById('flowChart'), { type: 'line', data: { labels: months.map(m => m.label), datasets: [{ label: 'å…¥åº«', data: months.map(m => m.receive), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3 }, { label: 'å‡ºåº«', data: months.map(m => m.ship), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } } });
            if (charts.payment) charts.payment.destroy();
            charts.payment = new Chart(document.getElementById('paymentChart'), { type: 'bar', data: { labels: months.map(m => m.label), datasets: [{ label: 'æ”¯æ‰•é¡', data: months.map(m => m.payment), backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => 'Â¥' + (v/10000).toFixed(0) + 'ä¸‡' } } } } });
        }

        async function requestAIAnalysis() {
            const card = document.getElementById('aiAdvisorCard'), adviceEl = document.getElementById('aiAdvice');
            card.classList.add('ai-thinking');
            adviceEl.innerHTML = '<div class="flex items-center gap-2 text-blue-600 dark:text-blue-400"><svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="typing-cursor">ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­</span></div>';
            const today = new Date(), inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­').length, waiting = inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').length, noShelf = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && !i.shelfNo).length;
            let unpaidTotal = 0, unpaidCount = 0, oldestUnpaid = null;
            projects.forEach(p => { (p.depositSchedule || []).forEach((d, idx) => { if (!d.paid) { unpaidTotal += d.amountJPY || (d.amountUSD * 150) || 0; unpaidCount++; if (idx === 0 && p.registeredDate) { const days = Math.floor((today - new Date(p.registeredDate)) / 86400000); if (!oldestUnpaid || days > oldestUnpaid.days) oldestUnpaid = { project: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}`, days, amount: d.amountUSD }; } } }); });
            const staleCount = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && i.receiveDate && Math.floor((today - new Date(i.receiveDate)) / 86400000) >= 60).length;
            const categoryCount = {}; inventory.filter(i => i.status === 'åœ¨åº«ä¸­').forEach(i => { categoryCount[i.category] = (categoryCount[i.category] || 0) + 1; });

            const prompt = `ã‚ãªãŸã¯èª¿é”ãƒ»åœ¨åº«ç®¡ç†ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€3ã€œ5å€‹ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç°¡æ½”ã«æä¾›ã—ã¦ãã ã•ã„ã€‚

ç¾çŠ¶ãƒ‡ãƒ¼ã‚¿:
- åœ¨åº«ä¸­: ${inStock}ä»¶
- å…¥åº«å¾…ã¡: ${waiting}ä»¶
- æ£šç•ªæœªè¨­å®š: ${noShelf}ä»¶
- æœªæ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆ: ${unpaidCount}ä»¶ï¼ˆç´„${Math.round(unpaidTotal/10000)}ä¸‡å††ï¼‰
- æœ€ã‚‚å¤ã„æœªæ‰•ã„: ${oldestUnpaid ? `${oldestUnpaid.project}ï¼ˆ${oldestUnpaid.days}æ—¥çµŒéã€$${oldestUnpaid.amount}ï¼‰` : 'ãªã—'}
- é•·æœŸæ»ç•™(60æ—¥+): ${staleCount}ä»¶
- ã‚«ãƒ†ã‚´ãƒªåˆ¥åœ¨åº«: ${JSON.stringify(categoryCount)}

ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯ä»¥ä¸‹ã®å½¢å¼ã§ã€çŸ­ãå…·ä½“çš„ã«ï¼š
ğŸ’¡ [ã‚¿ã‚¤ãƒˆãƒ«]: [å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³]

å„ªå…ˆåº¦ã®é«˜ã„å•é¡Œã‹ã‚‰é †ã«ã€å®Ÿè¡Œå¯èƒ½ãªææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1000, messages: [{ role: 'user', content: prompt }] }) });
                const data = await response.json();
                const advice = data.content?.[0]?.text || '';
                card.classList.remove('ai-thinking');
                const formatted = advice.split('\n').filter(l => l.trim()).map(l => l.startsWith('ğŸ’¡') ? `<div class="flex items-start gap-2 p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600"><span class="text-lg flex-shrink-0">ğŸ’¡</span><p class="text-sm text-slate-700 dark:text-slate-300">${l.replace('ğŸ’¡', '').trim()}</p></div>` : `<p class="text-sm text-slate-600 dark:text-slate-400">${l}</p>`).join('');
                adviceEl.innerHTML = `<div class="space-y-2">${formatted}</div>`;
            } catch (err) {
                console.error('AIåˆ†æã‚¨ãƒ©ãƒ¼:', err);
                card.classList.remove('ai-thinking');
                adviceEl.innerHTML = generateLocalAdvice(inStock, waiting, noShelf, unpaidCount, unpaidTotal, oldestUnpaid, staleCount);
            }
        }

        function generateLocalAdvice(inStock, waiting, noShelf, unpaidCount, unpaidTotal, oldestUnpaid, staleCount) {
            const advice = [];
            if (oldestUnpaid && oldestUnpaid.days > 30) advice.push(`<div class="flex items-start gap-2 p-2 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800"><span class="text-lg flex-shrink-0">ğŸš¨</span><p class="text-sm text-red-700 dark:text-red-300"><strong>ç·Šæ€¥:</strong> ${oldestUnpaid.project}ã®æ”¯æ‰•ã„ãŒ${oldestUnpaid.days}æ—¥çµŒéã—ã¦ã„ã¾ã™ã€‚æ—©æ€¥ã«å¯¾å¿œã—ã¦ãã ã•ã„ã€‚</p></div>`);
            if (noShelf > 0) advice.push(`<div class="flex items-start gap-2 p-2 rounded-lg bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800"><span class="text-lg flex-shrink-0">ğŸ“</span><p class="text-sm text-amber-700 dark:text-amber-300"><strong>æ•´ç†:</strong> æ£šç•ªæœªè¨­å®šãŒ${noShelf}ä»¶ã‚ã‚Šã¾ã™ã€‚æ£šå¸ã—å‰ã«è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚</p></div>`);
            if (staleCount > 0) advice.push(`<div class="flex items-start gap-2 p-2 rounded-lg bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800"><span class="text-lg flex-shrink-0">â°</span><p class="text-sm text-amber-700 dark:text-amber-300"><strong>æ»ç•™:</strong> 60æ—¥ä»¥ä¸Šã®é•·æœŸåœ¨åº«ãŒ${staleCount}ä»¶ã€‚å‡ºåº«äºˆå®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p></div>`);
            if (unpaidCount > 5) advice.push(`<div class="flex items-start gap-2 p-2 rounded-lg bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800"><span class="text-lg flex-shrink-0">ğŸ’°</span><p class="text-sm text-blue-700 dark:text-blue-300"><strong>æ”¯æ‰•ã„:</strong> æœªæ‰•ã„ãŒ${unpaidCount}ä»¶ï¼ˆç´„${Math.round(unpaidTotal/10000)}ä¸‡å††ï¼‰ã‚ã‚Šã¾ã™ã€‚è¨ˆç”»çš„ã«å‡¦ç†ã—ã¾ã—ã‚‡ã†ã€‚</p></div>`);
            if (advice.length === 0) advice.push(`<div class="flex items-start gap-2 p-2 rounded-lg bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800"><span class="text-lg flex-shrink-0">âœ…</span><p class="text-sm text-emerald-700 dark:text-emerald-300"><strong>è‰¯å¥½:</strong> ç‰¹ã«ç·Šæ€¥ã®å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã“ã®èª¿å­ã§ç®¡ç†ã‚’ç¶šã‘ã¦ãã ã•ã„ï¼</p></div>`);
            return `<div class="space-y-2">${advice.join('')}</div>`;
        }

        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', document.documentElement.classList.contains('dark')); }
        function initDarkMode() { if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); }
        window.onload = () => { const s = document.createElement('script'); s.src = 'https://accounts.google.com/gsi/client'; s.onload = init; document.head.appendChild(s); };
    </script>
</body>
</html>
