<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - èª¿é”ãƒ»åœ¨åº«ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        .card { @apply bg-white dark:bg-slate-800 rounded-xl p-4 sm:p-6 shadow-sm border dark:border-slate-700; }
        .stat-value { @apply text-2xl sm:text-3xl font-bold; }
        .stat-label { @apply text-sm text-slate-500 dark:text-slate-400; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">èª¿é”ãƒ»åœ¨åº«ç®¡ç†ã®å…¨ä½“åƒ</p>
            </div>
            <div class="flex gap-2">
                <a href="index.html" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">èª¿é”ç®¡ç†</a>
                <a href="inventory.html" class="px-4 py-2 bg-emerald-600 text-white text-sm rounded-lg hover:bg-emerald-700">åœ¨åº«ç®¡ç†</a>
                <button onclick="loadData()" class="px-4 py-2 bg-slate-600 text-white text-sm rounded-lg hover:bg-slate-700">ğŸ”„ æ›´æ–°</button>
            </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³å‰ -->
        <div id="loginSection" class="card text-center py-12">
            <p class="text-slate-600 dark:text-slate-400 mb-4">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
            <button onclick="handleAuth()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="mainContent" class="hidden">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
            <div id="statusBar" class="mb-4 text-sm text-slate-500 dark:text-slate-400"></div>

            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="card">
                    <div class="stat-label">åœ¨åº«ä¸­</div>
                    <div class="stat-value text-emerald-600" id="statInStock">-</div>
                    <div class="text-xs text-slate-400 mt-1" id="statInStockValue">-</div>
                </div>
                <div class="card">
                    <div class="stat-label">å…¥åº«å¾…ã¡</div>
                    <div class="stat-value text-amber-600" id="statWaiting">-</div>
                    <div class="text-xs text-slate-400 mt-1" id="statWaitingProjects">-</div>
                </div>
                <div class="card">
                    <div class="stat-label">æœªæ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆ</div>
                    <div class="stat-value text-red-600" id="statUnpaid">-</div>
                    <div class="text-xs text-slate-400 mt-1" id="statUnpaidUSD">-</div>
                </div>
                <div class="card">
                    <div class="stat-label">ä»Šæœˆã®æ”¯æ‰•ã„</div>
                    <div class="stat-value text-blue-600" id="statThisMonth">-</div>
                    <div class="text-xs text-slate-400 mt-1" id="statThisMonthCount">-</div>
                </div>
            </div>

            <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
            <div id="alertSection" class="mb-6 hidden">
                <div class="card border-l-4 border-orange-500">
                    <h3 class="font-bold text-orange-600 dark:text-orange-400 mb-2">âš ï¸ è¦ç¢ºèª</h3>
                    <ul id="alertList" class="text-sm space-y-1"></ul>
                </div>
            </div>

            <!-- ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒ‰ãƒ¼ãƒŠãƒ„ï¼‰ -->
                <div class="card">
                    <h3 class="font-bold text-slate-900 dark:text-white mb-4">åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                    <div class="h-64">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥åœ¨åº«ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰ -->
                <div class="card">
                    <h3 class="font-bold text-slate-900 dark:text-white mb-4">ã‚«ãƒ†ã‚´ãƒªåˆ¥åœ¨åº«æ•°</h3>
                    <div class="h-64">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- æœˆåˆ¥å…¥å‡ºåº«æ¨ç§»ï¼ˆæŠ˜ã‚Œç·šï¼‰ -->
                <div class="card">
                    <h3 class="font-bold text-slate-900 dark:text-white mb-4">æœˆåˆ¥å…¥å‡ºåº«æ¨ç§»</h3>
                    <div class="h-64">
                        <canvas id="monthlyFlowChart"></canvas>
                    </div>
                </div>

                <!-- æœˆåˆ¥æ”¯æ‰•ã„æ¨ç§»ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰ -->
                <div class="card">
                    <h3 class="font-bold text-slate-900 dark:text-white mb-4">æœˆåˆ¥æ”¯æ‰•ã„é¡</h3>
                    <div class="h-64">
                        <canvas id="monthlyPaymentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ -->
                <div class="card">
                    <h3 class="font-bold text-slate-900 dark:text-white mb-4">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b dark:border-slate-700">
                                    <th class="text-left py-2 px-2">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</th>
                                    <th class="text-right py-2 px-2">æ¡ˆä»¶æ•°</th>
                                    <th class="text-right py-2 px-2">åœ¨åº«</th>
                                    <th class="text-right py-2 px-2">æ”¯æ‰•ç´¯è¨ˆ</th>
                                </tr>
                            </thead>
                            <tbody id="supplierTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ä¿ç®¡å ´æ‰€åˆ¥ -->
                <div class="card">
                    <h3 class="font-bold text-slate-900 dark:text-white mb-4">ä¿ç®¡å ´æ‰€åˆ¥åœ¨åº«</h3>
                    <div class="h-48">
                        <canvas id="locationChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-blue-600" id="statTokyo">-</div>
                            <div class="text-sm text-slate-500">æ±äº¬</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-orange-600" id="statOsaka">-</div>
                            <div class="text-sm text-slate-500">å¤§é˜ª</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¡ˆä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="card">
                    <h3 class="font-bold text-slate-900 dark:text-white mb-4">æ¡ˆä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ</h3>
                    <div class="h-64">
                        <canvas id="projectStatusChart"></canvas>
                    </div>
                </div>

                <!-- é•·æœŸæ»ç•™ã‚¢ã‚¤ãƒ†ãƒ  -->
                <div class="card">
                    <h3 class="font-bold text-slate-900 dark:text-white mb-4">é•·æœŸæ»ç•™åœ¨åº«ï¼ˆ30æ—¥ä»¥ä¸Šï¼‰</h3>
                    <div class="overflow-x-auto max-h-64">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-800">
                                    <th class="text-left py-2 px-2">Serial</th>
                                    <th class="text-left py-2 px-2">è£½å“</th>
                                    <th class="text-right py-2 px-2">æ—¥æ•°</th>
                                </tr>
                            </thead>
                            <tbody id="staleInventoryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æœ€çµ‚æ›´æ–° -->
            <div class="text-center text-sm text-slate-400 dark:text-slate-500">
                æœ€çµ‚æ›´æ–°: <span id="lastUpdated">-</span>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';

        // ãƒ‡ãƒ¼ã‚¿
        let accessToken = null;
        let inventory = [];
        let archivedInventory = [];
        let projects = [];
        let suppliers = [];

        // ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let charts = {};

        // åˆæœŸåŒ–
        function init() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) {
                    accessToken = savedToken;
                    gapi.client.setToken({ access_token: accessToken });
                    showMain();
                    loadData();
                }
            });
        }

        function handleAuth() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        sessionStorage.setItem('googleAccessToken', accessToken);
                        gapi.client.setToken({ access_token: accessToken });
                        showMain();
                        loadData();
                    }
                },
            });
            client.requestAccessToken();
        }

        function showMain() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        function showStatus(msg) {
            document.getElementById('statusBar').textContent = msg;
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData() {
            if (!accessToken) return;
            
            try {
                showStatus('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');

                // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼
                const supplierResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A2:C',
                });
                const supplierRows = supplierResponse.result.values || [];
                suppliers = supplierRows.map(row => ({
                    id: parseInt(row[0] || 0),
                    name: row[1] || '',
                    paymentPatterns: JSON.parse(row[2] || '[]')
                }));

                // æ¡ˆä»¶
                const projectResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'æ¡ˆä»¶!A2:N',
                });
                const projectRows = projectResponse.result.values || [];
                projects = projectRows.map(row => ({
                    id: row[0],
                    projectPrefix: row[1] || 'AD',
                    projectNumber: parseInt(row[2]) || 0,
                    supplierId: parseInt(row[3] || 0),
                    productName: row[4] || '',
                    totalAmount: parseFloat(row[5] || 0),
                    depositSchedule: JSON.parse(row[6] || '[]'),
                    serial: row[7] || '',
                    quantity: parseInt(row[8] || 1),
                    workingDays: parseInt(row[9] || 30),
                    pickupDate: row[10] || '',
                    registeredDate: row[11] || '',
                    expenses: JSON.parse(row[12] || '[]'),
                    receivedComplete: row[13] === 'true'
                }));

                // åœ¨åº«
                const inventoryResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'åœ¨åº«!A2:Q',
                });
                const inventoryRows = inventoryResponse.result.values || [];
                inventory = inventoryRows.map(row => ({
                    id: row[0] || '',
                    serial: row[1] || '',
                    category: row[2] || '',
                    productName: row[3] || '',
                    orderPrefix: row[4] || '',
                    orderNumber: row[5] || '',
                    orderDate: row[6] || '',
                    receiveDate: row[7] || '',
                    status: row[8] || '',
                    shipDate: row[9] || '',
                    shipPrefix: row[10] || '',
                    shipNumber: row[11] || '',
                    costJPY: row[12] || '',
                    note: row[13] || '',
                    shelfNo: row[14] || '',
                    location: row[15] || '',
                    supplierId: row[16] || ''
                }));

                // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åœ¨åº«
                try {
                    const archiveResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A2:Q',
                    });
                    const archiveRows = archiveResponse.result.values || [];
                    archivedInventory = archiveRows.map(row => ({
                        id: row[0] || '',
                        serial: row[1] || '',
                        category: row[2] || '',
                        productName: row[3] || '',
                        orderPrefix: row[4] || '',
                        orderNumber: row[5] || '',
                        orderDate: row[6] || '',
                        receiveDate: row[7] || '',
                        status: row[8] || '',
                        shipDate: row[9] || '',
                        shipPrefix: row[10] || '',
                        shipNumber: row[11] || '',
                        costJPY: row[12] || '',
                        note: row[13] || '',
                        shelfNo: row[14] || '',
                        location: row[15] || '',
                        supplierId: row[16] || ''
                    }));
                } catch (e) {
                    archivedInventory = [];
                }

                showStatus('');
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString('ja-JP');
                
                renderDashboard();
            } catch (err) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                showStatus('ã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”»
        function renderDashboard() {
            renderSummaryCards();
            renderAlerts();
            renderCharts();
            renderTables();
        }

        // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
        function renderSummaryCards() {
            // åœ¨åº«ä¸­
            const inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            const inStockValue = inStock.reduce((sum, i) => sum + (parseFloat(i.costJPY) || 0), 0);
            document.getElementById('statInStock').textContent = inStock.length + 'å°';
            document.getElementById('statInStockValue').textContent = 'Â¥' + inStockValue.toLocaleString();

            // å…¥åº«å¾…ã¡
            const waiting = inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡');
            const waitingProjects = new Set(waiting.map(i => `${i.orderPrefix}-${i.orderNumber}`)).size;
            document.getElementById('statWaiting').textContent = waiting.length + 'å°';
            document.getElementById('statWaitingProjects').textContent = waitingProjects + 'æ¡ˆä»¶';

            // æœªæ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆ
            let unpaidUSD = 0;
            let unpaidJPY = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach(d => {
                    if (!d.paid) {
                        unpaidUSD += d.amountUSD || 0;
                        unpaidJPY += (d.amountUSD || 0) * 150; // æ¦‚ç®—ãƒ¬ãƒ¼ãƒˆ
                    }
                });
            });
            document.getElementById('statUnpaid').textContent = 'Â¥' + Math.round(unpaidJPY).toLocaleString();
            document.getElementById('statUnpaidUSD').textContent = '$' + unpaidUSD.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});

            // ä»Šæœˆã®æ”¯æ‰•ã„
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            let thisMonthTotal = 0;
            let thisMonthCount = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach(d => {
                    const paidDateStr = d.paidDate ? String(d.paidDate) : '';
                    if (d.paid && paidDateStr && paidDateStr.startsWith(thisMonth)) {
                        thisMonthTotal += d.amountJPY || 0;
                        thisMonthCount++;
                    }
                });
            });
            document.getElementById('statThisMonth').textContent = 'Â¥' + Math.round(thisMonthTotal).toLocaleString();
            document.getElementById('statThisMonthCount').textContent = thisMonthCount + 'ä»¶ã®æ”¯æ‰•ã„';

            // ä¿ç®¡å ´æ‰€åˆ¥
            const tokyo = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && i.location === 'æ±äº¬').length;
            const osaka = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && i.location === 'å¤§é˜ª').length;
            document.getElementById('statTokyo').textContent = tokyo + 'å°';
            document.getElementById('statOsaka').textContent = osaka + 'å°';
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆ
        function renderAlerts() {
            const alerts = [];
            const today = new Date();

            // é•·æœŸå…¥åº«å¾…ã¡ï¼ˆ14æ—¥ä»¥ä¸Šï¼‰
            inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡' && i.orderDate).forEach(item => {
                const orderDate = new Date(item.orderDate);
                const days = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                if (days >= 14) {
                    alerts.push(`ğŸ“¦ ${item.serial || item.productName}: å…¥åº«å¾…ã¡ ${days}æ—¥`);
                }
            });

            // é«˜é¡æœªæ‰•ã„ï¼ˆ$5000ä»¥ä¸Šï¼‰
            projects.forEach(p => {
                const unpaid = (p.depositSchedule || [])
                    .filter(d => !d.paid)
                    .reduce((sum, d) => sum + (d.amountUSD || 0), 0);
                if (unpaid >= 5000) {
                    alerts.push(`ğŸ’° ${p.projectPrefix}-${p.projectNumber}: æœªæ‰•ã„ $${unpaid.toLocaleString()}`);
                }
            });

            const alertSection = document.getElementById('alertSection');
            const alertList = document.getElementById('alertList');
            
            if (alerts.length > 0) {
                alertSection.classList.remove('hidden');
                alertList.innerHTML = alerts.map(a => `<li class="text-slate-700 dark:text-slate-300">${a}</li>`).join('');
            } else {
                alertSection.classList.add('hidden');
            }
        }

        // ãƒãƒ£ãƒ¼ãƒˆæç”»
        function renderCharts() {
            // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒ‰ãƒ¼ãƒŠãƒ„ï¼‰
            const statusCounts = {
                'å…¥åº«å¾…ã¡': inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').length,
                'åœ¨åº«ä¸­': inventory.filter(i => i.status === 'åœ¨åº«ä¸­').length,
                'å‡ºåº«æ¸ˆ': inventory.filter(i => i.status === 'å‡ºåº«æ¸ˆ').length,
                'ä¸å…·åˆ': inventory.filter(i => i.status === 'ä¸å…·åˆ').length,
            };
            charts.status = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#f59e0b', '#10b981', '#6366f1', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥åœ¨åº«ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
            const categoryCounts = {};
            inventory.filter(i => i.status === 'åœ¨åº«ä¸­').forEach(item => {
                const cat = item.category || 'æœªåˆ†é¡';
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            });
            const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);
            charts.category = new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: sortedCategories.map(c => c[0]),
                    datasets: [{
                        label: 'åœ¨åº«æ•°',
                        data: sortedCategories.map(c => c[1]),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // æœˆåˆ¥å…¥å‡ºåº«æ¨ç§»
            const allItems = [...inventory, ...archivedInventory];
            const monthlyFlow = {};
            const now = new Date();
            for (let i = 11; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthlyFlow[key] = { receive: 0, ship: 0 };
            }
            allItems.forEach(item => {
                if (item.receiveDate && typeof item.receiveDate === 'string') {
                    const month = item.receiveDate.substring(0, 7);
                    if (monthlyFlow[month]) monthlyFlow[month].receive++;
                }
                if (item.shipDate && typeof item.shipDate === 'string') {
                    const month = item.shipDate.substring(0, 7);
                    if (monthlyFlow[month]) monthlyFlow[month].ship++;
                }
            });
            const flowLabels = Object.keys(monthlyFlow).map(k => k.substring(5) + 'æœˆ');
            charts.flow = new Chart(document.getElementById('monthlyFlowChart'), {
                type: 'line',
                data: {
                    labels: flowLabels,
                    datasets: [
                        {
                            label: 'å…¥åº«',
                            data: Object.values(monthlyFlow).map(v => v.receive),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'å‡ºåº«',
                            data: Object.values(monthlyFlow).map(v => v.ship),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // æœˆåˆ¥æ”¯æ‰•ã„é¡
            const monthlyPayment = {};
            for (let i = 11; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthlyPayment[key] = 0;
            }
            projects.forEach(p => {
                (p.depositSchedule || []).forEach(d => {
                    const paidDateStr = d.paidDate ? String(d.paidDate) : '';
                    if (d.paid && paidDateStr.length >= 7) {
                        const month = paidDateStr.substring(0, 7);
                        if (monthlyPayment[month] !== undefined) {
                            monthlyPayment[month] += d.amountJPY || 0;
                        }
                    }
                });
            });
            charts.payment = new Chart(document.getElementById('monthlyPaymentChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(monthlyPayment).map(k => k.substring(5) + 'æœˆ'),
                    datasets: [{
                        label: 'æ”¯æ‰•ã„é¡ (å††)',
                        data: Object.values(monthlyPayment),
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + (value / 10000).toFixed(0) + 'ä¸‡';
                                }
                            }
                        } 
                    }
                }
            });

            // ä¿ç®¡å ´æ‰€ï¼ˆãƒ‰ãƒ¼ãƒŠãƒ„ï¼‰
            const inStockItems = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            const locationCounts = {
                'æ±äº¬': inStockItems.filter(i => i.location === 'æ±äº¬').length,
                'å¤§é˜ª': inStockItems.filter(i => i.location === 'å¤§é˜ª').length,
                'æœªè¨­å®š': inStockItems.filter(i => !i.location).length
            };
            charts.location = new Chart(document.getElementById('locationChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(locationCounts),
                    datasets: [{
                        data: Object.values(locationCounts),
                        backgroundColor: ['#3b82f6', '#f97316', '#94a3b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // æ¡ˆä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ
            const projectStatusCounts = { 'æœªç€æ‰‹': 0, 'æ”¯æ‰•ä¸­': 0, 'æ”¯æ‰•æ¸ˆ': 0, 'å…¥åº«å®Œäº†': 0 };
            projects.forEach(p => {
                const status = getProjectStatus(p);
                projectStatusCounts[status] = (projectStatusCounts[status] || 0) + 1;
            });
            charts.projectStatus = new Chart(document.getElementById('projectStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(projectStatusCounts),
                    datasets: [{
                        data: Object.values(projectStatusCounts),
                        backgroundColor: ['#94a3b8', '#f59e0b', '#3b82f6', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function getProjectStatus(project) {
            if (project.receivedComplete) return 'å…¥åº«å®Œäº†';
            
            const deposits = project.depositSchedule || [];
            const allPaid = deposits.length > 0 && deposits.every(d => d.paid);
            const somePaid = deposits.some(d => d.paid);
            
            const today = new Date();
            const pickupDate = project.pickupDate ? new Date(project.pickupDate) : null;
            const isPickupPassed = pickupDate && pickupDate < today;

            if (allPaid && isPickupPassed) return 'å…¥åº«å®Œäº†';
            if (allPaid) return 'æ”¯æ‰•æ¸ˆ';
            if (somePaid) return 'æ”¯æ‰•ä¸­';
            return 'æœªç€æ‰‹';
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderTables() {
            // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ
            const supplierStats = {};
            suppliers.forEach(s => {
                supplierStats[s.id] = { name: s.name, projects: 0, inventory: 0, paid: 0 };
            });
            
            projects.forEach(p => {
                if (supplierStats[p.supplierId]) {
                    supplierStats[p.supplierId].projects++;
                    (p.depositSchedule || []).forEach(d => {
                        if (d.paid) supplierStats[p.supplierId].paid += d.amountJPY || 0;
                    });
                }
            });
            
            inventory.filter(i => i.status === 'åœ¨åº«ä¸­').forEach(item => {
                const sid = parseInt(item.supplierId);
                if (supplierStats[sid]) supplierStats[sid].inventory++;
            });

            const sortedSuppliers = Object.values(supplierStats).sort((a, b) => b.paid - a.paid);
            document.getElementById('supplierTable').innerHTML = sortedSuppliers.map(s => `
                <tr class="border-b dark:border-slate-700">
                    <td class="py-2 px-2 dark:text-white">${s.name}</td>
                    <td class="py-2 px-2 text-right dark:text-slate-300">${s.projects}</td>
                    <td class="py-2 px-2 text-right dark:text-slate-300">${s.inventory}</td>
                    <td class="py-2 px-2 text-right font-semibold dark:text-white">Â¥${Math.round(s.paid).toLocaleString()}</td>
                </tr>
            `).join('');

            // é•·æœŸæ»ç•™åœ¨åº«
            const today = new Date();
            const staleItems = inventory
                .filter(i => i.status === 'åœ¨åº«ä¸­' && i.receiveDate)
                .map(item => {
                    const receiveDate = new Date(item.receiveDate);
                    const days = Math.floor((today - receiveDate) / (1000 * 60 * 60 * 24));
                    return { ...item, days };
                })
                .filter(item => item.days >= 30)
                .sort((a, b) => b.days - a.days)
                .slice(0, 20);

            document.getElementById('staleInventoryTable').innerHTML = staleItems.length > 0 
                ? staleItems.map(item => `
                    <tr class="border-b dark:border-slate-700">
                        <td class="py-2 px-2 font-mono text-sm dark:text-white">${item.serial || '-'}</td>
                        <td class="py-2 px-2 text-xs dark:text-slate-300 truncate max-w-32">${item.productName}</td>
                        <td class="py-2 px-2 text-right font-semibold ${item.days >= 60 ? 'text-red-600' : 'text-amber-600'}">${item.days}æ—¥</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" class="py-4 text-center text-slate-400">è©²å½“ãªã—</td></tr>';
        }

        // Google Identity Services
        window.onload = () => {
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = init;
            document.head.appendChild(script);
        };
    </script>
</body>
</html>
