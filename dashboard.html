<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSèª¿é”ãƒŠãƒ“ - èª¿é”ãƒ»åœ¨åº«ç®¡ç†</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%233b82f6'/><text x='50' y='65' font-size='45' text-anchor='middle' fill='white'>ğŸ§­</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');
        * { font-family: 'Noto Sans JP', sans-serif; }
        .card { @apply bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700; }
        .timeline-item { position: relative; padding-left: 24px; }
        .timeline-item::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -8px; width: 2px; background: #e2e8f0; }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; border-radius: 50%; border: 3px solid; }
        @keyframes pulse-border { 0%, 100% { border-color: rgba(59,130,246,0.5); } 50% { border-color: rgba(59,130,246,1); } }
        .ai-thinking { animation: pulse-border 1.5s ease-in-out infinite; }
        .mode-btn { @apply px-3 py-1.5 text-sm rounded-lg transition-colors; }
        .mode-btn.active { @apply bg-blue-600 text-white; }
        .mode-btn:not(.active) { @apply bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600; }
        .chat-msg { @apply p-3 rounded-lg max-w-[85%]; }
        .chat-user { @apply bg-blue-100 dark:bg-blue-900/50 text-blue-900 dark:text-blue-100 ml-auto; }
        .chat-ai { @apply bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-slate-100; }
    </style>
</head>
<body class="min-h-screen bg-slate-100 dark:bg-slate-900">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="sticky top-0 z-40 bg-white/95 dark:bg-slate-800/95 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 px-4 sm:px-6 py-3">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white">ğŸ§­ YSèª¿é”ãƒŠãƒ“</h1>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1" id="lastUpdate">èª¿é”ãƒ»åœ¨åº«ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
                </div>
                <div class="flex gap-2 items-center">
                    <a href="index.html" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">èª¿é”ç®¡ç†</a>
                    <a href="inventory.html" class="px-4 py-2 border border-blue-600 text-blue-600 dark:text-blue-400 text-sm rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/30">åœ¨åº«ç®¡ç†</a>
                    <button onclick="loadData()" class="px-4 py-2 bg-slate-600 text-white text-sm rounded-lg hover:bg-slate-700">ğŸ”„</button>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="p-4 sm:p-6">
            <!-- ãƒ­ã‚°ã‚¤ãƒ³å‰ -->
            <div id="loginSection" class="card p-8 text-center">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/50 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">ğŸ§­</span></div>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-2">YSèª¿é”ãƒŠãƒ“</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-6">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button onclick="handleAuth()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="mainContent" class="hidden space-y-6">
                
                <!-- ğŸ§  AIåˆ†æ & ãƒŠãƒ¬ãƒƒã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="card p-4 sm:p-6" id="aiSection">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center"><span class="text-xl">ğŸ§ </span></div>
                            <div>
                                <h2 class="font-bold text-slate-900 dark:text-white">AIåˆ†æ & ãƒŠãƒ¬ãƒƒã‚¸</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400">ãƒ‡ãƒ¼ã‚¿åˆ†æã¨çŸ¥è¦‹ã®è“„ç©</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åˆ†æãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button class="mode-btn active" data-mode="quick" onclick="setAnalysisMode('quick')">âš¡ ã‚¯ã‚¤ãƒƒã‚¯</button>
                        <button class="mode-btn" data-mode="detail" onclick="setAnalysisMode('detail')">ğŸ“Š è©³ç´°</button>
                        <button class="mode-btn" data-mode="cost" onclick="setAnalysisMode('cost')">ğŸ’° ã‚³ã‚¹ãƒˆ</button>
                        <button class="mode-btn" data-mode="supplier" onclick="setAnalysisMode('supplier')">ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</button>
                        <button class="mode-btn" data-mode="forecast" onclick="setAnalysisMode('forecast')">ğŸ”® äºˆæ¸¬</button>
                    </div>

                    <!-- åˆ†æçµæœã‚¨ãƒªã‚¢ -->
                    <div id="analysisResult" class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4 mb-4 min-h-[120px]">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">åˆ†æãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã€Œåˆ†æé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                    </div>
                    
                    <!-- åˆ†æã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="runAnalysis()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            åˆ†æé–‹å§‹
                        </button>
                        <button onclick="saveToKnowledge()" id="saveKnowledgeBtn" class="px-4 py-2 bg-emerald-600 text-white text-sm rounded-lg hover:bg-emerald-700 flex items-center gap-2 hidden">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                            ãƒŠãƒ¬ãƒƒã‚¸ã«ä¿å­˜
                        </button>
                    </div>

                    <!-- AIãƒãƒ£ãƒƒãƒˆ -->
                    <div class="border-t border-slate-200 dark:border-slate-600 pt-4">
                        <h3 class="font-medium text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                            <span>ğŸ’¬</span> AIã«è³ªå•ã™ã‚‹
                        </h3>
                        <div id="chatHistory" class="space-y-3 mb-3 max-h-[300px] overflow-y-auto">
                            <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã“ã“ã«è¡¨ç¤º -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chatInput" placeholder="ä¾‹: OKViewã¨ã®å–å¼•çŠ¶æ³ã¯ï¼Ÿ / æ¥æœˆã„ãã‚‰å¿…è¦ï¼Ÿ" 
                                class="flex-1 px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white text-sm"
                                onkeypress="if(event.key==='Enter')sendChat()">
                            <button onclick="sendChat()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">é€ä¿¡</button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ“š ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ -->
                <div class="card p-4 sm:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                            <span>ğŸ“š</span> è“„ç©ã•ã‚ŒãŸãƒŠãƒ¬ãƒƒã‚¸
                            <span id="knowledgeCount" class="text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded-full">0ä»¶</span>
                        </h3>
                        <button onclick="showKnowledgeModal()" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">ã™ã¹ã¦è¦‹ã‚‹</button>
                    </div>
                    <div id="knowledgePreview" class="space-y-2">
                        <p class="text-slate-400 text-sm">ãƒŠãƒ¬ãƒƒã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>

                <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="card p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="window.location.href='inventory.html?status=åœ¨åº«ä¸­'">
                        <div class="flex items-start justify-between">
                            <div><p class="text-slate-500 dark:text-slate-400 text-sm">åœ¨åº«ä¸­</p><p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="statInStock">-</p></div>
                            <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/50 rounded-lg flex items-center justify-center"><span class="text-xl">ğŸ“¦</span></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700"><p class="text-xs text-slate-500 dark:text-slate-400" id="statInStockDetail">-</p></div>
                    </div>
                    <div class="card p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="window.location.href='inventory.html?status=å…¥åº«å¾…ã¡'">
                        <div class="flex items-start justify-between">
                            <div><p class="text-slate-500 dark:text-slate-400 text-sm">å…¥åº«å¾…ã¡</p><p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="statWaiting">-</p></div>
                            <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/50 rounded-lg flex items-center justify-center"><span class="text-xl">ğŸšš</span></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700"><p class="text-xs text-amber-600 dark:text-amber-400 font-medium" id="statWaitingDetail">-</p></div>
                    </div>
                    <div class="card p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="window.location.href='index.html'">
                        <div class="flex items-start justify-between">
                            <div><p class="text-slate-500 dark:text-slate-400 text-sm">æœªæ‰•ã„</p><p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="statUnpaid">-</p></div>
                            <div class="w-10 h-10 bg-red-100 dark:bg-red-900/50 rounded-lg flex items-center justify-center"><span class="text-xl">ğŸ’°</span></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700"><p class="text-xs text-red-600 dark:text-red-400 font-medium" id="statUnpaidDetail">-</p></div>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-start justify-between">
                            <div><p class="text-slate-500 dark:text-slate-400 text-sm">ä»Šæœˆæ”¯æ‰•ã„</p><p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="statThisMonth">-</p></div>
                            <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/50 rounded-lg flex items-center justify-center"><span class="text-xl">ğŸ“Š</span></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700"><p class="text-xs text-slate-500 dark:text-slate-400" id="statThisMonthDetail">-</p></div>
                    </div>
                </div>

                <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ & ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card p-4 sm:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2"><span>ğŸ“…</span> ä»Šé€±ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
                            <span class="text-xs text-slate-500 dark:text-slate-400" id="timelineWeek">-</span>
                        </div>
                        <div id="timeline" class="space-y-3"><p class="text-slate-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</p></div>
                    </div>
                    <div class="card p-4 sm:p-6">
                        <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-4"><span>ğŸ¥</span> ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</h3>
                        <div id="healthCheck" class="space-y-3"><p class="text-slate-400 text-sm">èª­ã¿è¾¼ã¿ä¸­...</p></div>
                    </div>
                </div>

                <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="card p-4 sm:p-6">
                    <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-4"><span>âš¡</span> ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                    <div id="quickActions" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"><p class="text-slate-400 text-sm col-span-full">èª­ã¿è¾¼ã¿ä¸­...</p></div>
                </div>

                <!-- ã‚°ãƒ©ãƒ• -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-4 sm:p-6">
                        <h3 class="font-bold text-slate-900 dark:text-white mb-4">æœˆåˆ¥å…¥å‡ºåº«æ¨ç§»</h3>
                        <div class="h-48"><canvas id="flowChart"></canvas></div>
                    </div>
                    <div class="card p-4 sm:p-6">
                        <h3 class="font-bold text-slate-900 dark:text-white mb-4">æœˆåˆ¥æ”¯æ‰•ã„é¡</h3>
                        <div class="h-48"><canvas id="paymentChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="knowledgeModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-900 dark:text-white">ğŸ“š ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹</h3>
                <button onclick="closeKnowledgeModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">âœ•</button>
            </div>
            <div class="p-4 border-b border-slate-200 dark:border-slate-700">
                <div class="flex gap-2 flex-wrap">
                    <button class="knowledge-filter active px-3 py-1 text-sm rounded-full bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300" data-filter="all">ã™ã¹ã¦</button>
                    <button class="knowledge-filter px-3 py-1 text-sm rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300" data-filter="important">ğŸ“Œ é‡è¦</button>
                    <button class="knowledge-filter px-3 py-1 text-sm rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300" data-filter="supplier">ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</button>
                    <button class="knowledge-filter px-3 py-1 text-sm rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300" data-filter="cost">ğŸ’° ã‚³ã‚¹ãƒˆ</button>
                    <button class="knowledge-filter px-3 py-1 text-sm rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300" data-filter="pattern">ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³</button>
                </div>
            </div>
            <div id="knowledgeList" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ -->
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700">
                <button onclick="showAddKnowledgeForm()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">+ æ‰‹å‹•ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addKnowledgeModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl max-w-md w-full p-6">
            <h3 class="font-bold text-lg text-slate-900 dark:text-white mb-4">ğŸ“ ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="newKnowledgeCategory" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white">
                        <option value="important">ğŸ“Œ é‡è¦ãªæ°—ã¥ã</option>
                        <option value="supplier">ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</option>
                        <option value="cost">ğŸ’° ã‚³ã‚¹ãƒˆ</option>
                        <option value="pattern">ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
                        <option value="seasonal">ğŸ—“ï¸ å­£ç¯€æ€§</option>
                        <option value="note">ğŸ“ ãƒ¡ãƒ¢</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">å†…å®¹</label>
                    <textarea id="newKnowledgeContent" rows="3" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white" placeholder="ä¾‹: OKViewã¯å¹´æœ«ã«ç´æœŸãŒ2é€±é–“é…ã‚Œã‚‹å‚¾å‘ãŒã‚ã‚‹"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">é–¢é€£ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="newKnowledgeTags" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white" placeholder="ä¾‹: OKView, LED">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeAddKnowledgeModal()" class="flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="addKnowledge()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ========== è¨­å®š ==========
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        
        // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
        let accessToken = null;
        let inventory = [], archivedInventory = [], projects = [], suppliers = [], knowledge = [];
        let charts = {};
        let currentAnalysisMode = 'quick';
        let lastAnalysisResult = null;
        let chatHistory = [];

        // ========== åˆæœŸåŒ– ==========
        function init() {
            initDarkMode();
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) {
                    accessToken = savedToken;
                    gapi.client.setToken({ access_token: accessToken });
                    showMain();
                    loadData();
                }
            });
        }

        function handleAuth() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (r) => {
                    if (r.access_token) {
                        accessToken = r.access_token;
                        sessionStorage.setItem('googleAccessToken', accessToken);
                        gapi.client.setToken({ access_token: accessToken });
                        showMain();
                        loadData();
                    }
                }
            });
            client.requestAccessToken();
        }

        function showMain() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // ========== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ==========
        async function loadData() {
            if (!accessToken) return;
            try {
                const [supRes, prjRes, invRes] = await Promise.all([
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A2:C' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'æ¡ˆä»¶!A2:N' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'åœ¨åº«!A2:Q' })
                ]);
                
                suppliers = (supRes.result.values || []).map(r => ({ id: parseInt(r[0] || 0), name: r[1] || '', paymentPatterns: JSON.parse(r[2] || '[]') }));
                projects = (prjRes.result.values || []).map(r => ({
                    id: r[0], projectPrefix: r[1] || 'AD', projectNumber: parseInt(r[2]) || 0, supplierId: parseInt(r[3] || 0),
                    productName: r[4] || '', totalAmount: parseFloat(r[5] || 0), depositSchedule: JSON.parse(r[6] || '[]'),
                    serial: r[7] || '', quantity: parseInt(r[8] || 1), workingDays: parseInt(r[9] || 30),
                    pickupDate: r[10] || '', registeredDate: r[11] || '', expenses: JSON.parse(r[12] || '[]'), receivedComplete: r[13] === 'true'
                }));
                inventory = (invRes.result.values || []).map(r => ({
                    id: r[0] || '', serial: r[1] || '', category: r[2] || '', productName: r[3] || '',
                    orderPrefix: r[4] || '', orderNumber: r[5] || '', orderDate: r[6] || '', receiveDate: r[7] || '',
                    status: r[8] || '', shipDate: r[9] || '', shipPrefix: r[10] || '', shipNumber: r[11] || '',
                    costJPY: r[12] || '', note: r[13] || '', shelfNo: r[14] || '', location: r[15] || '', supplierId: r[16] || ''
                }));

                // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
                try {
                    const arcRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A2:Q' });
                    archivedInventory = (arcRes.result.values || []).map(r => ({ receiveDate: r[7] || '', shipDate: r[9] || '', category: r[2] || '', supplierId: r[16] || '' }));
                } catch(e) { archivedInventory = []; }

                // ãƒŠãƒ¬ãƒƒã‚¸èª­ã¿è¾¼ã¿
                await loadKnowledge();

                // UIæ›´æ–°
                updateSummary();
                updateTimeline();
                updateHealthCheck();
                updateQuickActions();
                updateCharts();
                updateKnowledgePreview();
                
                document.getElementById('lastUpdate').textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}`;
            } catch (err) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        // ========== ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç† ==========
        async function loadKnowledge() {
            try {
                const res = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ãƒŠãƒ¬ãƒƒã‚¸!A2:F'
                });
                knowledge = (res.result.values || []).map((r, idx) => ({
                    id: idx + 2, // è¡Œç•ªå·
                    date: r[0] || '',
                    category: r[1] || 'note',
                    content: r[2] || '',
                    importance: r[3] || 'ä¸­',
                    tags: r[4] || '',
                    source: r[5] || 'manual'
                }));
            } catch (e) {
                // ã‚·ãƒ¼ãƒˆãŒãªã‘ã‚Œã°ä½œæˆ
                console.log('ãƒŠãƒ¬ãƒƒã‚¸ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™');
                await createKnowledgeSheet();
                knowledge = [];
            }
        }

        async function createKnowledgeSheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: { title: 'ãƒŠãƒ¬ãƒƒã‚¸' }
                            }
                        }]
                    }
                });
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ 
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ãƒŠãƒ¬ãƒƒã‚¸!A1:F1',
                    valueInputOption: 'RAW',
                    resource: { values: [['æ—¥ä»˜', 'ã‚«ãƒ†ã‚´ãƒª', 'å†…å®¹', 'é‡è¦åº¦', 'ã‚¿ã‚°', 'ã‚½ãƒ¼ã‚¹']] }
                });
            } catch (e) {
                console.error('ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        async function saveKnowledgeItem(category, content, importance = 'ä¸­', tags = '', source = 'ai') {
            const date = new Date().toISOString().split('T')[0];
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ãƒŠãƒ¬ãƒƒã‚¸!A:F',
                    valueInputOption: 'RAW',
                    resource: { values: [[date, category, content, importance, tags, source]] }
                });
                await loadKnowledge();
                updateKnowledgePreview();
                return true;
            } catch (e) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                return false;
            }
        }

        function updateKnowledgePreview() {
            const container = document.getElementById('knowledgePreview');
            document.getElementById('knowledgeCount').textContent = knowledge.length + 'ä»¶';
            
            if (knowledge.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm">ãƒŠãƒ¬ãƒƒã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚AIåˆ†æã®çµæœã‚’ä¿å­˜ã™ã‚‹ã‹ã€æ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            const recent = [...knowledge].reverse().slice(0, 5);
            const icons = { important: 'ğŸ“Œ', supplier: 'ğŸ­', cost: 'ğŸ’°', pattern: 'ğŸ“Š', seasonal: 'ğŸ—“ï¸', note: 'ğŸ“' };
            
            container.innerHTML = recent.map(k => `
                <div class="flex items-start gap-2 p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50 text-sm">
                    <span>${icons[k.category] || 'ğŸ“'}</span>
                    <div class="flex-1 min-w-0">
                        <p class="text-slate-700 dark:text-slate-300 truncate">${k.content}</p>
                        <p class="text-xs text-slate-400 mt-1">${k.date}${k.tags ? ' Â· ' + k.tags : ''}</p>
                    </div>
                </div>
            `).join('');
        }

        // ========== åˆ†æãƒ¢ãƒ¼ãƒ‰ ==========
        function setAnalysisMode(mode) {
            currentAnalysisMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        async function runAnalysis() {
            const resultEl = document.getElementById('analysisResult');
            const saveBtn = document.getElementById('saveKnowledgeBtn');
            
            resultEl.innerHTML = '<div class="flex items-center gap-2 text-blue-600 dark:text-blue-400"><svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>åˆ†æä¸­...</span></div>';
            saveBtn.classList.add('hidden');

            const analysisData = prepareAnalysisData();
            const prompt = buildAnalysisPrompt(currentAnalysisMode, analysisData);

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1500, messages: [{ role: 'user', content: prompt }] })
                });
                const data = await response.json();
                lastAnalysisResult = data.content?.[0]?.text || '';
                
                resultEl.innerHTML = formatAnalysisResult(lastAnalysisResult);
                saveBtn.classList.remove('hidden');
            } catch (err) {
                console.error('åˆ†æã‚¨ãƒ©ãƒ¼:', err);
                resultEl.innerHTML = '<p class="text-red-500">åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</p>' + generateLocalAnalysis(currentAnalysisMode, analysisData);
                lastAnalysisResult = null;
            }
        }

        function prepareAnalysisData() {
            const today = new Date();
            const inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            const waiting = inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡');
            
            // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥é›†è¨ˆ
            const supplierStats = {};
            projects.forEach(p => {
                const sup = suppliers.find(s => s.id === p.supplierId);
                const name = sup?.name || 'ä¸æ˜';
                if (!supplierStats[name]) supplierStats[name] = { count: 0, total: 0, unpaid: 0 };
                supplierStats[name].count++;
                supplierStats[name].total += p.totalAmount;
                (p.depositSchedule || []).forEach(d => { if (!d.paid) supplierStats[name].unpaid += d.amountUSD || 0; });
            });

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ
            const categoryStats = {};
            inStock.forEach(i => { categoryStats[i.category] = (categoryStats[i.category] || 0) + 1; });

            // æœˆåˆ¥æ”¯æ‰•ã„
            const monthlyPayments = {};
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                monthlyPayments[d.toISOString().slice(0, 7)] = 0;
            }
            projects.forEach(p => {
                (p.depositSchedule || []).forEach(d => {
                    if (d.paid && d.paidDate && monthlyPayments.hasOwnProperty(d.paidDate.slice(0, 7))) {
                        monthlyPayments[d.paidDate.slice(0, 7)] += d.amountJPY || 0;
                    }
                });
            });

            // æœªæ‰•ã„é›†è¨ˆ
            let unpaidTotal = 0, unpaidCount = 0, oldestUnpaidDays = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach((d, idx) => {
                    if (!d.paid) {
                        unpaidTotal += d.amountJPY || (d.amountUSD * 150) || 0;
                        unpaidCount++;
                        if (idx === 0 && p.registeredDate) {
                            const days = Math.floor((today - new Date(p.registeredDate)) / 86400000);
                            if (days > oldestUnpaidDays) oldestUnpaidDays = days;
                        }
                    }
                });
            });

            // æ»ç•™æ—¥æ•°
            const stayDays = inStock.filter(i => i.receiveDate).map(i => Math.floor((today - new Date(i.receiveDate)) / 86400000));
            const avgStayDays = stayDays.length > 0 ? Math.round(stayDays.reduce((a, b) => a + b, 0) / stayDays.length) : 0;

            // æ¥æœˆã®æ”¯æ‰•ã„äºˆæ¸¬
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const nextMonthEnd = new Date(today.getFullYear(), today.getMonth() + 2, 0);
            let nextMonthPayment = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach((d, idx) => {
                    if (d.paid) return;
                    let dueDate;
                    if (idx === 0 && p.registeredDate) {
                        dueDate = new Date(p.registeredDate);
                        dueDate.setDate(dueDate.getDate() + 14);
                    } else if (p.pickupDate) {
                        dueDate = new Date(p.pickupDate);
                    }
                    if (dueDate && dueDate >= nextMonth && dueDate <= nextMonthEnd) {
                        nextMonthPayment += d.amountJPY || (d.amountUSD * 150) || 0;
                    }
                });
            });

            return {
                inStockCount: inStock.length,
                inStockValue: inStock.reduce((s, i) => s + (parseInt(i.costJPY) || 0), 0),
                waitingCount: waiting.length,
                unpaidTotal, unpaidCount, oldestUnpaidDays,
                supplierStats, categoryStats, monthlyPayments,
                avgStayDays,
                noShelfCount: inStock.filter(i => !i.shelfNo).length,
                staleCount: stayDays.filter(d => d >= 60).length,
                nextMonthPayment,
                knowledgeItems: knowledge.slice(-10).map(k => `[${k.category}] ${k.content}`).join('\n')
            };
        }

        function buildAnalysisPrompt(mode, data) {
            const baseContext = `
èª¿é”ãƒ»åœ¨åº«ãƒ‡ãƒ¼ã‚¿:
- åœ¨åº«ä¸­: ${data.inStockCount}ä»¶ï¼ˆç·é¡ Â¥${data.inStockValue.toLocaleString()}ï¼‰
- å…¥åº«å¾…ã¡: ${data.waitingCount}ä»¶
- æœªæ‰•ã„: ${data.unpaidCount}ä»¶ï¼ˆç´„Â¥${Math.round(data.unpaidTotal/10000)}ä¸‡ï¼‰
- æœ€é•·æœªæ‰•ã„çµŒéæ—¥æ•°: ${data.oldestUnpaidDays}æ—¥
- å¹³å‡æ»ç•™æ—¥æ•°: ${data.avgStayDays}æ—¥
- æ£šç•ªæœªè¨­å®š: ${data.noShelfCount}ä»¶
- é•·æœŸæ»ç•™(60æ—¥+): ${data.staleCount}ä»¶
- æ¥æœˆæ”¯æ‰•ã„äºˆæ¸¬: ç´„Â¥${Math.round(data.nextMonthPayment/10000)}ä¸‡

ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥: ${JSON.stringify(data.supplierStats)}
ã‚«ãƒ†ã‚´ãƒªåˆ¥åœ¨åº«: ${JSON.stringify(data.categoryStats)}
æœˆåˆ¥æ”¯æ‰•ã„æ¨ç§»: ${JSON.stringify(data.monthlyPayments)}

éå»ã®ãƒŠãƒ¬ãƒƒã‚¸:
${data.knowledgeItems || 'ãªã—'}
`;

            const modePrompts = {
                quick: `${baseContext}

ä¸Šè¨˜ãƒ‡ãƒ¼ã‚¿ã‚’è¸ã¾ãˆã€ä»Šã™ãå¯¾å¿œã™ã¹ãé‡è¦äº‹é …ã‚’3ã€œ5å€‹ã€å„ªå…ˆåº¦é †ã«ç°¡æ½”ã«æç¤ºã—ã¦ãã ã•ã„ã€‚
å½¢å¼: ğŸ”´/ğŸŸ¡/ğŸŸ¢ [å„ªå…ˆåº¦] ã‚¿ã‚¤ãƒˆãƒ«: å…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`,

                detail: `${baseContext}

ä¸Šè¨˜ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«åˆ†æã—ã€ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„:
1. ğŸ“Š ç¾çŠ¶ã‚µãƒãƒªãƒ¼ï¼ˆæ•°å€¤ã®å¥å…¨æ€§ï¼‰
2. âš ï¸ ãƒªã‚¹ã‚¯ãƒ»èª²é¡Œï¼ˆ3ã¤ç¨‹åº¦ï¼‰
3. ğŸ’¡ æ”¹å–„ææ¡ˆï¼ˆå…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
4. ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆå‰æœˆæ¯”è¼ƒã€å‚¾å‘ï¼‰`,

                cost: `${baseContext}

ã‚³ã‚¹ãƒˆè¦³ç‚¹ã§è©³ç´°åˆ†æã—ã¦ãã ã•ã„:
1. ğŸ’° ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼çŠ¶æ³
2. ğŸ“‰ æ”¯æ‰•ã„ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆå¢—æ¸›å‚¾å‘ï¼‰
3. â° æ”¯æ‰•ã„é…å»¶ãƒªã‚¹ã‚¯
4. ğŸ”® æ¥æœˆã®è³‡é‡‘ç¹°ã‚Šäºˆæ¸¬
5. ğŸ’¡ ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã®ææ¡ˆ`,

                supplier: `${baseContext}

ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼è¦³ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„:
1. ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ä¾å­˜åº¦ï¼ˆãƒªã‚¹ã‚¯åˆ†æ•£çŠ¶æ³ï¼‰
2. ğŸ“Š å„ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã®å–å¼•çŠ¶æ³
3. âš ï¸ ç‰¹å®šã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã¸ã®åã‚Š
4. ğŸ’¡ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼æˆ¦ç•¥ã®ææ¡ˆ`,

                forecast: `${baseContext}

ä»Šå¾Œ1ã€œ2ãƒ¶æœˆã®äºˆæ¸¬ã‚’è¡Œã£ã¦ãã ã•ã„:
1. ğŸ’° æ”¯æ‰•ã„äºˆæ¸¬ï¼ˆé‡‘é¡ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
2. ğŸ“¦ å…¥åº«äºˆæ¸¬
3. âš ï¸ æ³¨æ„ã™ã¹ãã‚¤ãƒ™ãƒ³ãƒˆ
4. ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä»Šé€±/æ¥é€±/ä»Šæœˆï¼‰`
            };

            return modePrompts[mode] + '\n\nâ€»å›ç­”ã¯æ—¥æœ¬èªã§ã€å…·ä½“çš„ãªæ•°å€¤ã‚’å«ã‚ã¦ãã ã•ã„ã€‚';
        }

        function formatAnalysisResult(text) {
            if (!text) return '<p class="text-slate-400">åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
            
            return '<div class="space-y-2 text-sm">' + text.split('\n').filter(l => l.trim()).map(line => {
                if (line.match(/^[ğŸ”´ğŸŸ¡ğŸŸ¢ğŸ“Šâš ï¸ğŸ’¡ğŸ“ˆğŸ’°ğŸ“‰â°ğŸ”®ğŸ­ğŸ“¦ğŸ¯]/)) {
                    return `<div class="p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600">${line}</div>`;
                }
                if (line.match(/^#+\s/)) {
                    return `<h4 class="font-bold text-slate-900 dark:text-white mt-3">${line.replace(/^#+\s/, '')}</h4>`;
                }
                if (line.match(/^\d+\.\s/)) {
                    return `<div class="ml-2">${line}</div>`;
                }
                return `<p class="text-slate-600 dark:text-slate-400">${line}</p>`;
            }).join('') + '</div>';
        }

        function generateLocalAnalysis(mode, data) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æ
            const items = [];
            if (data.oldestUnpaidDays > 30) items.push(`<div class="p-2 rounded-lg bg-red-50 dark:bg-red-900/30">ğŸ”´ æ”¯æ‰•ã„${data.oldestUnpaidDays}æ—¥è¶…éã‚ã‚Šã€‚æ—©æ€¥ã«ç¢ºèªã‚’ã€‚</div>`);
            if (data.noShelfCount > 0) items.push(`<div class="p-2 rounded-lg bg-amber-50 dark:bg-amber-900/30">ğŸŸ¡ æ£šç•ªæœªè¨­å®š${data.noShelfCount}ä»¶ã€‚æ•´ç†æ¨å¥¨ã€‚</div>`);
            if (data.staleCount > 0) items.push(`<div class="p-2 rounded-lg bg-amber-50 dark:bg-amber-900/30">ğŸŸ¡ é•·æœŸæ»ç•™${data.staleCount}ä»¶ã€‚å‡ºåº«äºˆå®šç¢ºèªã‚’ã€‚</div>`);
            if (data.nextMonthPayment > 1000000) items.push(`<div class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/30">ğŸŸ¢ æ¥æœˆæ”¯æ‰•ã„äºˆæ¸¬: ç´„Â¥${Math.round(data.nextMonthPayment/10000)}ä¸‡ã€‚è³‡é‡‘æº–å‚™ã‚’ã€‚</div>`);
            return '<div class="space-y-2 text-sm mt-2">' + (items.length > 0 ? items.join('') : '<p class="text-slate-400">ç‰¹ã«å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</p>') + '</div>';
        }

        async function saveToKnowledge() {
            if (!lastAnalysisResult) return;
            
            const summary = lastAnalysisResult.slice(0, 200) + (lastAnalysisResult.length > 200 ? '...' : '');
            const categoryMap = { quick: 'important', detail: 'pattern', cost: 'cost', supplier: 'supplier', forecast: 'pattern' };
            
            const success = await saveKnowledgeItem(
                categoryMap[currentAnalysisMode] || 'note',
                `[${currentAnalysisMode}åˆ†æ] ` + summary,
                'ä¸­',
                '',
                'ai'
            );
            
            if (success) {
                alert('ãƒŠãƒ¬ãƒƒã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸï¼');
                document.getElementById('saveKnowledgeBtn').classList.add('hidden');
            }
        }

        // ========== AIãƒãƒ£ãƒƒãƒˆ ==========
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            chatHistory.push({ role: 'user', content: message });
            updateChatUI();

            const analysisData = prepareAnalysisData();
            const context = `
ã‚ãªãŸã¯èª¿é”ãƒ»åœ¨åº«ç®¡ç†ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ã¦è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

${JSON.stringify(analysisData, null, 2)}

éå»ã®ä¼šè©±:
${chatHistory.slice(-6, -1).map(m => `${m.role}: ${m.content}`).join('\n')}

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•: ${message}

ç°¡æ½”ã«ã€å…·ä½“çš„ãªæ•°å€¤ã‚’å«ã‚ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 800, messages: [{ role: 'user', content: context }] })
                });
                const data = await response.json();
                const reply = data.content?.[0]?.text || 'å›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ';
                chatHistory.push({ role: 'assistant', content: reply });
            } catch (err) {
                chatHistory.push({ role: 'assistant', content: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚' });
            }
            updateChatUI();
        }

        function updateChatUI() {
            const container = document.getElementById('chatHistory');
            container.innerHTML = chatHistory.slice(-10).map(m => `
                <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="chat-msg ${m.role === 'user' ? 'chat-user' : 'chat-ai'}">
                        <p class="text-sm whitespace-pre-wrap">${m.content}</p>
                    </div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        // ========== ãƒŠãƒ¬ãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
        function showKnowledgeModal() {
            document.getElementById('knowledgeModal').classList.remove('hidden');
            renderKnowledgeList('all');
        }

        function closeKnowledgeModal() {
            document.getElementById('knowledgeModal').classList.add('hidden');
        }

        function renderKnowledgeList(filter) {
            const container = document.getElementById('knowledgeList');
            const icons = { important: 'ğŸ“Œ', supplier: 'ğŸ­', cost: 'ğŸ’°', pattern: 'ğŸ“Š', seasonal: 'ğŸ—“ï¸', note: 'ğŸ“' };
            
            let filtered = knowledge;
            if (filter !== 'all') filtered = knowledge.filter(k => k.category === filter);
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center py-8">è©²å½“ã™ã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = [...filtered].reverse().map(k => `
                <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600">
                    <div class="flex items-start gap-2">
                        <span class="text-lg">${icons[k.category] || 'ğŸ“'}</span>
                        <div class="flex-1">
                            <p class="text-sm text-slate-700 dark:text-slate-300">${k.content}</p>
                            <div class="flex items-center gap-2 mt-2 text-xs text-slate-400">
                                <span>${k.date}</span>
                                ${k.tags ? `<span class="px-1.5 py-0.5 bg-slate-200 dark:bg-slate-600 rounded">${k.tags}</span>` : ''}
                                <span class="px-1.5 py-0.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded">${k.source === 'ai' ? 'AI' : 'æ‰‹å‹•'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³æ›´æ–°
            document.querySelectorAll('.knowledge-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
                btn.classList.toggle('bg-blue-100', btn.dataset.filter === filter);
                btn.classList.toggle('dark:bg-blue-900/50', btn.dataset.filter === filter);
                btn.classList.toggle('text-blue-700', btn.dataset.filter === filter);
                btn.classList.toggle('bg-slate-100', btn.dataset.filter !== filter);
                btn.classList.toggle('text-slate-600', btn.dataset.filter !== filter);
            });
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('knowledge-filter')) {
                renderKnowledgeList(e.target.dataset.filter);
            }
        });

        function showAddKnowledgeForm() {
            document.getElementById('addKnowledgeModal').classList.remove('hidden');
        }

        function closeAddKnowledgeModal() {
            document.getElementById('addKnowledgeModal').classList.add('hidden');
        }

        async function addKnowledge() {
            const category = document.getElementById('newKnowledgeCategory').value;
            const content = document.getElementById('newKnowledgeContent').value.trim();
            const tags = document.getElementById('newKnowledgeTags').value.trim();
            
            if (!content) { alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            
            const success = await saveKnowledgeItem(category, content, 'ä¸­', tags, 'manual');
            if (success) {
                closeAddKnowledgeModal();
                renderKnowledgeList('all');
                document.getElementById('newKnowledgeContent').value = '';
                document.getElementById('newKnowledgeTags').value = '';
            }
        }

        // ========== UIæ›´æ–°é–¢æ•°ï¼ˆæ—¢å­˜ï¼‰ ==========
        function updateSummary() {
            const today = new Date(), inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­'), waiting = inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡');
            const inStockValue = inStock.reduce((s, i) => s + (parseInt(i.costJPY) || 0), 0);
            const weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);
            const arrivingThisWeek = projects.filter(p => { if (!p.pickupDate || p.receivedComplete) return false; const d = new Date(p.pickupDate); return d >= today && d <= weekEnd; });
            let unpaidTotal = 0, unpaidCount = 0, urgentCount = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach((d, idx) => { if (!d.paid) { unpaidTotal += d.amountJPY || (d.amountUSD * 150) || 0; unpaidCount++; if (idx === 0 && p.registeredDate && Math.floor((today - new Date(p.registeredDate)) / 86400000) > 30) urgentCount++; } }); });
            const thisMonth = today.toISOString().slice(0, 7); let thisMonthTotal = 0, thisMonthCount = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate && d.paidDate.startsWith(thisMonth)) { thisMonthTotal += d.amountJPY || 0; thisMonthCount++; } }); });
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1).toISOString().slice(0, 7); let lastMonthTotal = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate && d.paidDate.startsWith(lastMonth)) lastMonthTotal += d.amountJPY || 0; }); });
            const momChange = lastMonthTotal > 0 ? Math.round((thisMonthTotal - lastMonthTotal) / lastMonthTotal * 100) : 0;

            document.getElementById('statInStock').textContent = inStock.length + 'ä»¶';
            document.getElementById('statInStockDetail').textContent = `ç·é¡ Â¥${inStockValue.toLocaleString()}`;
            document.getElementById('statWaiting').textContent = waiting.length + 'ä»¶';
            document.getElementById('statWaitingDetail').textContent = arrivingThisWeek.length > 0 ? `ğŸ”¥ ä»Šé€±åˆ°ç€äºˆå®š ${arrivingThisWeek.length}ä»¶` : 'ä»Šé€±ã®åˆ°ç€äºˆå®šãªã—';
            document.getElementById('statUnpaid').textContent = `Â¥${Math.round(unpaidTotal/10000)}ä¸‡`;
            document.getElementById('statUnpaidDetail').textContent = urgentCount > 0 ? `âš ï¸ 30æ—¥è¶…é ${urgentCount}ä»¶` : `${unpaidCount}ä»¶ã®æ”¯æ‰•ã„å¾…ã¡`;
            document.getElementById('statThisMonth').textContent = `Â¥${Math.round(thisMonthTotal/10000)}ä¸‡`;
            document.getElementById('statThisMonthDetail').innerHTML = `${thisMonthCount}ä»¶ / <span class="${momChange >= 0 ? 'text-red-500' : 'text-emerald-500'}">å‰æœˆæ¯” ${momChange >= 0 ? '+' : ''}${momChange}%</span>`;
        }

        function updateTimeline() {
            const today = new Date(); today.setHours(0,0,0,0); const weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);
            const weekEndDisp = new Date(today); weekEndDisp.setDate(weekEndDisp.getDate() + 6);
            document.getElementById('timelineWeek').textContent = `${today.getMonth()+1}/${today.getDate()} - ${weekEndDisp.getMonth()+1}/${weekEndDisp.getDate()}`;
            const events = [];
            projects.forEach(p => {
                if (p.pickupDate && !p.receivedComplete) { const d = new Date(p.pickupDate); if (d >= today && d <= weekEnd) events.push({ date: d, icon: 'ğŸšš', color: 'border-amber-500 bg-amber-100 dark:bg-amber-900/50', title: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')} é›†è·`, detail: p.productName, link: `index.html?project=${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}` }); }
                if (p.registeredDate) { (p.depositSchedule || []).forEach((dep, idx) => { if (dep.paid) return; let due; if (idx === 0) { due = new Date(p.registeredDate); due.setDate(due.getDate() + 7); } else if (p.pickupDate) { due = new Date(p.pickupDate); due.setDate(due.getDate() - 7); } if (due && due >= today && due <= weekEnd) events.push({ date: due, icon: 'ğŸ’°', color: 'border-red-500 bg-red-100 dark:bg-red-900/50', title: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')} æ”¯æ‰•ã„`, detail: `${dep.percentage}% ($${(dep.amountUSD || 0).toLocaleString()})`, link: `index.html?project=${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}` }); }); }
            });
            events.sort((a, b) => a.date - b.date);
            const container = document.getElementById('timeline');
            if (events.length === 0) { container.innerHTML = '<div class="text-center py-8 text-slate-400"><span class="text-4xl">ğŸ“­</span><p class="mt-2">ä»Šé€±ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p></div>'; return; }
            const grouped = {}; events.forEach(e => { const k = e.date.toISOString().split('T')[0]; if (!grouped[k]) grouped[k] = []; grouped[k].push(e); });
            let html = '';
            Object.entries(grouped).forEach(([ds, de]) => {
                const d = new Date(ds), isToday = d.toDateString() === today.toDateString(), dn = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
                html += `<div class="timeline-item"><div class="timeline-dot ${isToday ? 'border-blue-500 bg-blue-500' : 'border-slate-300 bg-white dark:bg-slate-700'}"></div><div class="mb-1"><span class="text-sm font-semibold ${isToday ? 'text-blue-600 dark:text-blue-400' : 'text-slate-600 dark:text-slate-400'}">${d.getMonth()+1}/${d.getDate()} (${dn})${isToday ? ' <span class="ml-1 px-1.5 py-0.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs rounded">ä»Šæ—¥</span>' : ''}</span></div>`;
                de.forEach(e => { html += `<a href="${e.link}" class="block mt-2 p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><div class="flex items-center gap-2"><span class="w-6 h-6 rounded-full ${e.color} flex items-center justify-center text-sm">${e.icon}</span><span class="font-medium text-sm text-slate-900 dark:text-white">${e.title}</span></div><p class="text-xs text-slate-500 dark:text-slate-400 mt-1 ml-8">${e.detail}</p></a>`; });
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function updateHealthCheck() {
            const today = new Date(), checks = [];
            const noShelf = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && !i.shelfNo).length;
            if (noShelf > 0) checks.push({ status: 'warning', icon: 'ğŸ“', text: `æ£šç•ªæœªè¨­å®š ${noShelf}ä»¶`, link: 'inventory.html?noShelf=1' });
            const stale = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && i.receiveDate && Math.floor((today - new Date(i.receiveDate)) / 86400000) >= 60).length;
            if (stale > 0) checks.push({ status: 'warning', icon: 'â°', text: `é•·æœŸæ»ç•™(60æ—¥+) ${stale}ä»¶`, link: 'inventory.html?status=åœ¨åº«ä¸­' });
            let overdueCount = 0; projects.forEach(p => { if (p.registeredDate && (p.depositSchedule || [])[0] && !(p.depositSchedule || [])[0].paid && Math.floor((today - new Date(p.registeredDate)) / 86400000) > 30) overdueCount++; });
            if (overdueCount > 0) checks.push({ status: 'error', icon: 'ğŸš¨', text: `æ”¯æ‰•ã„30æ—¥è¶…é ${overdueCount}ä»¶`, link: 'index.html' });
            const issues = inventory.filter(i => i.status === 'ä¸å…·åˆ').length;
            if (issues > 0) checks.push({ status: 'error', icon: 'ğŸ”´', text: `ä¸å…·åˆåœ¨åº« ${issues}ä»¶`, link: 'inventory.html?status=ä¸å…·åˆ' });
            if (checks.length === 0) checks.push({ status: 'ok', icon: 'âœ…', text: 'å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ' });
            const container = document.getElementById('healthCheck');
            container.innerHTML = checks.map(c => {
                const bg = c.status === 'error' ? 'bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800' : c.status === 'warning' ? 'bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-800' : 'bg-emerald-50 dark:bg-emerald-900/30 border-emerald-200 dark:border-emerald-800';
                const tc = c.status === 'error' ? 'text-red-700 dark:text-red-300' : c.status === 'warning' ? 'text-amber-700 dark:text-amber-300' : 'text-emerald-700 dark:text-emerald-300';
                return c.link ? `<a href="${c.link}" class="block p-3 rounded-lg border ${bg} hover:opacity-80"><div class="flex items-center gap-2"><span>${c.icon}</span><span class="text-sm font-medium ${tc}">${c.text}</span></div></a>` : `<div class="p-3 rounded-lg border ${bg}"><div class="flex items-center gap-2"><span>${c.icon}</span><span class="text-sm font-medium ${tc}">${c.text}</span></div></div>`;
            }).join('');
        }

        function updateQuickActions() {
            const actions = [];
            inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').slice(0, 3).forEach(item => { actions.push({ icon: 'ğŸ“¦', title: `${item.serial} ã‚’å…¥åº«`, detail: item.productName.slice(0, 20), color: 'bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300', link: `inventory.html?search=${item.serial}` }); });
            const unpaidProjects = []; projects.forEach(p => { const u = (p.depositSchedule || []).find(d => !d.paid); if (u && p.registeredDate) unpaidProjects.push({ p, u, d: new Date(p.registeredDate) }); });
            unpaidProjects.sort((a, b) => a.d - b.d).slice(0, 3).forEach(({ p, u }) => { const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}`; actions.push({ icon: 'ğŸ’³', title: `${pn} æ”¯æ‰•ã„`, detail: `${u.percentage}% ($${(u.amountUSD || 0).toLocaleString()})`, color: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300', link: `index.html?project=${pn}` }); });
            const container = document.getElementById('quickActions');
            if (actions.length === 0) { container.innerHTML = '<p class="text-slate-400 text-sm col-span-full text-center py-4">å®Ÿè¡Œå¾…ã¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‰</p>'; return; }
            container.innerHTML = actions.slice(0, 6).map(a => `<a href="${a.link}" class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50"><div class="w-10 h-10 rounded-lg ${a.color} flex items-center justify-center flex-shrink-0"><span class="text-lg">${a.icon}</span></div><div class="min-w-0"><p class="font-medium text-sm text-slate-900 dark:text-white truncate">${a.title}</p><p class="text-xs text-slate-500 dark:text-slate-400 truncate">${a.detail}</p></div></a>`).join('');
        }

        function updateCharts() {
            const now = new Date(), allItems = [...inventory, ...archivedInventory], months = [];
            for (let i = 5; i >= 0; i--) { const d = new Date(now.getFullYear(), now.getMonth() - i, 1); months.push({ key: d.toISOString().slice(0, 7), label: `${d.getMonth() + 1}æœˆ`, receive: 0, ship: 0, payment: 0 }); }
            allItems.forEach(item => { if (item.receiveDate) { const m = months.find(m => m.key === item.receiveDate.slice(0, 7)); if (m) m.receive++; } if (item.shipDate) { const m = months.find(m => m.key === item.shipDate.slice(0, 7)); if (m) m.ship++; } });
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate) { const m = months.find(m => m.key === d.paidDate.slice(0, 7)); if (m) m.payment += d.amountJPY || 0; } }); });
            if (charts.flow) charts.flow.destroy();
            charts.flow = new Chart(document.getElementById('flowChart'), { type: 'line', data: { labels: months.map(m => m.label), datasets: [{ label: 'å…¥åº«', data: months.map(m => m.receive), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3 }, { label: 'å‡ºåº«', data: months.map(m => m.ship), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } } });
            if (charts.payment) charts.payment.destroy();
            charts.payment = new Chart(document.getElementById('paymentChart'), { type: 'bar', data: { labels: months.map(m => m.label), datasets: [{ label: 'æ”¯æ‰•é¡', data: months.map(m => m.payment), backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => 'Â¥' + (v/10000).toFixed(0) + 'ä¸‡' } } } } });
        }

        // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', document.documentElement.classList.contains('dark')); }
        function initDarkMode() { if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); }
        
        window.onload = () => { const s = document.createElement('script'); s.src = 'https://accounts.google.com/gsi/client'; s.onload = init; document.head.appendChild(s); };
    </script>
</body>
</html>
