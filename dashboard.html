<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ヤマトサイネージ支払・在庫・売上管理ダッシュボード">
    <title>YS調達ナビ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%232383e2'/><stop offset='100%25' stop-color='%231a5fb4'/></linearGradient></defs><circle cx='16' cy='16' r='15' fill='url(%23g)'/><polygon points='16,4 18,14 16,16 14,14' fill='%23fff'/><polygon points='16,28 14,18 16,16 18,18' fill='%23fff' opacity='0.6'/><circle cx='16' cy='16' r='2.5' fill='%23fff'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%232383e2'/><polygon points='90,30 100,80 90,90 80,80' fill='%23fff'/><polygon points='90,150 80,100 90,90 100,100' fill='%23fff' opacity='0.6'/><circle cx='90' cy='90' r='12' fill='%23fff'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600&display=swap');
        :root {
            --text: #37352f; --text-sub: rgba(55,53,47,0.65); 
            --bg: #fff; --bg-hover: rgba(55,53,47,0.04); --bg-card: #f7f6f3; --border: rgba(55,53,47,0.09);
            --blue: #2383e2; --blue-bg: #e8f0fe;
            --green: #0f7b6c; --green-bg: #dbeddb;
            --orange: #d9730d; --orange-bg: #faebdd;
            --red: #e03e3e; --red-bg: #fbe4e4;
            --purple: #6940a5; --purple-bg: #eae4f2;
            --yellow: #dfab01; --yellow-bg: #fbf3db;
            --gray: #787774; --gray-bg: #ebeaea;
        }
        .dark {
            --text: rgba(255,255,255,0.9); --text-sub: rgba(255,255,255,0.5);
            --bg: #191919; --bg-hover: rgba(255,255,255,0.03); --bg-card: #252525; --border: rgba(255,255,255,0.08);
            --blue-bg: #1c3a5e; --green-bg: #1e3a32; --orange-bg: #3d2e1e; --red-bg: #3d2828; --purple-bg: #2e2540; --yellow-bg: #3d3526; --gray-bg: #2f2f2f;
        }
        * { font-family: 'Noto Sans JP', -apple-system, sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); }
        .t-sub { color: var(--text-sub); }
        .bg-card { background: var(--bg-card); }
        .border-def { border-color: var(--border); }
        .hover-bg { transition: background 80ms; border-radius: 4px; }
        .hover-bg:hover { background: var(--bg-hover); }
        .btn { padding: 5px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; border: none; transition: opacity 80ms; }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background: var(--blue); color: #fff; }
        .mode-btn { padding: 4px 10px; font-size: 11px; border-radius: 4px; color: var(--text-sub); cursor: pointer; border: none; background: transparent; transition: all 80ms; }
        .mode-btn:hover { background: var(--bg-hover); }
        .mode-btn.active { background: var(--blue-bg); color: var(--blue); }
        input { background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px; padding: 6px 10px; font-size: 12px; }
        input:focus { outline: none; border-color: var(--blue); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        
        .dashboard { display: grid; height: 100vh; grid-template-rows: auto 1fr; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr 300px; grid-template-rows: auto 1fr 1fr; gap: 1px; background: var(--border); padding: 1px; overflow: hidden; }
        .main-grid > * { background: var(--bg); padding: 12px; overflow: hidden; }
        
        .kpi-bar { display: flex; gap: 8px; padding: 10px 12px !important; overflow-x: auto; }
        .kpi { flex: 1; min-width: 90px; padding: 10px; border-radius: 6px; background: var(--bg-card); }
        .kpi-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-bottom: 6px; }
        .kpi-value { font-size: 18px; font-weight: 600; }
        .kpi-label { font-size: 10px; color: var(--text-sub); margin-top: 2px; }
        .kpi-sub { font-size: 10px; margin-top: 4px; }
        
        .mini-table { font-size: 11px; width: 100%; }
        .mini-table th { text-align: left; font-weight: 500; padding: 6px 8px; border-bottom: 1px solid var(--border); color: var(--text-sub); }
        .mini-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
        .mini-table tr:hover { background: var(--bg-hover); }
        
        .tag { display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 500; }
        .tag-red { background: var(--red-bg); color: var(--red); }
        .tag-yellow { background: var(--yellow-bg); color: var(--yellow); }
        .tag-green { background: var(--green-bg); color: var(--green); }
        .tag-blue { background: var(--blue-bg); color: var(--blue); }
        .tag-gray { background: var(--gray-bg); color: var(--gray); }
        
        /* ツールチップ・ポップオーバー */
        .tooltip-container { position: relative; }
        .tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: var(--text); color: var(--bg); padding: 8px 12px; border-radius: 6px;
            font-size: 11px; white-space: nowrap; opacity: 0; pointer-events: none;
            transition: opacity 150ms; z-index: 100; margin-bottom: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            border: 5px solid transparent; border-top-color: var(--text);
        }
        .tooltip-container:hover .tooltip { opacity: 1; }
        
        .popover {
            position: fixed; background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; padding: 12px; min-width: 280px; max-width: 360px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 200;
            font-size: 12px; display: none;
        }
        .popover.show { display: block; }
        .popover-title { font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .popover-content { color: var(--text-sub); line-height: 1.5; }
        .popover-content .insight { background: var(--blue-bg); color: var(--blue); padding: 6px 8px; border-radius: 4px; margin-top: 8px; }
        .popover-content .action { background: var(--green-bg); color: var(--green); padding: 6px 8px; border-radius: 4px; margin-top: 6px; cursor: pointer; }
        .popover-content .warning { background: var(--red-bg); color: var(--red); padding: 6px 8px; border-radius: 4px; margin-top: 6px; }
        
        .kpi { cursor: pointer; transition: transform 80ms, box-shadow 80ms; }
        .kpi:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        @media (max-width: 1024px) {
            .dashboard { height: auto; }
            .main-grid { grid-template-columns: 1fr; grid-template-rows: auto; }
            .main-grid > * { min-height: 200px; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- ヘッダー -->
        <header class="flex items-center justify-between px-4 py-2 border-b border-def">
            <div class="flex items-center gap-2">
                <div class="w-7 h-7 rounded-lg flex items-center justify-center" style="background:var(--blue-bg)">
                    <i data-lucide="compass" class="w-4 h-4" style="color:var(--blue)"></i>
                </div>
                <span class="font-semibold">YS調達ナビ</span>
                <span class="t-sub text-xs" id="lastUpdate"></span>
            </div>
            <div class="flex items-center gap-1 text-xs">
                <a href="index.html" class="hover-bg p-1.5 sm:px-2 sm:py-1.5 t-sub flex items-center gap-1" title="支払ナビ">
                    <i data-lucide="credit-card" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">支払</span>
                </a>
                <a href="inventory.html" class="hover-bg p-1.5 sm:px-2 sm:py-1.5 t-sub flex items-center gap-1" title="在庫ナビ">
                    <i data-lucide="package" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">在庫</span>
                </a>
                <button onclick="loadData()" class="hover-bg p-1.5 t-sub" title="更新"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                <button onclick="toggleDarkMode()" class="hover-bg p-1.5 t-sub" title="ダークモード"><i data-lucide="moon" class="w-4 h-4"></i></button>
                <button onclick="signOut()" class="hover-bg p-1.5 t-sub" title="サインアウト"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </header>

        <!-- ログイン -->
        <div id="loginSection" class="flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4" style="background:var(--blue-bg)">
                    <i data-lucide="compass" class="w-8 h-8" style="color:var(--blue)"></i>
                </div>
                <p class="text-sm mb-4">Googleアカウントでログイン</p>
                <button onclick="handleAuth()" class="btn btn-primary px-5 py-2">ログイン</button>
            </div>
        </div>

        <!-- メイン -->
        <div id="mainContent" class="main-grid hidden">
            
            <!-- KPIバー -->
            <div class="kpi-bar" style="grid-column: 1 / -1;">
                <div class="kpi" onclick="showKpiPopover(event, 'inStock')">
                    <div class="kpi-icon" style="background:var(--blue-bg)"><i data-lucide="package" class="w-4 h-4" style="color:var(--blue)"></i></div>
                    <div class="kpi-value" id="kpiInStock">-</div>
                    <div class="kpi-label">在庫中</div>
                    <div class="kpi-sub t-sub" id="kpiInStockSub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'waiting')">
                    <div class="kpi-icon" style="background:var(--orange-bg)"><i data-lucide="truck" class="w-4 h-4" style="color:var(--orange)"></i></div>
                    <div class="kpi-value" id="kpiWaiting">-</div>
                    <div class="kpi-label">入庫待ち</div>
                    <div class="kpi-sub" style="color:var(--orange)" id="kpiWaitingSub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'unpaid')">
                    <div class="kpi-icon" style="background:var(--red-bg)"><i data-lucide="wallet" class="w-4 h-4" style="color:var(--red)"></i></div>
                    <div class="kpi-value" id="kpiUnpaid">-</div>
                    <div class="kpi-label">未払い</div>
                    <div class="kpi-sub t-sub" id="kpiUnpaidSub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'payment')">
                    <div class="kpi-icon" style="background:var(--green-bg)"><i data-lucide="credit-card" class="w-4 h-4" style="color:var(--green)"></i></div>
                    <div class="kpi-value" id="kpiThisMonth">-</div>
                    <div class="kpi-label">今月支払</div>
                    <div class="kpi-sub" id="kpiThisMonthSub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'stay')">
                    <div class="kpi-icon" style="background:var(--purple-bg)"><i data-lucide="clock" class="w-4 h-4" style="color:var(--purple)"></i></div>
                    <div class="kpi-value" id="kpiAvgStay">-</div>
                    <div class="kpi-label">平均滞留</div>
                    <div class="kpi-sub" id="kpiAvgStaySub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'turnover')">
                    <div class="kpi-icon" style="background:var(--yellow-bg)"><i data-lucide="refresh-cw" class="w-4 h-4" style="color:var(--yellow)"></i></div>
                    <div class="kpi-value" id="kpiTurnover">-</div>
                    <div class="kpi-label">回転率</div>
                    <div class="kpi-sub t-sub">回/月</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'sales')">
                    <div class="kpi-icon" style="background:var(--green-bg)"><i data-lucide="bar-chart-2" class="w-4 h-4" style="color:var(--green)"></i></div>
                    <div class="kpi-value" id="kpiSales7">-</div>
                    <div class="kpi-label">7期売上</div>
                    <div class="kpi-sub" id="kpiSales7Sub">-</div>
                </div>
                <div class="kpi" onclick="showKpiPopover(event, 'overdue')">
                    <div class="kpi-icon" style="background:var(--red-bg)"><i data-lucide="alert-triangle" class="w-4 h-4" style="color:var(--red)"></i></div>
                    <div class="kpi-value" id="kpiOverdue">-</div>
                    <div class="kpi-label">支払遅延</div>
                    <div class="kpi-sub" id="kpiOverdueSub">-</div>
                </div>
                <div class="kpi" style="background:var(--bg);cursor:default">
                    <div class="flex items-center gap-1 mb-2"><i data-lucide="activity" class="w-4 h-4" style="color:var(--green)"></i><span class="text-xs font-medium">ヘルス</span></div>
                    <div id="healthMini" class="text-xs space-y-1"></div>
                </div>
            </div>

            <!-- AI分析 -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded flex items-center justify-center" style="background:var(--purple-bg)">
                            <i data-lucide="sparkles" class="w-3.5 h-3.5" style="color:var(--purple)"></i>
                        </div>
                        <span class="font-medium text-sm">AI分析</span>
                    </div>
                    <div class="flex gap-1">
                        <button class="mode-btn active" data-mode="quick" onclick="setMode('quick')">クイック</button>
                        <button class="mode-btn" data-mode="detail" onclick="setMode('detail')">詳細</button>
                        <button class="mode-btn" data-mode="cost" onclick="setMode('cost')">コスト</button>
                        <button class="mode-btn" data-mode="sales" onclick="setMode('sales')">売上</button>
                        <button class="mode-btn" data-mode="supplier" onclick="setMode('supplier')">サプライヤー</button>
                    </div>
                </div>
                <div id="analysisResult" class="flex-1 bg-card rounded-lg p-3 text-xs overflow-auto mb-2">
                    <p class="t-sub">「分析」をクリック</p>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="質問を入力..." class="flex-1" onkeypress="if(event.key==='Enter')sendChat()">
                    <button onclick="runAnalysis()" class="btn btn-primary">分析</button>
                    <button onclick="sendChat()" class="btn" style="background:var(--gray);color:#fff">送信</button>
                </div>
            </div>

            <!-- グラフ2つ（売上） -->
            <div class="grid grid-cols-2 gap-3">
                <div class="cursor-pointer hover:opacity-80 transition-opacity" onclick="analyzeChart('salesTrend')">
                    <div class="flex items-center gap-1 mb-2">
                        <i data-lucide="trending-up" class="w-3.5 h-3.5" style="color:var(--green)"></i>
                        <span class="text-xs font-medium">売上推移（6ヶ月）</span>
                        <i data-lucide="sparkles" class="w-3 h-3 t-sub ml-auto" title="クリックでAI分析"></i>
                    </div>
                    <div class="h-28"><canvas id="salesChart"></canvas></div>
                </div>
                <div class="cursor-pointer hover:opacity-80 transition-opacity" onclick="analyzeChart('salesCategory')">
                    <div class="flex items-center gap-1 mb-2">
                        <i data-lucide="pie-chart" class="w-3.5 h-3.5" style="color:var(--purple)"></i>
                        <span class="text-xs font-medium">カテゴリ別売上</span>
                        <i data-lucide="sparkles" class="w-3 h-3 t-sub ml-auto" title="クリックでAI分析"></i>
                    </div>
                    <div class="h-28"><canvas id="salesCategoryChart"></canvas></div>
                </div>
            </div>

            <!-- スケジュール -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded flex items-center justify-center" style="background:var(--blue-bg)">
                            <i data-lucide="calendar" class="w-3.5 h-3.5" style="color:var(--blue)"></i>
                        </div>
                        <span class="font-medium text-sm">今週</span>
                    </div>
                    <span class="text-xs t-sub" id="weekRange"></span>
                </div>
                <div id="timeline" class="flex-1 overflow-auto text-xs space-y-1"></div>
            </div>

            <!-- 未払い一覧 -->
            <div class="flex flex-col">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-6 h-6 rounded flex items-center justify-center" style="background:var(--red-bg)">
                        <i data-lucide="wallet" class="w-3.5 h-3.5" style="color:var(--red)"></i>
                    </div>
                    <span class="font-medium text-sm">未払い一覧</span>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="mini-table">
                        <thead><tr><th>案件</th><th>金額</th><th>経過</th><th>状態</th></tr></thead>
                        <tbody id="unpaidTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- グラフ2つ -->
            <div class="grid grid-cols-2 gap-3">
                <div class="cursor-pointer hover:opacity-80 transition-opacity" onclick="analyzeChart('paymentForecast')">
                    <div class="flex items-center gap-1 mb-2">
                        <i data-lucide="bar-chart-2" class="w-3.5 h-3.5" style="color:var(--green)"></i>
                        <span class="text-xs font-medium">支払い予定（4週）</span>
                        <i data-lucide="sparkles" class="w-3 h-3 t-sub ml-auto" title="クリックでAI分析"></i>
                    </div>
                    <div class="h-28"><canvas id="forecastChart"></canvas></div>
                </div>
                <div class="cursor-pointer hover:opacity-80 transition-opacity" onclick="analyzeChart('inventoryFlow')">
                    <div class="flex items-center gap-1 mb-2">
                        <i data-lucide="trending-up" class="w-3.5 h-3.5" style="color:var(--purple)"></i>
                        <span class="text-xs font-medium">入出庫推移</span>
                        <i data-lucide="sparkles" class="w-3 h-3 t-sub ml-auto" title="クリックでAI分析"></i>
                    </div>
                    <div class="h-28"><canvas id="flowChart"></canvas></div>
                </div>
            </div>

            <!-- 滞留 & アクション -->
            <div class="flex flex-col gap-3">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-5 h-5 rounded flex items-center justify-center" style="background:var(--yellow-bg)">
                            <i data-lucide="clock" class="w-3 h-3" style="color:var(--yellow)"></i>
                        </div>
                        <span class="font-medium text-xs">長期滞留</span>
                    </div>
                    <div id="staleList" class="text-xs space-y-1 overflow-auto" style="max-height:90px"></div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-5 h-5 rounded flex items-center justify-center" style="background:var(--green-bg)">
                            <i data-lucide="zap" class="w-3 h-3" style="color:var(--green)"></i>
                        </div>
                        <span class="font-medium text-xs">クイックアクション</span>
                    </div>
                    <div id="quickActions" class="text-xs space-y-1 overflow-auto" style="max-height:90px"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- ポップオーバー -->
    <div id="popover" class="popover">
        <div class="popover-title"><i data-lucide="info" class="w-4 h-4"></i><span id="popoverTitle">-</span></div>
        <div class="popover-content" id="popoverContent"></div>
    </div>

    <!-- 設定ボタン -->
    <div id="settingsBtn" class="fixed bottom-4 left-4 hidden">
        <button onclick="showSettingsModal()" class="flex items-center gap-2 px-3 py-2 rounded-lg shadow-lg text-sm hover:opacity-90 bg-card border border-def">
            <i data-lucide="settings" class="w-4 h-4 t-sub"></i>
            <span class="t-sub">設定</span>
        </button>
    </div>

    <!-- 設定モーダル -->
    <div id="settingsModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
        <div class="rounded-lg max-w-md w-full overflow-hidden flex flex-col" style="background:var(--bg)">
            <div class="p-3 flex justify-between items-center border-b border-def">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded flex items-center justify-center" style="background:var(--gray-bg)">
                        <i data-lucide="settings" class="w-3.5 h-3.5" style="color:var(--gray)"></i>
                    </div>
                    <span class="font-medium text-sm">設定</span>
                </div>
                <button onclick="closeSettingsModal()" class="hover-bg p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-medium block mb-1">Anthropic APIキー</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-..." class="w-full text-sm">
                    <p class="text-xs t-sub mt-1">AI分析機能に必要です。<a href="https://console.anthropic.com/" target="_blank" class="underline" style="color:var(--blue)">取得はこちら</a></p>
                </div>
                <div id="apiKeyStatus" class="text-xs"></div>
            </div>
            <div class="p-3 border-t border-def flex justify-end gap-2">
                <button onclick="closeSettingsModal()" class="btn" style="background:var(--gray-bg);color:var(--text)">キャンセル</button>
                <button onclick="saveApiKey()" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- ナレッジボタン -->
    <div id="knowledgeBtn" class="fixed bottom-4 right-4 hidden">
        <button onclick="showKnowledgeModal()" class="flex items-center gap-2 px-3 py-2 rounded-lg shadow-lg text-sm hover:opacity-90" style="background:var(--purple);color:#fff">
            <i data-lucide="book-open" class="w-4 h-4"></i>
            <span>ナレッジ</span>
            <span class="px-1.5 py-0.5 rounded text-xs" style="background:rgba(255,255,255,0.2)" id="knowledgeCount">0</span>
        </button>
    </div>

    <!-- ナレッジモーダル -->
    <div id="knowledgeModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
        <div class="rounded-lg max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col" style="background:var(--bg)">
            <div class="p-3 flex justify-between items-center border-b border-def">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded flex items-center justify-center" style="background:var(--purple-bg)">
                        <i data-lucide="book-open" class="w-3.5 h-3.5" style="color:var(--purple)"></i>
                    </div>
                    <span class="font-medium text-sm">ナレッジ</span>
                </div>
                <button onclick="closeKnowledgeModal()" class="hover-bg p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div id="knowledgeList" class="flex-1 overflow-auto p-3 space-y-2 text-sm"></div>
            <div class="p-3 border-t border-def">
                <div class="flex gap-2">
                    <input type="text" id="newKnowledge" placeholder="新しいナレッジを追加..." class="flex-1 text-sm">
                    <button onclick="addKnowledge()" class="btn btn-primary">追加</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        let accessToken = null, inventory = [], archivedInventory = [], projects = [], suppliers = [], knowledge = [], salesData = [];
        let charts = {}, currentMode = 'quick';
        let apiKey = localStorage.getItem('anthropicApiKey') || '';
        
        // 売上データ（6期・7期）
        const SALES_RAW_DATA = [
            // 6期 2024年7月〜2025年6月
            {period:'6期',month:'2024-07',category:'マルチディスプレイ',amount:4638400},
            {period:'6期',month:'2024-07',category:'液晶ディスプレイ(屋外)',amount:4409800},
            {period:'6期',month:'2024-07',category:'液晶ディスプレイ(屋内)',amount:912000},
            {period:'6期',month:'2024-07',category:'LEDビジョン',amount:263000},
            {period:'6期',month:'2024-07',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2024-07',category:'レンタル',amount:497550},
            {period:'6期',month:'2024-07',category:'その他',amount:1132700},
            {period:'6期',month:'2024-08',category:'マルチディスプレイ',amount:4618700},
            {period:'6期',month:'2024-08',category:'液晶ディスプレイ(屋外)',amount:2278670},
            {period:'6期',month:'2024-08',category:'液晶ディスプレイ(屋内)',amount:472800},
            {period:'6期',month:'2024-08',category:'LEDビジョン',amount:0},
            {period:'6期',month:'2024-08',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2024-08',category:'レンタル',amount:497550},
            {period:'6期',month:'2024-08',category:'その他',amount:658000},
            {period:'6期',month:'2024-09',category:'マルチディスプレイ',amount:6371600},
            {period:'6期',month:'2024-09',category:'液晶ディスプレイ(屋外)',amount:4151850},
            {period:'6期',month:'2024-09',category:'液晶ディスプレイ(屋内)',amount:1263500},
            {period:'6期',month:'2024-09',category:'LEDビジョン',amount:424000},
            {period:'6期',month:'2024-09',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2024-09',category:'レンタル',amount:497550},
            {period:'6期',month:'2024-09',category:'その他',amount:163400},
            {period:'6期',month:'2024-10',category:'マルチディスプレイ',amount:14377550},
            {period:'6期',month:'2024-10',category:'液晶ディスプレイ(屋外)',amount:1189000},
            {period:'6期',month:'2024-10',category:'液晶ディスプレイ(屋内)',amount:1549450},
            {period:'6期',month:'2024-10',category:'LEDビジョン',amount:3943600},
            {period:'6期',month:'2024-10',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2024-10',category:'レンタル',amount:564550},
            {period:'6期',month:'2024-10',category:'その他',amount:4329500},
            {period:'6期',month:'2024-11',category:'マルチディスプレイ',amount:2508000},
            {period:'6期',month:'2024-11',category:'液晶ディスプレイ(屋外)',amount:3125000},
            {period:'6期',month:'2024-11',category:'液晶ディスプレイ(屋内)',amount:1608500},
            {period:'6期',month:'2024-11',category:'LEDビジョン',amount:3600000},
            {period:'6期',month:'2024-11',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2024-11',category:'レンタル',amount:590400},
            {period:'6期',month:'2024-11',category:'その他',amount:615081},
            {period:'6期',month:'2024-12',category:'マルチディスプレイ',amount:2272600},
            {period:'6期',month:'2024-12',category:'液晶ディスプレイ(屋外)',amount:4912500},
            {period:'6期',month:'2024-12',category:'液晶ディスプレイ(屋内)',amount:0},
            {period:'6期',month:'2024-12',category:'LEDビジョン',amount:8018000},
            {period:'6期',month:'2024-12',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2024-12',category:'レンタル',amount:564550},
            {period:'6期',month:'2024-12',category:'その他',amount:1912400},
            {period:'6期',month:'2025-01',category:'マルチディスプレイ',amount:5888600},
            {period:'6期',month:'2025-01',category:'液晶ディスプレイ(屋外)',amount:0},
            {period:'6期',month:'2025-01',category:'液晶ディスプレイ(屋内)',amount:0},
            {period:'6期',month:'2025-01',category:'LEDビジョン',amount:0},
            {period:'6期',month:'2025-01',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2025-01',category:'レンタル',amount:590200},
            {period:'6期',month:'2025-01',category:'その他',amount:2430950},
            {period:'6期',month:'2025-02',category:'マルチディスプレイ',amount:10515000},
            {period:'6期',month:'2025-02',category:'液晶ディスプレイ(屋外)',amount:16768000},
            {period:'6期',month:'2025-02',category:'液晶ディスプレイ(屋内)',amount:2808000},
            {period:'6期',month:'2025-02',category:'LEDビジョン',amount:0},
            {period:'6期',month:'2025-02',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2025-02',category:'レンタル',amount:855700},
            {period:'6期',month:'2025-02',category:'その他',amount:5633600},
            {period:'6期',month:'2025-03',category:'マルチディスプレイ',amount:24491800},
            {period:'6期',month:'2025-03',category:'液晶ディスプレイ(屋外)',amount:13100700},
            {period:'6期',month:'2025-03',category:'液晶ディスプレイ(屋内)',amount:4173340},
            {period:'6期',month:'2025-03',category:'LEDビジョン',amount:0},
            {period:'6期',month:'2025-03',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2025-03',category:'レンタル',amount:1105450},
            {period:'6期',month:'2025-03',category:'その他',amount:4537025},
            {period:'6期',month:'2025-04',category:'マルチディスプレイ',amount:11374400},
            {period:'6期',month:'2025-04',category:'液晶ディスプレイ(屋外)',amount:2429500},
            {period:'6期',month:'2025-04',category:'液晶ディスプレイ(屋内)',amount:0},
            {period:'6期',month:'2025-04',category:'LEDビジョン',amount:8966600},
            {period:'6期',month:'2025-04',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2025-04',category:'レンタル',amount:650100},
            {period:'6期',month:'2025-04',category:'その他',amount:737850},
            {period:'6期',month:'2025-05',category:'マルチディスプレイ',amount:8712000},
            {period:'6期',month:'2025-05',category:'液晶ディスプレイ(屋外)',amount:0},
            {period:'6期',month:'2025-05',category:'液晶ディスプレイ(屋内)',amount:0},
            {period:'6期',month:'2025-05',category:'LEDビジョン',amount:4941000},
            {period:'6期',month:'2025-05',category:'STUDIA(電子黒板)',amount:0},
            {period:'6期',month:'2025-05',category:'レンタル',amount:650100},
            {period:'6期',month:'2025-05',category:'その他',amount:137250},
            {period:'6期',month:'2025-06',category:'マルチディスプレイ',amount:16854000},
            {period:'6期',month:'2025-06',category:'液晶ディスプレイ(屋外)',amount:23601980},
            {period:'6期',month:'2025-06',category:'液晶ディスプレイ(屋内)',amount:2253000},
            {period:'6期',month:'2025-06',category:'LEDビジョン',amount:7223900},
            {period:'6期',month:'2025-06',category:'STUDIA(電子黒板)',amount:537800},
            {period:'6期',month:'2025-06',category:'レンタル',amount:650100},
            {period:'6期',month:'2025-06',category:'その他',amount:2383950},
            // 7期 2025年7月〜
            {period:'7期',month:'2025-07',category:'マルチディスプレイ',amount:9185000},
            {period:'7期',month:'2025-07',category:'液晶ディスプレイ(屋外)',amount:3776000},
            {period:'7期',month:'2025-07',category:'液晶ディスプレイ(屋内)',amount:0},
            {period:'7期',month:'2025-07',category:'LEDビジョン',amount:3359000},
            {period:'7期',month:'2025-07',category:'STUDIA(電子黒板)',amount:1126000},
            {period:'7期',month:'2025-07',category:'レンタル',amount:650100},
            {period:'7期',month:'2025-07',category:'その他',amount:1511750},
            {period:'7期',month:'2025-08',category:'マルチディスプレイ',amount:0},
            {period:'7期',month:'2025-08',category:'液晶ディスプレイ(屋外)',amount:1603000},
            {period:'7期',month:'2025-08',category:'液晶ディスプレイ(屋内)',amount:0},
            {period:'7期',month:'2025-08',category:'LEDビジョン',amount:358000},
            {period:'7期',month:'2025-08',category:'STUDIA(電子黒板)',amount:3924240},
            {period:'7期',month:'2025-08',category:'レンタル',amount:650100},
            {period:'7期',month:'2025-08',category:'その他',amount:4249250},
            {period:'7期',month:'2025-09',category:'マルチディスプレイ',amount:4692640},
            {period:'7期',month:'2025-09',category:'液晶ディスプレイ(屋外)',amount:773000},
            {period:'7期',month:'2025-09',category:'液晶ディスプレイ(屋内)',amount:283800},
            {period:'7期',month:'2025-09',category:'LEDビジョン',amount:4000000},
            {period:'7期',month:'2025-09',category:'STUDIA(電子黒板)',amount:537800},
            {period:'7期',month:'2025-09',category:'レンタル',amount:650100},
            {period:'7期',month:'2025-09',category:'その他',amount:2302750},
            {period:'7期',month:'2025-10',category:'マルチディスプレイ',amount:9579564},
            {period:'7期',month:'2025-10',category:'液晶ディスプレイ(屋外)',amount:2735000},
            {period:'7期',month:'2025-10',category:'液晶ディスプレイ(屋内)',amount:395000},
            {period:'7期',month:'2025-10',category:'LEDビジョン',amount:0},
            {period:'7期',month:'2025-10',category:'STUDIA(電子黒板)',amount:11516700},
            {period:'7期',month:'2025-10',category:'レンタル',amount:361600},
            {period:'7期',month:'2025-10',category:'その他',amount:6681527}
        ];
        
        // カラーパレット
        const colors = {
            blue: '#2383e2', green: '#0f7b6c', orange: '#d9730d', red: '#e03e3e', purple: '#6940a5', yellow: '#dfab01', gray: '#787774',
            chart: ['#2383e2', '#0f7b6c', '#d9730d', '#6940a5', '#dfab01']
        };

        function init() {
            initDarkMode(); lucide.createIcons();
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
                const t = sessionStorage.getItem('googleAccessToken');
                if (t) { accessToken = t; gapi.client.setToken({ access_token: accessToken }); showMain(); loadData(); }
            });
        }

        function handleAuth() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (r) => { if (r.access_token) { accessToken = r.access_token; sessionStorage.setItem('googleAccessToken', accessToken); gapi.client.setToken({ access_token: accessToken }); showMain(); loadData(); } }
            }).requestAccessToken();
        }

        function showMain() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('knowledgeBtn').classList.remove('hidden');
            document.getElementById('settingsBtn').classList.remove('hidden');
            lucide.createIcons();
        }

        // 設定モーダル
        function showSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('apiKeyInput').value = apiKey;
            updateApiKeyStatus();
            lucide.createIcons();
        }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); }
        function saveApiKey() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('anthropicApiKey', apiKey);
            updateApiKeyStatus();
            closeSettingsModal();
        }
        function updateApiKeyStatus() {
            const el = document.getElementById('apiKeyStatus');
            if (apiKey) {
                el.innerHTML = '<span class="tag tag-green">✓ APIキー設定済み</span>';
            } else {
                el.innerHTML = '<span class="tag tag-yellow">APIキー未設定</span>';
            }
        }

        async function loadData() {
            if (!accessToken) return;
            try {
                const [supRes, prjRes, invRes] = await Promise.all([
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'サプライヤー!A2:C' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: '案件!A2:N' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: '在庫!A2:Q' })
                ]);
                suppliers = (supRes.result.values || []).map(r => ({ id: parseInt(r[0] || 0), name: r[1] || '' }));
                projects = (prjRes.result.values || []).map(r => ({ id: r[0], projectPrefix: r[1] || 'AD', projectNumber: parseInt(r[2]) || 0, supplierId: parseInt(r[3] || 0), productName: r[4] || '', totalAmount: parseFloat(r[5] || 0), depositSchedule: JSON.parse(r[6] || '[]'), pickupDate: r[10] || '', registeredDate: r[11] || '', receivedComplete: r[13] === 'true' }));
                inventory = (invRes.result.values || []).map(r => ({ serial: r[1] || '', category: r[2] || '', productName: r[3] || '', receiveDate: r[7] || '', status: r[8] || '', shipDate: r[9] || '', costJPY: r[12] || '', shelfNo: r[14] || '', supplierId: r[16] || '' }));
                try { const a = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: '在庫アーカイブ!A2:Q' }); archivedInventory = (a.result.values || []).map(r => ({ receiveDate: r[7] || '', shipDate: r[9] || '', category: r[2] || '' })); } catch { archivedInventory = []; }
                await loadKnowledge();
                updateAll();
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            } catch (e) { console.error(e); }
        }

        async function loadKnowledge() {
            try {
                const r = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'ナレッジ!A2:F' });
                knowledge = (r.result.values || []).map((v, i) => ({ id: i + 2, date: v[0] || '', category: v[1] || 'note', content: v[2] || '' }));
            } catch { knowledge = []; }
            document.getElementById('knowledgeCount').textContent = knowledge.length;
        }

        function updateAll() {
            updateKPIs(); updateTimeline(); updateUnpaidTable(); updateStaleList(); updateQuickActions(); updateCharts();
            lucide.createIcons();
        }

        function updateKPIs() {
            const today = new Date();
            const inStock = inventory.filter(i => i.status === '在庫中');
            const waiting = inventory.filter(i => i.status === '入庫待ち');
            const inStockValue = inStock.reduce((s, i) => s + (parseInt(i.costJPY) || 0), 0);

            const we = new Date(today); we.setDate(we.getDate() + 7);
            const arrivingThisWeek = projects.filter(p => p.pickupDate && !p.receivedComplete && new Date(p.pickupDate) >= today && new Date(p.pickupDate) <= we).length;

            let unpaidTotal = 0, unpaidCount = 0, overdueCount = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach((d, i) => {
                    if (!d.paid) {
                        unpaidTotal += d.amountJPY || (d.amountUSD * 150) || 0;
                        unpaidCount++;
                        if (i === 0 && p.registeredDate && Math.floor((today - new Date(p.registeredDate)) / 86400000) > 30) overdueCount++;
                    }
                });
            });

            const tm = today.toISOString().slice(0, 7);
            const lm = new Date(today.getFullYear(), today.getMonth() - 1, 1).toISOString().slice(0, 7);
            let thisMonthTotal = 0, lastMonthTotal = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach(d => {
                    if (d.paid && d.paidDate) {
                        if (d.paidDate.startsWith(tm)) thisMonthTotal += d.amountJPY || 0;
                        if (d.paidDate.startsWith(lm)) lastMonthTotal += d.amountJPY || 0;
                    }
                });
            });
            const momChange = lastMonthTotal > 0 ? Math.round((thisMonthTotal - lastMonthTotal) / lastMonthTotal * 100) : 0;

            const stayDays = inStock.filter(i => i.receiveDate).map(i => Math.floor((today - new Date(i.receiveDate)) / 86400000));
            const avgStay = stayDays.length ? Math.round(stayDays.reduce((a, b) => a + b, 0) / stayDays.length) : 0;
            const stayChange = 0; // 簡略化

            const thisMonthShipped = [...inventory, ...archivedInventory].filter(i => i.shipDate && i.shipDate.startsWith(tm)).length;
            const turnover = ((thisMonthShipped / (inStock.length || 1))).toFixed(1);

            const noShelf = inStock.filter(i => !i.shelfNo).length;
            const stale60 = stayDays.filter(d => d >= 60).length;
            let healthHtml = '';
            if (overdueCount > 0) healthHtml += `<div class="tag tag-red">支払遅延 ${overdueCount}</div>`;
            if (noShelf > 0) healthHtml += `<div class="tag tag-yellow">棚番未設定 ${noShelf}</div>`;
            if (stale60 > 0) healthHtml += `<div class="tag tag-yellow">長期滞留 ${stale60}</div>`;
            if (!healthHtml) healthHtml = '<div class="tag tag-green">問題なし</div>';

            // 7期売上集計
            const sales7 = SALES_RAW_DATA.filter(s => s.period === '7期').reduce((a, s) => a + s.amount, 0);
            const sales7Months = SALES_RAW_DATA.filter(s => s.period === '7期').map(s => s.month);
            const uniqueMonths7 = [...new Set(sales7Months)].length;

            document.getElementById('kpiInStock').textContent = inStock.length + '件';
            document.getElementById('kpiInStockSub').textContent = '¥' + (inStockValue / 10000).toFixed(0) + '万';
            document.getElementById('kpiWaiting').textContent = waiting.length + '件';
            document.getElementById('kpiWaitingSub').textContent = arrivingThisWeek > 0 ? `今週${arrivingThisWeek}件` : '-';
            document.getElementById('kpiUnpaid').textContent = '¥' + Math.round(unpaidTotal / 10000) + '万';
            document.getElementById('kpiUnpaidSub').textContent = unpaidCount + '件';
            document.getElementById('kpiThisMonth').textContent = '¥' + Math.round(thisMonthTotal / 10000) + '万';
            document.getElementById('kpiThisMonthSub').innerHTML = `<span class="tag ${momChange >= 0 ? 'tag-red' : 'tag-green'}">${momChange >= 0 ? '+' : ''}${momChange}%</span>`;
            document.getElementById('kpiAvgStay').textContent = avgStay + '日';
            document.getElementById('kpiAvgStaySub').innerHTML = avgStay > 45 ? '<span class="tag tag-yellow">長め</span>' : '<span class="tag tag-green">良好</span>';
            document.getElementById('kpiTurnover').textContent = turnover;
            document.getElementById('kpiSales7').textContent = '¥' + (sales7 / 10000).toFixed(0) + '万';
            document.getElementById('kpiSales7Sub').textContent = uniqueMonths7 + 'ヶ月経過';
            document.getElementById('kpiOverdue').textContent = overdueCount + '件';
            document.getElementById('kpiOverdueSub').innerHTML = overdueCount > 0 ? '<span class="tag tag-red">要対応</span>' : '<span class="tag tag-gray">-</span>';
            document.getElementById('healthMini').innerHTML = healthHtml;
        }

        function updateTimeline() {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const we = new Date(today); we.setDate(we.getDate() + 7);
            const wed = new Date(today); wed.setDate(wed.getDate() + 6);
            document.getElementById('weekRange').textContent = `${today.getMonth() + 1}/${today.getDate()}-${wed.getMonth() + 1}/${wed.getDate()}`;

            const events = [];
            projects.forEach(p => {
                const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4, '0')}`;
                if (p.pickupDate && !p.receivedComplete) {
                    const d = new Date(p.pickupDate);
                    if (d >= today && d <= we) events.push({ date: d, type: 'pickup', title: pn, sub: p.productName.slice(0, 12) });
                }
                if (p.registeredDate) {
                    (p.depositSchedule || []).forEach((dep, i) => {
                        if (dep.paid) return;
                        let due;
                        if (i === 0) { due = new Date(p.registeredDate); due.setDate(due.getDate() + 7); }
                        else if (p.pickupDate) { due = new Date(p.pickupDate); due.setDate(due.getDate() - 7); }
                        if (due && due >= today && due <= we) events.push({ date: due, type: 'payment', title: pn, sub: `${dep.percentage}%` });
                    });
                }
            });
            events.sort((a, b) => a.date - b.date);

            const c = document.getElementById('timeline');
            if (!events.length) { c.innerHTML = '<p class="t-sub text-center py-4">今週の予定なし</p>'; return; }
            
            const dn = ['日', '月', '火', '水', '木', '金', '土'];
            c.innerHTML = events.slice(0, 8).map(e => {
                const isToday = e.date.toDateString() === today.toDateString();
                const color = e.type === 'pickup' ? colors.orange : colors.red;
                const icon = e.type === 'pickup' ? 'truck' : 'wallet';
                return `<div class="flex items-center gap-2 hover-bg p-1.5 rounded ${isToday ? 'bg-card' : ''}">
                    <span class="w-12 text-right ${isToday ? 'font-medium' : 't-sub'}">${e.date.getMonth() + 1}/${e.date.getDate()}(${dn[e.date.getDay()]})</span>
                    <div class="w-5 h-5 rounded flex items-center justify-center" style="background:${color}20"><i data-lucide="${icon}" class="w-3 h-3" style="color:${color}"></i></div>
                    <span class="font-medium">${e.title}</span>
                    <span class="t-sub truncate flex-1">${e.sub}</span>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function updateUnpaidTable() {
            const today = new Date();
            const unpaid = [];
            projects.forEach(p => {
                const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4, '0')}`;
                (p.depositSchedule || []).forEach((d, i) => {
                    if (!d.paid) {
                        const days = p.registeredDate ? Math.floor((today - new Date(p.registeredDate)) / 86400000) : 0;
                        unpaid.push({ pn, amount: d.amountUSD || 0, days, overdue: i === 0 && days > 30 });
                    }
                });
            });
            unpaid.sort((a, b) => b.days - a.days);

            const tbody = document.getElementById('unpaidTable');
            tbody.innerHTML = unpaid.slice(0, 6).map(u => `
                <tr>
                    <td class="font-medium">${u.pn}</td>
                    <td>$${u.amount.toLocaleString()}</td>
                    <td>${u.days}日</td>
                    <td><span class="tag ${u.overdue ? 'tag-red' : 'tag-green'}">${u.overdue ? '遅延' : 'OK'}</span></td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="text-center t-sub py-4">未払いなし</td></tr>';
        }

        function updateStaleList() {
            const today = new Date();
            const stale = inventory.filter(i => i.status === '在庫中' && i.receiveDate)
                .map(i => ({ serial: i.serial, days: Math.floor((today - new Date(i.receiveDate)) / 86400000), cat: i.category }))
                .filter(i => i.days >= 45)
                .sort((a, b) => b.days - a.days);

            const c = document.getElementById('staleList');
            if (!stale.length) { c.innerHTML = '<p class="t-sub text-center py-2">長期滞留なし ✓</p>'; return; }
            c.innerHTML = stale.slice(0, 5).map(s => `
                <div class="flex items-center gap-2 hover-bg p-1.5 rounded">
                    <span class="font-medium" style="color:var(--orange)">${s.serial}</span>
                    <span class="tag ${s.days >= 60 ? 'tag-red' : 'tag-yellow'}">${s.days}日</span>
                    <span class="t-sub truncate">${s.cat}</span>
                </div>
            `).join('');
        }

        function updateQuickActions() {
            const actions = [];
            inventory.filter(i => i.status === '入庫待ち').slice(0, 3).forEach(i => {
                actions.push({ icon: 'package', color: colors.blue, title: i.serial, sub: '入庫処理', link: `inventory.html?search=${i.serial}` });
            });
            const today = new Date();
            const unpaidProjects = [];
            projects.forEach(p => {
                const u = (p.depositSchedule || []).find(d => !d.paid);
                if (u && p.registeredDate) unpaidProjects.push({ p, u, d: new Date(p.registeredDate) });
            });
            unpaidProjects.sort((a, b) => a.d - b.d).slice(0, 3).forEach(({ p, u }) => {
                const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4, '0')}`;
                actions.push({ icon: 'credit-card', color: colors.green, title: pn, sub: `${u.percentage}%支払`, link: `index.html?project=${pn}` });
            });

            const c = document.getElementById('quickActions');
            if (!actions.length) { c.innerHTML = '<p class="t-sub text-center py-2">アクションなし ✓</p>'; return; }
            c.innerHTML = actions.slice(0, 5).map(a => `
                <a href="${a.link}" class="flex items-center gap-2 hover-bg p-1.5 rounded">
                    <div class="w-5 h-5 rounded flex items-center justify-center" style="background:${a.color}20">
                        <i data-lucide="${a.icon}" class="w-3 h-3" style="color:${a.color}"></i>
                    </div>
                    <span class="font-medium">${a.title}</span>
                    <span class="t-sub">${a.sub}</span>
                </a>
            `).join('');
            lucide.createIcons();
        }

        function updateCharts() {
            const today = new Date();
            const inStock = inventory.filter(i => i.status === '在庫中');
            const defaultOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

            // 売上推移（直近6ヶ月）
            const salesMonths = [];
            for (let i = 5; i >= 0; i--) { 
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1); 
                salesMonths.push({ key: d.toISOString().slice(0, 7), label: `${d.getMonth() + 1}月`, total: 0 }); 
            }
            SALES_RAW_DATA.forEach(s => {
                const m = salesMonths.find(m => m.key === s.month);
                if (m) m.total += s.amount;
            });
            if (charts.sales) charts.sales.destroy();
            charts.sales = new Chart(document.getElementById('salesChart'), {
                type: 'bar',
                data: { labels: salesMonths.map(m => m.label), datasets: [{ data: salesMonths.map(m => m.total), backgroundColor: colors.green, borderRadius: 3 }] },
                options: { ...defaultOpts, scales: { x: { grid: { display: false }, ticks: { font: { size: 10 } } }, y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 10 }, callback: v => (v / 10000000).toFixed(0) + '千万' } } } }
            });

            // カテゴリ別売上（直近6ヶ月合計）
            const salesCatData = {};
            const recentMonths = salesMonths.map(m => m.key);
            SALES_RAW_DATA.filter(s => recentMonths.includes(s.month)).forEach(s => {
                const cat = s.category.replace('液晶ディスプレイ', '液晶').replace('STUDIA(電子黒板)', '電子黒板');
                salesCatData[cat] = (salesCatData[cat] || 0) + s.amount;
            });
            const salesCatLabels = Object.keys(salesCatData).sort((a, b) => salesCatData[b] - salesCatData[a]).slice(0, 5);
            const salesCatValues = salesCatLabels.map(l => salesCatData[l]);
            if (charts.salesCategory) charts.salesCategory.destroy();
            charts.salesCategory = new Chart(document.getElementById('salesCategoryChart'), {
                type: 'doughnut',
                data: { labels: salesCatLabels, datasets: [{ data: salesCatValues, backgroundColor: colors.chart }] },
                options: { ...defaultOpts, cutout: '55%', plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 8, padding: 4, font: { size: 9 } } } } }
            });

            // 支払い予定
            const weeks = [];
            for (let i = 0; i < 4; i++) {
                const ws = new Date(today); ws.setDate(ws.getDate() + i * 7);
                const we = new Date(ws); we.setDate(we.getDate() + 6);
                weeks.push({ label: `${i + 1}週`, start: ws, end: we, total: 0 });
            }
            projects.forEach(p => {
                (p.depositSchedule || []).forEach((d, i) => {
                    if (d.paid) return;
                    let due;
                    if (i === 0 && p.registeredDate) { due = new Date(p.registeredDate); due.setDate(due.getDate() + 14); }
                    else if (p.pickupDate) { due = new Date(p.pickupDate); }
                    if (due) { const w = weeks.find(w => due >= w.start && due <= w.end); if (w) w.total += d.amountJPY || (d.amountUSD * 150) || 0; }
                });
            });
            if (charts.forecast) charts.forecast.destroy();
            charts.forecast = new Chart(document.getElementById('forecastChart'), {
                type: 'bar',
                data: { labels: weeks.map(w => w.label), datasets: [{ data: weeks.map(w => w.total), backgroundColor: colors.green, borderRadius: 3 }] },
                options: { ...defaultOpts, scales: { x: { grid: { display: false }, ticks: { font: { size: 10 } } }, y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 10 }, callback: v => '¥' + (v / 10000).toFixed(0) + '万' } } } }
            });

            // 入出庫推移
            const months = [];
            for (let i = 5; i >= 0; i--) { const d = new Date(today.getFullYear(), today.getMonth() - i, 1); months.push({ key: d.toISOString().slice(0, 7), label: `${d.getMonth() + 1}月`, receive: 0, ship: 0 }); }
            [...inventory, ...archivedInventory].forEach(item => {
                if (item.receiveDate) { const m = months.find(m => m.key === item.receiveDate.slice(0, 7)); if (m) m.receive++; }
                if (item.shipDate) { const m = months.find(m => m.key === item.shipDate.slice(0, 7)); if (m) m.ship++; }
            });
            if (charts.flow) charts.flow.destroy();
            charts.flow = new Chart(document.getElementById('flowChart'), {
                type: 'line',
                data: {
                    labels: months.map(m => m.label),
                    datasets: [
                        { label: '入庫', data: months.map(m => m.receive), borderColor: colors.blue, backgroundColor: colors.blue + '20', fill: true, tension: 0.3, pointRadius: 3, borderWidth: 2 },
                        { label: '出庫', data: months.map(m => m.ship), borderColor: colors.purple, backgroundColor: 'transparent', tension: 0.3, pointRadius: 3, borderWidth: 2 }
                    ]
                },
                options: { ...defaultOpts, scales: { x: { grid: { display: false }, ticks: { font: { size: 10 } } }, y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 10 } } } }, plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 10, padding: 8, font: { size: 10 } } } } }
            });
        }

        // AI分析
        function setMode(m) {
            currentMode = m;
            document.querySelectorAll('.mode-btn[data-mode]').forEach(b => b.classList.toggle('active', b.dataset.mode === m));
        }

        async function runAnalysis() {
            const el = document.getElementById('analysisResult');
            if (!apiKey) {
                el.innerHTML = '<p class="t-sub">APIキーを設定してください → <button onclick="showSettingsModal()" class="underline" style="color:var(--blue)">設定</button></p>';
                return;
            }
            el.innerHTML = '<p class="t-sub"><i data-lucide="loader-2" class="w-4 h-4 inline animate-spin mr-1"></i>分析中...</p>';
            lucide.createIcons();
            const d = prepareData();
            const prompts = {
                quick: '今すぐ対応すべき3〜5項目を優先度順に。売上・在庫・支払いの観点から。形式: ● 高/中/低 タイトル: 内容',
                detail: '1. 現状サマリー（売上・在庫・支払い） 2. リスク・課題 3. 改善案 を簡潔に',
                cost: '1. キャッシュフロー状況 2. 来月支払い予測 3. コスト削減提案',
                supplier: '1. サプライヤー依存度リスク 2. 各社評価 3. 戦略提案',
                sales: '1. 売上トレンド分析 2. カテゴリ別成長率 3. 来月予測と在庫推奨'
            };
            const prompt = `支払・在庫・売上データ: ${JSON.stringify(d)}\n\nナレッジ: ${knowledge.map(k => k.content).join('; ')}\n\n${prompts[currentMode]}\n\n日本語で簡潔に。現在は7期（2025年7月〜）です。`;
            try {
                const r = await fetch('https://api.anthropic.com/v1/messages', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    }, 
                    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 800, messages: [{ role: 'user', content: prompt }] }) 
                });
                if (!r.ok) {
                    const err = await r.json();
                    throw new Error(err.error?.message || 'API Error');
                }
                const j = await r.json();
                const text = j.content?.[0]?.text || '';
                el.innerHTML = text.split('\n').filter(l => l.trim()).map(l => {
                    if (l.includes('● 高')) return `<div class="mb-1.5 p-1.5 rounded" style="background:var(--red-bg)">${l}</div>`;
                    if (l.includes('● 中')) return `<div class="mb-1.5 p-1.5 rounded" style="background:var(--yellow-bg)">${l}</div>`;
                    if (l.includes('● 低')) return `<div class="mb-1.5 p-1.5 rounded" style="background:var(--green-bg)">${l}</div>`;
                    return `<div class="mb-1">${l}</div>`;
                }).join('');
            } catch (e) { el.innerHTML = `<p style="color:var(--red)">エラー: ${e.message}</p>`; }
        }

        async function sendChat() {
            const inp = document.getElementById('chatInput');
            const msg = inp.value.trim();
            if (!msg) return;
            const el = document.getElementById('analysisResult');
            if (!apiKey) {
                el.innerHTML = '<p class="t-sub">APIキーを設定してください → <button onclick="showSettingsModal()" class="underline" style="color:var(--blue)">設定</button></p>';
                return;
            }
            inp.value = '';
            el.innerHTML = '<p class="t-sub"><i data-lucide="loader-2" class="w-4 h-4 inline animate-spin mr-1"></i>回答中...</p>';
            lucide.createIcons();
            const d = prepareData();
            try {
                const r = await fetch('https://api.anthropic.com/v1/messages', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    }, 
                    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 500, messages: [{ role: 'user', content: `データ: ${JSON.stringify(d)}\n\n質問: ${msg}\n\n簡潔に回答。` }] }) 
                });
                if (!r.ok) {
                    const err = await r.json();
                    throw new Error(err.error?.message || 'API Error');
                }
                const j = await r.json();
                el.innerHTML = (j.content?.[0]?.text || 'エラー').split('\n').map(l => `<div class="mb-1">${l}</div>`).join('');
            } catch (e) { el.innerHTML = `<p style="color:var(--red)">エラー: ${e.message}</p>`; }
        }

        function prepareData() {
            const today = new Date();
            const inStock = inventory.filter(i => i.status === '在庫中');
            let ut = 0, uc = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (!d.paid) { ut += d.amountJPY || (d.amountUSD * 150) || 0; uc++; } }); });
            const supplierStats = {};
            projects.forEach(p => { const n = suppliers.find(s => s.id === p.supplierId)?.name || '他'; supplierStats[n] = (supplierStats[n] || 0) + p.totalAmount; });
            const categoryStats = {};
            inStock.forEach(i => { categoryStats[i.category] = (categoryStats[i.category] || 0) + 1; });
            
            // 売上データ集計（直近6ヶ月）
            const salesMonths = [];
            for (let i = 5; i >= 0; i--) { 
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                salesMonths.push(d.toISOString().slice(0, 7));
            }
            const salesByCategory = {};
            const salesByMonth = {};
            SALES_RAW_DATA.filter(s => salesMonths.includes(s.month)).forEach(s => {
                salesByCategory[s.category] = (salesByCategory[s.category] || 0) + s.amount;
                salesByMonth[s.month] = (salesByMonth[s.month] || 0) + s.amount;
            });
            const totalSales6m = Object.values(salesByMonth).reduce((a, b) => a + b, 0);
            
            // 7期売上（今期）
            const sales7 = SALES_RAW_DATA.filter(s => s.period === '7期').reduce((a, s) => a + s.amount, 0);
            
            return { 
                inStock: inStock.length, 
                waiting: inventory.filter(i => i.status === '入庫待ち').length, 
                unpaid: uc, 
                unpaidTotal: ut, 
                supplierStats, 
                categoryStats,
                salesByCategory,
                salesByMonth,
                totalSales6m,
                sales7期: sales7,
                currentPeriod: '7期',
                currentMonth: today.toISOString().slice(0, 7)
            };
        }

        // ナレッジ
        function showKnowledgeModal() { document.getElementById('knowledgeModal').classList.remove('hidden'); renderKnowledgeList(); lucide.createIcons(); }
        function closeKnowledgeModal() { document.getElementById('knowledgeModal').classList.add('hidden'); }
        function renderKnowledgeList() {
            const icons = { important: 'pin', supplier: 'factory', cost: 'coins', pattern: 'bar-chart-2', note: 'file-text' };
            const iconColors = { important: colors.red, supplier: colors.orange, cost: colors.green, pattern: colors.purple, note: colors.gray };
            const c = document.getElementById('knowledgeList');
            if (!knowledge.length) { c.innerHTML = '<p class="t-sub text-center py-8">ナレッジなし</p>'; return; }
            c.innerHTML = [...knowledge].reverse().map(k => `
                <div class="hover-bg p-2 rounded flex items-start gap-2">
                    <div class="w-5 h-5 rounded flex items-center justify-center flex-shrink-0" style="background:${iconColors[k.category] || colors.gray}20">
                        <i data-lucide="${icons[k.category] || 'file-text'}" class="w-3 h-3" style="color:${iconColors[k.category] || colors.gray}"></i>
                    </div>
                    <div><p>${k.content}</p><p class="text-xs t-sub mt-1">${k.date}</p></div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        async function addKnowledge() {
            const inp = document.getElementById('newKnowledge');
            const content = inp.value.trim();
            if (!content) return;
            try {
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'ナレッジ!A:F', valueInputOption: 'RAW', resource: { values: [[new Date().toISOString().split('T')[0], 'note', content, '中', '', 'manual']] } });
                inp.value = '';
                await loadKnowledge();
                renderKnowledgeList();
            } catch (e) { console.error(e); }
        }

        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', document.documentElement.classList.contains('dark')); }
        function initDarkMode() { if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); }
        function signOut() {
            if (confirm('サインアウトしますか？')) {
                sessionStorage.removeItem('googleAccessToken');
                accessToken = null;
                google.accounts.oauth2.revoke(sessionStorage.getItem('googleAccessToken'), () => {});
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('knowledgeBtn').classList.add('hidden');
                document.getElementById('settingsBtn').classList.add('hidden');
                document.getElementById('loginSection').classList.remove('hidden');
            }
        }

        // グラフクリックでAI分析
        async function analyzeChart(chartType) {
            if (!apiKey) {
                alert('APIキーを設定してください（左下の設定ボタン）');
                return;
            }
            
            const el = document.getElementById('analysisResult');
            el.innerHTML = '<p class="t-sub"><i data-lucide="loader-2" class="w-4 h-4 inline animate-spin mr-1"></i>グラフを分析中...</p>';
            lucide.createIcons();
            
            const d = prepareData();
            let prompt = '';
            
            switch(chartType) {
                case 'salesTrend':
                    prompt = `売上推移データ: ${JSON.stringify(d.salesByMonth)}\n\n直近6ヶ月の売上トレンドを分析して、1)傾向 2)異常値 3)来月予測 を簡潔に。`;
                    break;
                case 'salesCategory':
                    prompt = `カテゴリ別売上: ${JSON.stringify(d.salesByCategory)}\n\nカテゴリ別の売上構成を分析して、1)主力カテゴリ 2)成長カテゴリ 3)在庫への示唆 を簡潔に。`;
                    break;
                case 'paymentForecast':
                    prompt = `未払い件数: ${d.unpaid}件、未払い総額: ¥${d.unpaidTotal}、サプライヤー別: ${JSON.stringify(d.supplierStats)}\n\n今後4週間の支払い予測とキャッシュフロー管理のアドバイスを簡潔に。`;
                    break;
                case 'inventoryFlow':
                    prompt = `在庫中: ${d.inStock}件、入庫待ち: ${d.waiting}件、カテゴリ: ${JSON.stringify(d.categoryStats)}\n\n入出庫の傾向を分析して、1)回転率評価 2)滞留リスク 3)発注推奨 を簡潔に。`;
                    break;
            }
            
            try {
                const r = await fetch('https://api.anthropic.com/v1/messages', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    }, 
                    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 400, messages: [{ role: 'user', content: prompt + '\n\n日本語で簡潔に。' }] }) 
                });
                if (!r.ok) throw new Error('API Error');
                const j = await r.json();
                el.innerHTML = `<div class="mb-2 text-xs font-medium" style="color:var(--purple)">📊 グラフ分析結果</div>` + 
                    (j.content?.[0]?.text || '').split('\n').map(l => `<div class="mb-1">${l}</div>`).join('');
            } catch (e) { 
                el.innerHTML = `<p style="color:var(--red)">エラー: ${e.message}</p>`; 
            }
        }

        // ポップオーバー
        let currentPopover = null;
        function showKpiPopover(event, type) {
            event.stopPropagation();
            const popover = document.getElementById('popover');
            const titleEl = document.getElementById('popoverTitle');
            const contentEl = document.getElementById('popoverContent');
            
            const today = new Date();
            const inStock = inventory.filter(i => i.status === '在庫中');
            const waiting = inventory.filter(i => i.status === '入庫待ち');
            
            let title = '', content = '';
            
            switch(type) {
                case 'inStock':
                    const catBreakdown = {};
                    inStock.forEach(i => { catBreakdown[i.category] = (catBreakdown[i.category] || 0) + 1; });
                    const topCats = Object.entries(catBreakdown).sort((a,b) => b[1] - a[1]).slice(0, 3);
                    title = '📦 在庫中 詳細';
                    content = `<div><strong>${inStock.length}件</strong>の在庫があります</div>
                        <div class="mt-2">カテゴリ内訳:</div>
                        ${topCats.map(([cat, cnt]) => `<div>・${cat}: ${cnt}件</div>`).join('')}
                        <div class="insight">💡 ${topCats[0] ? topCats[0][0] + 'が最も多い' : '在庫なし'}</div>`;
                    break;
                case 'waiting':
                    const thisWeek = new Date(today); thisWeek.setDate(thisWeek.getDate() + 7);
                    const arriving = projects.filter(p => p.pickupDate && !p.receivedComplete && new Date(p.pickupDate) <= thisWeek);
                    title = '🚚 入庫待ち 詳細';
                    content = `<div><strong>${waiting.length}件</strong>が入庫待ち</div>
                        <div class="mt-2">今週到着予定: ${arriving.length}件</div>
                        ${arriving.slice(0, 3).map(p => `<div>・${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}: ${p.productName.slice(0,15)}</div>`).join('')}
                        ${arriving.length > 0 ? '<div class="action" onclick="window.location.href=\'inventory.html\'">→ 入庫処理へ</div>' : '<div class="insight">💡 今週の到着予定なし</div>'}`;
                    break;
                case 'unpaid':
                    let unpaidList = [];
                    projects.forEach(p => {
                        (p.depositSchedule || []).forEach((d, i) => {
                            if (!d.paid) {
                                const days = p.registeredDate ? Math.floor((today - new Date(p.registeredDate)) / 86400000) : 0;
                                unpaidList.push({ pn: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}`, days, amount: d.amountUSD || 0 });
                            }
                        });
                    });
                    unpaidList.sort((a,b) => b.days - a.days);
                    const overdue = unpaidList.filter(u => u.days > 30);
                    title = '💰 未払い 詳細';
                    content = `<div><strong>${unpaidList.length}件</strong>の未払いあり</div>
                        ${overdue.length > 0 ? `<div class="warning">⚠ ${overdue.length}件が30日超過</div>` : '<div class="insight">✓ 30日超過なし</div>'}
                        <div class="mt-2">経過日数TOP3:</div>
                        ${unpaidList.slice(0,3).map(u => `<div>・${u.pn}: ${u.days}日 ($${u.amount})</div>`).join('')}`;
                    break;
                case 'payment':
                    const tm = today.toISOString().slice(0, 7);
                    let thisMonthPaid = 0, thisMonthCount = 0;
                    projects.forEach(p => {
                        (p.depositSchedule || []).forEach(d => {
                            if (d.paid && d.paidDate && d.paidDate.startsWith(tm)) {
                                thisMonthPaid += d.amountJPY || 0;
                                thisMonthCount++;
                            }
                        });
                    });
                    title = '💳 今月支払い 詳細';
                    content = `<div>今月の支払い実績</div>
                        <div class="mt-2"><strong>¥${(thisMonthPaid/10000).toFixed(0)}万</strong> (${thisMonthCount}件)</div>
                        <div class="insight">💡 月末に向けて支払い予定を確認</div>`;
                    break;
                case 'stay':
                    const stayDays = inStock.filter(i => i.receiveDate).map(i => ({ serial: i.serial, days: Math.floor((today - new Date(i.receiveDate)) / 86400000), cat: i.category }));
                    const longStay = stayDays.filter(s => s.days >= 60).sort((a,b) => b.days - a.days);
                    const avgStay = stayDays.length ? Math.round(stayDays.reduce((a,b) => a + b.days, 0) / stayDays.length) : 0;
                    title = '⏱ 滞留日数 詳細';
                    content = `<div>平均滞留: <strong>${avgStay}日</strong></div>
                        ${longStay.length > 0 ? `<div class="warning">⚠ 60日超え: ${longStay.length}件</div>` : '<div class="insight">✓ 長期滞留なし</div>'}
                        ${longStay.slice(0,3).map(s => `<div>・${s.serial}: ${s.days}日</div>`).join('')}
                        ${longStay.length > 0 ? '<div class="action" onclick="window.location.href=\'inventory.html\'">→ 在庫確認へ</div>' : ''}`;
                    break;
                case 'turnover':
                    const thisMonthShipped = [...inventory, ...archivedInventory].filter(i => i.shipDate && i.shipDate.startsWith(today.toISOString().slice(0,7))).length;
                    const turnover = (thisMonthShipped / (inStock.length || 1)).toFixed(2);
                    title = '🔄 回転率 詳細';
                    content = `<div>今月の回転率: <strong>${turnover}回</strong></div>
                        <div class="mt-2">・今月出庫: ${thisMonthShipped}件</div>
                        <div>・現在在庫: ${inStock.length}件</div>
                        <div class="insight">💡 回転率1.0以上が理想的</div>`;
                    break;
                case 'sales':
                    const sales7 = SALES_RAW_DATA.filter(s => s.period === '7期');
                    const total7 = sales7.reduce((a,s) => a + s.amount, 0);
                    const byCat = {};
                    sales7.forEach(s => { byCat[s.category] = (byCat[s.category] || 0) + s.amount; });
                    const topSales = Object.entries(byCat).sort((a,b) => b[1] - a[1]).slice(0, 3);
                    title = '📈 7期売上 詳細';
                    content = `<div>7期累計: <strong>¥${(total7/10000).toFixed(0)}万</strong></div>
                        <div class="mt-2">カテゴリTOP3:</div>
                        ${topSales.map(([cat, amt]) => `<div>・${cat.replace('液晶ディスプレイ','液晶')}: ¥${(amt/10000).toFixed(0)}万</div>`).join('')}
                        <div class="insight">💡 電子黒板が急成長中！</div>`;
                    break;
                case 'overdue':
                    let overdueList = [];
                    projects.forEach(p => {
                        (p.depositSchedule || []).forEach((d, i) => {
                            if (!d.paid && i === 0 && p.registeredDate) {
                                const days = Math.floor((today - new Date(p.registeredDate)) / 86400000);
                                if (days > 30) overdueList.push({ pn: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}`, days, supplier: suppliers.find(s => s.id === p.supplierId)?.name || '不明' });
                            }
                        });
                    });
                    title = '⚠ 支払遅延 詳細';
                    content = overdueList.length > 0 
                        ? `<div class="warning">⚠ ${overdueList.length}件が30日超過</div>
                           ${overdueList.slice(0,3).map(o => `<div>・${o.pn}: ${o.days}日 (${o.supplier})</div>`).join('')}
                           <div class="action" onclick="window.location.href='index.html'">→ 支払い処理へ</div>`
                        : '<div class="insight">✓ 支払い遅延なし</div>';
                    break;
            }
            
            titleEl.textContent = title;
            contentEl.innerHTML = content;
            
            // 位置調整
            const rect = event.target.closest('.kpi').getBoundingClientRect();
            popover.style.top = (rect.bottom + 8) + 'px';
            popover.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';
            popover.classList.add('show');
            currentPopover = popover;
            lucide.createIcons();
        }
        
        // ポップオーバーを閉じる
        document.addEventListener('click', (e) => {
            const popover = document.getElementById('popover');
            if (currentPopover && !popover.contains(e.target) && !e.target.closest('.kpi')) {
                popover.classList.remove('show');
                currentPopover = null;
            }
        });

        window.onload = () => { const s = document.createElement('script'); s.src = 'https://accounts.google.com/gsi/client'; s.onload = init; document.head.appendChild(s); };
    </script>
</body>
</html>
