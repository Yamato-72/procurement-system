<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSèª¿é”ãƒŠãƒ“</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2337352f' stroke-width='2'><circle cx='12' cy='12' r='10'/><polygon points='16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600&display=swap');
        :root { --text: #37352f; --text-sub: rgba(55,53,47,0.65); --bg: #fff; --bg-hover: rgba(55,53,47,0.04); --bg-card: #f7f6f3; --border: rgba(55,53,47,0.09); --accent: #2383e2; --green: #0f7b6c; --red: #eb5757; --yellow: #dfab01; }
        .dark { --text: rgba(255,255,255,0.9); --text-sub: rgba(255,255,255,0.5); --bg: #191919; --bg-hover: rgba(255,255,255,0.03); --bg-card: #252525; --border: rgba(255,255,255,0.08); }
        * { font-family: 'Noto Sans JP', -apple-system, sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); }
        .t-sub { color: var(--text-sub); }
        .bg-card { background: var(--bg-card); }
        .border-def { border-color: var(--border); }
        .hover-bg { transition: background 80ms; border-radius: 3px; }
        .hover-bg:hover { background: var(--bg-hover); }
        .btn { padding: 4px 10px; border-radius: 3px; font-size: 12px; transition: opacity 80ms; cursor: pointer; border: none; }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background: var(--accent); color: #fff; }
        .mode-btn { padding: 3px 8px; font-size: 11px; border-radius: 3px; color: var(--text-sub); transition: all 80ms; cursor: pointer; border: none; background: transparent; }
        .mode-btn:hover { background: var(--bg-hover); }
        .mode-btn.active { background: rgba(35,131,226,0.1); color: var(--accent); }
        input { background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 3px; padding: 6px 8px; font-size: 12px; }
        input:focus { outline: none; border-color: var(--accent); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        
        /* ãƒ•ãƒ«ç”»é¢ã‚°ãƒªãƒƒãƒ‰ */
        .dashboard { display: grid; height: 100vh; grid-template-rows: auto 1fr; gap: 0; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr 280px; grid-template-rows: auto 1fr 1fr; gap: 1px; background: var(--border); padding: 1px; overflow: hidden; }
        .main-grid > * { background: var(--bg); padding: 12px; overflow: hidden; }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .mini-table { font-size: 11px; width: 100%; }
        .mini-table th { text-align: left; font-weight: 500; padding: 4px 6px; border-bottom: 1px solid var(--border); }
        .mini-table td { padding: 4px 6px; border-bottom: 1px solid var(--border); }
        .mini-table tr:hover { background: var(--bg-hover); }
        
        /* KPIã‚«ãƒ¼ãƒ‰ */
        .kpi { text-align: center; padding: 8px !important; }
        .kpi-value { font-size: 20px; font-weight: 600; }
        .kpi-label { font-size: 10px; color: var(--text-sub); }
        .kpi-sub { font-size: 10px; margin-top: 2px; }
        
        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 1024px) {
            .dashboard { height: auto; }
            .main-grid { grid-template-columns: 1fr; grid-template-rows: auto; }
            .main-grid > * { min-height: 200px; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="flex items-center justify-between px-4 py-2 border-b border-def">
            <div class="flex items-center gap-2">
                <i data-lucide="compass" class="w-5 h-5"></i>
                <span class="font-semibold">YSèª¿é”ãƒŠãƒ“</span>
                <span class="t-sub text-xs" id="lastUpdate"></span>
            </div>
            <div class="flex items-center gap-1 text-xs">
                <a href="index.html" class="hover-bg px-2 py-1 t-sub">èª¿é”</a>
                <a href="inventory.html" class="hover-bg px-2 py-1 t-sub">åœ¨åº«</a>
                <button onclick="loadData()" class="hover-bg p-1.5 t-sub"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                <button onclick="toggleDarkMode()" class="hover-bg p-1.5 t-sub"><i data-lucide="moon" class="w-4 h-4"></i></button>
            </div>
        </header>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
        <div id="loginSection" class="flex items-center justify-center">
            <div class="text-center">
                <i data-lucide="compass" class="w-12 h-12 mx-auto mb-3 stroke-1"></i>
                <p class="text-sm mb-4">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</p>
                <button onclick="handleAuth()" class="btn btn-primary px-4 py-2">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚°ãƒªãƒƒãƒ‰ -->
        <div id="mainContent" class="main-grid hidden">
            
            <!-- Row 1: KPIãƒãƒ¼ -->
            <div class="col-span-3 flex gap-1 p-2 overflow-x-auto" style="grid-column: 1 / -1;">
                <div class="kpi flex-1 min-w-0">
                    <div class="kpi-label">åœ¨åº«ä¸­</div>
                    <div class="kpi-value" id="kpiInStock">-</div>
                    <div class="kpi-sub t-sub" id="kpiInStockSub">-</div>
                </div>
                <div class="kpi flex-1 min-w-0">
                    <div class="kpi-label">å…¥åº«å¾…ã¡</div>
                    <div class="kpi-value" id="kpiWaiting">-</div>
                    <div class="kpi-sub" style="color:var(--yellow)" id="kpiWaitingSub">-</div>
                </div>
                <div class="kpi flex-1 min-w-0">
                    <div class="kpi-label">æœªæ‰•ã„</div>
                    <div class="kpi-value" id="kpiUnpaid">-</div>
                    <div class="kpi-sub t-sub" id="kpiUnpaidSub">-</div>
                </div>
                <div class="kpi flex-1 min-w-0">
                    <div class="kpi-label">ä»Šæœˆæ”¯æ‰•</div>
                    <div class="kpi-value" id="kpiThisMonth">-</div>
                    <div class="kpi-sub" id="kpiThisMonthSub">-</div>
                </div>
                <div class="kpi flex-1 min-w-0">
                    <div class="kpi-label">å¹³å‡æ»ç•™</div>
                    <div class="kpi-value" id="kpiAvgStay">-</div>
                    <div class="kpi-sub" id="kpiAvgStaySub">-</div>
                </div>
                <div class="kpi flex-1 min-w-0">
                    <div class="kpi-label">å›è»¢ç‡</div>
                    <div class="kpi-value" id="kpiTurnover">-</div>
                    <div class="kpi-sub t-sub">å›/æœˆ</div>
                </div>
                <div class="kpi flex-1 min-w-0">
                    <div class="kpi-label">é…å»¶</div>
                    <div class="kpi-value" id="kpiOverdue">-</div>
                    <div class="kpi-sub" style="color:var(--red)" id="kpiOverdueSub">-</div>
                </div>
                <div class="kpi flex-1 min-w-0 bg-card rounded" style="padding:6px !important">
                    <div class="kpi-label">ãƒ˜ãƒ«ã‚¹</div>
                    <div id="healthMini" class="text-xs mt-1"></div>
                </div>
            </div>

            <!-- Row 2 Col 1: AIåˆ†æ -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-1">
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                        <span class="font-medium text-sm">AIåˆ†æ</span>
                    </div>
                    <div class="flex gap-1">
                        <button class="mode-btn active" data-mode="quick" onclick="setMode('quick')">ã‚¯ã‚¤ãƒƒã‚¯</button>
                        <button class="mode-btn" data-mode="detail" onclick="setMode('detail')">è©³ç´°</button>
                        <button class="mode-btn" data-mode="cost" onclick="setMode('cost')">ã‚³ã‚¹ãƒˆ</button>
                        <button class="mode-btn" data-mode="supplier" onclick="setMode('supplier')">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</button>
                    </div>
                </div>
                <div id="analysisResult" class="flex-1 bg-card rounded p-2 text-xs overflow-auto mb-2">
                    <p class="t-sub">ã€Œåˆ†æã€ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                </div>
                <div class="flex gap-1">
                    <input type="text" id="chatInput" placeholder="è³ªå•..." class="flex-1 text-xs" onkeypress="if(event.key==='Enter')sendChat()">
                    <button onclick="runAnalysis()" class="btn btn-primary">åˆ†æ</button>
                    <button onclick="sendChat()" class="btn" style="background:var(--text);color:var(--bg)">é€ä¿¡</button>
                </div>
            </div>

            <!-- Row 2 Col 2: ã‚°ãƒ©ãƒ•2ã¤ -->
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <p class="text-xs font-medium mb-1">ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥</p>
                    <div class="h-28"><canvas id="supplierChart"></canvas></div>
                </div>
                <div>
                    <p class="text-xs font-medium mb-1">ã‚«ãƒ†ã‚´ãƒªåˆ¥åœ¨åº«</p>
                    <div class="h-28"><canvas id="categoryChart"></canvas></div>
                </div>
            </div>

            <!-- Row 2 Col 3: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
            <div class="flex flex-col">
                <div class="flex items-center gap-1 mb-2">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span class="font-medium text-sm">ä»Šé€±</span>
                    <span class="t-sub text-xs" id="weekRange"></span>
                </div>
                <div id="timeline" class="flex-1 overflow-auto text-xs space-y-1"></div>
            </div>

            <!-- Row 3 Col 1: æœªæ‰•ã„ä¸€è¦§ -->
            <div class="flex flex-col">
                <div class="flex items-center gap-1 mb-2">
                    <i data-lucide="wallet" class="w-4 h-4"></i>
                    <span class="font-medium text-sm">æœªæ‰•ã„ä¸€è¦§</span>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="mini-table">
                        <thead><tr><th>æ¡ˆä»¶</th><th>é‡‘é¡</th><th>çµŒé</th><th></th></tr></thead>
                        <tbody id="unpaidTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Row 3 Col 2: ã‚°ãƒ©ãƒ•2ã¤ -->
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <p class="text-xs font-medium mb-1">æ”¯æ‰•ã„äºˆå®šï¼ˆ4é€±ï¼‰</p>
                    <div class="h-28"><canvas id="forecastChart"></canvas></div>
                </div>
                <div>
                    <p class="text-xs font-medium mb-1">å…¥å‡ºåº«æ¨ç§»</p>
                    <div class="h-28"><canvas id="flowChart"></canvas></div>
                </div>
            </div>

            <!-- Row 3 Col 3: æ»ç•™ & ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="flex flex-col gap-2">
                <div class="flex-1">
                    <div class="flex items-center gap-1 mb-1">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        <span class="font-medium text-xs">é•·æœŸæ»ç•™</span>
                    </div>
                    <div id="staleList" class="text-xs space-y-1 overflow-auto" style="max-height:80px"></div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-1 mb-1">
                        <i data-lucide="zap" class="w-3 h-3"></i>
                        <span class="font-medium text-xs">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span>
                    </div>
                    <div id="quickActions" class="text-xs space-y-1 overflow-auto" style="max-height:80px"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸ã¯åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ -->
    <div id="knowledgeBtn" class="fixed bottom-4 right-4 hidden">
        <button onclick="showKnowledgeModal()" class="flex items-center gap-1 px-3 py-2 bg-card rounded-lg shadow-lg text-sm hover:opacity-80">
            <i data-lucide="book-open" class="w-4 h-4"></i>
            <span>ãƒŠãƒ¬ãƒƒã‚¸</span>
            <span id="knowledgeCount" class="text-xs t-sub">0</span>
        </button>
    </div>

    <div id="knowledgeModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
        <div class="rounded-lg max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col" style="background:var(--bg)">
            <div class="p-3 flex justify-between items-center border-b border-def">
                <span class="font-medium text-sm">ğŸ“š ãƒŠãƒ¬ãƒƒã‚¸</span>
                <button onclick="closeKnowledgeModal()" class="hover-bg p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div id="knowledgeList" class="flex-1 overflow-auto p-3 space-y-2 text-sm"></div>
            <div class="p-3 border-t border-def">
                <div class="flex gap-2">
                    <input type="text" id="newKnowledge" placeholder="æ–°ã—ã„ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ ..." class="flex-1 text-sm">
                    <button onclick="addKnowledge()" class="btn btn-primary">è¿½åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        let accessToken = null, inventory = [], archivedInventory = [], projects = [], suppliers = [], knowledge = [];
        let charts = {}, currentMode = 'quick', lastResult = null;
        const icons = { important: 'pin', supplier: 'factory', cost: 'coins', pattern: 'bar-chart-2', seasonal: 'calendar-days', note: 'file-text' };

        function init() {
            initDarkMode(); lucide.createIcons();
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
                const t = sessionStorage.getItem('googleAccessToken');
                if (t) { accessToken = t; gapi.client.setToken({ access_token: accessToken }); showMain(); loadData(); }
            });
        }

        function handleAuth() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (r) => { if (r.access_token) { accessToken = r.access_token; sessionStorage.setItem('googleAccessToken', accessToken); gapi.client.setToken({ access_token: accessToken }); showMain(); loadData(); } }
            }).requestAccessToken();
        }

        function showMain() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('knowledgeBtn').classList.remove('hidden');
            lucide.createIcons();
        }

        async function loadData() {
            if (!accessToken) return;
            try {
                const [supRes, prjRes, invRes] = await Promise.all([
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A2:C' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'æ¡ˆä»¶!A2:N' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'åœ¨åº«!A2:Q' })
                ]);
                suppliers = (supRes.result.values || []).map(r => ({ id: parseInt(r[0] || 0), name: r[1] || '' }));
                projects = (prjRes.result.values || []).map(r => ({ id: r[0], projectPrefix: r[1] || 'AD', projectNumber: parseInt(r[2]) || 0, supplierId: parseInt(r[3] || 0), productName: r[4] || '', totalAmount: parseFloat(r[5] || 0), depositSchedule: JSON.parse(r[6] || '[]'), pickupDate: r[10] || '', registeredDate: r[11] || '', receivedComplete: r[13] === 'true' }));
                inventory = (invRes.result.values || []).map(r => ({ serial: r[1] || '', category: r[2] || '', productName: r[3] || '', receiveDate: r[7] || '', status: r[8] || '', shipDate: r[9] || '', costJPY: r[12] || '', shelfNo: r[14] || '', supplierId: r[16] || '' }));
                try { const a = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A2:Q' }); archivedInventory = (a.result.values || []).map(r => ({ receiveDate: r[7] || '', shipDate: r[9] || '', category: r[2] || '' })); } catch { archivedInventory = []; }
                await loadKnowledge();
                updateAll();
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            } catch (e) { console.error(e); }
        }

        async function loadKnowledge() {
            try {
                const r = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'ãƒŠãƒ¬ãƒƒã‚¸!A2:F' });
                knowledge = (r.result.values || []).map((v, i) => ({ id: i + 2, date: v[0] || '', category: v[1] || 'note', content: v[2] || '' }));
            } catch { knowledge = []; }
            document.getElementById('knowledgeCount').textContent = knowledge.length;
        }

        function updateAll() {
            updateKPIs();
            updateTimeline();
            updateUnpaidTable();
            updateStaleList();
            updateQuickActions();
            updateCharts();
            lucide.createIcons();
        }

        function updateKPIs() {
            const today = new Date();
            const inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            const waiting = inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡');
            const inStockValue = inStock.reduce((s, i) => s + (parseInt(i.costJPY) || 0), 0);

            // å…¥åº«å¾…ã¡ï¼ˆä»Šé€±åˆ°ç€ï¼‰
            const we = new Date(today); we.setDate(we.getDate() + 7);
            const arrivingThisWeek = projects.filter(p => p.pickupDate && !p.receivedComplete && new Date(p.pickupDate) >= today && new Date(p.pickupDate) <= we).length;

            // æœªæ‰•ã„
            let unpaidTotal = 0, unpaidCount = 0, overdueCount = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach((d, i) => {
                    if (!d.paid) {
                        unpaidTotal += d.amountJPY || (d.amountUSD * 150) || 0;
                        unpaidCount++;
                        if (i === 0 && p.registeredDate && Math.floor((today - new Date(p.registeredDate)) / 86400000) > 30) overdueCount++;
                    }
                });
            });

            // ä»Šæœˆæ”¯æ‰•ã„
            const tm = today.toISOString().slice(0, 7);
            const lm = new Date(today.getFullYear(), today.getMonth() - 1, 1).toISOString().slice(0, 7);
            let thisMonthTotal = 0, lastMonthTotal = 0;
            projects.forEach(p => {
                (p.depositSchedule || []).forEach(d => {
                    if (d.paid && d.paidDate) {
                        if (d.paidDate.startsWith(tm)) thisMonthTotal += d.amountJPY || 0;
                        if (d.paidDate.startsWith(lm)) lastMonthTotal += d.amountJPY || 0;
                    }
                });
            });
            const momChange = lastMonthTotal > 0 ? Math.round((thisMonthTotal - lastMonthTotal) / lastMonthTotal * 100) : 0;

            // å¹³å‡æ»ç•™æ—¥æ•°
            const stayDays = inStock.filter(i => i.receiveDate).map(i => Math.floor((today - new Date(i.receiveDate)) / 86400000));
            const avgStay = stayDays.length ? Math.round(stayDays.reduce((a, b) => a + b, 0) / stayDays.length) : 0;
            
            // å…ˆæœˆã®å¹³å‡ã¨æ¯”è¼ƒ
            const lastMonthInStock = [...inventory, ...archivedInventory].filter(i => {
                if (!i.receiveDate) return false;
                const rd = new Date(i.receiveDate);
                return rd.getMonth() === today.getMonth() - 1;
            });
            const lastMonthStay = lastMonthInStock.length > 0 ? 30 : avgStay; // ä»®
            const stayChange = avgStay - lastMonthStay;

            // å›è»¢ç‡ï¼ˆæœˆé–“å‡ºåº«æ•° / å¹³å‡åœ¨åº«ï¼‰
            const thisMonthShipped = [...inventory, ...archivedInventory].filter(i => i.shipDate && i.shipDate.startsWith(tm)).length;
            const avgInventory = inStock.length || 1;
            const turnover = (thisMonthShipped / avgInventory).toFixed(1);

            // ãƒ˜ãƒ«ã‚¹
            const noShelf = inStock.filter(i => !i.shelfNo).length;
            const stale60 = stayDays.filter(d => d >= 60).length;
            let healthHtml = '';
            if (overdueCount > 0) healthHtml += `<div style="color:var(--red)">âš  æ”¯æ‰•é…å»¶${overdueCount}</div>`;
            if (noShelf > 0) healthHtml += `<div style="color:var(--yellow)">â–³ æ£šç•ª${noShelf}</div>`;
            if (stale60 > 0) healthHtml += `<div style="color:var(--yellow)">â–³ æ»ç•™${stale60}</div>`;
            if (!healthHtml) healthHtml = '<div style="color:var(--green)">âœ“ OK</div>';

            // DOMæ›´æ–°
            document.getElementById('kpiInStock').textContent = inStock.length + 'ä»¶';
            document.getElementById('kpiInStockSub').textContent = 'Â¥' + (inStockValue / 10000).toFixed(0) + 'ä¸‡';
            document.getElementById('kpiWaiting').textContent = waiting.length + 'ä»¶';
            document.getElementById('kpiWaitingSub').textContent = arrivingThisWeek > 0 ? `ä»Šé€±${arrivingThisWeek}ä»¶` : '-';
            document.getElementById('kpiUnpaid').textContent = 'Â¥' + Math.round(unpaidTotal / 10000) + 'ä¸‡';
            document.getElementById('kpiUnpaidSub').textContent = unpaidCount + 'ä»¶';
            document.getElementById('kpiThisMonth').textContent = 'Â¥' + Math.round(thisMonthTotal / 10000) + 'ä¸‡';
            document.getElementById('kpiThisMonthSub').innerHTML = `<span style="color:${momChange >= 0 ? 'var(--red)' : 'var(--green)'}">${momChange >= 0 ? '+' : ''}${momChange}%</span>`;
            document.getElementById('kpiAvgStay').textContent = avgStay + 'æ—¥';
            document.getElementById('kpiAvgStaySub').innerHTML = `<span style="color:${stayChange >= 0 ? 'var(--red)' : 'var(--green)'}">${stayChange >= 0 ? '+' : ''}${stayChange}æ—¥</span>`;
            document.getElementById('kpiTurnover').textContent = turnover;
            document.getElementById('kpiOverdue').textContent = overdueCount + 'ä»¶';
            document.getElementById('kpiOverdueSub').textContent = overdueCount > 0 ? 'è¦å¯¾å¿œ' : '-';
            document.getElementById('healthMini').innerHTML = healthHtml;
        }

        function updateTimeline() {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const we = new Date(today); we.setDate(we.getDate() + 7);
            const wed = new Date(today); wed.setDate(wed.getDate() + 6);
            document.getElementById('weekRange').textContent = `${today.getMonth() + 1}/${today.getDate()}-${wed.getMonth() + 1}/${wed.getDate()}`;

            const events = [];
            projects.forEach(p => {
                const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4, '0')}`;
                if (p.pickupDate && !p.receivedComplete) {
                    const d = new Date(p.pickupDate);
                    if (d >= today && d <= we) events.push({ date: d, icon: 'truck', title: pn, sub: p.productName.slice(0, 10) });
                }
                if (p.registeredDate) {
                    (p.depositSchedule || []).forEach((dep, i) => {
                        if (dep.paid) return;
                        let due;
                        if (i === 0) { due = new Date(p.registeredDate); due.setDate(due.getDate() + 7); }
                        else if (p.pickupDate) { due = new Date(p.pickupDate); due.setDate(due.getDate() - 7); }
                        if (due && due >= today && due <= we) events.push({ date: due, icon: 'wallet', title: pn, sub: `${dep.percentage}%` });
                    });
                }
            });
            events.sort((a, b) => a.date - b.date);

            const c = document.getElementById('timeline');
            if (!events.length) { c.innerHTML = '<p class="t-sub">äºˆå®šãªã—</p>'; return; }
            
            const dn = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            c.innerHTML = events.slice(0, 8).map(e => {
                const isToday = e.date.toDateString() === today.toDateString();
                return `<div class="flex items-center gap-2 hover-bg p-1 ${isToday ? 'font-medium' : ''}">
                    <span class="w-10 t-sub">${e.date.getMonth() + 1}/${e.date.getDate()}${dn[e.date.getDay()]}</span>
                    <i data-lucide="${e.icon}" class="w-3 h-3 t-sub"></i>
                    <span>${e.title}</span>
                    <span class="t-sub truncate">${e.sub}</span>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function updateUnpaidTable() {
            const today = new Date();
            const unpaid = [];
            projects.forEach(p => {
                const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4, '0')}`;
                (p.depositSchedule || []).forEach((d, i) => {
                    if (!d.paid) {
                        const days = p.registeredDate ? Math.floor((today - new Date(p.registeredDate)) / 86400000) : 0;
                        unpaid.push({ pn, amount: d.amountUSD || 0, amountJPY: d.amountJPY || 0, days, overdue: i === 0 && days > 30 });
                    }
                });
            });
            unpaid.sort((a, b) => b.days - a.days);

            const tbody = document.getElementById('unpaidTable');
            tbody.innerHTML = unpaid.slice(0, 6).map(u => `
                <tr>
                    <td>${u.pn}</td>
                    <td>$${u.amount.toLocaleString()}</td>
                    <td>${u.days}æ—¥</td>
                    <td>${u.overdue ? '<span style="color:var(--red)">âš </span>' : 'âœ“'}</td>
                </tr>
            `).join('');
        }

        function updateStaleList() {
            const today = new Date();
            const stale = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && i.receiveDate)
                .map(i => ({ serial: i.serial, days: Math.floor((today - new Date(i.receiveDate)) / 86400000), cat: i.category }))
                .filter(i => i.days >= 45)
                .sort((a, b) => b.days - a.days);

            const c = document.getElementById('staleList');
            if (!stale.length) { c.innerHTML = '<p class="t-sub">ãªã—</p>'; return; }
            c.innerHTML = stale.slice(0, 5).map(s => `
                <div class="flex items-center gap-2 hover-bg p-1">
                    <span class="font-medium">${s.serial}</span>
                    <span class="t-sub">${s.days}æ—¥</span>
                    <span class="t-sub truncate">${s.cat}</span>
                </div>
            `).join('');
        }

        function updateQuickActions() {
            const actions = [];
            inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').slice(0, 3).forEach(i => {
                actions.push({ icon: 'package', title: i.serial, sub: 'å…¥åº«', link: `inventory.html?search=${i.serial}` });
            });
            const today = new Date();
            const unpaidProjects = [];
            projects.forEach(p => {
                const u = (p.depositSchedule || []).find(d => !d.paid);
                if (u && p.registeredDate) unpaidProjects.push({ p, u, d: new Date(p.registeredDate) });
            });
            unpaidProjects.sort((a, b) => a.d - b.d).slice(0, 3).forEach(({ p, u }) => {
                const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4, '0')}`;
                actions.push({ icon: 'credit-card', title: pn, sub: `${u.percentage}%`, link: `index.html?project=${pn}` });
            });

            const c = document.getElementById('quickActions');
            if (!actions.length) { c.innerHTML = '<p class="t-sub">ãªã—</p>'; return; }
            c.innerHTML = actions.slice(0, 5).map(a => `
                <a href="${a.link}" class="flex items-center gap-2 hover-bg p-1">
                    <i data-lucide="${a.icon}" class="w-3 h-3 t-sub"></i>
                    <span class="font-medium">${a.title}</span>
                    <span class="t-sub">${a.sub}</span>
                </a>
            `).join('');
            lucide.createIcons();
        }

        function updateCharts() {
            const today = new Date();
            const inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            const chartColors = ['#37352f', '#787774', '#9b9a97', '#bfbfbd', '#d3d3d1'];
            const defaultOpts = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            };

            // ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥
            const supplierData = {};
            projects.forEach(p => {
                const name = suppliers.find(s => s.id === p.supplierId)?.name || 'ä»–';
                supplierData[name] = (supplierData[name] || 0) + p.totalAmount;
            });
            const supLabels = Object.keys(supplierData).slice(0, 5);
            const supValues = supLabels.map(l => supplierData[l]);
            if (charts.supplier) charts.supplier.destroy();
            charts.supplier = new Chart(document.getElementById('supplierChart'), {
                type: 'doughnut',
                data: { labels: supLabels, datasets: [{ data: supValues, backgroundColor: chartColors }] },
                options: { ...defaultOpts, cutout: '60%' }
            });

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥
            const catData = {};
            inStock.forEach(i => { catData[i.category] = (catData[i.category] || 0) + 1; });
            const catLabels = Object.keys(catData).slice(0, 5);
            const catValues = catLabels.map(l => catData[l]);
            if (charts.category) charts.category.destroy();
            charts.category = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: { labels: catLabels, datasets: [{ data: catValues, backgroundColor: chartColors }] },
                options: { ...defaultOpts, cutout: '60%' }
            });

            // æ”¯æ‰•ã„äºˆå®šï¼ˆ4é€±ï¼‰
            const weeks = [];
            for (let i = 0; i < 4; i++) {
                const ws = new Date(today); ws.setDate(ws.getDate() + i * 7);
                const we = new Date(ws); we.setDate(we.getDate() + 6);
                weeks.push({ label: `${ws.getMonth() + 1}/${ws.getDate()}ã€œ`, start: ws, end: we, total: 0 });
            }
            projects.forEach(p => {
                (p.depositSchedule || []).forEach((d, i) => {
                    if (d.paid) return;
                    let due;
                    if (i === 0 && p.registeredDate) { due = new Date(p.registeredDate); due.setDate(due.getDate() + 14); }
                    else if (p.pickupDate) { due = new Date(p.pickupDate); }
                    if (due) {
                        const w = weeks.find(w => due >= w.start && due <= w.end);
                        if (w) w.total += d.amountJPY || (d.amountUSD * 150) || 0;
                    }
                });
            });
            if (charts.forecast) charts.forecast.destroy();
            charts.forecast = new Chart(document.getElementById('forecastChart'), {
                type: 'bar',
                data: { labels: weeks.map(w => w.label), datasets: [{ data: weeks.map(w => w.total), backgroundColor: '#37352f', borderRadius: 2 }] },
                options: { ...defaultOpts, scales: { x: { grid: { display: false }, ticks: { font: { size: 9 } } }, y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 9 }, callback: v => 'Â¥' + (v / 10000).toFixed(0) + 'ä¸‡' } } } }
            });

            // å…¥å‡ºåº«æ¨ç§»
            const months = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                months.push({ key: d.toISOString().slice(0, 7), label: `${d.getMonth() + 1}æœˆ`, receive: 0, ship: 0 });
            }
            [...inventory, ...archivedInventory].forEach(item => {
                if (item.receiveDate) { const m = months.find(m => m.key === item.receiveDate.slice(0, 7)); if (m) m.receive++; }
                if (item.shipDate) { const m = months.find(m => m.key === item.shipDate.slice(0, 7)); if (m) m.ship++; }
            });
            if (charts.flow) charts.flow.destroy();
            charts.flow = new Chart(document.getElementById('flowChart'), {
                type: 'line',
                data: {
                    labels: months.map(m => m.label),
                    datasets: [
                        { label: 'å…¥åº«', data: months.map(m => m.receive), borderColor: '#37352f', backgroundColor: 'transparent', tension: 0.3, pointRadius: 2, borderWidth: 1.5 },
                        { label: 'å‡ºåº«', data: months.map(m => m.ship), borderColor: '#37352f', borderDash: [3, 3], backgroundColor: 'transparent', tension: 0.3, pointRadius: 2, borderWidth: 1.5 }
                    ]
                },
                options: { ...defaultOpts, scales: { x: { grid: { display: false }, ticks: { font: { size: 9 } } }, y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 9 } } } } }
            });
        }

        // AIåˆ†æ
        function setMode(m) {
            currentMode = m;
            document.querySelectorAll('.mode-btn[data-mode]').forEach(b => b.classList.toggle('active', b.dataset.mode === m));
        }

        async function runAnalysis() {
            const el = document.getElementById('analysisResult');
            el.innerHTML = '<p class="t-sub">åˆ†æä¸­...</p>';
            const d = prepareData();
            const prompts = {
                quick: 'ä»Šã™ãå¯¾å¿œã™ã¹ã3ã€œ5é …ç›®ã‚’å„ªå…ˆåº¦é †ã«ã€‚å½¢å¼: â— é«˜/ä¸­/ä½ ã‚¿ã‚¤ãƒˆãƒ«: å†…å®¹',
                detail: '1. ç¾çŠ¶ 2. ãƒªã‚¹ã‚¯ 3. æ”¹å–„æ¡ˆ ã‚’ç°¡æ½”ã«',
                cost: '1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ 2. æ¥æœˆäºˆæ¸¬ 3. ã‚³ã‚¹ãƒˆå‰Šæ¸›æ¡ˆ',
                supplier: '1. ä¾å­˜åº¦ãƒªã‚¹ã‚¯ 2. å„ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼è©•ä¾¡ 3. æˆ¦ç•¥ææ¡ˆ'
            };
            const prompt = `èª¿é”åœ¨åº«ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(d)}\n\nãƒŠãƒ¬ãƒƒã‚¸: ${knowledge.map(k => k.content).join('; ')}\n\n${prompts[currentMode]}\n\næ—¥æœ¬èªã§ç°¡æ½”ã«ã€ç®‡æ¡æ›¸ãã§ã€‚`;
            try {
                const r = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 800, messages: [{ role: 'user', content: prompt }] })
                });
                const j = await r.json();
                lastResult = j.content?.[0]?.text || '';
                el.innerHTML = lastResult.split('\n').filter(l => l.trim()).map(l => `<div class="mb-1">${l}</div>`).join('');
            } catch { el.innerHTML = '<p style="color:var(--red)">ã‚¨ãƒ©ãƒ¼</p>'; }
        }

        async function sendChat() {
            const inp = document.getElementById('chatInput');
            const msg = inp.value.trim();
            if (!msg) return;
            inp.value = '';
            const el = document.getElementById('analysisResult');
            el.innerHTML = '<p class="t-sub">å›ç­”ä¸­...</p>';
            const d = prepareData();
            try {
                const r = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 500, messages: [{ role: 'user', content: `ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(d)}\n\nè³ªå•: ${msg}\n\nç°¡æ½”ã«å›ç­”ã€‚` }] })
                });
                const j = await r.json();
                el.innerHTML = (j.content?.[0]?.text || 'ã‚¨ãƒ©ãƒ¼').split('\n').map(l => `<div class="mb-1">${l}</div>`).join('');
            } catch { el.innerHTML = '<p style="color:var(--red)">ã‚¨ãƒ©ãƒ¼</p>'; }
        }

        function prepareData() {
            const today = new Date();
            const inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            let ut = 0, uc = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (!d.paid) { ut += d.amountJPY || (d.amountUSD * 150) || 0; uc++; } }); });
            const supplierStats = {};
            projects.forEach(p => { const n = suppliers.find(s => s.id === p.supplierId)?.name || 'ä»–'; supplierStats[n] = (supplierStats[n] || 0) + p.totalAmount; });
            return { inStock: inStock.length, waiting: inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').length, unpaid: uc, unpaidTotal: ut, supplierStats };
        }

        // ãƒŠãƒ¬ãƒƒã‚¸
        function showKnowledgeModal() {
            document.getElementById('knowledgeModal').classList.remove('hidden');
            renderKnowledgeList();
            lucide.createIcons();
        }
        function closeKnowledgeModal() { document.getElementById('knowledgeModal').classList.add('hidden'); }
        function renderKnowledgeList() {
            const c = document.getElementById('knowledgeList');
            if (!knowledge.length) { c.innerHTML = '<p class="t-sub">ãƒŠãƒ¬ãƒƒã‚¸ãªã—</p>'; return; }
            c.innerHTML = [...knowledge].reverse().map(k => `
                <div class="hover-bg p-2 flex items-start gap-2">
                    <i data-lucide="${icons[k.category] || 'file-text'}" class="w-4 h-4 t-sub flex-shrink-0 mt-0.5"></i>
                    <div><p>${k.content}</p><p class="text-xs t-sub">${k.date}</p></div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        async function addKnowledge() {
            const inp = document.getElementById('newKnowledge');
            const content = inp.value.trim();
            if (!content) return;
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID, range: 'ãƒŠãƒ¬ãƒƒã‚¸!A:F', valueInputOption: 'RAW',
                    resource: { values: [[new Date().toISOString().split('T')[0], 'note', content, 'ä¸­', '', 'manual']] }
                });
                inp.value = '';
                await loadKnowledge();
                renderKnowledgeList();
            } catch (e) { console.error(e); }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', document.documentElement.classList.contains('dark')); }
        function initDarkMode() { if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); }
        window.onload = () => { const s = document.createElement('script'); s.src = 'https://accounts.google.com/gsi/client'; s.onload = init; document.head.appendChild(s); };
    </script>
</body>
</html>
