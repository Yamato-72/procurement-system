<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSèª¿é”ãƒŠãƒ“</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='70' font-size='60' text-anchor='middle'>ğŸ§­</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');
        * { font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif; }
        
        /* Notioné¢¨ãƒ™ãƒ¼ã‚¹ */
        body { background: #ffffff; }
        .dark body { background: #191919; }
        
        /* ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .hover-bg { transition: background-color 0.15s ease; }
        .hover-bg:hover { background-color: rgba(55, 53, 47, 0.04); }
        .dark .hover-bg:hover { background-color: rgba(255, 255, 255, 0.03); }
        
        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section { padding: 12px 14px; border-radius: 4px; }
        
        /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ */
        .icon-box { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-item { position: relative; padding-left: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: 5px; top: 20px; bottom: -4px; width: 1px; background: #e5e5e5; }
        .dark .timeline-item::before { background: #333; }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot { position: absolute; left: 0; top: 6px; width: 12px; height: 12px; border-radius: 50%; background: #e5e5e5; }
        .dark .timeline-dot { background: #444; }
        .timeline-dot.active { background: #2383e2; }
        
        /* ãƒãƒ£ãƒƒãƒˆ */
        .chat-bubble { max-width: 85%; padding: 8px 12px; border-radius: 8px; font-size: 14px; }
        .chat-user { background: #f1f1f0; margin-left: auto; }
        .chat-ai { background: transparent; border: 1px solid #e5e5e5; }
        .dark .chat-user { background: #2f2f2f; }
        .dark .chat-ai { border-color: #333; }
        
        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
        .mode-btn { padding: 4px 10px; font-size: 13px; border-radius: 4px; color: rgba(55, 53, 47, 0.65); transition: all 0.15s; }
        .mode-btn:hover { background: rgba(55, 53, 47, 0.04); }
        .mode-btn.active { background: rgba(35, 131, 226, 0.1); color: #2383e2; }
        .dark .mode-btn { color: rgba(255, 255, 255, 0.6); }
        .dark .mode-btn:hover { background: rgba(255, 255, 255, 0.04); }
        .dark .mode-btn.active { background: rgba(35, 131, 226, 0.2); color: #529cca; }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #d3d3d3; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #bbb; }
        .dark ::-webkit-scrollbar-thumb { background: #444; }
    </style>
</head>
<body class="min-h-screen bg-white dark:bg-[#191919] text-[#37352f] dark:text-[#ffffffcf]">
    <div id="app" class="max-w-5xl mx-auto px-4 sm:px-8 py-4">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="flex items-center justify-between py-3 mb-2">
            <div class="flex items-center gap-3">
                <span class="text-3xl">ğŸ§­</span>
                <div>
                    <h1 class="text-xl font-bold">YSèª¿é”ãƒŠãƒ“</h1>
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66]" id="lastUpdate">èª¿é”ãƒ»åœ¨åº«ç®¡ç†</p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <a href="index.html" class="hover-bg px-3 py-1.5 rounded text-sm">èª¿é”ç®¡ç†</a>
                <a href="inventory.html" class="hover-bg px-3 py-1.5 rounded text-sm">åœ¨åº«ç®¡ç†</a>
                <button onclick="loadData()" class="hover-bg p-2 rounded text-lg" title="æ›´æ–°">ğŸ”„</button>
                <button onclick="toggleDarkMode()" class="hover-bg p-2 rounded text-lg" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ™</button>
            </div>
        </header>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³å‰ -->
        <div id="loginSection" class="py-20 text-center">
            <span class="text-6xl mb-6 block">ğŸ§­</span>
            <h2 class="text-xl font-semibold mb-2">YSèª¿é”ãƒŠãƒ“</h2>
            <p class="text-[#37352f99] dark:text-[#ffffff66] mb-6">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</p>
            <button onclick="handleAuth()" class="px-5 py-2 bg-[#2383e2] text-white rounded hover:bg-[#1a6fbe] transition-colors">
                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="mainContent" class="hidden space-y-8">
            
            <!-- ã‚µãƒãƒªãƒ¼ -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <a href="inventory.html?status=åœ¨åº«ä¸­" class="hover-bg section cursor-pointer">
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mb-1">åœ¨åº«ä¸­</p>
                    <p class="text-2xl font-semibold" id="statInStock">-</p>
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mt-1" id="statInStockDetail">-</p>
                </a>
                <a href="inventory.html?status=å…¥åº«å¾…ã¡" class="hover-bg section cursor-pointer">
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mb-1">å…¥åº«å¾…ã¡</p>
                    <p class="text-2xl font-semibold" id="statWaiting">-</p>
                    <p class="text-xs text-[#eb5757] dark:text-[#ff7369] mt-1" id="statWaitingDetail">-</p>
                </a>
                <a href="index.html" class="hover-bg section cursor-pointer">
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mb-1">æœªæ‰•ã„</p>
                    <p class="text-2xl font-semibold" id="statUnpaid">-</p>
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mt-1" id="statUnpaidDetail">-</p>
                </a>
                <div class="section">
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mb-1">ä»Šæœˆæ”¯æ‰•ã„</p>
                    <p class="text-2xl font-semibold" id="statThisMonth">-</p>
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mt-1" id="statThisMonthDetail">-</p>
                </div>
            </div>

            <!-- AIåˆ†æ -->
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">ğŸ§ </span>
                    <h2 class="font-semibold">AIåˆ†æ</h2>
                </div>
                
                <div class="flex flex-wrap gap-1 mb-3">
                    <button class="mode-btn active" data-mode="quick" onclick="setAnalysisMode('quick')">âš¡ ã‚¯ã‚¤ãƒƒã‚¯</button>
                    <button class="mode-btn" data-mode="detail" onclick="setAnalysisMode('detail')">ğŸ“Š è©³ç´°</button>
                    <button class="mode-btn" data-mode="cost" onclick="setAnalysisMode('cost')">ğŸ’° ã‚³ã‚¹ãƒˆ</button>
                    <button class="mode-btn" data-mode="supplier" onclick="setAnalysisMode('supplier')">ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</button>
                    <button class="mode-btn" data-mode="forecast" onclick="setAnalysisMode('forecast')">ğŸ”® äºˆæ¸¬</button>
                </div>

                <div id="analysisResult" class="p-4 bg-[#f7f6f3] dark:bg-[#252525] rounded-lg mb-3 min-h-[100px] text-sm">
                    <p class="text-[#37352f99] dark:text-[#ffffff66]">åˆ†æãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã€Œåˆ†æé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                </div>
                
                <div class="flex gap-2 mb-6">
                    <button onclick="runAnalysis()" class="px-4 py-2 bg-[#2383e2] text-white text-sm rounded hover:bg-[#1a6fbe] transition-colors">
                        åˆ†æé–‹å§‹
                    </button>
                    <button onclick="saveToKnowledge()" id="saveKnowledgeBtn" class="px-4 py-2 bg-[#0f7b6c] text-white text-sm rounded hover:bg-[#0a6355] transition-colors hidden">
                        ğŸ’¾ ãƒŠãƒ¬ãƒƒã‚¸ã«ä¿å­˜
                    </button>
                </div>

                <!-- AIãƒãƒ£ãƒƒãƒˆ -->
                <div class="border-t border-[#e5e5e5] dark:border-[#333] pt-4">
                    <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mb-3">ğŸ’¬ AIã«è³ªå•</p>
                    <div id="chatHistory" class="space-y-2 mb-3 max-h-[250px] overflow-y-auto"></div>
                    <div class="flex gap-2">
                        <input type="text" id="chatInput" placeholder="ä¾‹: æ¥æœˆã®æ”¯æ‰•ã„ã¯ã„ãã‚‰ï¼Ÿ" 
                            class="flex-1 px-3 py-2 bg-[#f7f6f3] dark:bg-[#252525] rounded text-sm border-0 outline-none focus:ring-1 focus:ring-[#2383e2]"
                            onkeypress="if(event.key==='Enter')sendChat()">
                        <button onclick="sendChat()" class="px-4 py-2 bg-[#37352f] dark:bg-[#fff] text-white dark:text-[#191919] text-sm rounded hover:opacity-80">
                            é€ä¿¡
                        </button>
                    </div>
                </div>
            </div>

            <!-- ãƒŠãƒ¬ãƒƒã‚¸ -->
            <div>
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">ğŸ“š</span>
                        <h2 class="font-semibold">ãƒŠãƒ¬ãƒƒã‚¸</h2>
                        <span id="knowledgeCount" class="text-xs text-[#37352f99] dark:text-[#ffffff66]">0ä»¶</span>
                    </div>
                    <button onclick="showKnowledgeModal()" class="text-sm text-[#2383e2] hover:underline">ã™ã¹ã¦è¦‹ã‚‹</button>
                </div>
                <div id="knowledgePreview" class="space-y-1">
                    <p class="text-sm text-[#37352f99] dark:text-[#ffffff66]">ãƒŠãƒ¬ãƒƒã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>

            <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ & ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">ğŸ“…</span>
                            <h2 class="font-semibold">ä»Šé€±ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
                        </div>
                        <span class="text-xs text-[#37352f99] dark:text-[#ffffff66]" id="timelineWeek">-</span>
                    </div>
                    <div id="timeline" class="space-y-2">
                        <p class="text-sm text-[#37352f99] dark:text-[#ffffff66]">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-lg">ğŸ¥</span>
                        <h2 class="font-semibold">ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</h2>
                    </div>
                    <div id="healthCheck" class="space-y-2">
                        <p class="text-sm text-[#37352f99] dark:text-[#ffffff66]">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">âš¡</span>
                    <h2 class="font-semibold">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
                </div>
                <div id="quickActions" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                    <p class="text-sm text-[#37352f99] dark:text-[#ffffff66]">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- ã‚°ãƒ©ãƒ• -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <p class="text-sm font-medium mb-3">æœˆåˆ¥å…¥å‡ºåº«æ¨ç§»</p>
                    <div class="h-48"><canvas id="flowChart"></canvas></div>
                </div>
                <div>
                    <p class="text-sm font-medium mb-3">æœˆåˆ¥æ”¯æ‰•ã„é¡</p>
                    <div class="h-48"><canvas id="paymentChart"></canvas></div>
                </div>
            </div>

        </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="knowledgeModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#252525] rounded-lg max-w-xl w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 flex justify-between items-center border-b border-[#e5e5e5] dark:border-[#333]">
                <h3 class="font-semibold">ğŸ“š ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹</h3>
                <button onclick="closeKnowledgeModal()" class="hover-bg p-1 rounded">âœ•</button>
            </div>
            <div class="p-3 border-b border-[#e5e5e5] dark:border-[#333] flex gap-1 flex-wrap">
                <button class="knowledge-filter mode-btn active" data-filter="all">ã™ã¹ã¦</button>
                <button class="knowledge-filter mode-btn" data-filter="important">ğŸ“Œ é‡è¦</button>
                <button class="knowledge-filter mode-btn" data-filter="supplier">ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</button>
                <button class="knowledge-filter mode-btn" data-filter="cost">ğŸ’° ã‚³ã‚¹ãƒˆ</button>
                <button class="knowledge-filter mode-btn" data-filter="pattern">ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³</button>
            </div>
            <div id="knowledgeList" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
            <div class="p-4 border-t border-[#e5e5e5] dark:border-[#333]">
                <button onclick="showAddKnowledgeForm()" class="w-full px-4 py-2 text-sm text-[#2383e2] hover:bg-[#f7f6f3] dark:hover:bg-[#333] rounded transition-colors">
                    + ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ 
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addKnowledgeModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#252525] rounded-lg max-w-md w-full p-6">
            <h3 class="font-semibold mb-4">ğŸ“ ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-[#37352f99] dark:text-[#ffffff66] mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="newKnowledgeCategory" class="w-full px-3 py-2 bg-[#f7f6f3] dark:bg-[#333] rounded text-sm border-0">
                        <option value="important">ğŸ“Œ é‡è¦ãªæ°—ã¥ã</option>
                        <option value="supplier">ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼</option>
                        <option value="cost">ğŸ’° ã‚³ã‚¹ãƒˆ</option>
                        <option value="pattern">ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
                        <option value="seasonal">ğŸ—“ï¸ å­£ç¯€æ€§</option>
                        <option value="note">ğŸ“ ãƒ¡ãƒ¢</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-[#37352f99] dark:text-[#ffffff66] mb-1">å†…å®¹</label>
                    <textarea id="newKnowledgeContent" rows="3" class="w-full px-3 py-2 bg-[#f7f6f3] dark:bg-[#333] rounded text-sm border-0 resize-none" placeholder="ä¾‹: OKViewã¯å¹´æœ«ã«ç´æœŸãŒé…ã‚Œã‚‹å‚¾å‘"></textarea>
                </div>
                <div>
                    <label class="block text-xs text-[#37352f99] dark:text-[#ffffff66] mb-1">ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="newKnowledgeTags" class="w-full px-3 py-2 bg-[#f7f6f3] dark:bg-[#333] rounded text-sm border-0" placeholder="ä¾‹: OKView, LED">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeAddKnowledgeModal()" class="flex-1 px-4 py-2 text-sm hover:bg-[#f7f6f3] dark:hover:bg-[#333] rounded transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="addKnowledge()" class="flex-1 px-4 py-2 bg-[#2383e2] text-white text-sm rounded hover:bg-[#1a6fbe]">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ========== è¨­å®š ==========
        const CLIENT_ID = '47228502594-hk66ecflb2s5iq02rim3o8j0j87d2p3c.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1-Sv1ci9aQ80d5U42lTa2_eWfDCpsp2HESIOpHkOaxQQ';
        
        let accessToken = null;
        let inventory = [], archivedInventory = [], projects = [], suppliers = [], knowledge = [];
        let charts = {};
        let currentAnalysisMode = 'quick';
        let lastAnalysisResult = null;
        let chatHistory = [];

        // ========== åˆæœŸåŒ– ==========
        function init() {
            initDarkMode();
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
                const savedToken = sessionStorage.getItem('googleAccessToken');
                if (savedToken) { accessToken = savedToken; gapi.client.setToken({ access_token: accessToken }); showMain(); loadData(); }
            });
        }

        function handleAuth() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (r) => { if (r.access_token) { accessToken = r.access_token; sessionStorage.setItem('googleAccessToken', accessToken); gapi.client.setToken({ access_token: accessToken }); showMain(); loadData(); } }
            });
            client.requestAccessToken();
        }

        function showMain() { document.getElementById('loginSection').classList.add('hidden'); document.getElementById('mainContent').classList.remove('hidden'); }

        // ========== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ==========
        async function loadData() {
            if (!accessToken) return;
            try {
                const [supRes, prjRes, invRes] = await Promise.all([
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼!A2:C' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'æ¡ˆä»¶!A2:N' }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'åœ¨åº«!A2:Q' })
                ]);
                suppliers = (supRes.result.values || []).map(r => ({ id: parseInt(r[0] || 0), name: r[1] || '', paymentPatterns: JSON.parse(r[2] || '[]') }));
                projects = (prjRes.result.values || []).map(r => ({ id: r[0], projectPrefix: r[1] || 'AD', projectNumber: parseInt(r[2]) || 0, supplierId: parseInt(r[3] || 0), productName: r[4] || '', totalAmount: parseFloat(r[5] || 0), depositSchedule: JSON.parse(r[6] || '[]'), serial: r[7] || '', quantity: parseInt(r[8] || 1), workingDays: parseInt(r[9] || 30), pickupDate: r[10] || '', registeredDate: r[11] || '', expenses: JSON.parse(r[12] || '[]'), receivedComplete: r[13] === 'true' }));
                inventory = (invRes.result.values || []).map(r => ({ id: r[0] || '', serial: r[1] || '', category: r[2] || '', productName: r[3] || '', orderPrefix: r[4] || '', orderNumber: r[5] || '', orderDate: r[6] || '', receiveDate: r[7] || '', status: r[8] || '', shipDate: r[9] || '', shipPrefix: r[10] || '', shipNumber: r[11] || '', costJPY: r[12] || '', note: r[13] || '', shelfNo: r[14] || '', location: r[15] || '', supplierId: r[16] || '' }));
                try { const arcRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'åœ¨åº«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–!A2:Q' }); archivedInventory = (arcRes.result.values || []).map(r => ({ receiveDate: r[7] || '', shipDate: r[9] || '' })); } catch(e) { archivedInventory = []; }
                await loadKnowledge();
                updateSummary(); updateTimeline(); updateHealthCheck(); updateQuickActions(); updateCharts(); updateKnowledgePreview();
                document.getElementById('lastUpdate').textContent = `æœ€çµ‚æ›´æ–° ${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}`;
            } catch (err) { console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err); }
        }

        // ========== ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç† ==========
        async function loadKnowledge() {
            try {
                const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'ãƒŠãƒ¬ãƒƒã‚¸!A2:F' });
                knowledge = (res.result.values || []).map((r, idx) => ({ id: idx + 2, date: r[0] || '', category: r[1] || 'note', content: r[2] || '', importance: r[3] || 'ä¸­', tags: r[4] || '', source: r[5] || 'manual' }));
            } catch (e) { await createKnowledgeSheet(); knowledge = []; }
        }

        async function createKnowledgeSheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({ spreadsheetId: SPREADSHEET_ID, resource: { requests: [{ addSheet: { properties: { title: 'ãƒŠãƒ¬ãƒƒã‚¸' } } }] } });
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'ãƒŠãƒ¬ãƒƒã‚¸!A1:F1', valueInputOption: 'RAW', resource: { values: [['æ—¥ä»˜', 'ã‚«ãƒ†ã‚´ãƒª', 'å†…å®¹', 'é‡è¦åº¦', 'ã‚¿ã‚°', 'ã‚½ãƒ¼ã‚¹']] } });
            } catch (e) { console.error('ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', e); }
        }

        async function saveKnowledgeItem(category, content, importance = 'ä¸­', tags = '', source = 'ai') {
            const date = new Date().toISOString().split('T')[0];
            try {
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'ãƒŠãƒ¬ãƒƒã‚¸!A:F', valueInputOption: 'RAW', resource: { values: [[date, category, content, importance, tags, source]] } });
                await loadKnowledge(); updateKnowledgePreview(); return true;
            } catch (e) { console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e); return false; }
        }

        function updateKnowledgePreview() {
            const container = document.getElementById('knowledgePreview');
            document.getElementById('knowledgeCount').textContent = knowledge.length + 'ä»¶';
            if (knowledge.length === 0) { container.innerHTML = '<p class="text-sm text-[#37352f99] dark:text-[#ffffff66]">ãƒŠãƒ¬ãƒƒã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>'; return; }
            const recent = [...knowledge].reverse().slice(0, 4);
            const icons = { important: 'ğŸ“Œ', supplier: 'ğŸ­', cost: 'ğŸ’°', pattern: 'ğŸ“Š', seasonal: 'ğŸ—“ï¸', note: 'ğŸ“' };
            container.innerHTML = recent.map(k => `
                <div class="hover-bg section flex items-start gap-2 text-sm">
                    <span>${icons[k.category] || 'ğŸ“'}</span>
                    <div class="flex-1 min-w-0">
                        <p class="truncate">${k.content}</p>
                        <p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mt-0.5">${k.date}</p>
                    </div>
                </div>
            `).join('');
        }

        // ========== åˆ†æ ==========
        function setAnalysisMode(mode) {
            currentAnalysisMode = mode;
            document.querySelectorAll('.mode-btn[data-mode]').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
        }

        async function runAnalysis() {
            const resultEl = document.getElementById('analysisResult');
            const saveBtn = document.getElementById('saveKnowledgeBtn');
            resultEl.innerHTML = '<p class="text-[#37352f99] dark:text-[#ffffff66]">â³ åˆ†æä¸­...</p>';
            saveBtn.classList.add('hidden');
            const analysisData = prepareAnalysisData();
            const prompt = buildAnalysisPrompt(currentAnalysisMode, analysisData);
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1500, messages: [{ role: 'user', content: prompt }] }) });
                const data = await response.json();
                lastAnalysisResult = data.content?.[0]?.text || '';
                resultEl.innerHTML = formatAnalysisResult(lastAnalysisResult);
                saveBtn.classList.remove('hidden');
            } catch (err) {
                resultEl.innerHTML = '<p class="text-[#eb5757]">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>' + generateLocalAnalysis(analysisData);
                lastAnalysisResult = null;
            }
        }

        function prepareAnalysisData() {
            const today = new Date();
            const inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­');
            const supplierStats = {};
            projects.forEach(p => { const sup = suppliers.find(s => s.id === p.supplierId); const name = sup?.name || 'ä¸æ˜'; if (!supplierStats[name]) supplierStats[name] = { count: 0, total: 0, unpaid: 0 }; supplierStats[name].count++; supplierStats[name].total += p.totalAmount; (p.depositSchedule || []).forEach(d => { if (!d.paid) supplierStats[name].unpaid += d.amountUSD || 0; }); });
            const categoryStats = {}; inStock.forEach(i => { categoryStats[i.category] = (categoryStats[i.category] || 0) + 1; });
            const monthlyPayments = {}; for (let i = 5; i >= 0; i--) { const d = new Date(today.getFullYear(), today.getMonth() - i, 1); monthlyPayments[d.toISOString().slice(0, 7)] = 0; }
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate && monthlyPayments.hasOwnProperty(d.paidDate.slice(0, 7))) monthlyPayments[d.paidDate.slice(0, 7)] += d.amountJPY || 0; }); });
            let unpaidTotal = 0, unpaidCount = 0, oldestUnpaidDays = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach((d, idx) => { if (!d.paid) { unpaidTotal += d.amountJPY || (d.amountUSD * 150) || 0; unpaidCount++; if (idx === 0 && p.registeredDate) { const days = Math.floor((today - new Date(p.registeredDate)) / 86400000); if (days > oldestUnpaidDays) oldestUnpaidDays = days; } } }); });
            const stayDays = inStock.filter(i => i.receiveDate).map(i => Math.floor((today - new Date(i.receiveDate)) / 86400000));
            const avgStayDays = stayDays.length > 0 ? Math.round(stayDays.reduce((a, b) => a + b, 0) / stayDays.length) : 0;
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const nextMonthEnd = new Date(today.getFullYear(), today.getMonth() + 2, 0);
            let nextMonthPayment = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach((d, idx) => { if (d.paid) return; let dueDate; if (idx === 0 && p.registeredDate) { dueDate = new Date(p.registeredDate); dueDate.setDate(dueDate.getDate() + 14); } else if (p.pickupDate) { dueDate = new Date(p.pickupDate); } if (dueDate && dueDate >= nextMonth && dueDate <= nextMonthEnd) nextMonthPayment += d.amountJPY || (d.amountUSD * 150) || 0; }); });
            return { inStockCount: inStock.length, inStockValue: inStock.reduce((s, i) => s + (parseInt(i.costJPY) || 0), 0), waitingCount: inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').length, unpaidTotal, unpaidCount, oldestUnpaidDays, supplierStats, categoryStats, monthlyPayments, avgStayDays, noShelfCount: inStock.filter(i => !i.shelfNo).length, staleCount: stayDays.filter(d => d >= 60).length, nextMonthPayment, knowledgeItems: knowledge.slice(-10).map(k => `[${k.category}] ${k.content}`).join('\n') };
        }

        function buildAnalysisPrompt(mode, data) {
            const baseContext = `èª¿é”ãƒ»åœ¨åº«ãƒ‡ãƒ¼ã‚¿:\n- åœ¨åº«ä¸­: ${data.inStockCount}ä»¶ï¼ˆç·é¡ Â¥${data.inStockValue.toLocaleString()}ï¼‰\n- å…¥åº«å¾…ã¡: ${data.waitingCount}ä»¶\n- æœªæ‰•ã„: ${data.unpaidCount}ä»¶ï¼ˆç´„Â¥${Math.round(data.unpaidTotal/10000)}ä¸‡ï¼‰\n- æœ€é•·æœªæ‰•ã„çµŒé: ${data.oldestUnpaidDays}æ—¥\n- å¹³å‡æ»ç•™: ${data.avgStayDays}æ—¥\n- æ£šç•ªæœªè¨­å®š: ${data.noShelfCount}ä»¶\n- é•·æœŸæ»ç•™(60æ—¥+): ${data.staleCount}ä»¶\n- æ¥æœˆæ”¯æ‰•ã„äºˆæ¸¬: ç´„Â¥${Math.round(data.nextMonthPayment/10000)}ä¸‡\n\nã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ¥: ${JSON.stringify(data.supplierStats)}\nã‚«ãƒ†ã‚´ãƒªåˆ¥: ${JSON.stringify(data.categoryStats)}\næœˆåˆ¥æ”¯æ‰•ã„: ${JSON.stringify(data.monthlyPayments)}\n\néå»ã®ãƒŠãƒ¬ãƒƒã‚¸:\n${data.knowledgeItems || 'ãªã—'}`;
            const modePrompts = { quick: `${baseContext}\n\nä»Šã™ãå¯¾å¿œã™ã¹ãé‡è¦äº‹é …ã‚’3ã€œ5å€‹ã€å„ªå…ˆåº¦é †ã«ç°¡æ½”ã«ã€‚å½¢å¼: ğŸ”´/ğŸŸ¡/ğŸŸ¢ ã‚¿ã‚¤ãƒˆãƒ«: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`, detail: `${baseContext}\n\nè©³ç´°åˆ†æ:\n1. ğŸ“Š ç¾çŠ¶ã‚µãƒãƒªãƒ¼\n2. âš ï¸ ãƒªã‚¹ã‚¯ãƒ»èª²é¡Œ\n3. ğŸ’¡ æ”¹å–„ææ¡ˆ\n4. ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰`, cost: `${baseContext}\n\nã‚³ã‚¹ãƒˆåˆ†æ:\n1. ğŸ’° ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼\n2. ğŸ“‰ æ”¯æ‰•ã„ãƒˆãƒ¬ãƒ³ãƒ‰\n3. â° é…å»¶ãƒªã‚¹ã‚¯\n4. ğŸ”® æ¥æœˆäºˆæ¸¬\n5. ğŸ’¡ æœ€é©åŒ–ææ¡ˆ`, supplier: `${baseContext}\n\nã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼åˆ†æ:\n1. ğŸ­ ä¾å­˜åº¦\n2. ğŸ“Š å–å¼•çŠ¶æ³\n3. âš ï¸ åã‚Šãƒªã‚¹ã‚¯\n4. ğŸ’¡ æˆ¦ç•¥ææ¡ˆ`, forecast: `${baseContext}\n\n1ã€œ2ãƒ¶æœˆäºˆæ¸¬:\n1. ğŸ’° æ”¯æ‰•ã„äºˆæ¸¬\n2. ğŸ“¦ å…¥åº«äºˆæ¸¬\n3. âš ï¸ æ³¨æ„ã‚¤ãƒ™ãƒ³ãƒˆ\n4. ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³` };
            return modePrompts[mode] + '\n\nâ€»æ—¥æœ¬èªã§ã€å…·ä½“çš„ãªæ•°å€¤ã‚’å«ã‚ã¦ç°¡æ½”ã«ã€‚';
        }

        function formatAnalysisResult(text) {
            if (!text) return '<p class="text-[#37352f99]">åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return '<div class="space-y-2">' + text.split('\n').filter(l => l.trim()).map(line => {
                if (line.match(/^[ğŸ”´ğŸŸ¡ğŸŸ¢ğŸ“Šâš ï¸ğŸ’¡ğŸ“ˆğŸ’°ğŸ“‰â°ğŸ”®ğŸ­ğŸ“¦ğŸ¯]/)) return `<div class="p-2 bg-white dark:bg-[#1e1e1e] rounded">${line}</div>`;
                if (line.match(/^#+\s/)) return `<p class="font-semibold mt-3">${line.replace(/^#+\s/, '')}</p>`;
                return `<p class="text-[#37352f99] dark:text-[#ffffff99]">${line}</p>`;
            }).join('') + '</div>';
        }

        function generateLocalAnalysis(data) {
            const items = [];
            if (data.oldestUnpaidDays > 30) items.push(`<div class="p-2 bg-[#fdebec] dark:bg-[#3d2929] rounded">ğŸ”´ æ”¯æ‰•ã„${data.oldestUnpaidDays}æ—¥è¶…éã‚ã‚Š</div>`);
            if (data.noShelfCount > 0) items.push(`<div class="p-2 bg-[#fbf3db] dark:bg-[#3d3526] rounded">ğŸŸ¡ æ£šç•ªæœªè¨­å®š${data.noShelfCount}ä»¶</div>`);
            if (data.staleCount > 0) items.push(`<div class="p-2 bg-[#fbf3db] dark:bg-[#3d3526] rounded">ğŸŸ¡ é•·æœŸæ»ç•™${data.staleCount}ä»¶</div>`);
            return '<div class="space-y-2 mt-2">' + (items.length > 0 ? items.join('') : '<p class="text-[#37352f99]">ç‰¹ã«å•é¡Œãªã—</p>') + '</div>';
        }

        async function saveToKnowledge() {
            if (!lastAnalysisResult) return;
            const summary = lastAnalysisResult.slice(0, 200) + (lastAnalysisResult.length > 200 ? '...' : '');
            const categoryMap = { quick: 'important', detail: 'pattern', cost: 'cost', supplier: 'supplier', forecast: 'pattern' };
            if (await saveKnowledgeItem(categoryMap[currentAnalysisMode] || 'note', `[${currentAnalysisMode}åˆ†æ] ` + summary, 'ä¸­', '', 'ai')) {
                alert('ãƒŠãƒ¬ãƒƒã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸ');
                document.getElementById('saveKnowledgeBtn').classList.add('hidden');
            }
        }

        // ========== AIãƒãƒ£ãƒƒãƒˆ ==========
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            input.value = '';
            chatHistory.push({ role: 'user', content: message });
            updateChatUI();
            const analysisData = prepareAnalysisData();
            const context = `èª¿é”ãƒ»åœ¨åº«ç®¡ç†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨ã—ã¦å›ç­”ã€‚ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(analysisData)}\n\nè³ªå•: ${message}\n\nç°¡æ½”ã«å›ç­”ã€‚`;
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 800, messages: [{ role: 'user', content: context }] }) });
                const data = await response.json();
                chatHistory.push({ role: 'assistant', content: data.content?.[0]?.text || 'å›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ' });
            } catch (err) { chatHistory.push({ role: 'assistant', content: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }); }
            updateChatUI();
        }

        function updateChatUI() {
            const container = document.getElementById('chatHistory');
            container.innerHTML = chatHistory.slice(-10).map(m => `<div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}"><div class="chat-bubble ${m.role === 'user' ? 'chat-user' : 'chat-ai'}"><p class="whitespace-pre-wrap">${m.content}</p></div></div>`).join('');
            container.scrollTop = container.scrollHeight;
        }

        // ========== ãƒŠãƒ¬ãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
        function showKnowledgeModal() { document.getElementById('knowledgeModal').classList.remove('hidden'); renderKnowledgeList('all'); }
        function closeKnowledgeModal() { document.getElementById('knowledgeModal').classList.add('hidden'); }
        function renderKnowledgeList(filter) {
            const container = document.getElementById('knowledgeList');
            const icons = { important: 'ğŸ“Œ', supplier: 'ğŸ­', cost: 'ğŸ’°', pattern: 'ğŸ“Š', seasonal: 'ğŸ—“ï¸', note: 'ğŸ“' };
            let filtered = filter === 'all' ? knowledge : knowledge.filter(k => k.category === filter);
            if (filtered.length === 0) { container.innerHTML = '<p class="text-center text-[#37352f99] py-8">è©²å½“ã™ã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; }
            container.innerHTML = [...filtered].reverse().map(k => `<div class="hover-bg section"><div class="flex items-start gap-2"><span>${icons[k.category] || 'ğŸ“'}</span><div class="flex-1"><p class="text-sm">${k.content}</p><p class="text-xs text-[#37352f99] dark:text-[#ffffff66] mt-1">${k.date}${k.tags ? ' Â· ' + k.tags : ''}</p></div></div></div>`).join('');
            document.querySelectorAll('.knowledge-filter').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
        }
        document.addEventListener('click', (e) => { if (e.target.classList.contains('knowledge-filter')) renderKnowledgeList(e.target.dataset.filter); });
        function showAddKnowledgeForm() { document.getElementById('addKnowledgeModal').classList.remove('hidden'); }
        function closeAddKnowledgeModal() { document.getElementById('addKnowledgeModal').classList.add('hidden'); }
        async function addKnowledge() {
            const category = document.getElementById('newKnowledgeCategory').value;
            const content = document.getElementById('newKnowledgeContent').value.trim();
            const tags = document.getElementById('newKnowledgeTags').value.trim();
            if (!content) { alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (await saveKnowledgeItem(category, content, 'ä¸­', tags, 'manual')) { closeAddKnowledgeModal(); renderKnowledgeList('all'); document.getElementById('newKnowledgeContent').value = ''; document.getElementById('newKnowledgeTags').value = ''; }
        }

        // ========== UIæ›´æ–° ==========
        function updateSummary() {
            const today = new Date(), inStock = inventory.filter(i => i.status === 'åœ¨åº«ä¸­'), waiting = inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡');
            const inStockValue = inStock.reduce((s, i) => s + (parseInt(i.costJPY) || 0), 0);
            const weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);
            const arrivingThisWeek = projects.filter(p => { if (!p.pickupDate || p.receivedComplete) return false; const d = new Date(p.pickupDate); return d >= today && d <= weekEnd; });
            let unpaidTotal = 0, unpaidCount = 0, urgentCount = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach((d, idx) => { if (!d.paid) { unpaidTotal += d.amountJPY || (d.amountUSD * 150) || 0; unpaidCount++; if (idx === 0 && p.registeredDate && Math.floor((today - new Date(p.registeredDate)) / 86400000) > 30) urgentCount++; } }); });
            const thisMonth = today.toISOString().slice(0, 7); let thisMonthTotal = 0, thisMonthCount = 0;
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate && d.paidDate.startsWith(thisMonth)) { thisMonthTotal += d.amountJPY || 0; thisMonthCount++; } }); });
            document.getElementById('statInStock').textContent = inStock.length + 'ä»¶';
            document.getElementById('statInStockDetail').textContent = `Â¥${inStockValue.toLocaleString()}`;
            document.getElementById('statWaiting').textContent = waiting.length + 'ä»¶';
            document.getElementById('statWaitingDetail').textContent = arrivingThisWeek.length > 0 ? `ä»Šé€± ${arrivingThisWeek.length}ä»¶åˆ°ç€` : '';
            document.getElementById('statUnpaid').textContent = `Â¥${Math.round(unpaidTotal/10000)}ä¸‡`;
            document.getElementById('statUnpaidDetail').textContent = urgentCount > 0 ? `${urgentCount}ä»¶ãŒ30æ—¥è¶…é` : `${unpaidCount}ä»¶`;
            document.getElementById('statThisMonth').textContent = `Â¥${Math.round(thisMonthTotal/10000)}ä¸‡`;
            document.getElementById('statThisMonthDetail').textContent = `${thisMonthCount}ä»¶`;
        }

        function updateTimeline() {
            const today = new Date(); today.setHours(0,0,0,0); const weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);
            const weekEndDisp = new Date(today); weekEndDisp.setDate(weekEndDisp.getDate() + 6);
            document.getElementById('timelineWeek').textContent = `${today.getMonth()+1}/${today.getDate()} - ${weekEndDisp.getMonth()+1}/${weekEndDisp.getDate()}`;
            const events = [];
            projects.forEach(p => {
                if (p.pickupDate && !p.receivedComplete) { const d = new Date(p.pickupDate); if (d >= today && d <= weekEnd) events.push({ date: d, icon: 'ğŸšš', title: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}`, detail: p.productName, link: `index.html?project=${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}` }); }
                if (p.registeredDate) { (p.depositSchedule || []).forEach((dep, idx) => { if (dep.paid) return; let due; if (idx === 0) { due = new Date(p.registeredDate); due.setDate(due.getDate() + 7); } else if (p.pickupDate) { due = new Date(p.pickupDate); due.setDate(due.getDate() - 7); } if (due && due >= today && due <= weekEnd) events.push({ date: due, icon: 'ğŸ’°', title: `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}`, detail: `${dep.percentage}%`, link: `index.html?project=${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}` }); }); }
            });
            events.sort((a, b) => a.date - b.date);
            const container = document.getElementById('timeline');
            if (events.length === 0) { container.innerHTML = '<p class="text-sm text-[#37352f99] dark:text-[#ffffff66] py-4 text-center">ä»Šé€±ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>'; return; }
            const grouped = {}; events.forEach(e => { const k = e.date.toISOString().split('T')[0]; if (!grouped[k]) grouped[k] = []; grouped[k].push(e); });
            let html = '';
            Object.entries(grouped).forEach(([ds, de]) => {
                const d = new Date(ds), isToday = d.toDateString() === today.toDateString(), dn = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
                html += `<div class="timeline-item"><div class="timeline-dot ${isToday ? 'active' : ''}"></div><p class="text-xs ${isToday ? 'text-[#2383e2] font-medium' : 'text-[#37352f99] dark:text-[#ffffff66]'} mb-1">${d.getMonth()+1}/${d.getDate()} (${dn})${isToday ? ' ä»Šæ—¥' : ''}</p>`;
                de.forEach(e => { html += `<a href="${e.link}" class="hover-bg block p-2 rounded mb-1"><span class="mr-2">${e.icon}</span><span class="font-medium">${e.title}</span><span class="text-[#37352f99] dark:text-[#ffffff66] ml-2 text-sm">${e.detail}</span></a>`; });
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function updateHealthCheck() {
            const today = new Date(), checks = [];
            const noShelf = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && !i.shelfNo).length;
            if (noShelf > 0) checks.push({ icon: 'ğŸ“', text: `æ£šç•ªæœªè¨­å®š ${noShelf}ä»¶`, color: 'bg-[#fbf3db] dark:bg-[#3d3526]' });
            const stale = inventory.filter(i => i.status === 'åœ¨åº«ä¸­' && i.receiveDate && Math.floor((today - new Date(i.receiveDate)) / 86400000) >= 60).length;
            if (stale > 0) checks.push({ icon: 'â°', text: `é•·æœŸæ»ç•™ ${stale}ä»¶`, color: 'bg-[#fbf3db] dark:bg-[#3d3526]' });
            let overdueCount = 0; projects.forEach(p => { if (p.registeredDate && (p.depositSchedule || [])[0] && !(p.depositSchedule || [])[0].paid && Math.floor((today - new Date(p.registeredDate)) / 86400000) > 30) overdueCount++; });
            if (overdueCount > 0) checks.push({ icon: 'ğŸš¨', text: `æ”¯æ‰•ã„é…å»¶ ${overdueCount}ä»¶`, color: 'bg-[#fdebec] dark:bg-[#3d2929]' });
            if (checks.length === 0) checks.push({ icon: 'âœ…', text: 'å•é¡Œãªã—', color: 'bg-[#dbeddb] dark:bg-[#2b3d2b]' });
            document.getElementById('healthCheck').innerHTML = checks.map(c => `<div class="${c.color} p-2 rounded text-sm"><span class="mr-2">${c.icon}</span>${c.text}</div>`).join('');
        }

        function updateQuickActions() {
            const actions = [];
            inventory.filter(i => i.status === 'å…¥åº«å¾…ã¡').slice(0, 3).forEach(item => { actions.push({ icon: 'ğŸ“¦', title: item.serial, detail: item.productName.slice(0, 15), link: `inventory.html?search=${item.serial}` }); });
            const unpaidProjects = []; projects.forEach(p => { const u = (p.depositSchedule || []).find(d => !d.paid); if (u && p.registeredDate) unpaidProjects.push({ p, u, d: new Date(p.registeredDate) }); });
            unpaidProjects.sort((a, b) => a.d - b.d).slice(0, 3).forEach(({ p, u }) => { const pn = `${p.projectPrefix}-${String(p.projectNumber).padStart(4,'0')}`; actions.push({ icon: 'ğŸ’³', title: pn, detail: `${u.percentage}%`, link: `index.html?project=${pn}` }); });
            const container = document.getElementById('quickActions');
            if (actions.length === 0) { container.innerHTML = '<p class="text-sm text-[#37352f99] dark:text-[#ffffff66]">å®Ÿè¡Œå¾…ã¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</p>'; return; }
            container.innerHTML = actions.slice(0, 6).map(a => `<a href="${a.link}" class="hover-bg section flex items-center gap-3"><span class="text-lg">${a.icon}</span><div class="min-w-0"><p class="font-medium text-sm truncate">${a.title}</p><p class="text-xs text-[#37352f99] dark:text-[#ffffff66] truncate">${a.detail}</p></div></a>`).join('');
        }

        function updateCharts() {
            const now = new Date(), allItems = [...inventory, ...archivedInventory], months = [];
            for (let i = 5; i >= 0; i--) { const d = new Date(now.getFullYear(), now.getMonth() - i, 1); months.push({ key: d.toISOString().slice(0, 7), label: `${d.getMonth() + 1}æœˆ`, receive: 0, ship: 0, payment: 0 }); }
            allItems.forEach(item => { if (item.receiveDate) { const m = months.find(m => m.key === item.receiveDate.slice(0, 7)); if (m) m.receive++; } if (item.shipDate) { const m = months.find(m => m.key === item.shipDate.slice(0, 7)); if (m) m.ship++; } });
            projects.forEach(p => { (p.depositSchedule || []).forEach(d => { if (d.paid && d.paidDate) { const m = months.find(m => m.key === d.paidDate.slice(0, 7)); if (m) m.payment += d.amountJPY || 0; } }); });
            const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#e5e5e5' }, beginAtZero: true } } };
            if (charts.flow) charts.flow.destroy();
            charts.flow = new Chart(document.getElementById('flowChart'), { type: 'line', data: { labels: months.map(m => m.label), datasets: [{ label: 'å…¥åº«', data: months.map(m => m.receive), borderColor: '#0f7b6c', backgroundColor: 'transparent', tension: 0.3, pointRadius: 3 }, { label: 'å‡ºåº«', data: months.map(m => m.ship), borderColor: '#2383e2', backgroundColor: 'transparent', tension: 0.3, pointRadius: 3 }] }, options: { ...chartOptions, plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 12, padding: 15 } } } } });
            if (charts.payment) charts.payment.destroy();
            charts.payment = new Chart(document.getElementById('paymentChart'), { type: 'bar', data: { labels: months.map(m => m.label), datasets: [{ data: months.map(m => m.payment), backgroundColor: '#37352f', borderRadius: 4 }] }, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, ticks: { callback: v => 'Â¥' + (v/10000).toFixed(0) + 'ä¸‡' } } } } });
        }

        // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', document.documentElement.classList.contains('dark')); }
        function initDarkMode() { if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); }
        window.onload = () => { const s = document.createElement('script'); s.src = 'https://accounts.google.com/gsi/client'; s.onload = init; document.head.appendChild(s); };
    </script>
</body>
</html>
